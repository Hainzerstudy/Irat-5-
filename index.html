<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>ICAT – Índice Clínico de Ayuda Técnica</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
body{font-family:Segoe UI,Arial;background:#eef2f7;margin:0;padding:20px}
.container{max-width:1400px;margin:auto;background:white;border-radius:16px;box-shadow:0 20px 40px rgba(0,0,0,.15)}
.header{background:linear-gradient(135deg,#1a237e,#3949ab);color:white;padding:40px;text-align:center}
.section{padding:40px}
.card{background:#f9faff;border-radius:12px;padding:25px;margin-bottom:25px}
.card h3{margin-top:0}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px}
label{font-weight:600}
select,input{width:100%;padding:8px;margin-top:5px}
button{padding:12px 18px;border:none;border-radius:8px;cursor:pointer}
.primary{background:#3949ab;color:white}
.success{background:#2e7d32;color:white}
.secondary{background:#546e7a;color:white}
pre{background:#eceff1;padding:15px;border-radius:8px}
.badge{padding:6px 10px;border-radius:20px;font-size:14px;color:white}
.low{background:#2e7d32}
.mid{background:#f9a825}
.high{background:#c62828}
</style>
</head>

<body>

<div class="container">
<div class="header">
<h1>ICAT – Índice Clínico de Ayuda Técnica</h1>
<p>Instrumento clínico–investigativo · Versión 1.0</p>
</div>

<div class="section">

<div class="card">
<h3>Datos del paciente (anonimizado)</h3>
<div class="grid">
<input id="codigo" placeholder="Código paciente">
<input id="edad" type="number" placeholder="Edad">
<input id="sexo" placeholder="Sexo">
<input id="evaluador" placeholder="Evaluador">
<input id="fecha" type="date">
</div>
</div>

<!-- IRAT -->
<div class="card">
<h3>IRAT – Independencia Funcional</h3>
<div id="irat-items"></div>
</div>

<!-- TINETTI -->
<div class="card">
<h3>Tinetti – Equilibrio y Marcha</h3>
<div id="tinetti-items"></div>
</div>

<!-- NORTON -->
<div class="card">
<h3>Norton – Riesgo de dependencia</h3>
<div id="norton-items"></div>
</div>

<button class="primary" onclick="calcular()">Calcular ICAT</button>

<div class="card" id="resultados" style="display:none">
<h3>Resultados</h3>
<pre id="resumen"></pre>
<button class="primary" onclick="pdf()">PDF</button>
<button class="success" onclick="guardar()">Guardar</button>
<button class="secondary" onclick="csv()">CSV</button>
</div>

</div>
</div>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey:"AIzaSyDJbtRuEwWVAsC1Nz6LbeF5a99LcUfAz4g",
  authDomain:"irat-5-evaluaciones.firebaseapp.com",
  projectId:"irat-5-evaluaciones"
});
const db=firebase.firestore();

/* ================= CUESTIONARIOS ================= */
const iratQ=5, tinettiQ=10, nortonQ=5;
const makeItems=(id,n,max)=>{
  let h='';
  for(let i=1;i<=n;i++){
    h+=`<label>Ítem ${i}</label>
    <select data-max="${max}">
      ${[...Array(max+1).keys()].map(v=>`<option value="${v}">${v}</option>`).join('')}
    </select><br><br>`;
  }
  document.getElementById(id).innerHTML=h;
}
makeItems("irat-items",iratQ,4);
makeItems("tinetti-items",tinettiQ,2);
makeItems("norton-items",nortonQ,4);

/* ================= CÁLCULO ================= */
let evaluacion=null;
function calcular(){
  const sum=(id)=>[...document.querySelectorAll(`#${id} select`)]
    .reduce((a,s)=>a+parseInt(s.value),0);

  const irat=sum("irat-items");
  const tinetti=sum("tinetti-items");
  const norton=sum("norton-items");

  const iratN=(irat/(iratQ*4))*100;
  const tinettiN=((tinettiQ*2-tinetti)/(tinettiQ*2))*100;
  const nortonN=((nortonQ*4-norton)/(nortonQ*4))*100;

  const ICAT=(iratN*0.4+tinettiN*0.35+nortonN*0.25).toFixed(1);

  let nivel,ayuda,f;
  if(ICAT<20){nivel="Muy bajo";ayuda="Sin ayuda";f="Funcionalidad conservada";}
  else if(ICAT<40){nivel="Bajo";ayuda="Bastón";f="Leve compromiso funcional";}
  else if(ICAT<60){nivel="Moderado";ayuda="Andador";f="Riesgo funcional significativo";}
  else if(ICAT<80){nivel="Alto";ayuda="Silla de ruedas";f="Alta dependencia";}
  else{nivel="Muy alto";ayuda="Ayuda compleja";f="Dependencia severa";}

  evaluacion={
    instrumento:"ICAT",
    version:"1.0",
    paciente:{codigo:codigo.value,edad:edad.value,sexo:sexo.value},
    evaluador:evaluador.value,
    fecha:fecha.value,
    puntajes:{irat,tinetti,norton,ICAT},
    nivel,ayuda,fundamento:f,
    timestamp:firebase.firestore.FieldValue.serverTimestamp()
  };

  resultados.style.display="block";
  resumen.textContent=
`IRAT: ${irat}
Tinetti: ${tinetti}
Norton: ${norton}

ICAT: ${ICAT}
Nivel: ${nivel}
Ayuda recomendada: ${ayuda}

Fundamento clínico:
${f}`;
}

/* ================= PDF ================= */
function pdf(){
  const {jsPDF}=window.jspdf;
  const d=new jsPDF();
  let y=20;
  d.text("ICAT – Índice Clínico de Ayuda Técnica",105,y,{align:"center"});
  y+=20;
  Object.entries(evaluacion).forEach(([k,v])=>{
    if(typeof v!=="object"){
      d.text(`${k}: ${v}`,20,y);y+=8;
    }
  });
  d.save("ICAT.pdf");
}

/* ================= FIRESTORE ================= */
function guardar(){
  db.collection("ICAT_evaluaciones").add(evaluacion);
  alert("Guardado");
}

/* ================= CSV ================= */
function csv(){
  const rows=[];
  Object.entries(evaluacion).forEach(([k,v])=>{
    rows.push(`${k},${JSON.stringify(v)}`);
  });
  const b=new Blob([rows.join("\n")],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(b);
  a.download="ICAT.csv";
  a.click();
}
</script>

</body>
</html>
