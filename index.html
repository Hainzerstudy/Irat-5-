<script>
        // ========== CONFIGURACIÓN FIREBASE ==========
        const firebaseConfig = {
            apiKey: "AIzaSyDJbtRuEwWVAsC1Nz6LbeF5a99LcUfAz4g",
            authDomain: "irat-5-evaluaciones.firebaseapp.com",
            projectId: "irat-5-evaluaciones",
            storageBucket: "irat-5-evaluaciones.firebasestorage.app",
            messagingSenderId: "487279274410",
            appId: "1:487279274410:web:146e9c35a0bf795c5423d3",
            measurementId: "G-WSXJY5QHJS"
        };

        // ========== VARIABLES GLOBALES ==========
        let firebaseApp;
        let db;
        let auth;
        let currentUser = null;
        let datosCompletos = null;
        let historialFirebase = [];
        let currentPage = 1;
        const itemsPerPage = 5;
        let lastVisible = null;
        let firstVisible = null;
        let currentQuery = null;
        
        // Variables del formulario
        let puntajeTotalIRAT = 0;
        let puntajeNorton = 15;
        let puntajeTinetti = 0;
        let nivelRiesgoIRAT = "";
        let nivelRiesgoNorton = "";
        let recomendaciones = [];
        let tinettiNoEvaluable = false;
        let respuestasTinetti = {};
        let respuestasIRAT = {};
        let respuestasNorton = {};
        
        // Storage local para modo offline
        const LOCAL_STORAGE_KEY = 'irat_evaluaciones_pendientes';
        let evaluacionesPendientes = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY)) || [];

        // ========== INICIALIZACIÓN ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM cargado, inicializando...');
            
            // Configurar fecha actual
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fecha').value = today;
            
            // Configurar navegación
            inicializarNavegacion();
            
            // Configurar componentes del formulario
            configurarTinetti();
            configurarIRAT5();
            configurarCompartir();
            configurarHistorial();
            configurarValidaciones();
            
            // Configurar eventos de Norton
            ['norton-fisico', 'norton-mental', 'norton-actividad', 'norton-movilidad', 'norton-incontinencia'].forEach(id => {
                document.getElementById(id).addEventListener('change', calcularNorton);
            });
            
            calcularNorton();
            
            // Inicializar Firebase después de configurar todo
            inicializarFirebase();
            
            // Configurar detección de conexión
            configurarDeteccionConexion();
            
            mostrarNotificacion('Sistema cargado correctamente', 'info');
        });

        // ========== INICIALIZAR FIREBASE ==========
        function inicializarFirebase() {
            try {
                console.log('Inicializando Firebase...');
                
                // Evitar múltiples inicializaciones
                if (!firebase.apps.length) {
                    firebaseApp = firebase.initializeApp(firebaseConfig);
                    console.log('Firebase inicializado por primera vez');
                } else {
                    firebaseApp = firebase.app();
                    console.log('Firebase ya estaba inicializado');
                }
                
                db = firebase.firestore();
                auth = firebase.auth();
                console.log('Firestore y Auth configurados');
                
                // Configurar persistencia de sesión
                auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                
                // Escuchar cambios de autenticación
                auth.onAuthStateChanged((user) => {
                    console.log('Cambio en estado de autenticación:', user ? 'Usuario conectado' : 'No hay usuario');
                    if (user) {
                        // Usuario autenticado
                        currentUser = user;
                        actualizarUIUsuario(user);
                        actualizarEstadoFirebase('Conectado ✓', 'firebase-connected');
                        
                        // Sincronizar evaluaciones pendientes
                        sincronizarEvaluacionesPendientes();
                        
                        // Cargar historial si estamos en esa sección
                        if (document.getElementById('historial').classList.contains('active')) {
                            cargarHistorialFirebase();
                        }
                        
                        mostrarNotificacion(`Bienvenido ${user.email}`, 'success');
                    } else {
                        // No autenticado
                        currentUser = null;
                        actualizarUIUsuario(null);
                        mostrarLogin();
                    }
                });
                
            } catch (error) {
                console.error('Error inicializando Firebase:', error);
                actualizarEstadoFirebase('Error de conexión', 'firebase-disconnected');
                mostrarNotificacion('Error conectando a Firebase. Trabajando en modo local.', 'warning');
            }
        }

        // ========== DETECCIÓN DE CONEXIÓN ==========
        function configurarDeteccionConexion() {
            window.addEventListener('online', () => {
                document.getElementById('offline-indicator').classList.remove('show');
                actualizarEstadoFirebase('Conectado ✓', 'firebase-connected');
                mostrarNotificacion('Conexión restablecida', 'success');
                
                // Sincronizar datos pendientes
                if (currentUser) {
                    sincronizarEvaluacionesPendientes();
                }
            });
            
            window.addEventListener('offline', () => {
                document.getElementById('offline-indicator').classList.add('show');
                actualizarEstadoFirebase('Sin conexión', 'firebase-disconnected');
                mostrarNotificacion('Sin conexión a Internet', 'warning');
            });
        }

        // ========== SISTEMA OFFLINE ==========
        function guardarLocalmente(datos) {
            try {
                evaluacionesPendientes.push({
                    ...datos,
                    timestamp: Date.now(),
                    status: 'pendiente'
                });
                
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(evaluacionesPendientes));
                mostrarNotificacion('Evaluación guardada localmente. Se sincronizará cuando haya conexión.', 'info');
                
                return true;
            } catch (error) {
                console.error('Error guardando localmente:', error);
                mostrarNotificacion('Error al guardar localmente', 'error');
                return false;
            }
        }
        
        async function sincronizarEvaluacionesPendientes() {
            if (evaluacionesPendientes.length === 0 || !currentUser) return;
            
            mostrarNotificacion('Sincronizando evaluaciones pendientes...', 'info');
            
            const exitosas = [];
            const fallidas = [];
            
            for (let i = evaluacionesPendientes.length - 1; i >= 0; i--) {
                const evaluacion = evaluacionesPendientes[i];
                
                try {
                    await db.collection('evaluaciones').add({
                        ...evaluacion,
                        userId: currentUser.uid,
                        userEmail: currentUser.email,
                        fechaGuardado: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    exitosas.push(evaluacion);
                    evaluacionesPendientes.splice(i, 1);
                    
                } catch (error) {
                    console.error('Error sincronizando evaluación:', error);
                    fallidas.push(evaluacion);
                }
            }
            
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(evaluacionesPendientes));
            
            if (exitosas.length > 0) {
                mostrarNotificacion(`${exitosas.length} evaluación(es) sincronizada(s)`, 'success');
            }
            
            if (fallidas.length > 0) {
                mostrarNotificacion(`${fallidas.length} evaluación(es) no se pudieron sincronizar`, 'warning');
            }
        }

        // ========== AUTENTICACIÓN ==========
        function mostrarLogin() {
            document.getElementById('login-container').style.display = 'flex';
        }
        
        function ocultarLogin() {
            document.getElementById('login-container').style.display = 'none';
        }
        
        function actualizarUIUsuario(user) {
            const userDisplay = document.getElementById('user-display');
            const currentUserSpan = document.getElementById('current-user');
            
            if (user) {
                currentUserSpan.textContent = user.email;
                userDisplay.style.display = 'flex';
                ocultarLogin();
            } else {
                userDisplay.style.display = 'none';
            }
        }
        
        // Eventos de login
        document.getElementById('btn-login')?.addEventListener('click', async function() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                mostrarNotificacion('Ingrese email y contraseña', 'error');
                return;
            }
            
            const btn = this;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading"></span> Iniciando sesión...';
            btn.disabled = true;
            
            try {
                console.log('Intentando iniciar sesión con:', email);
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                console.log('Login exitoso:', userCredential.user.email);
                
                // Mostrar éxito
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('login-success').style.display = 'block';
                document.getElementById('user-info').textContent = `Usuario: ${userCredential.user.email}`;
                
            } catch (error) {
                console.error('Error de login:', error);
                let mensaje = 'Error de autenticación';
                
                switch(error.code) {
                    case 'auth/user-not-found':
                        mensaje = 'Usuario no encontrado';
                        break;
                    case 'auth/wrong-password':
                        mensaje = 'Contraseña incorrecta';
                        break;
                    case 'auth/invalid-email':
                        mensaje = 'Email inválido';
                        break;
                    case 'auth/too-many-requests':
                        mensaje = 'Demasiados intentos. Intente más tarde';
                        break;
                    case 'auth/network-request-failed':
                        mensaje = 'Error de red. Verifique su conexión';
                        break;
                    default:
                        mensaje = `Error: ${error.code}`;
                }
                
                mostrarNotificacion(mensaje, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });
        
        document.getElementById('btn-login-cancel')?.addEventListener('click', function() {
            ocultarLogin();
            mostrarNotificacion('Se requiere autenticación para usar todas las funciones', 'warning');
        });
        
        document.getElementById('btn-continue')?.addEventListener('click', function() {
            ocultarLogin();
        });
        
        document.getElementById('btn-logout')?.addEventListener('click', function() {
            if (confirm('¿Está seguro de cerrar sesión?')) {
                auth.signOut().then(() => {
                    mostrarNotificacion('Sesión cerrada', 'info');
                }).catch((error) => {
                    console.error('Error cerrando sesión:', error);
                    mostrarNotificacion('Error al cerrar sesión', 'error');
                });
            }
        });

        // ========== CONFIGURACIÓN DEL HISTORIAL FIREBASE ==========
        function configurarHistorial() {
            // Botón guardar en Firebase
            document.getElementById('btn-guardar-firebase')?.addEventListener('click', guardarEnFirebase);
            
            // Botón exportar CSV
            document.getElementById('btn-exportar-csv')?.addEventListener('click', exportarHistorialCSV);
            
            // Botones de paginación
            document.getElementById('btn-prev')?.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    cargarHistorialFirebase('prev');
                }
            });
            
            document.getElementById('btn-next')?.addEventListener('click', () => {
                currentPage++;
                cargarHistorialFirebase('next');
            });
            
            // Filtros
            document.getElementById('btn-aplicar-filtros')?.addEventListener('click', aplicarFiltros);
            document.getElementById('btn-limpiar-filtros')?.addEventListener('click', limpiarFiltros);
        }
        
        // ========== CARGAR HISTORIAL DESDE FIREBASE ==========
        async function cargarHistorialFirebase(direction = 'first') {
            if (!currentUser) {
                mostrarNotificacion('Debe iniciar sesión para ver el historial', 'error');
                mostrarLogin();
                return;
            }
            
            try {
                mostrarCargandoHistorial(true);
                
                let query = db.collection('evaluaciones')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('fechaEvaluacion', 'desc')
                    .limit(itemsPerPage);
                
                // Manejar paginación
                if (direction === 'next' && lastVisible) {
                    query = query.startAfter(lastVisible);
                } else if (direction === 'prev' && firstVisible) {
                    query = query.endBefore(firstVisible).limitToLast(itemsPerPage);
                }
                
                const snapshot = await query.get();
                
                if (snapshot.empty) {
                    mostrarHistorialVacio();
                    actualizarEstadisticas(0);
                    return;
                }
                
                // Procesar documentos
                historialFirebase = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    historialFirebase.push({
                        id: doc.id,
                        ...data
                    });
                });
                
                // Actualizar marcadores de paginación
                lastVisible = snapshot.docs[snapshot.docs.length - 1];
                firstVisible = snapshot.docs[0];
                
                // Actualizar UI
                actualizarVistaHistorial();
                actualizarEstadisticas(snapshot.size);
                actualizarPaginacion();
                
            } catch (error) {
                console.error('Error cargando historial Firebase:', error);
                mostrarErrorHistorial(error.message);
            } finally {
                mostrarCargandoHistorial(false);
            }
        }
        
        function mostrarCargandoHistorial(mostrar) {
            const container = document.getElementById('historial-container');
            if (mostrar) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-spinner fa-spin fa-2x" style="margin-bottom: 20px;"></i>
                        <p>Cargando historial desde Firebase...</p>
                    </div>
                `;
            }
        }
        
        function mostrarHistorialVacio() {
            const container = document.getElementById('historial-container');
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #666;">
                    <i class="fas fa-inbox fa-2x" style="margin-bottom: 20px; opacity: 0.5;"></i>
                    <h4>No hay evaluaciones registradas</h4>
                    <p>Realice su primera evaluación para verla aquí</p>
                </div>
            `;
            document.getElementById('pagination-container').style.display = 'none';
        }
        
        function mostrarErrorHistorial(mensaje) {
            const container = document.getElementById('historial-container');
            container.innerHTML = `
                <div class="warning-box" style="text-align: center; padding: 30px;">
                    <i class="fas fa-exclamation-triangle fa-2x" style="color: var(--warning-color); margin-bottom: 20px;"></i>
                    <h4>Error cargando historial</h4>
                    <p>${mensaje || 'Error desconocido'}</p>
                    <button class="btn btn-primary" onclick="cargarHistorialFirebase()" style="margin-top: 15px;">
                        <i class="fas fa-redo"></i> Reintentar
                    </button>
                </div>
            `;
        }
        
        function actualizarVistaHistorial() {
            const container = document.getElementById('historial-container');
            
            if (!historialFirebase || historialFirebase.length === 0) {
                mostrarHistorialVacio();
                return;
            }
            
            let historialHTML = '';
            
            historialFirebase.forEach((evaluacion) => {
                // Validar y obtener datos de forma segura
                const paciente = evaluacion.paciente || {};
                const fechaEvaluacion = evaluacion.fechaEvaluacion || paciente.fecha || 'Sin fecha';
                const nombre = paciente.nombre || 'Sin nombre';
                const evaluador = paciente.evaluador || 'Sin evaluador';
                const puntajeIRAT = evaluacion.irat5?.puntaje || 0;
                const riesgoIRAT = evaluacion.irat5?.riesgo || 'No calculado';
                
                // Formatear fecha
                let fechaFormateada = 'Sin fecha';
                try {
                    if (fechaEvaluacion) {
                        const fecha = new Date(fechaEvaluacion);
                        fechaFormateada = fecha.toLocaleDateString('es-ES');
                    }
                } catch (e) {
                    fechaFormateada = fechaEvaluacion;
                }
                
                historialHTML += `
                    <div class="historial-item">
                        <h4>${nombre}</h4>
                        <p><strong>Fecha:</strong> ${fechaFormateada}</p>
                        <p><strong>Evaluador:</strong> ${evaluador}</p>
                        <p><strong>IRAT-5:</strong> ${puntajeIRAT} puntos - ${riesgoIRAT}</p>
                        <div class="firebase-actions">
                            <button class="btn btn-primary" onclick="verDetalleEvaluacion('${evaluacion.id}')">
                                <i class="fas fa-eye"></i> Ver detalle
                            </button>
                            <button class="btn btn-warning" onclick="cargarEvaluacionFirebase('${evaluacion.id}')">
                                <i class="fas fa-edit"></i> Cargar
                            </button>
                            <button class="btn btn-danger" onclick="eliminarEvaluacionFirebase('${evaluacion.id}', '${nombre.replace(/'/g, "\\'")}')">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = historialHTML;
        }
        
        async function verDetalleEvaluacion(id) {
            try {
                const doc = await db.collection('evaluaciones').doc(id).get();
                
                if (!doc.exists) {
                    mostrarNotificacion('Evaluación no encontrada', 'error');
                    return;
                }
                
                const evaluacion = { id: doc.id, ...doc.data() };
                
                // Validar que la evaluación pertenece al usuario actual
                if (evaluacion.userId !== currentUser.uid) {
                    mostrarNotificacion('No tiene permiso para ver esta evaluación', 'error');
                    return;
                }
                
                // Mostrar en modal
                mostrarModalDetalle(evaluacion);
                
            } catch (error) {
                console.error('Error cargando evaluación:', error);
                mostrarNotificacion('Error: ' + error.message, 'error');
            }
        }
        
        function mostrarModalDetalle(evaluacion) {
            const modal = document.getElementById('detail-modal');
            const modalBody = document.getElementById('modal-body');
            
            const paciente = evaluacion.paciente || {};
            const irat5 = evaluacion.irat5 || {};
            const tinetti = evaluacion.tinetti || {};
            const norton = evaluacion.norton || {};
            const resultados = evaluacion.resultados || {};
            
            let fechaFormateada = 'Sin fecha';
            try {
                if (evaluacion.fechaEvaluacion) {
                    const fecha = new Date(evaluacion.fechaEvaluacion);
                    fechaFormateada = fecha.toLocaleDateString('es-ES');
                }
            } catch (e) {
                fechaFormateada = evaluacion.fechaEvaluacion;
            }
            
            modalBody.innerHTML = `
                <div class="informe-profesional" style="margin: 0; box-shadow: none;">
                    <div class="cabecera-informe" style="padding: 0 0 20px 0;">
                        <div class="logo-informe">
                            <i class="fas fa-file-medical-alt"></i>
                        </div>
                        <h2 class="titulo-informe">Detalle de Evaluación</h2>
                        <p class="subtitulo-informe">ID: ${evaluacion.id.substring(0, 8)}...</p>
                    </div>
                    
                    <div class="seccion-informe">
                        <h3><i class="fas fa-user"></i> Datos del Paciente</h3>
                        <div class="resultados-detallados">
                            <div class="resultado-item">
                                <span class="resultado-label">Nombre:</span>
                                <span class="resultado-valor">${paciente.nombre || "Sin nombre"}</span>
                            </div>
                            <div class="resultado-item">
                                <span class="resultado-label">RUT:</span>
                                <span class="resultado-valor">${paciente.rut || "No especificado"}</span>
                            </div>
                            <div class="resultado-item">
                                <span class="resultado-label">Edad:</span>
                                <span class="resultado-valor">${paciente.edad || "No especificado"}</span>
                            </div>
                            <div class="resultado-item">
                                <span class="resultado-label">Fecha evaluación:</span>
                                <span class="resultado-valor">${fechaFormateada}</span>
                            </div>
                            <div class="resultado-item">
                                <span class="resultado-label">Evaluador:</span>
                                <span class="resultado-valor">${paciente.evaluador || "Sin evaluador"}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="seccion-informe">
                        <h3><i class="fas fa-chart-bar"></i> Resultados</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                            <div class="score-display" style="margin: 0; padding: 15px;">
                                <div>IRAT-5</div>
                                <div class="score-value" style="font-size: 2.5rem;">${irat5.puntaje || 0}</div>
                                <div>${irat5.riesgo || "Sin riesgo"}</div>
                            </div>
                            
                            <div class="score-display" style="margin: 0; padding: 15px;">
                                <div>Tinetti</div>
                                <div class="score-value" style="font-size: 2.5rem;">${tinetti.evaluable === false ? 'NE' : tinetti.puntaje || 0}${tinetti.evaluable === false ? '' : '/28'}</div>
                                <div>${tinetti.riesgo || "Sin riesgo"}</div>
                            </div>
                            
                            <div class="score-display" style="margin: 0; padding: 15px;">
                                <div>Norton</div>
                                <div class="score-value" style="font-size: 2.5rem;">${norton.puntaje || 0}</div>
                                <div>${norton.riesgo || "Sin riesgo"}</div>
                            </div>
                        </div>
                    </div>
                    
                    ${resultados.recomendaciones && resultados.recomendaciones.length > 0 ? `
                        <div class="seccion-informe">
                            <h3><i class="fas fa-clipboard-check"></i> Recomendaciones</h3>
                            <div class="recommendations-grid">
                                ${resultados.recomendaciones.map((rec, index) => `
                                    <div class="recommendation-card">
                                        <div style="font-weight: 600; color: var(--primary-color);">
                                            <i class="fas fa-check-circle"></i> Recomendación ${index + 1}
                                        </div>
                                        <p style="margin-top: 8px;">${rec}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="firma-informe" style="margin-top: 20px;">
                        <p><strong>Guardado el:</strong> ${evaluacion.fechaGuardado ? new Date(evaluacion.fechaGuardado.toDate()).toLocaleString('es-ES') : 'No disponible'}</p>
                        <p style="margin-top: 15px; text-align: right;">
                            <strong>ID de evaluación:</strong> ${evaluacion.id}
                        </p>
                    </div>
                </div>
            `;
            
            modal.style.display = 'flex';
        }
        
        // Cerrar modal
        document.getElementById('close-modal')?.addEventListener('click', () => {
            document.getElementById('detail-modal').style.display = 'none';
        });
        
        // Cerrar modal al hacer clic fuera
        document.getElementById('detail-modal')?.addEventListener('click', (e) => {
            if (e.target.id === 'detail-modal') {
                document.getElementById('detail-modal').style.display = 'none';
            }
        });
        
        function actualizarEstadisticas(total) {
            const statsElement = document.getElementById('total-evaluaciones');
            const pendientes = evaluacionesPendientes.length;
            
            let html = `<i class="fas fa-chart-bar"></i> Mostrando ${total} evaluación(es)`;
            
            if (pendientes > 0) {
                html += ` | <i class="fas fa-clock"></i> ${pendientes} pendiente(s)`;
            }
            
            statsElement.innerHTML = html;
        }
        
        function actualizarPaginacion() {
            const prevBtn = document.getElementById('btn-prev');
            const nextBtn = document.getElementById('btn-next');
            const pageInfo = document.getElementById('page-info');
            
            if (prevBtn) prevBtn.disabled = currentPage === 1;
            if (pageInfo) pageInfo.textContent = `Página ${currentPage}`;
            
            // Mostrar/ocultar paginación
            const paginationContainer = document.getElementById('pagination-container');
            if (paginationContainer) paginationContainer.style.display = historialFirebase.length > 0 ? 'block' : 'none';
            
            // Habilitar/deshabilitar siguiente botón
            if (nextBtn) nextBtn.disabled = historialFirebase.length < itemsPerPage;
        }
        
        // ========== OPERACIONES CRUD FIREBASE ==========
        async function guardarEnFirebase() {
            if (!datosCompletos) {
                mostrarNotificacion('Primero calcule los resultados', 'error');
                return;
            }
            
            const btn = document.getElementById('btn-guardar-firebase');
            if (!btn) return;

            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading"></span> Guardando...';
            btn.disabled = true;
            
            try {
                // Preparar datos para Firebase
                const datosFirebase = {
                    ...datosCompletos,
                    fechaEvaluacion: datosCompletos.paciente.fecha || new Date().toISOString()
                };
                
                // Validar datos requeridos
                if (!datosFirebase.paciente || !datosFirebase.paciente.nombre) {
                    throw new Error('Datos incompletos para guardar');
                }
                
                // Guardar en Firestore si hay conexión y usuario autenticado
                if (currentUser && navigator.onLine) {
                    datosFirebase.userId = currentUser.uid;
                    datosFirebase.userEmail = currentUser.email;
                    datosFirebase.fechaGuardado = firebase.firestore.FieldValue.serverTimestamp();
                    
                    const docRef = await db.collection('evaluaciones').add(datosFirebase);
                    
                    mostrarNotificacion(`Evaluación guardada correctamente (ID: ${docRef.id.substring(0, 8)}...)`, 'success');
                    
                    // Recargar historial si estamos en esa sección
                    if (document.getElementById('historial')?.classList.contains('active')) {
                        cargarHistorialFirebase();
                    }
                } else {
                    // Guardar localmente para sincronizar después
                    guardarLocalmente(datosFirebase);
                }
                
            } catch (error) {
                console.error('Error guardando en Firebase:', error);
                mostrarNotificacion('Error al guardar: ' + error.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        async function cargarEvaluacionFirebase(id) {
            try {
                const doc = await db.collection('evaluaciones').doc(id).get();
                
                if (!doc.exists) {
                    mostrarNotificacion('Evaluación no encontrada', 'error');
                    return;
                }
                
                const evaluacion = doc.data();
                
                // Validar propiedad
                if (evaluacion.userId !== currentUser.uid) {
                    mostrarNotificacion('No tiene permiso para cargar esta evaluación', 'error');
                    return;
                }
                
                // Cargar datos del paciente en el formulario
                if (evaluacion.paciente) {
                    document.getElementById('nombre').value = evaluacion.paciente.nombre || '';
                    document.getElementById('rut').value = evaluacion.paciente.rut || '';
                    document.getElementById('edad').value = evaluacion.paciente.edad || '';
                    document.getElementById('fecha').value = evaluacion.paciente.fecha || '';
                    document.getElementById('sexo').value = evaluacion.paciente.sexo || '';
                    document.getElementById('evaluador').value = evaluacion.paciente.evaluador || '';
                    document.getElementById('institucion').value = evaluacion.paciente.institucion || '';
                    document.getElementById('historia-clinica').value = evaluacion.paciente.historiaClinica || '';
                }
                
                mostrarNotificacion(`Datos de ${evaluacion.paciente?.nombre || 'paciente'} cargados para edición`, 'info');
                cambiarSeccion('identificacion');
                
            } catch (error) {
                console.error('Error cargando evaluación:', error);
                mostrarNotificacion('Error al cargar: ' + error.message, 'error');
            }
        }
        
        async function eliminarEvaluacionFirebase(id, nombre) {
            if (!confirm(`¿Está seguro de eliminar la evaluación de "${nombre}"?\nEsta acción no se puede deshacer.`)) {
                return;
            }
            
            try {
                // Verificar que existe y pertenece al usuario
                const doc = await db.collection('evaluaciones').doc(id).get();
                if (!doc.exists) {
                    mostrarNotificacion('La evaluación ya no existe', 'error');
                    return;
                }
                
                if (doc.data().userId !== currentUser.uid) {
                    mostrarNotificacion('No tiene permiso para eliminar esta evaluación', 'error');
                    return;
                }
                
                await db.collection('evaluaciones').doc(id).delete();
                
                mostrarNotificacion('Evaluación eliminada correctamente', 'success');
                
                // Recargar historial
                cargarHistorialFirebase();
                
            } catch (error) {
                console.error('Error eliminando evaluación:', error);
                mostrarNotificacion('Error al eliminar: ' + error.message, 'error');
            }
        }
        
        // ========== EXPORTAR CSV ==========
        async function exportarHistorialCSV() {
            if (!currentUser) {
                mostrarNotificacion('Debe iniciar sesión para exportar', 'error');
                mostrarLogin();
                return;
            }
            
            try {
                mostrarNotificacion('Preparando exportación...', 'info');
                
                // Obtener todas las evaluaciones del usuario
                const snapshot = await db.collection('evaluaciones')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('fechaEvaluacion', 'desc')
                    .get();
                
                if (snapshot.empty) {
                    mostrarNotificacion('No hay evaluaciones para exportar', 'warning');
                    return;
                }
                
                // Crear CSV
                const headers = [
                    'ID',
                    'Nombre Paciente',
                    'RUT',
                    'Edad',
                    'Fecha Evaluación',
                    'Evaluador',
                    'Puntaje IRAT-5',
                    'Riesgo IRAT-5',
                    'Puntaje Tinetti',
                    'Riesgo Tinetti',
                    'Puntaje Norton',
                    'Riesgo Norton',
                    'Fecha Guardado'
                ];
                
                let csvContent = headers.join(';') + '\n';
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const paciente = data.paciente || {};
                    const irat5 = data.irat5 || {};
                    const tinetti = data.tinetti || {};
                    const norton = data.norton || {};
                    
                    const row = [
                        doc.id.substring(0, 8) + '...',
                        `"${paciente.nombre || ''}"`,
                        `"${paciente.rut || ''}"`,
                        paciente.edad || '',
                        data.fechaEvaluacion || '',
                        `"${paciente.evaluador || ''}"`,
                        irat5.puntaje || 0,
                        `"${irat5.riesgo || ''}"`,
                        tinetti.evaluable === false ? 'NE' : (tinetti.puntaje || 0),
                        `"${tinetti.riesgo || ''}"`,
                        norton.puntaje || 0,
                        `"${norton.riesgo || ''}"`,
                        data.fechaGuardado ? new Date(data.fechaGuardado.toDate()).toLocaleString('es-ES') : ''
                    ];
                    
                    csvContent += row.join(';') + '\n';
                });
                
                // Crear y descargar archivo
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `evaluaciones_irat_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                mostrarNotificacion(`Exportadas ${snapshot.size} evaluaciones en CSV`, 'success');
                
            } catch (error) {
                console.error('Error exportando CSV:', error);
                mostrarNotificacion('Error al exportar: ' + error.message, 'error');
            }
        }
        
        // ========== FILTROS ==========
        async function aplicarFiltros() {
            try {
                const nombre = document.getElementById('filter-nombre').value.trim();
                const fechaDesde = document.getElementById('filter-fecha-desde').value;
                const fechaHasta = document.getElementById('filter-fecha-hasta').value;
                
                // Construir query base
                let query = db.collection('evaluaciones')
                    .where('userId', '==', currentUser.uid);
                
                // Aplicar filtro por nombre (búsqueda parcial)
                if (nombre) {
                    // Para búsqueda por nombre (case insensitive)
                    query = query.where('paciente.nombre', '>=', nombre)
                                 .where('paciente.nombre', '<=', nombre + '\uf8ff');
                }
                
                // Aplicar filtros por fecha
                if (fechaDesde) {
                    query = query.where('fechaEvaluacion', '>=', fechaDesde);
                }
                
                if (fechaHasta) {
                    // Añadir un día para incluir la fecha hasta
                    const fechaHastaObj = new Date(fechaHasta);
                    fechaHastaObj.setDate(fechaHastaObj.getDate() + 1);
                    query = query.where('fechaEvaluacion', '<', fechaHastaObj.toISOString());
                }
                
                // Ordenar y limitar
                query = query.orderBy('fechaEvaluacion', 'desc').limit(itemsPerPage);
                
                const snapshot = await query.get();
                
                if (snapshot.empty) {
                    mostrarNotificacion('No se encontraron evaluaciones con los filtros aplicados', 'info');
                    mostrarHistorialVacio();
                    return;
                }
                
                // Procesar resultados
                historialFirebase = [];
                snapshot.forEach(doc => {
                    historialFirebase.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Actualizar UI
                actualizarVistaHistorial();
                mostrarNotificacion(`Encontradas ${historialFirebase.length} evaluación(es)`, 'success');
                
                // Reiniciar paginación
                currentPage = 1;
                lastVisible = snapshot.docs[snapshot.docs.length - 1];
                firstVisible = snapshot.docs[0];
                actualizarPaginacion();
                
            } catch (error) {
                console.error('Error aplicando filtros:', error);
                mostrarNotificacion('Error en filtros: ' + error.message, 'error');
            }
        }
        
        function limpiarFiltros() {
            document.getElementById('filter-nombre').value = '';
            document.getElementById('filter-fecha-desde').value = '';
            document.getElementById('filter-fecha-hasta').value = '';
            
            currentPage = 1;
            cargarHistorialFirebase();
            mostrarNotificacion('Filtros limpiados', 'info');
        }
        
        // ========== FUNCIONES AUXILIARES ==========
        function obtenerValorSeguro(obj, path, defaultValue) {
            try {
                if (!obj) return defaultValue;
                
                const keys = path.split('.');
                let result = obj;
                
                for (const key of keys) {
                    if (result === null || result === undefined) {
                        return defaultValue;
                    }
                    result = result[key];
                }
                
                return result !== undefined ? result : defaultValue;
            } catch (error) {
                return defaultValue;
            }
        }
        
        function actualizarEstadoFirebase(mensaje, clase) {
            const statusElement = document.getElementById('firebase-status');
            if (statusElement) {
                statusElement.textContent = mensaje;
                statusElement.className = `firebase-status ${clase}`;
            }
        }
        
        function mostrarNotificacion(mensaje, tipo) {
            const notificacion = document.getElementById('notification');
            if (!notificacion) return;
            
            notificacion.textContent = mensaje;
            notificacion.className = `notification ${tipo}`;
            notificacion.style.display = 'block';
            
            setTimeout(() => {
                notificacion.style.display = 'none';
            }, 4000);
        }
        
        // ========== FUNCIONES DEL FORMULARIO ==========
        function inicializarNavegacion() {
            console.log('Configurando navegación...');
            
            // Navegación por pestañas
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    console.log('Click en pestaña:', this.getAttribute('data-section'));
                    const sectionId = this.getAttribute('data-section');
                    
                    // Si es historial y no está autenticado, mostrar login
                    if (sectionId === 'historial' && !currentUser) {
                        mostrarLogin();
                        mostrarNotificacion('Debe iniciar sesión para ver el historial', 'warning');
                        return;
                    }
                    
                    cambiarSeccion(sectionId);
                    
                    // Cargar historial si es la sección correspondiente
                    if (sectionId === 'historial' && currentUser) {
                        cargarHistorialFirebase();
                    }
                });
            });
            
            // Función auxiliar para configurar botones (Asegura que el botón existe y depura)
            const configurarBoton = (id, callback) => {
                const boton = document.getElementById(id);
                if (boton) {
                    boton.addEventListener('click', callback);
                    console.log(`Botón ${id} configurado.`);
                } else {
                    console.warn(`No se encontró el botón con ID: ${id}. ¡Verifique su HTML!`);
                }
            };
            
            // Botones de navegación del formulario (CORREGIDOS/REFORZADOS)
            configurarBoton('siguiente-irat', () => {
                console.log('Click en siguiente IRAT');
                if (validarSeccionIdentificacion()) cambiarSeccion('evaluacion');
            });
            configurarBoton('volver-identificacion', () => {
                console.log('Click en volver identificación');
                cambiarSeccion('identificacion');
            });
            configurarBoton('siguiente-tinetti', () => {
                console.log('Click en siguiente Tinetti');
                if (validarSeccionIRAT5()) cambiarSeccion('tinetti');
            });
            configurarBoton('volver-irat', () => {
                console.log('Click en volver IRAT');
                cambiarSeccion('evaluacion');
            });
            configurarBoton('siguiente-norton', () => {
                console.log('Click en siguiente Norton');
                if (validarSeccionTinetti()) cambiarSeccion('norton');
            });
            configurarBoton('volver-tinetti', () => {
                console.log('Click en volver Tinetti');
                cambiarSeccion('tinetti');
            });
            configurarBoton('calcular-resultados', calcularResultadosCompletos);
            configurarBoton('volver-norton', () => {
                console.log('Click en volver Norton');
                cambiarSeccion('norton');
            });
            configurarBoton('ir-compartir', () => {
                console.log('Click en ir a compartir');
                if (datosCompletos) cambiarSeccion('compartir');
                else mostrarNotificacion('Primero calcule los resultados', 'error');
            });
            configurarBoton('volver-resultados-historial', () => {
                console.log('Click en volver resultados (o Historial si es el caso)');
                cambiarSeccion('resultados');
            });
            configurarBoton('volver-compartir', () => {
                console.log('Click en volver compartir');
                cambiarSeccion('resultados');
            });
            configurarBoton('nueva-evaluacion', iniciarNuevaEvaluacion);
        }
        
        function cambiarSeccion(sectionId) {
            console.log('Cambiando a sección:', sectionId);
            
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            const seccion = document.getElementById(sectionId);
            if (seccion) {
                seccion.classList.add('active');
                console.log('Sección activada:', sectionId);
            }
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-section') === sectionId) {
                    tab.classList.add('active');
                }
            });
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function configurarValidaciones() {
            const camposRequeridos = document.querySelectorAll('[required]');
            camposRequeridos.forEach(campo => {
                campo.addEventListener('blur', function() {
                    if (!this.value.trim()) {
                        this.classList.add('error-input');
                        mostrarErrorCampo(this.id, 'Este campo es requerido');
                    } else {
                        this.classList.remove('error-input');
                        eliminarErrorCampo(this.id);
                    }
                });
            });
        }
        
        function mostrarErrorCampo(idCampo, mensaje) {
            const errorDiv = document.getElementById(`error-${idCampo}`);
            if (errorDiv) {
                errorDiv.textContent = mensaje;
                errorDiv.style.display = 'block';
            }
        }
        
        function eliminarErrorCampo(idCampo) {
            const errorDiv = document.getElementById(`error-${idCampo}`);
            if (errorDiv) errorDiv.style.display = 'none';
        }
        
        function validarSeccionIdentificacion() {
            let valido = true;
            ['nombre', 'fecha', 'evaluador'].forEach(campo => {
                const elemento = document.getElementById(campo);
                if (!elemento || !elemento.value.trim()) {
                    if (elemento) {
                         elemento.classList.add('error-input');
                         mostrarErrorCampo(campo, 'Este campo es requerido');
                    }
                    valido = false;
                } else {
                    elemento.classList.remove('error-input');
                    eliminarErrorCampo(campo);
                }
            });
            if (!valido) mostrarNotificacion('Complete todos los campos requeridos', 'error');
            return valido;
        }
        
        function validarSeccionIRAT5() {
            let valido = true;
            ['equilibrio', 'amputacion', 'brazos', 'social', 'cooperacion'].forEach(id => {
                const select = document.getElementById(id);
                if (!select || !select.value) {
                    if (select) {
                        select.classList.add('error-input');
                        mostrarErrorCampo(id, 'Seleccione una opción');
                    }
                    valido = false;
                } else {
                    select.classList.remove('error-input');
                    eliminarErrorCampo(id);
                }
            });
            if (!valido) mostrarNotificacion('Complete todas las preguntas IRAT-5', 'error');
            return valido;
        }
        
        function validarSeccionTinetti() {
            if (tinettiNoEvaluable) return true;
            
            let completo = true;
            for (let i = 1; i <= 16; i++) {
                const grupo = i <= 8 ? `balance${i}` : `gait${i}`;
                if (!respuestasTinetti[grupo]) {
                    completo = false;
                    break;
                }
            }

            if (!completo) {
                mostrarNotificacion('Complete todas las preguntas del Test de Tinetti', 'error');
                return false;
            }
            return true;
        }
        
        function configurarTinetti() {
            console.log('Configurando Tinetti...');
            document.getElementById('opcion-no-evaluable')?.addEventListener('click', function() {
                console.log('Click en no evaluable');
                tinettiNoEvaluable = true;
                const testCompleto = document.getElementById('test-tinetti-completo');
                if (testCompleto) testCompleto.style.display = 'none';
                document.querySelectorAll('.tinetti-option[data-grupo]').forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                mostrarResultadoTinetti();
            });
            
            document.querySelectorAll('.tinetti-option[data-grupo]').forEach(option => {
                option.addEventListener('click', function() {
                    console.log('Click en opción Tinetti');
                    tinettiNoEvaluable = false;
                    const testCompleto = document.getElementById('test-tinetti-completo');
                    if (testCompleto) testCompleto.style.display = 'block';
                    document.getElementById('opcion-no-evaluable')?.classList.remove('selected');
                    
                    const grupo = this.getAttribute('data-grupo');
                    document.querySelectorAll(`.tinetti-option[data-grupo="${grupo}"]`).forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    
                    respuestasTinetti[grupo] = {
                        numero: parseInt(grupo.replace(/[a-z]/g, '')),
                        pregunta: obtenerTextoPreguntaTinetti(grupo),
                        respuesta: this.querySelector('strong')?.textContent || this.textContent,
                        puntos: parseInt(this.getAttribute('data-puntaje'))
                    };
                    
                    calcularPuntajeTinetti();
                });
            });
        }
        
        function calcularPuntajeTinetti() {
            if (tinettiNoEvaluable) {
                puntajeTinetti = 0;
                mostrarResultadoTinetti();
                return;
            }
            
            puntajeTinetti = 0;
            for (let i = 1; i <= 16; i++) {
                const grupo = i <= 8 ? `balance${i}` : `gait${i}`;
                if (respuestasTinetti[grupo]) {
                    puntajeTinetti += respuestasTinetti[grupo].puntos || 0;
                }
            }
            mostrarResultadoTinetti();
        }
        
        function mostrarResultadoTinetti() {
            const resultadoDiv = document.getElementById('resultado-tinetti');
            if (!resultadoDiv) return;
            
            const puntajeSpan = document.getElementById('puntaje-tinetti-total');
            const interpretacionSpan = document.getElementById('interpretacion-tinetti');
            const puntosIRATSpan = document.getElementById('puntos-irat-tinetti');
            
            if (!puntajeSpan || !interpretacionSpan || !puntosIRATSpan) return;

            if (tinettiNoEvaluable) {
                resultadoDiv.style.display = 'block';
                puntajeSpan.textContent = 'No evaluable';
                interpretacionSpan.innerHTML = '<strong>Máximo riesgo de caídas</strong>';
                puntosIRATSpan.innerHTML = '<strong>4 puntos IRAT-5 (máximo)</strong>';
                return;
            }
            
            // Verificar que todas las preguntas estén respondidas
            let todasRespondidas = true;
            for (let i = 1; i <= 16; i++) {
                const grupo = i <= 8 ? `balance${i}` : `gait${i}`;
                if (!respuestasTinetti[grupo]) {
                    todasRespondidas = false;
                    break;
                }
            }
            
            if (todasRespondidas) {
                resultadoDiv.style.display = 'block';
                puntajeSpan.textContent = puntajeTinetti;
                
                let interpretacion = '';
                let puntosIRAT = 0;
                
                if (puntajeTinetti >= 25) {
                    interpretacion = '<strong>Bajo riesgo de caídas</strong>';
                    puntosIRAT = 0;
                } else if (puntajeTinetti >= 19) {
                    interpretacion = '<strong>Riesgo moderado de caídas</strong>';
                    puntosIRAT = 2;
                } else {
                    interpretacion = '<strong>Alto riesgo de caídas</strong>';
                    puntosIRAT = 4;
                }
                
                interpretacionSpan.innerHTML = interpretacion;
                puntosIRATSpan.innerHTML = `<strong>${puntosIRAT} puntos IRAT-5</strong>`;
            } else {
                resultadoDiv.style.display = 'none';
            }
        }
        
        function obtenerTextoPreguntaTinetti(grupo) {
            const preguntas = {
                'balance1': '1. Sentado sin apoyo',
                'balance2': '2. Levantarse',
                'balance3': '3. Intentos de levantarse',
                'balance4': '4. Equilibrio inmediato al levantarse',
                'balance5': '5. Equilibrio de pie',
                'balance6': '6. Equilibrio con ojos cerrados',
                'balance7': '7. Girar 360 grados',
                'balance8': '8. Sentarse',
                'gait9': '9. Inicio de la marcha',
                'gait10': '10. Longitud y altura del paso (pie derecho)',
                'gait11': '11. Longitud y altura del paso (pie izquierdo)',
                'gait12': '12. Simetría del paso',
                'gait13': '13. Continuidad del paso',
                'gait14': '14. Desviación de la marcha',
                'gait15': '15. Tronco',
                'gait16': '16. Base de sustentación'
            };
            return preguntas[grupo] || grupo;
        }
        
        function configurarIRAT5() {
            console.log('Configurando IRAT-5...');
            ['equilibrio', 'amputacion', 'brazos', 'social', 'cooperacion'].forEach(id => {
                document.getElementById(id)?.addEventListener('change', function() {
                    console.log('Cambio en', id, 'valor:', this.value);
                    calcularPuntajeIRATPreliminar();
                    respuestasIRAT[id] = {
                        pregunta: obtenerNombrePreguntaIRAT(id),
                        respuesta: this.options[this.selectedIndex].text,
                        puntos: parseInt(this.value) || 0
                    };
                });
            });
            calcularPuntajeIRATPreliminar();
        }
        
        function calcularPuntajeIRATPreliminar() {
            let puntaje = 0;
            ['equilibrio', 'amputacion', 'brazos', 'social', 'cooperacion'].forEach(id => {
                const select = document.getElementById(id);
                if (select) puntaje += parseInt(select.value) || 0;
            });
            
            const amputacionSelect = document.getElementById('amputacion');
            if (amputacionSelect && parseInt(amputacionSelect.value) >= 3) puntaje += 1;
            
            const puntajeElement = document.getElementById('puntaje-irat');
            if (puntajeElement) puntajeElement.textContent = puntaje;
        }
        
        function obtenerNombrePreguntaIRAT(id) {
            const nombres = {
                'equilibrio': '1. Equilibrio Unipodal',
                'amputacion': '2. Tipo de Amputación',
                'brazos': '3. Función de Brazos',
                'social': '4. Situación Social',
                'cooperacion': '5. Nivel de Cooperación'
            };
            return nombres[id] || id;
        }
        
        function calcularNorton() {
            puntajeNorton = 0;
            ['norton-fisico', 'norton-mental', 'norton-actividad', 'norton-movilidad', 'norton-incontinencia'].forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    const valor = parseInt(select.value) || 0;
                    puntajeNorton += valor;
                    
                    respuestasNorton[id] = {
                        pregunta: obtenerNombrePreguntaNorton(id),
                        respuesta: select.options[select.selectedIndex].text,
                        puntos: valor
                    };
                }
            });
            const puntajeElement = document.getElementById('puntaje-norton');
            if (puntajeElement) puntajeElement.textContent = puntajeNorton;
        }
        
        function obtenerNombrePreguntaNorton(id) {
            const nombres = {
                'norton-fisico': 'Estado Físico',
                'norton-mental': 'Estado Mental',
                'norton-actividad': 'Actividad',
                'norton-movilidad': 'Movilidad',
                'norton-incontinencia': 'Incontinencia'
            };
            return nombres[id] || id;
        }
        
        function calcularResultadosCompletos() {
            try {
                console.log('Calculando resultados completos...');
                // Validaciones
                if (!validarSeccionIRAT5() || !validarSeccionTinetti()) return;
                
                // Calcular puntajes IRAT-5
                let puntajeIRAT = 0;
                ['equilibrio', 'amputacion', 'brazos', 'social', 'cooperacion'].forEach(id => {
                    const select = document.getElementById(id);
                    if (select) puntajeIRAT += parseInt(select.value) || 0;
                });
                
                const amputacionSelect = document.getElementById('amputacion');
                if (amputacionSelect && parseInt(amputacionSelect.value) >= 3) puntajeIRAT += 1;
                
                // Puntos Tinetti para IRAT-5
                let puntosTinettiIRAT = 4;
                if (!tinettiNoEvaluable) {
                    if (puntajeTinetti >= 25) puntosTinettiIRAT = 0;
                    else if (puntajeTinetti >= 19) puntosTinettiIRAT = 2;
                }
                
                puntajeTotalIRAT = puntajeIRAT + puntosTinettiIRAT;
                
                // Niveles de riesgo
                nivelRiesgoIRAT = puntajeTotalIRAT <= 6 ? "BAJO RIESGO" :
                                 puntajeTotalIRAT <= 9 ? "RIESGO MODERADO" :
                                 puntajeTotalIRAT <= 12 ? "ALTO RIESGO" : "MUY ALTO RIESGO";
                
                nivelRiesgoNorton = puntajeNorton >= 16 ? "BAJO RIESGO Úlceras por presión" :
                                   puntajeNorton >= 12 ? "RIESGO MODERADO Úlceras por presión" : 
                                   "ALTO RIESGO Úlceras por presión";
                
                // Recopilar datos completos
                recopilarDatosCompletos();
                
                // Generar recomendaciones
                recomendaciones = generarRecomendaciones();
                if (datosCompletos.resultados) {
                    datosCompletos.resultados.recomendaciones = recomendaciones;
                }
                
                // Mostrar resultados
                mostrarResultados();
                cambiarSeccion('resultados');
                mostrarNotificacion('Resultados calculados exitosamente', 'success');
                
            } catch (error) {
                console.error('Error calculando resultados:', error);
                mostrarNotificacion('Error: ' + error.message, 'error');
            }
        }
        
        function recopilarDatosCompletos() {
            datosCompletos = {
                paciente: {
                    nombre: document.getElementById('nombre')?.value || 'Sin nombre',
                    rut: document.getElementById('rut')?.value || '',
                    edad: document.getElementById('edad')?.value || '',
                    fecha: document.getElementById('fecha')?.value || '',
                    sexo: document.getElementById('sexo')?.value || '',
                    evaluador: document.getElementById('evaluador')?.value || 'Sin evaluador',
                    institucion: document.getElementById('institucion')?.value || '',
                    historiaClinica: document.getElementById('historia-clinica')?.value || ''
                },
                irat5: {
                    respuestas: Object.values(respuestasIRAT).filter(r => r),
                    puntaje: puntajeTotalIRAT,
                    riesgo: nivelRiesgoIRAT,
                    puntosTinetti: tinettiNoEvaluable ? 4 : (puntajeTinetti >= 25 ? 0 : puntajeTinetti >= 19 ? 2 : 4)
                },
                tinetti: {
                    evaluable: !tinettiNoEvaluable,
                    puntaje: puntajeTinetti,
                    riesgo: tinettiNoEvaluable ? 'Máximo riesgo (No evaluable)' : 
                           puntajeTinetti >= 25 ? 'Bajo riesgo caídas' : 
                           puntajeTinetti >= 19 ? 'Riesgo moderado caídas' : 'Alto riesgo caídas',
                    respuestas: tinettiNoEvaluable ? 
                        [{pregunta: 'Test de Tinetti', respuesta: 'NO EVALUABLE', puntos: 0}] : 
                        Object.values(respuestasTinetti).sort((a, b) => (a.numero || 0) - (b.numero || 0))
                },
                norton: {
                    respuestas: Object.values(respuestasNorton).filter(r => r),
                    puntaje: puntajeNorton,
                    riesgo: nivelRiesgoNorton
                },
                resultados: {
                    fechaCalculo: new Date().toLocaleString('es-ES'),
                    proximaEvaluacion: obtenerProximaFechaEvaluacion(),
                    recomendaciones: recomendaciones
                }
            };
            console.log('Datos completos recopilados:', datosCompletos);
        }
        
        function mostrarResultados() {
            try {
                if (!datosCompletos) {
                    throw new Error('No hay datos para mostrar');
                }
                
                const riesgoColorIRAT = nivelRiesgoIRAT.includes("BAJO") ? "risk-low" :
                                       nivelRiesgoIRAT.includes("MODERADO") ? "risk-moderate" :
                                       nivelRiesgoIRAT.includes("ALTO") ? "risk-high" : "risk-very-high";
                
                const riesgoColorNorton = nivelRiesgoNorton.includes("BAJO") ? "risk-low" :
                                         nivelRiesgoNorton.includes("MODERADO") ? "risk-moderate" : "risk-high";
                
                let riesgoTinettiHTML = '';
                if (tinettiNoEvaluable) {
                    riesgoTinettiHTML = '<strong>NO EVALUABLE - MÁXIMO RIESGO</strong>';
                } else {
                    riesgoTinettiHTML = `<strong>${datosCompletos.tinetti.riesgo}</strong> (${datosCompletos.tinetti.puntaje}/28)`;
                }
                
                const html = `
                    <div class="informe-profesional">
                        <div class="cabecera-informe">
                            <div class="logo-informe">
                                <i class="fas fa-hospital-alt"></i>
                            </div>
                            <h2 class="titulo-informe">Informe de Evaluación Clínica</h2>
                            <p class="subtitulo-informe">IRAT-5 Modificado + Test de Tinetti + Escala Norton</p>
                        </div>
                        
                        <div class="seccion-informe">
                            <h3><i class="fas fa-user"></i> Datos del Paciente</h3>
                            <div class="resultados-detallados">
                                ${Object.entries(datosCompletos.paciente).map(([key, value]) => `
                                    <div class="resultado-item">
                                        <span class="resultado-label">${key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}:</span>
                                        <span class="resultado-valor">${value || "No especificado"}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="seccion-informe">
                            <h3><i class="fas fa-chart-bar"></i> Resultados de las Evaluaciones</h3>
                            
                            <div class="score-display">
                                <div>Puntaje Total IRAT-5 Modificado</div>
                                <div class="score-value">${puntajeTotalIRAT}</div>
                                <div>Puntos de corte: 0-6 (Bajo) | 7-9 (Moderado) | 10-12 (Alto) | ≥13 (Muy Alto)</div>
                            </div>
                            
                            <div class="risk-level ${riesgoColorIRAT}">
                                <h3 style="margin-bottom: 10px;">${nivelRiesgoIRAT}</h3>
                                <p>${obtenerDescripcionRiesgoIRAT()}</p>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 25px;">
                                <div>
                                    <div class="score-display" style="margin: 0;">
                                        <div>Test de Tinetti</div>
                                        <div class="score-value">${tinettiNoEvaluable ? 'NE' : puntajeTinetti}${tinettiNoEvaluable ? '' : '/28'}</div>
                                        <div>${riesgoTinettiHTML}</div>
                                    </div>
                                </div>
                                
                                <div>
                                    <div class="score-display" style="margin: 0;">
                                        <div>Escala Norton</div>
                                        <div class="score-value">${puntajeNorton}</div>
                                        <div>${nivelRiesgoNorton}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="seccion-informe">
                            <h3><i class="fas fa-clipboard-check"></i> Detalle de Evaluaciones</h3>
                            
                            <div style="margin: 20px 0;">
                                <h4><i class="fas fa-list"></i> IRAT-5 Modificado - Respuestas Detalladas</h4>
                                <div class="resultados-detallados">
                                    ${datosCompletos.irat5.respuestas.map(resp => `
                                        <div class="resultado-item">
                                            <span class="resultado-label">${resp.pregunta}:</span>
                                            <span class="resultado-valor">${resp.respuesta}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div style="margin: 20px 0;">
                                <h4><i class="fas fa-walking"></i> Test de Tinetti - Respuestas Detalladas</h4>
                                <div class="resultados-detallados">
                                    ${datosCompletos.tinetti.respuestas.map(resp => `
                                        <div class="resultado-item">
                                            <span class="resultado-label">${resp.pregunta}:</span>
                                            <span class="resultado-valor">${resp.respuesta} ${resp.puntos !== undefined ? '(' + resp.puntos + ' puntos)' : ''}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div style="margin: 20px 0;">
                                <h4><i class="fas fa-bed"></i> Escala Norton - Respuestas Detalladas</h4>
                                <div class="resultados-detallados">
                                    ${datosCompletos.norton.respuestas.map(resp => `
                                        <div class="resultado-item">
                                            <span class="resultado-label">${resp.pregunta}:</span>
                                            <span class="resultado-valor">${resp.respuesta} (${resp.puntos} puntos)</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <div class="seccion-informe">
                            <h3><i class="fas fa-prescription-bottle-alt"></i> Recomendaciones Integrales</h3>
                            
                            <div class="recommendations-grid">
                                ${recomendaciones.map((rec, index) => `
                                    <div class="recommendation-card">
                                        <div style="font-weight: 600; color: var(--primary-color);">
                                            <i class="fas fa-check-circle"></i> Recomendación ${index + 1}
                                        </div>
                                        <p style="margin-top: 8px;">${rec}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="seccion-informe">
                            <h3><i class="fas fa-calendar-check"></i> Plan de Seguimiento</h3>
                            <div class="info-box">
                                <p><strong>Próxima evaluación recomendada:</strong> ${obtenerProximaFechaEvaluacion()}</p>
                                <p><strong>Fecha de este informe:</strong> ${new Date().toLocaleDateString('es-ES', { 
                                    day: '2-digit', 
                                    month: 'long', 
                                    year: 'numeric' 
                                })}</p>
                            </div>
                        </div>
                        
                        <div class="firma-informe">
                            <p><strong>Nota:</strong> Este informe es una guía clínica y debe ser interpretado por profesionales capacitados.</p>
                            <p style="margin-top: 30px; text-align: right;">
                                <strong>Profesional evaluador:</strong><br>
                                ${datosCompletos.paciente.evaluador || "No especificado"}
                            </p>
                        </div>
                    </div>
                `;
                
                document.getElementById('contenido-resultados').innerHTML = html;
                
            } catch (error) {
                console.error('Error mostrando resultados:', error);
                mostrarErrorEnResultados(error.message);
            }
        }
        
        function mostrarErrorEnResultados(mensaje) {
            const contenidoResultados = document.getElementById('contenido-resultados');
            if (!contenidoResultados) return;

            const errorHTML = `
                <div class="warning-box" style="padding: 30px; text-align: center;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: var(--warning-color); margin-bottom: 20px;"></i>
                    <h3>Error al cargar evaluación</h3>
                    <p>${mensaje}</p>
                    <button class="btn btn-primary" onclick="cambiarSeccion('historial')" style="margin-top: 20px;">
                        <i class="fas fa-arrow-left"></i> Volver al historial
                    </button>
                </div>
            `;
            contenidoResultados.innerHTML = errorHTML;
        }
        
        function generarRecomendaciones() {
            const recs = [];
            
            if (puntajeTotalIRAT <= 6) {
                recs.push("Bastón simple si es necesario para mayor seguridad");
                recs.push("Ejercicios de equilibrio básicos");
                recs.push("Revisión domiciliaria básica de seguridad");
                recs.push("Seguimiento cada 6 meses");
            } else if (puntajeTotalIRAT <= 9) {
                recs.push("Andador con 2 o 4 ruedas para mayor estabilidad");
                recs.push("Cojín antiescaras para silla o sillón");
                recs.push("Instalación de barras de apoyo en baño");
                recs.push("Programa de ejercicios de fortalecimiento");
                recs.push("Evaluación por terapia ocupacional");
            } else if (puntajeTotalIRAT <= 12) {
                recs.push("Andador fijo (sin ruedas) para máxima estabilidad");
                recs.push("Colchón estático de alta densidad");
                recs.push("Supervisión durante la deambulación");
                recs.push("Adaptaciones domiciliarias prioritarias");
                recs.push("Entrenamiento básico para cuidadores");
            } else {
                recs.push("Silla de ruedas adaptada con cojín antiescaras");
                recs.push("Colchón alternante de aire para prevención UPP");
                recs.push("Plan de movilización cada 2-3 horas");
                recs.push("Valoración por equipo multidisciplinar");
                recs.push("Entrenamiento formal para cuidadores");
                recs.push("Modificaciones estructurales en domicilio");
            }
            
            return recs;
        }
        
        function obtenerDescripcionRiesgoIRAT() {
            if (puntajeTotalIRAT <= 6) return "Ayudas básicas o ninguna. Bastón simple o sin ayuda.";
            if (puntajeTotalIRAT <= 9) return "Ayudas intermedias. Andador con ruedas + cojín antiescaras.";
            if (puntajeTotalIRAT <= 12) return "Ayudas avanzadas. Andador fijo + colchón estático.";
            return "Ayudas de movilización. Silla de ruedas + colchón alternante.";
        }
        
        function obtenerProximaFechaEvaluacion() {
            const fecha = new Date();
            fecha.setMonth(fecha.getMonth() + 3);
            return fecha.toLocaleDateString('es-ES');
        }
        
        function configurarCompartir() {
            console.log('Configurando compartir...');
            document.getElementById('generar-pdf')?.addEventListener('click', generarPDFProfesional);
            document.getElementById('compartir-whatsapp')?.addEventListener('click', compartirWhatsAppProfesional);
            document.getElementById('copiar-texto')?.addEventListener('click', copiarInformeCompleto);
            document.getElementById('nueva-evaluacion')?.addEventListener('click', iniciarNuevaEvaluacion);
        }
        
        async function generarPDFProfesional() {
            if (!datosCompletos) {
                mostrarNotificacion('Primero calcule los resultados', 'error');
                return;
            }
            
            try {
                mostrarNotificacion('Generando PDF...', 'info');
                
                const element = document.querySelector('.informe-profesional');
                if (!element) {
                    mostrarNotificacion('No se encontró el contenido del informe para generar el PDF.', 'error');
                    return;
                }

                // Aquí se asume que tienes la librería html2pdf.js cargada
                const opt = {
                    margin:       10,
                    filename:     `Evaluacion_${datosCompletos.paciente.nombre.replace(/[^a-z0-9]/gi, '_')}.pdf`,
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { 
                        scale: 2,
                        useCORS: true,
                        logging: false
                    },
                    jsPDF:        { 
                        unit: 'mm', 
                        format: 'a4', 
                        orientation: 'portrait' 
                    }
                };
                
                // Verifica que la función html2pdf exista
                if (typeof html2pdf !== 'undefined') {
                    await html2pdf().set(opt).from(element).save();
                    mostrarNotificacion('PDF generado correctamente', 'success');
                } else {
                    mostrarNotificacion('La librería html2pdf no está cargada. No se puede generar el PDF.', 'error');
                }
                
            } catch (error) {
                console.error('Error generando PDF:', error);
                mostrarNotificacion('Error al generar PDF: ' + error.message, 'error');
            }
        }
        
        function compartirWhatsAppProfesional() {
            if (!datosCompletos) {
                mostrarNotificacion('Primero calcule los resultados', 'error');
                return;
            }
            
            const mensaje = `*INFORME DE EVALUACIÓN CLÍNICA*%0A%0A` +
                           `*Paciente:* ${datosCompletos.paciente.nombre}%0A` +
                           `*Fecha:* ${datosCompletos.paciente.fecha}%0A` +
                           `*Evaluador:* ${datosCompletos.paciente.evaluador}%0A%0A` +
                           `*RESULTADOS:*%0A` +
                           `• IRAT-5: ${puntajeTotalIRAT} pts - ${nivelRiesgoIRAT}%0A` +
                           `• Tinetti: ${tinettiNoEvaluable ? 'No evaluable' : puntajeTinetti + '/28'} - ${datosCompletos.tinetti.riesgo}%0A` +
                           `• Norton: ${puntajeNorton} pts - ${nivelRiesgoNorton}%0A%0A` +
                           `*Próxima evaluación:* ${obtenerProximaFechaEvaluacion()}%0A` +
                           `*Informe completo disponible en el sistema*`;
            
            window.open(`https://wa.me/?text=${mensaje}`, '_blank');
            mostrarNotificacion('Compartiendo por WhatsApp...', 'info');
        }
        
        function copiarInformeCompleto() {
            if (!datosCompletos) {
                mostrarNotificacion('Primero calcule los resultados', 'error');
                return;
            }
            
            let informe = `INFORME DE EVALUACIÓN CLÍNICA PROFESIONAL
================================================================

DATOS DEL PACIENTE
------------------
${Object.entries(datosCompletos.paciente)
    .map(([key, value]) => `${key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}: ${value || 'No especificado'}`)
    .join('\n')}

RESULTADOS PRINCIPALES
----------------------
• IRAT-5 Modificado: ${puntajeTotalIRAT} puntos - ${nivelRiesgoIRAT}
• Test de Tinetti: ${tinettiNoEvaluable ? 'No evaluable' : puntajeTinetti + '/28 puntos'} - ${datosCompletos.tinetti.riesgo}
• Escala Norton: ${puntajeNorton} puntos - ${nivelRiesgoNorton}

RECOMENDACIONES INTEGRALES
--------------------------
${recomendaciones.map((r, i) => `${i + 1}. ${r}`).join('\n')}

PLAN DE SEGUIMIENTO
-------------------
• Próxima evaluación recomendada: ${obtenerProximaFechaEvaluacion()}

FIRMAS
------
Profesional evaluador: ${datosCompletos.paciente.evaluador}
Paciente/Representante: _________________________

Fecha de emisión: ${new Date().toLocaleDateString('es-ES')}
================================================================
Sistema IRAT-5 + Tinetti + Norton`;

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(informe)
                    .then(() => mostrarNotificacion('Informe copiado al portapapeles', 'success'))
                    .catch(() => {
                        copiarTextoFallback(informe);
                    });
            } else {
                copiarTextoFallback(informe);
            }
        }
        
        function copiarTextoFallback(texto) {
            const textarea = document.createElement('textarea');
            textarea.value = texto;
            textarea.style.position = 'fixed';
            textarea.style.left = '-999999px';
            textarea.style.top = '-999999px';
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            mostrarNotificacion('Informe copiado al portapapeles', 'success');
        }
        
        function iniciarNuevaEvaluacion() {
            if (confirm('¿Está seguro de comenzar una nueva evaluación? Los datos no guardados se perderán.')) {
                location.reload();
            }
        }
    </script>
