<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluador Cl√≠nico Integrado</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* Paleta de Colores Moderna */
        :root {
            --color-primary: #007bff; /* Azul vibrante */
            --color-secondary: #6c757d; /* Gris secundario */
            --color-accent: #28a745; /* Verde para √©xito/guardar */
            --color-danger: #dc3545; /* Rojo para riesgo/eliminar */
            --color-warning: #ffc107; /* Amarillo para moderado */
            --color-info: #17a2b8; /* Turquesa para info */
            --color-bg: #f8f9fa; /* Fondo muy claro */
            --color-card-bg: #ffffff; /* Fondo de tarjeta blanco */
            --color-header-bg: #343a40; /* Fondo de cabecera oscuro */
            --color-text-dark: #212529;
            --color-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }

        /* Estilos Generales y Tipograf√≠a */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--color-bg); color: var(--color-text-dark); margin: 0; padding: 0; line-height: 1.6; }
        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; background: transparent; }
        h1, h2, h3, h4 { color: var(--color-text-dark); margin-top: 0; }
        h1 { color: var(--color-primary); text-align: center; padding-bottom: 15px; margin-bottom: 25px; font-size: 2.2em; }
        h2 { color: var(--color-primary); margin-top: 35px; border-left: 6px solid var(--color-primary); padding-left: 15px; font-weight: 600; font-size: 1.8em; }
        h3 { color: var(--color-primary); margin-top: 20px; font-size: 1.4em; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        h4 { color: var(--color-secondary); margin-top: 15px; font-size: 1.1em; }

        /* Botones Elegantes */
        button { 
            background-color: var(--color-primary); 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 5px; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            font-size: 1em;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        button:hover { background-color: #0056b3; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        .btn-secondary { background-color: var(--color-secondary); }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-save { background-color: var(--color-accent); }
        .btn-save:hover { background-color: #1e7e34; }
        .btn-danger { background-color: var(--color-danger); }
        .btn-danger:hover { background-color: #bd2130; }
        .btn-admin { background-color: var(--color-header-bg); }
        .btn-admin:hover { background-color: #1d2124; }

        /* Estilos de Tarjeta (Card) - Principal Contenedor de Grupo */
        .card { 
            background-color: var(--color-card-bg); 
            padding: 25px; 
            border-radius: 10px; 
            box-shadow: var(--color-shadow); 
            margin-bottom: 30px; 
            border-left: 5px solid var(--color-primary);
        }

        /* Formulario y Evaluaci√≥n */
        .form-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: var(--color-text-dark); }
        input[type="text"], input[type="date"], select, textarea { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid #ced4da; 
            border-radius: 6px; 
            box-sizing: border-box; 
            transition: border-color 0.3s;
            font-size: 1em;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--color-primary); box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25); outline: none; }
        
        .item-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px 0; 
            border-bottom: 1px solid #f1f1f1; 
            gap: 15px; 
        }
        .item-row:last-child { border-bottom: none; }
        .item-label { flex-grow: 1; font-weight: 500; }
        .item-select { width: 40%; min-width: 150px; }
        .item-score { 
            width: 80px; 
            text-align: center; 
            font-weight: bold; 
            color: var(--color-primary); 
            background-color: #e9ecef;
            padding: 5px;
            border-radius: 4px;
        }

        /* Resultados y Notificaciones (Dashboard Style) */
        .results-section { 
            background-color: #e9f5ff; 
            padding: 25px; 
            border-radius: 10px; 
            border: 1px solid #cceeff; 
            margin-top: 30px; 
        }
        .results-summary { 
            display: flex; 
            justify-content: space-around; 
            flex-wrap: wrap; 
            gap: 15px;
            margin-bottom: 25px;
        }
        .result-box { 
            text-align: center; 
            padding: 20px 15px; 
            border-radius: 8px; 
            flex: 1; 
            min-width: 180px; 
            background-color: var(--color-card-bg); 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
            border-top: 4px solid var(--color-primary);
        }
        .result-box strong { display: block; font-size: 1em; color: var(--color-text-dark); margin-bottom: 5px; font-weight: 700; }
        .resultado-valor { font-size: 2em; font-weight: 900; }
        
        /* Clasificaci√≥n Global Box - Destacado */
        .result-box.global-summary {
            border: 4px solid var(--color-danger); 
            background-color: #fff0f0; 
            min-width: 250px;
        }

        /* Colores de Riesgo */
        .risk-success { color: var(--color-accent); }
        .risk-warning { color: var(--color-warning); }
        .risk-danger { color: var(--color-danger); }
        .risk-critical { color: var(--color-danger); background-color: #fee; padding: 5px; border-radius: 4px; }

        /* Tarjetas de Recomendaci√≥n (Clean and Prioritized) */
        .recommendation-card { 
            margin-top: 15px; 
            padding: 15px; 
            border-radius: 8px; 
            border-left: 8px solid; 
            background-color: var(--color-card-bg); 
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05); 
            transition: all 0.3s ease;
        }
        .recommendation-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        .recommendation-card strong { font-size: 1.1em; display: block; margin-bottom: 5px; }
        
        /* Estilos de Color para Recomendaciones */
        .rec-danger { border-left-color: var(--color-danger); background-color: #fce7e8; }
        .rec-warning { border-left-color: var(--color-warning); background-color: #fff9e6; }
        .rec-success { border-left-color: var(--color-accent); background-color: #e6f7e9; }
        .rec-info { border-left-color: var(--color-info); background-color: #e6f9fb; }

        /* Historial y Autenticaci√≥n */
        .auth-section, #main-app { padding: 20px; }
        .auth-section { 
            text-align: center; 
            max-width: 400px; 
            margin: 50px auto; 
            padding: 30px; 
            background: var(--color-card-bg); 
            border-radius: 10px; 
            box-shadow: var(--color-shadow); 
        }
        .auth-section input { margin: 10px auto; }

        #historial-list { list-style: none; padding: 0; }
        #historial-list li { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px 15px; 
            border-bottom: 1px solid #eee; 
            background-color: var(--color-card-bg); 
            margin-bottom: 8px; 
            border-radius: 6px; 
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: background-color 0.3s;
        }
        #historial-list li:hover { background-color: #f1f1f1; }
        
        .notification-bar { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            text-align: center; 
            padding: 15px; 
            color: white; 
            z-index: 1000; 
            transition: all 0.5s ease-in-out; 
            display: none; 
            font-weight: bold;
        }
        .notification-success { background-color: var(--color-accent); }
        .notification-error { background-color: var(--color-danger); }
        .notification-warning { background-color: var(--color-warning); }
        .notification-info { background-color: var(--color-info); }

        /* Cabecera */
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 15px 25px; 
            background-color: var(--color-header-bg); 
            color: white; 
            border-radius: 8px 8px 0 0; 
        }
        .header h1 { color: white; border-bottom: none; margin: 0; padding: 0; font-size: 1.5em; }
        #user-display { display: flex; align-items: center; font-size: 0.9em; }
        #user-display i { margin-right: 8px; font-size: 1.1em; }
        .logout-btn { 
            background-color: transparent; 
            border: 1px solid white; 
            padding: 5px 10px; 
            margin-left: 15px; 
            font-size: 0.9em;
        }
        .logout-btn:hover { background-color: var(--color-danger); border-color: var(--color-danger); }

        /* Ocultar secci√≥n por defecto */
        #main-app { display: none; padding: 0;}

        /* Estilo para los puntajes totales */
        .total-score-row {
            background-color: #f0f0f0;
            padding: 15px !important;
            border-radius: 0 0 8px 8px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 style="color: white; border-bottom: none; margin: 0; padding: 0;">Evaluador Cl√≠nico Integrado</h1>
            <div id="user-display">
                <i class="fas fa-user-circle"></i>
                <span>Modo Desconectado</span>
                <button class="logout-btn" onclick="logout()" id="logout-btn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
                </button>
            </div>
        </div>

        <section id="auth-section" class="auth-section">
            <h2 id="auth-title" style="border: none; padding-left: 0; color: var(--color-primary);">Iniciar Sesi√≥n</h2>
            <input type="text" id="auth-email" placeholder="Correo Electr√≥nico" required>
            <input type="password" id="auth-password" placeholder="Contrase√±a" required>
            <button id="auth-button" onclick="handleAuth()"><i class="fas fa-sign-in-alt"></i> Iniciar Sesi√≥n</button>
            <p style="margin-top: 20px; font-size: 0.9em;">
                <a href="#" id="toggle-auth-mode" onclick="toggleAuthModeFunc()">Reg√≠strate aqu√≠</a>
            </p>
        </section>

        <section id="main-app">
            
            <div class="card">
                <h2><i class="fas fa-id-card-alt"></i> Datos Generales del Paciente</h2>
                <div class="form-section">
                    <div>
                        <label for="nombre">Nombre del Paciente:</label>
                        <input type="text" id="nombre" placeholder="Nombre completo">
                    </div>
                    <div>
                        <label for="fecha">Fecha de Evaluaci√≥n:</label>
                        <input type="date" id="fecha">
                    </div>
                    <div>
                        <label for="evaluador">Nombre del Evaluador:</label>
                        <input type="text" id="evaluador" placeholder="Su nombre">
                    </div>
                </div>
            </div>

            <div class="card" id="irat-section">
                <h3><i class="fas fa-notes-medical"></i> IRAT-5 (Riesgo de Amputaci√≥n y Ca√≠da)</h3>
                <p style="font-style: italic; color: var(--color-secondary);">M√°ximo 10 puntos.</p>

                <div class="item-row">
                    <div class="item-label">Amputaci√≥n</div>
                    <select id="amputacion" class="item-select" onchange="calcularIRAT()">
                        <option value="0">0. Ausencia</option>
                        <option value="3">3. Unilateral Infracond√≠lea / Transmetatarsiana</option>
                        <option value="4">4. Bilateral Infracond√≠lea</option>
                        <option value="5">5. Unilateral Supracond√≠lea</option>
                        <option value="6">6. Bilateral Supracond√≠lea</option>
                    </select>
                </div>
                <div class="item-row">
                    <div class="item-label">D√©ficit Visual Severo (con correcci√≥n)</div>
                    <select id="visual" class="item-select" onchange="calcularIRAT()">
                        <option value="0">0. No</option>
                        <option value="1">1. S√≠</option>
                    </select>
                </div>
                <div class="item-row">
                    <div class="item-label">Polifarmacia (5 o m√°s medicamentos)</div>
                    <select id="polifarmacia" class="item-select" onchange="calcularIRAT()">
                        <option value="0">0. No</option>
                        <option value="1">1. S√≠</option>
                    </select>
                </div>
                <div class="item-row">
                    <div class="item-label">Uso de Benzodiazepinas/Neurol√©pticos</div>
                    <select id="farmacos" class="item-select" onchange="calcularIRAT()">
                        <option value="0">0. No</option>
                        <option value="1">1. S√≠</option>
                    </select>
                </div>
                <div class="item-row">
                    <div class="item-label">Antecedente de Ca√≠da en los √∫ltimos 6 meses</div>
                    <select id="caida" class="item-select" onchange="calcularIRAT()">
                        <option value="0">0. No</option>
                        <option value="1">1. S√≠</option>
                    </select>
                </div>
                <div class="item-row total-score-row">
                    <div class="item-label" style="font-weight: 700;">PUNTAJE TOTAL IRAT-5</div>
                    <div class="item-score" id="puntaje-irat" style="width: 150px; background-color: var(--color-primary); color: white;">0</div>
                </div>
            </div>

            <div class="card" id="tinetti-section">
                <h3><i class="fas fa-shoe-prints"></i> Tinetti (Marcha y Equilibrio)</h3>
                <p style="font-style: italic; color: var(--color-secondary);">M√°ximo 28 puntos. Se han convertido los radios a men√∫s desplegables para uniformidad y elegancia.</p>

                <h4>I. Equilibrio (M√°x. 16)</h4>
                <div class="tinetti-questions">
                    <div class="item-row">
                        <div class="item-label">1. Equilibrio sentado</div>
                        <select name="e1" class="item-select" onchange="calcularTinetti(true)">
                            <option value="0">0. Se desliza / Requiere ayuda</option>
                            <option value="1">1. Firme</option>
                        </select>
                    </div>
                    <div class="item-row">
                        <div class="item-label">2. Levantarse</div>
                        <select name="e2" class="item-select" onchange="calcularTinetti(true)">
                            <option value="0">0. Imposible sin ayuda</option>
                            <option value="1">1. Posible, pero utiliza brazos</option>
                            <option value="2">2. Sin uso de brazos</option>
                        </select>
                    </div>
                    <div class="item-row">
                        <div class="item-label">3. Intentos para levantarse</div>
                        <select name="e3" class="item-select" onchange="calcularTinetti(true)">
                            <option value="0">0. Incapaz</option>
                            <option value="1">1. M√∫ltiples intentos (m√°s de 1)</option>
                            <option value="2">2. Un solo intento</option>
                        </select>
                    </div>
                    <div class="item-row">
                        <div class="item-label">4. Equilibrio de pie (inmediato 5s)</div>
                        <select name="e4" class="item-select" onchange="calcularTinetti(true)">
                            <option value="0">0. Inestable</option>
                            <option value="1">1. Estable, pero usa andador/bast√≥n</option>
                            <option value="2">2. Estable sin apoyo</option>
                        </select>
                    </div>
                    <div class="item-row">
                        <div class="item-label">5. Equilibrio de pie (mantenido)</div>
                        <select name="e5" class="item-select" onchange="calcularTinetti(true)">
                            <option value="0">0. Inestable/Se agarra</option>
                            <option value="1">1. Ligeramente inestable</option>
                            <option value="2">2. Estable</option>
                        </select>
                    </div>
                    <div class="item-row">
                        <div class="item-label">6. Tensi√≥n al empuje (Ligero empuj√≥n al estern√≥n)</div>
                        <select name="e6" class="item-select" onchange="calcularTinetti(true)">
                            <option value="0">0. Se cae / Inicia el paso</option>
                            <option value="1">1. Se tambalea, pero recupera</option>
                            <option value="2">2. Firme</option>
                        </select>
                    </div>
                    <div class="item-row">
                        <div class="item-label">7. Ojos cerrados (mantenerse de pie)</div>
                        <select name="e7" class="item-select" onchange="calcularTinetti(true)">
                            <option value="0">0. Inestable</option>
                            <option value="1">1. Estable</option>
                        </select>
                    </div>
                    <div class="item-row">
                        <div class="item-label">8. Giro de 360¬∫</div>
                        <select name="e8" class="item-select" onchange="calcularTinetti(true)">
                            <option value="0">0. Pasos discontinuos / Inestable</option>
                            <option value="1">1. Pasos discontinuos, pero estable</option>
                            <option value="2">2. Pasos continuos y estable</option>
                        </select>
                    </div>
                    <div class="item-row">
                        <div class="item-label">9. Sentarse</div>
                        <select name="e9" class="item-select" onchange="calcularTinetti(true)">
                            <option value="0">0. Cae en silla / No alcanza asiento</option>
                            <option value="1">1. Usa brazos, no es suave</option>
                            <option value="2">2. Suave, utiliza la parte posterior de las piernas</option>
                        </select>
                    </div>
                </div>
                
                <h4>II. Marcha (M√°x. 12)</h4>
                <div class="marcha-questions">
                    <div class="item-row">
                        <div class="item-label">10. Inicio de la marcha</div>
                        <select name="m1" class="item-select" onchange="calcularTinetti(true)">
                            <option value="0">0. Titubeo o m√∫ltiples intentos</option>
                            <option value="1">1. Sin titubeo</option>
                        </select>
                    </div>
                    <div class="item-row">
                        <div class="item-label">11. Longitud/Altura del paso (Pie Derecho)</div>
                        <select name="m2" class="item-select" onchange="calcularTinetti(true)">
                            <option value="0">0. No levanta pie del suelo</option>
                            <option value="1">1. Levanta pie, paso corto</option>
                            <option value="2">2. Paso normal</option>
                        </select>
                    </div>
                    <div class="item-row">
                        <div class="item-label">12. Simetr√≠a del paso</div>
                        <select name="m3" class="item-select" onchange="calcularTinetti(true)">
                            <option value="0">0. Asim√©trico</option>
                            <option value="1">1. Ligeramente asim√©trico</option>
                            <option value="2">2. Sim√©trico</option>
                        </select>
                    </div>
                    <div class="item-row">
                        <div class="item-label">13. Continuidad del paso</div>
                        <select name="m4" class="item-select" onchange="calcularTinetti(true)">
                            <option value="0">0. Discontinuo (detenciones)</option>
                            <option value="1">1. Continuo</option>
                        </select>
                    </div>
                    <div class="item-row">
                        <div class="item-label">14. Trayectoria</div>
                        <select name="m5" class="item-select" onchange="calcularTinetti(true)">
                            <option value="0">0. Desviaci√≥n marcada o ayuda</option>
                            <option value="1">1. Desviaci√≥n leve, pero estable</option>
                            <option value="2">2. Recta</option>
                        </select>
                    </div>
                    <div class="item-row">
                        <div class="item-label">15. Tronco</div>
                        <select name="m6" class="item-select" onchange="calcularTinetti(true)">
                            <option value="0">0. Balanceo o uso de ayuda</option>
                            <option value="1">1. Balanceo leve, pero firme</option>
                            <option value="2">2. Sin balanceo (erguido)</option>
                        </select>
                    </div>
                </div>

                <div class="item-row total-score-row">
                    <div class="item-label" style="font-weight: 700;">PUNTAJE TOTAL TINETTI (M√°x 28)</div>
                    <div class="item-score" id="puntaje-tinetti" style="width: 150px; background-color: var(--color-primary); color: white;">0</div>
                </div>
            </div>

            <div class="card" id="norton-section">
                <h3><i class="fas fa-bed"></i> Norton (Riesgo de √ölcera por Presi√≥n)</h3>
                <p style="font-style: italic; color: var(--color-secondary);">M√≠nimo 5, M√°ximo 20 puntos.</p>

                <div class="item-row">
                    <div class="item-label">Condici√≥n f√≠sica</div>
                    <select id="norton-fisica" class="item-select" onchange="calcularNorton()">
                        <option value="4">4. Buena</option>
                        <option value="3">3. Regular</option>
                        <option value="2">2. Pobre</option>
                        <option value="1">1. Muy Pobre</option>
                    </select>
                </div>
                <div class="item-row">
                    <div class="item-label">Estado mental</div>
                    <select id="norton-mental" class="item-select" onchange="calcularNorton()">
                        <option value="4">4. Alerta</option>
                        <option value="3">3. Ap√°tico</option>
                        <option value="2">2. Confuso</option>
                        <option value="1">1. Estuporoso/Coma</option>
                    </select>
                </div>
                <div class="item-row">
                    <div class="item-label">Actividad</div>
                    <select id="norton-actividad" class="item-select" onchange="calcularNorton()">
                        <option value="4">4. Ambulante</option>
                        <option value="3">3. Camina con ayuda</option>
                        <option value="2">2. En silla</option>
                        <option value="1">1. En cama</option>
                    </select>
                </div>
                <div class="item-row">
                    <div class="item-label">Movilidad</div>
                    <select id="norton-movilidad" class="item-select" onchange="calcularNorton()">
                        <option value="4">4. Completa</option>
                        <option value="3">3. Disminuida</option>
                        <option value="2">2. Muy Limitada</option>
                        <option value="1">1. Inm√≥vil</option>
                    </select>
                </div>
                <div class="item-row">
                    <div class="item-label">Incontinencia</div>
                    <select id="norton-incontinencia" class="item-select" onchange="calcularNorton()">
                        <option value="4">4. No</option>
                        <option value="3">3. Ocasional</option>
                        <option value="2">2. Urinaria</option>
                        <option value="1">1. Fecal y Urinaria</option>
                    </select>
                </div>
                <div class="item-row total-score-row">
                    <div class="item-label" style="font-weight: 700;">PUNTAJE TOTAL NORTON (M√°x 20)</div>
                    <div class="item-score" id="puntaje-norton" style="width: 150px; background-color: var(--color-primary); color: white;">20</div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 30px; margin-bottom: 40px;">
                <button class="btn-save" onclick="generarResultados()"><i class="fas fa-calculator"></i> Generar Resultados y Recomendaciones</button>
                <button class="btn-secondary" onclick="resetForm()"><i class="fas fa-undo"></i> Limpiar Formulario</button>
            </div>

            <div class="results-section" id="results-section" style="display: none;">
                <h2><i class="fas fa-chart-bar"></i> An√°lisis Cl√≠nico y Recomendaciones</h2>
                
                <div class="results-summary">
                    <div class="result-box">
                        <strong>Paciente</strong>
                        <span id="res-nombre">N/A</span>
                    </div>
                    <div class="result-box">
                        <strong>Fecha</strong>
                        <span id="res-fecha">N/A</span>
                    </div>
                    <div class="result-box">
                        <strong>IRAT-5 (Ca√≠da/Amputaci√≥n)</strong>
                        <span id="res-irat-total" class="resultado-valor">0</span>
                        <p id="res-irat-riesgo" class="resultado-valor risk-success" style="font-size: 1em;"></p>
                    </div>
                    <div class="result-box">
                        <strong>Tinetti (Movilidad)</strong>
                        <span id="res-tinetti-total" class="resultado-valor">0 / 28</span>
                        <p style="font-size: 1em;">Movilidad/Riesgo Ca√≠da</p>
                    </div>
                    <div class="result-box">
                        <strong>Norton (√ölcera)</strong>
                        <span id="res-norton-total" class="resultado-valor">0 / 20</span>
                        <p id="res-norton-riesgo" class="resultado-valor risk-success" style="font-size: 1em;"></p>
                    </div>
                     <div class="result-box global-summary">
                        <strong>CLASIFICACI√ìN COMBINADA</strong>
                        <span id="res-global-riesgo" class="resultado-valor risk-success" style="font-size: 1.8em;">BAJO</span>
                        <p style="font-size: 0.9em; font-weight: 600;">Plan Interdisciplinar Prioritario</p>
                    </div>
                </div>
                
                <h3 style="margin-top: 15px;"><i class="fas fa-check-double"></i> Plan de Acci√≥n Interdisciplinar</h3>
                <div id="recomendaciones-irat">
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn-secondary" onclick="saveReport()"><i class="fas fa-save"></i> Guardar Evaluaci√≥n</button>
                    <button class="btn-primary" onclick="generatePDF()"><i class="fas fa-file-pdf"></i> Generar PDF</button>
                </div>
            </div>

            <div class="card" style="margin-top: 40px; border-left-color: var(--color-secondary);">
                <h2><i class="fas fa-history"></i> Historial de Evaluaciones</h2>
                <div style="text-align: right; margin-bottom: 10px;">
                    <button class="btn-admin" id="limpiar-historial-btn" style="display:none;"><i class="fas fa-eraser"></i> Limpiar Historial (Admin)</button>
                    <button class="btn-secondary" onclick="loadHistorial(true)"><i class="fas fa-sync-alt"></i> Recargar</button>
                </div>
                <ul id="historial-list">
                    <li id="loading-history-msg">Cargando historial...</li>
                </ul>
            </div>
        </section>
        
        <div id="notification-bar" class="notification-bar"></div>

    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // ------------------------------------------------------------------
        // CONFIGURACI√ìN E INICIALIZACI√ìN DE FIREBASE (MANTENIDA)
        // ------------------------------------------------------------------
        
        // üö® CR√çTICO: REEMPLACE ESTAS VARIABLES CON SUS PROPIAS CREDENCIALES DE FIREBASE
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional

        const firebaseConfig = {
  apiKey: "AIzaSyDJbtRuEwWVAsC1Nz6LbeF5a99LcUfAz4g",
  authDomain: "irat-5-evaluaciones.firebaseapp.com",
  databaseURL: "https://irat-5-evaluaciones-default-rtdb.firebaseio.com",
  projectId: "irat-5-evaluaciones",
  storageBucket: "irat-5-evaluaciones.firebasestorage.app",
  messagingSenderId: "487279274410",
  appId: "1:487279274410:web:146e9c35a0bf795c5423d3",
};
        
        let app, db, auth;
        let authMode = 'login'; // 'login' o 'register'
        let currentUser = null;
        let currentUserId = null;
        let lastReportData = {}; 
        
        const authSection = document.getElementById('auth-section');
        const mainApp = document.getElementById('main-app');
        const authTitle = document.getElementById('auth-title');
        const authButton = document.getElementById('auth-button');
        const toggleAuthMode = document.getElementById('toggle-auth-mode');
        const logoutBtn = document.getElementById('logout-btn');
        
        function initFirebase() {
            try {
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                console.log("Firebase inicializado correctamente.");
                setupAuthStateListener();
            } catch (e) {
                console.error("Error al inicializar Firebase. Revise las credenciales.", e);
                showNotification(`Error: No se pudo conectar a Firebase. Revise la consola.`, 'error', 10000);
            }
        }
        
        window.onload = initFirebase;
        
        // ------------------------------------------------------------------
        // L√ìGICA DE AUTENTICACI√ìN (MANTENIDA)
        // ------------------------------------------------------------------
        
        function toggleAuthModeFunc() {
            if (authMode === 'login') {
                authMode = 'register';
                authTitle.textContent = 'Registrar Nuevo Usuario';
                authButton.innerHTML = '<i class="fas fa-user-plus"></i> Registrar';
                toggleAuthMode.textContent = 'Volver a Iniciar Sesi√≥n';
            } else {
                authMode = 'login';
                authTitle.textContent = 'Iniciar Sesi√≥n';
                authButton.innerHTML = '<i class="fas fa-sign-in-alt"></i> Iniciar Sesi√≥n';
                toggleAuthMode.textContent = 'Reg√≠strate aqu√≠';
            }
        }
        
        async function handleAuth() {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
        
            if (!email || !password) {
                showNotification('Ingrese correo y contrase√±a.', 'warning');
                return;
            }
        
            try {
                if (authMode === 'register') {
                    await auth.createUserWithEmailAndPassword(email, password);
                    showNotification('Usuario registrado exitosamente. Iniciando sesi√≥n...', 'success');
                } else {
                    await auth.signInWithEmailAndPassword(email, password);
                }
            } catch (error) {
                console.error("Error de autenticaci√≥n:", error);
                showNotification(`Error: ${error.message}`, 'error');
            }
        }
        
        function logout() {
            auth.signOut().then(() => {
                showNotification('Sesi√≥n cerrada.', 'info');
            }).catch((error) => {
                console.error("Error al cerrar sesi√≥n:", error);
                showNotification(`Error al cerrar sesi√≥n: ${error.message}`, 'error');
            });
        }
        
        async function checkAdminStatus(uid) {
            if (!db) return false;
            try {
                const doc = await db.collection('roles').doc(uid).get();
                return doc.exists && doc.data().role === 'admin';
            } catch (error) {
                console.error("Error al verificar el rol de administrador:", error);
                return false;
            }
        }
        
        function updateUIAfterAuth(user) {
            const limpiarBtn = document.getElementById('limpiar-historial-btn');
            limpiarBtn.style.display = 'none'; 
        
            if (user) {
                checkAdminStatus(user.uid).then(isAdmin => {
                    if (isAdmin) {
                        limpiarBtn.style.display = 'inline-flex'; 
                        limpiarBtn.onclick = confirmAndClearHistorial; 
                        showNotification('Acceso de Administrador activado.', 'warning');
                    }
                }).catch(e => console.error("Error al actualizar UI con roles:", e));
            }
        }
        
        function setupAuthStateListener() {
            const userDisplay = document.getElementById('user-display').querySelector('span');
        
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    currentUserId = user.uid;
                    authSection.style.display = 'none';
                    mainApp.style.display = 'block';
                    userDisplay.textContent = user.email;
                    logoutBtn.style.display = 'inline-block';
                    
                    updateUIAfterAuth(user); 
                    loadHistorial(true);
                } else {
                    currentUser = null;
                    currentUserId = null;
                    authSection.style.display = 'block';
                    mainApp.style.display = 'none';
                    userDisplay.textContent = 'Modo Desconectado';
                    logoutBtn.style.display = 'none';
                    
                    document.getElementById('limpiar-historial-btn').style.display = 'none';
                    
                    authMode = 'login'; 
                    authTitle.textContent = 'Iniciar Sesi√≥n';
                    authButton.innerHTML = '<i class="fas fa-sign-in-alt"></i> Iniciar Sesi√≥n';
                    toggleAuthMode.textContent = 'Reg√≠strate aqu√≠';
                }
            });
        }

        // ------------------------------------------------------------------
        // FUNCIONES DE C√ÅLCULO (AJUSTADAS PARA USAR SELECTS)
        // ------------------------------------------------------------------

        function calcularIRAT() {
            if (!document.getElementById('amputacion')) return 0;
            const items = ['amputacion', 'visual', 'polifarmacia', 'farmacos', 'caida'];
            let total = 0;
            items.forEach(id => {
                total += parseInt(document.getElementById(id).value) || 0;
            });
            document.getElementById('puntaje-irat').textContent = total;
            return total;
        }

        function getIratAmputacionValue() {
            return parseInt(document.getElementById('amputacion').value) || 0;
        }

        /**
         * Calcula el puntaje Tinetti (Adaptado para usar SELECTs en lugar de Radios).
         */
        function calcularTinetti(updateUI = true) {
            let total = 0;
            // Recorre todos los elementos SELECT dentro de #tinetti-section
            document.querySelectorAll('#tinetti-section select').forEach(select => {
                total += parseInt(select.value) || 0;
            });

            if (updateUI) {
                document.getElementById('puntaje-tinetti').textContent = total;
            }
            return total;
        }

        function calcularNorton() {
            if (!document.getElementById('norton-fisica')) return 0;
            const items = ['norton-fisica', 'norton-mental', 'norton-actividad', 'norton-movilidad', 'norton-incontinencia'];
            let total = 0;
            items.forEach(id => {
                total += parseInt(document.getElementById(id).value) || 0;
            });
            document.getElementById('puntaje-norton').textContent = total;
            return total;
        }

        // ------------------------------------------------------------------
        // L√ìGICA DE CLASIFICACI√ìN COMBINADA (MANTENIDA)
        // ------------------------------------------------------------------

        function getCombinedClinicalClassification(iratScore, tinettiScore, nortonScore) {
            const iratAmputacion = getIratAmputacionValue();
            let recomendaciones = [];
            let nivelRiesgoGlobal = 'BAJO';
            let colorGlobal = 'success';
            
            // 1. L√≥gica por Amputaci√≥n (IRAT - CR√çTICO si >= 3)
            if (iratAmputacion >= 3) {
                recomendaciones.push({
                    titulo: 'üö® Consideraci√≥n: Amputaci√≥n Presente',
                    texto: 'Requiere evaluaci√≥n y manejo prot√©sico urgente (o adaptaci√≥n si ya posee pr√≥tesis). Ense√±ar t√©cnicas de cuidado del mu√±√≥n para prevenir infecciones y √∫lceras.',
                    color: 'danger',
                    tipo: 'Amputacion'
                });
                
                if (iratAmputacion === 4 || iratAmputacion === 6) { 
                    recomendaciones.unshift({ 
                        titulo: "‚ôø Ayuda T√©cnica Principal: Silla de Ruedas",
                        texto: "Amputaci√≥n Bilateral. La ayuda principal de movilidad es la Silla de Ruedas. Dispositivos de marcha (andador/bast√≥n) contraindicados hasta adaptaci√≥n prot√©sica. Requiere entrenamiento en silla.",
                        color: 'danger',
                        tipo: 'Movilidad Principal'
                    });
                    nivelRiesgoGlobal = 'CR√çTICO';
                    colorGlobal = 'danger';
                }
            }

            // 2. Clasificaci√≥n por Movilidad (Tinetti) y Asignaci√≥n de Ayuda Principal
            let ayudaPrincipalAsignada = recomendaciones.some(r => r.tipo === 'Movilidad Principal');

            if (!ayudaPrincipalAsignada) {
                if (tinettiScore <= 18) {
                    recomendaciones.push({ 
                        titulo: "üö∂ Ayuda T√©cnica Principal: Andador (Fijo o con Ruedas)",
                        texto: "Tinetti Severo (Riesgo de Ca√≠da ALTO). Se recomienda Andador Fijo o de 2 ruedas (si hay fuerza en MMSS) y entrenamiento de marcha supervisado intensivo.",
                        color: 'danger',
                        tipo: 'Movilidad Principal'
                    });
                    if (nivelRiesgoGlobal !== 'CR√çTICO') {
                        nivelRiesgoGlobal = 'ALTO';
                        colorGlobal = 'danger';
                    }
                } else if (tinettiScore <= 24) {
                    recomendaciones.push({ 
                        titulo: "ü¶Ø Ayuda T√©cnica Principal: Bast√≥n de 4 Apoyos",
                        texto: "Tinetti Moderado. Se recomienda Bast√≥n de 4 Apoyos (o de 3/1 si hay coordinaci√≥n) y entrenamiento espec√≠fico de equilibrio y marcha.",
                        color: 'warning',
                        tipo: 'Movilidad Principal'
                    });
                    if (nivelRiesgoGlobal === 'BAJO') {
                        nivelRiesgoGlobal = 'MODERADO';
                        colorGlobal = 'warning';
                    }
                } else {
                    recomendaciones.push({ 
                        titulo: "üü¢ Ayuda T√©cnica Principal: Preventiva / No Requerida",
                        texto: "Tinetti √ìptimo. No se requiere ayuda t√©cnica principal. Uso de bast√≥n simple solo en exteriores o terrenos irregulares. Mantener actividad f√≠sica y reevaluaci√≥n.",
                        color: 'success',
                        tipo: 'Movilidad Principal'
                    });
                }
            }
            
            // 3. Clasificaci√≥n por riesgo de √ölcera (Norton - ALTO si <= 14)
            if (nortonScore <= 14) {
                recomendaciones.push({ 
                    titulo: 'üö® Riesgo de √ölcera por Presi√≥n ALTO', 
                    texto: 'Protocolo estricto de cambios posturales cada 2-3 horas (registro obligatorio). Uso inmediato de colch√≥n y coj√≠n de presi√≥n alterna o viscoel√°stico.', 
                    color: 'danger', 
                    tipo: 'Ulcera' 
                });
                if (nivelRiesgoGlobal !== 'CR√çTICO' && nivelRiesgoGlobal !== 'ALTO') {
                    nivelRiesgoGlobal = 'ALTO';
                    colorGlobal = 'danger';
                }
            }

            // 4. Recomendaciones Interdisciplinarias y de Nivel de Riesgo Global
            
            if (nivelRiesgoGlobal === 'CR√çTICO') {
                recomendaciones.push(
                    { titulo: 'KINESIOLOG√çA/TERAPIA F√çSICA', texto: 'Inmediata. √ânfasis en el entrenamiento de transferencias (cama-silla), fortalecimiento de MMSS y acondicionamiento del tronco (Kinesiterapia).', color: 'danger' },
                    { titulo: 'TERAPIA OCUPACIONAL', texto: 'Evaluaci√≥n y adaptaci√≥n del hogar y el entorno para permitir el uso seguro de la silla de ruedas (rampas, ancho de puertas).', color: 'danger' },
                    { titulo: 'INTERCONSULTA NUTRICI√ìN', texto: 'Urgente. Evaluar ingesta proteica y estado nutricional para favorecer la cicatrizaci√≥n y prevenir el deterioro muscular (Sarcopenia).', color: 'danger' },
                    { titulo: 'INTERCONSULTA M√âDICA', texto: 'Urgente con Especialista (Cirujano, Geriatra) para manejo del dolor, polifarmacia y manejo de comorbilidades agudas.', color: 'danger' },
                    { titulo: 'ENFERMER√çA', texto: 'Protocolo de inspecci√≥n de piel 3 veces al d√≠a y manejo avanzado de heridas (si existen). Entrenar a cuidadores.', color: 'danger' },
                    { titulo: 'CUIDADOR', texto: 'Se requiere cuidador 24 horas al d√≠a, capacitado en manejo de cambios posturales y transferencias seguras.', color: 'danger' },
                    { titulo: 'REVISI√ìN EX√ÅMENES CL√çNICOS', texto: 'Urgente. Revisar resultados de Hemograma, Glicemia, Electrolitos y funci√≥n renal. Considerar gases arteriales si hay compromiso respiratorio.', color: 'danger' },
                    { titulo: 'FECHA DE CONTROL PR√ìXIMO', texto: 'Control Interdisciplinar (M√©dico y Kinesi√≥logo) semanal, dadas las condiciones de criticidad y necesidad de ajustes inmediatos.', color: 'danger' }
                );
            } 
            else if (nivelRiesgoGlobal === 'ALTO') {
                recomendaciones.push(
                    { titulo: 'KINESIOLOG√çA/TERAPIA F√çSICA', texto: 'Intensiva. Foco en la reeducaci√≥n de la marcha con el andador, entrenamiento de equilibrio din√°mico y fortalecimiento espec√≠fico de m√∫sculos clave (Kinesiterapia).', color: 'danger' },
                    { titulo: 'TERAPIA OCUPACIONAL', texto: 'Adaptaci√≥n del entorno: instalaci√≥n de barras de apoyo en ba√±o, eliminaci√≥n de alfombras y optimizaci√≥n de iluminaci√≥n para reducir ca√≠das.', color: 'danger' },
                    { titulo: 'INTERCONSULTA M√âDICA', texto: 'Prioritaria. Revisi√≥n de polifarmacia, especialmente sedantes y antihipertensivos que puedan causar inestabilidad.', color: 'danger' },
                    { titulo: 'ENFERMER√çA/ATENCI√ìN DOMICILIARIA', texto: 'Monitoreo diario de la piel en puntos de presi√≥n. Educaci√≥n a paciente y familia sobre el uso correcto del dispositivo de ayuda t√©cnica.', color: 'warning' },
                    { titulo: 'NUTRICI√ìN', texto: 'Optimizaci√≥n de la hidrataci√≥n y soporte cal√≥rico-proteico si hay riesgo de √∫lcera o desnutrici√≥n.', color: 'warning' },
                    { titulo: 'PSICOLOG√çA', texto: 'Soporte emocional por la p√©rdida de autonom√≠a y miedo a caer (Ptofobia). Fomentar la participaci√≥n activa.', color: 'warning' },
                    { titulo: 'REVISI√ìN EX√ÅMENES CL√çNICOS', texto: 'Urgente. Evaluar Vitamina D, Calcio, B12 y perfil tiroideo, ya que son causas comunes de debilidad y riesgo de ca√≠da en adultos mayores.', color: 'danger' },
                    { titulo: 'FECHA DE CONTROL PR√ìXIMO', texto: 'Control Interdisciplinar (Kinesiolog√≠a y T. Ocupacional) cada 1-2 semanas hasta mejorar puntaje de Tinetti a >18. Control m√©dico mensual.', color: 'danger' }
                );
                if (iratScore >= 11) {
                    recomendaciones.push({ titulo: 'üö® Riesgo de Ca√≠da por IRAT ALTO', texto: 'Urgente: Revisi√≥n de la Agudeza Visual y eliminaci√≥n de calzado inestable. Uso de alarma personal.', color: 'danger' });
                }
            } 
            else if (nivelRiesgoGlobal === 'MODERADO') {
                recomendaciones.push(
                    { titulo: 'KINESIOLOG√çA/TERAPIA F√çSICA', texto: 'Moderada. Programa de ejercicios en casa (Ejercicios de Otago o similares) y reentrenamiento de la marcha con el bast√≥n para mejorar la confianza.', color: 'warning' },
                    { titulo: 'TERAPIA OCUPACIONAL', texto: 'Recomendaciones b√°sicas de seguridad en el hogar (cables, altura de sillas) y simplificaci√≥n de tareas diarias.', color: 'warning' },
                    { titulo: 'INTERCONSULTA M√âDICA', texto: 'Control. Revisi√≥n de polifarmacia, especialmente de ansiol√≠ticos e hipn√≥ticos. Seguimiento de la presi√≥n arterial y control de glicemia.', color: 'info' },
                    { titulo: 'CUIDADO', texto: 'Fomentar la autonom√≠a, pero con supervisi√≥n intermitente. El paciente debe ser capaz de realizar la mayor√≠a de las AVD por s√≠ mismo.', color: 'info' },
                    { titulo: 'EDUCACI√ìN', texto: 'Ense√±ar al paciente t√©cnicas para levantarse del suelo de forma segura en caso de ca√≠da (si es viable).', color: 'info' },
                    { titulo: 'EQUILIBRIO', texto: 'Realizar ejercicios de equilibrio sobre una pierna (con apoyo) 3 veces por semana para mejorar la estabilidad y reflejos.', color: 'warning' },
                    { titulo: 'REVISI√ìN EX√ÅMENES CL√çNICOS', texto: 'Control de rutina. Verificar Hemoglobina y Ferritina (anemia), y Creatinina (funci√≥n renal) como factores de riesgo de fatiga y ca√≠da.', color: 'info' },
                    { titulo: 'FECHA DE CONTROL PR√ìXIMO', texto: 'Control Kinesiol√≥gico y Terapia Ocupacional cada 4-6 semanas. Reevaluaci√≥n global en 3 meses.', color: 'warning' }
                );
            }
            else if (nivelRiesgoGlobal === 'BAJO') {
                recomendaciones.push(
                    { titulo: 'KINESIOLOG√çA/TERAPIA F√çSICA', texto: 'Preventiva. Mantener un programa de actividad f√≠sica regular (caminatas, Tai Chi) que incluya fortalecimiento y estiramientos.', color: 'success' },
                    { titulo: 'TERAPIA OCUPACIONAL', texto: 'Chequeo anual de riesgos ergon√≥micos y de ca√≠das. Mantener los objetos de uso diario a la altura accesible.', color: 'success' },
                    { titulo: 'CONTROL M√âDICO', texto: 'Control anual para revisi√≥n de audici√≥n y visi√≥n. Fomentar vacunaci√≥n anual contra la influenza y neumococo.', color: 'success' },
                    { titulo: 'NUTRICI√ìN', texto: 'Dieta balanceada rica en calcio y Vitamina D. Ingesta adecuada de l√≠quidos.', color: 'success' },
                    { titulo: 'AUTOCUIDADO', texto: 'Uso de calzado firme y cerrado. Evitar el sedentarismo y fomentar la participaci√≥n social activa.', color: 'success' },
                    { titulo: 'REVISI√ìN EX√ÅMENES CL√çNICOS', texto: 'De rutina. Revisar Perfil Lip√≠dico y Glicemia anualmente. Considerar Densitometr√≠a √ìsea seg√∫n edad y factores de riesgo.', color: 'success' },
                    { titulo: 'FECHA DE CONTROL PR√ìXIMO', texto: 'Reevaluaci√≥n de Tinetti, IRAT y Norton de manera anual o ante cualquier cambio de salud significativo.', color: 'success' }
                );
            }
            
            // Re-evaluar el nivel de riesgo global final
            if (recomendaciones.some(r => r.color === 'danger')) {
                colorGlobal = 'danger';
                if (nivelRiesgoGlobal !== 'CR√çTICO') nivelRiesgoGlobal = 'ALTO';
            } else if (recomendaciones.some(r => r.color === 'warning')) {
                colorGlobal = 'warning';
                if (nivelRiesgoGlobal === 'BAJO') nivelRiesgoGlobal = 'MODERADO';
            } else {
                colorGlobal = 'success';
            }


            return { 
                nivelRiesgoGlobal: nivelRiesgoGlobal, 
                colorGlobal: colorGlobal.toUpperCase(), 
                recomendaciones: recomendaciones 
            };
        }

        // ------------------------------------------------------------------
        // L√ìGICA DE UI Y RESULTADOS (AJUSTADA PARA NUEVOS ESTILOS)
        // ------------------------------------------------------------------

        function generarResultados() {
            calcularIRAT();
            const tinettiScore = calcularTinetti(false);
            const nortonScore = calcularNorton();
            const iratScore = parseInt(document.getElementById('puntaje-irat').textContent);

            const clasificacion = getCombinedClinicalClassification(iratScore, tinettiScore, nortonScore);
            
            let iratRiesgoTexto;
            let iratRiesgoClase;
            if (iratScore <= 6) {
                iratRiesgoTexto = 'Riesgo Bajo';
                iratRiesgoClase = 'risk-success';
            } else if (iratScore >= 7 && iratScore <= 10) {
                iratRiesgoTexto = 'Riesgo Moderado';
                iratRiesgoClase = 'risk-warning';
            } else {
                iratRiesgoTexto = 'Riesgo Alto';
                iratRiesgoClase = 'risk-danger';
            }

            const nortonRiesgoTexto = nortonScore <= 14 ? 'Riesgo Alto de √ölcera' : 'Riesgo Bajo de √ölcera';
            const nortonRiesgoClase = nortonScore <= 14 ? 'risk-danger' : 'risk-success';

            // 4. Actualizar Resumen de Puntajes
            document.getElementById('res-nombre').textContent = document.getElementById('nombre').value || 'Sin nombre';
            document.getElementById('res-fecha').textContent = document.getElementById('fecha').value || 'N/A';
            document.getElementById('res-irat-total').textContent = iratScore;
            document.getElementById('res-irat-riesgo').textContent = iratRiesgoTexto;
            document.getElementById('res-irat-riesgo').className = `resultado-valor ${iratRiesgoClase}`;
            document.getElementById('res-tinetti-total').textContent = `${tinettiScore} / 28`;
            document.getElementById('res-norton-total').textContent = `${nortonScore} / 20`;
            document.getElementById('res-norton-riesgo').textContent = nortonRiesgoTexto;
            document.getElementById('res-norton-riesgo').className = `resultado-valor ${nortonRiesgoClase}`;

            // 5. Actualizar Resumen Global
            const globalRiesgoElement = document.getElementById('res-global-riesgo');
            globalRiesgoElement.textContent = clasificacion.nivelRiesgoGlobal;
            globalRiesgoElement.className = `resultado-valor risk-${clasificacion.colorGlobal.toLowerCase()}`;
            
            // Aplicar estilo de caja destacada para el resumen global
            const globalSummaryBox = document.querySelector('.result-box.global-summary');
            globalSummaryBox.style.borderTopColor = `var(--color-${clasificacion.colorGlobal.toLowerCase()})`;
            globalSummaryBox.style.borderColor = `var(--color-${clasificacion.colorGlobal.toLowerCase()})`;

            // 6. Mostrar las tarjetas de recomendaci√≥n en la UI
            const recContainer = document.getElementById('recomendaciones-irat');
            recContainer.innerHTML = '';
            
            clasificacion.recomendaciones.forEach(rec => {
                const card = document.createElement('div');
                card.className = `recommendation-card rec-${rec.color}`;
                card.innerHTML = `<strong><i class="fas fa-arrow-right"></i> ${rec.titulo}</strong><p>${rec.texto}</p>`;
                recContainer.appendChild(card);
            });
            
            document.getElementById('results-section').style.display = 'block';

            // 7. Guardar el informe final para PDF/Compartir
            lastReportData = {
                nombre: document.getElementById('nombre').value,
                fecha: document.getElementById('fecha').value,
                evaluador: document.getElementById('evaluador').value,
                iratScore: iratScore,
                iratRiesgo: iratRiesgoTexto,
                tinettiScore: tinettiScore,
                nortonScore: nortonScore,
                nortonRiesgo: nortonRiesgoTexto,
                clasificacionGlobal: clasificacion.nivelRiesgoGlobal,
                recomendaciones: clasificacion.recomendaciones,
                // Guardar los inputs SELECT para poder cargar el reporte completo
                iratInputs: ['amputacion', 'visual', 'polifarmacia', 'farmacos', 'caida'].map(id => ({ id: id, value: document.getElementById(id).value })),
                nortonInputs: ['norton-fisica', 'norton-mental', 'norton-actividad', 'norton-movilidad', 'norton-incontinencia'].map(id => ({ id: id, value: document.getElementById(id).value })),
                tinettiInputs: [...document.querySelectorAll('#tinetti-section select')].map(select => ({ name: select.name, value: select.value }))
            };
        }

        // ------------------------------------------------------------------
        // MANEJO DE FIRESTORE (AJUSTADO PARA EL NUEVO INPUT TINNETI)
        // ------------------------------------------------------------------

        async function saveReport() {
            if (!currentUser) {
                showNotification('Debe iniciar sesi√≥n para guardar una evaluaci√≥n.', 'error');
                return;
            }
            if (!lastReportData.nombre || !lastReportData.fecha) {
                showNotification('Primero debe generar los resultados (datos de paciente y fecha).', 'warning');
                return;
            }

            try {
                await db.collection('evaluaciones').add({
                    userId: currentUserId,
                    ...lastReportData,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                showNotification('Evaluaci√≥n guardada exitosamente.', 'success');
                loadHistorial(); 
            } catch (error) {
                console.error("Error al guardar la evaluaci√≥n:", error);
                showNotification(`Error al guardar: ${error.message}`, 'error');
            }
        }

        async function loadHistorial(forceRefresh = false) {
            if (!currentUserId) return;
            const historialList = document.getElementById('historial-list');
            historialList.innerHTML = '<li id="loading-history-msg">Cargando historial...</li>';

            try {
                const snapshot = await db.collection('evaluaciones')
                    .where('userId', '==', currentUserId)
                    .orderBy('timestamp', 'desc')
                    .limit(50) 
                    .get();

                historialList.innerHTML = ''; 
                if (snapshot.empty) {
                    historialList.innerHTML = '<li>No hay evaluaciones guardadas.</li>';
                    return;
                }

                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const li = document.createElement('li');
                    const date = data.fecha ? new Date(data.fecha + 'T00:00:00').toLocaleDateString() : 'Fecha N/A';
                    
                    li.innerHTML = `
                        <span><strong>${data.nombre || 'Sin Nombre'}</strong> - ${date}</span>
                        <div>
                            <button class="btn-secondary" style="margin-right: 5px;" onclick="viewReport('${doc.id}')">
                                <i class="fas fa-eye"></i> Ver
                            </button>
                            <button class="btn-danger" onclick="deleteReport('${doc.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    historialList.appendChild(li);
                });
            } catch (error) {
                console.error("Error al cargar el historial:", error);
                historialList.innerHTML = `<li>Error al cargar: ${error.message}</li>`;
                showNotification(`Error al cargar el historial: ${error.message}`, 'error', 5000);
            }
        }
        
        async function viewReport(docId) {
            try {
                const doc = await db.collection('evaluaciones').doc(docId).get();
                if (!doc.exists) {
                    showNotification('El reporte solicitado no existe.', 'error');
                    return;
                }
                const data = doc.data();

                resetForm();

                document.getElementById('nombre').value = data.nombre || '';
                document.getElementById('fecha').value = data.fecha || '';
                document.getElementById('evaluador').value = data.evaluador || '';

                (data.iratInputs || []).forEach(input => {
                    const element = document.getElementById(input.id);
                    if (element) element.value = input.value;
                });
                
                (data.nortonInputs || []).forEach(input => {
                    const element = document.getElementById(input.id);
                    if (element) element.value = input.value;
                });

                // 5. Cargar Tinetti (usando selects)
                (data.tinettiInputs || []).forEach(input => {
                    const select = document.querySelector(`#tinetti-section select[name="${input.name}"]`);
                    if (select) select.value = input.value;
                });
                
                generarResultados();
                showNotification(`Evaluaci√≥n de ${data.nombre} cargada.`, 'info');
                document.querySelector('#results-section').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                console.error("Error al cargar el reporte:", error);
                showNotification(`Error al ver reporte: ${error.message}`, 'error');
            }
        }


        async function deleteReport(docId) {
            if (!confirm('¬øEst√° seguro de que desea eliminar esta evaluaci√≥n?')) {
                return;
            }

            try {
                await db.collection('evaluaciones').doc(docId).delete();
                showNotification('Evaluaci√≥n eliminada.', 'success');
                loadHistorial(); 
            } catch (error) {
                console.error("Error al eliminar la evaluaci√≥n:", error);
                showNotification(`Error al eliminar: ${error.message}`, 'error');
            }
        }
        
        function confirmAndClearHistorial() {
            if (confirm("üö® ATENCI√ìN: Esta acci√≥n eliminar√° *TODAS* las evaluaciones (evaluaciones de *todos* los usuarios) de Firestore. ¬øEst√° seguro?")) {
                clearAllHistorial();
            }
        }

        async function clearAllHistorial() {
            if (!currentUser) {
                showNotification('Debe iniciar sesi√≥n para realizar esta acci√≥n.', 'error');
                return;
            }

            const isAdmin = await checkAdminStatus(currentUser.uid);
            if (!isAdmin) {
                showNotification('Acceso denegado. Solo administradores pueden limpiar el historial.', 'error');
                return;
            }

            showNotification('Iniciando limpieza de historial...', 'warning', 10000);

            try {
                const batch = db.batch();
                let deletedCount = 0;
                let batchLimit = 500;
                let snapshot;

                do {
                    snapshot = await db.collection('evaluaciones').limit(batchLimit).get();
                    if (snapshot.size === 0) break;

                    snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });

                    await batch.commit();
                    deletedCount += snapshot.size;
                    
                    if (snapshot.size === batchLimit) {
                         continue; 
                    }

                } while (snapshot.size > 0);
                
                showNotification(`Se eliminaron ${deletedCount} evaluaciones. Recargando historial...`, 'success', 5000);
                loadHistorial(true);

            } catch (error) {
                console.error("Error al limpiar el historial:", error);
                showNotification(`Error cr√≠tico al limpiar el historial: ${error.message}`, 'error', 10000);
            }
        }


        // ------------------------------------------------------------------
        // UTILIDADES DE UI (AJUSTADAS)
        // ------------------------------------------------------------------
        
        function showNotification(message, type = 'info', duration = 3000) {
            const bar = document.getElementById('notification-bar');
            bar.textContent = message;
            bar.className = `notification-bar notification-${type}`;
            bar.style.display = 'block';

            setTimeout(() => {
                bar.style.display = 'none';
            }, duration);
        }

        function resetForm() {
            document.getElementById('nombre').value = '';
            document.getElementById('fecha').value = '';
            document.getElementById('evaluador').value = '';
            
            // Resetear todos los selects a la primera opci√≥n (√≠ndice 0)
            document.querySelectorAll('select').forEach(select => select.selectedIndex = 0);
            
            // Recalcular para asegurar que los puntajes de la UI se actualizan a 0/20
            calcularIRAT();
            calcularTinetti();
            calcularNorton();

            document.getElementById('results-section').style.display = 'none';
        }

        // ------------------------------------------------------------------
        // GENERACI√ìN DE PDF (MANTENIDA)
        // ------------------------------------------------------------------

        function generatePDF() {
            if (!lastReportData || !lastReportData.nombre) {
                showNotification('Primero genere los resultados para crear el PDF.', 'warning');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let y = 15;
            const margin = 15;
            const lineHeight = 7;
            const sectionMargin = 10;
            const pageWidth = doc.internal.pageSize.width;

            // T√≠tulo
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(18);
            doc.setTextColor(30, 60, 114); // Azul oscuro
            doc.text("INFORME DE EVALUACI√ìN CL√çNICA INTEGRADA", pageWidth / 2, y, { align: 'center' });
            y += lineHeight * 2;

            // Datos Generales
            doc.setFontSize(12);
            doc.setTextColor(51, 51, 51);
            doc.setFont('helvetica', 'normal');
            doc.text(`Paciente: ${lastReportData.nombre}`, margin, y);
            doc.text(`Fecha de Evaluaci√≥n: ${lastReportData.fecha}`, pageWidth / 2, y);
            y += lineHeight;
            doc.text(`Evaluador: ${lastReportData.evaluador || 'N/A'}`, margin, y);
            y += sectionMargin;

            // T√≠tulos de Secciones
            const drawSectionTitle = (text, color) => {
                doc.setFillColor(color[0], color[1], color[2]);
                doc.rect(margin, y - 5, pageWidth - margin * 2, 7, 'F');
                doc.setTextColor(255, 255, 255);
                doc.text(text, margin + 2, y);
                doc.setTextColor(51, 51, 51);
                doc.setFont('helvetica', 'bold');
                y += lineHeight;
            };

            // Secci√≥n de Puntajes
            drawSectionTitle("PUNTAJES OBTENIDOS", [30, 60, 114]);
            doc.setFont('helvetica', 'normal');
            
            doc.text(`IRAT-5 (Ca√≠da/Amputaci√≥n): ${lastReportData.iratScore} | Riesgo: ${lastReportData.iratRiesgo}`, margin, y);
            y += lineHeight;
            doc.text(`Tinetti (Marcha/Equilibrio): ${lastReportData.tinettiScore} / 28`, margin, y);
            y += lineHeight;
            doc.text(`Norton (√ölcera por Presi√≥n): ${lastReportData.nortonScore} / 20 | Riesgo: ${lastReportData.nortonRiesgo}`, margin
