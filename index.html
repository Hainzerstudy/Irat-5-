<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Índice Clínico de Ayuda Técnica (ICAT)</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background:#eef2f7;
  padding:20px;
}
.container {
  max-width:1400px;
  margin:auto;
  background:white;
  border-radius:12px;
  padding:30px;
}
.card {
  background:#f8f9ff;
  padding:20px;
  border-radius:10px;
  margin-bottom:20px;
}
button {
  padding:10px 15px;
  border:none;
  border-radius:6px;
  cursor:pointer;
}
.primary { background:#3949ab; color:white; }
.success { background:#2e7d32; color:white; }
.secondary { background:#546e7a; color:white; }
pre { background:#eee; padding:15px; }
</style>
</head>

<body>

<div class="container">
<h1>Índice Clínico de Ayuda Técnica (ICAT)</h1>
<p><b>Versión del instrumento:</b> ICAT v1.0 – Uso clínico e investigativo</p>

<div class="card">
<h3>Datos (anonimizables)</h3>
<input id="codigo" placeholder="Código del paciente (no RUT)">
<input id="edad" type="number" placeholder="Edad">
<input id="sexo" placeholder="Sexo">
<input id="evaluador" placeholder="Evaluador">
<input id="fecha" type="date">
</div>

<div class="card">
<h3>Escalas</h3>
<label>IRAT</label>
<input type="number" id="irat" value="0">
<label>Tinetti</label>
<input type="number" id="tinetti" value="0">
<label>Norton</label>
<input type="number" id="norton" value="0">
</div>

<button class="primary" onclick="calcularICAT()">Calcular ICAT</button>

<div class="card" id="resultados" style="display:none">
<h3>Resultados</h3>
<pre id="resumen"></pre>
<button class="primary" onclick="generarPDF()">PDF</button>
<button class="success" onclick="guardar()">Guardar</button>
<button class="secondary" onclick="exportarCSV()">Exportar CSV</button>
</div>

<div class="card">
<h3>Historial (últimas 10)</h3>
<ul id="historial"></ul>
</div>

</div>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyDJbtRuEwWVAsC1Nz6LbeF5a99LcUfAz4g",
  authDomain: "irat-5-evaluaciones.firebaseapp.com",
  projectId: "irat-5-evaluaciones"
});
const db = firebase.firestore();

/* ================= VARIABLES ================= */
let evaluacion = null;

/* ================= CÁLCULO ICAT ================= */
function calcularICAT() {

  const irat = parseInt(irat.value)||0;
  const tinetti = parseInt(tinetti.value)||0;
  const norton = parseInt(norton.value)||0;

  const iratNorm = (irat / 20) * 100;
  const tinettiNorm = ((28 - tinetti) / 28) * 100;
  const nortonNorm = ((20 - norton) / 20) * 100;

  const ICAT =
    iratNorm * 0.40 +
    tinettiNorm * 0.35 +
    nortonNorm * 0.25;

  let nivel, ayuda, fundamento;

  if (ICAT < 20) {
    nivel = "Muy bajo";
    ayuda = "No requiere ayuda técnica";
    fundamento = "Adecuada funcionalidad y bajo riesgo de caída y dependencia.";
  } else if (ICAT < 40) {
    nivel = "Bajo";
    ayuda = "Bastón";
    fundamento = "Leve compromiso funcional o de equilibrio.";
  } else if (ICAT < 60) {
    nivel = "Moderado";
    ayuda = "Andador";
    fundamento = "Compromiso funcional y riesgo de caída significativo.";
  } else if (ICAT < 80) {
    nivel = "Alto";
    ayuda = "Silla de ruedas";
    fundamento = "Alta dependencia funcional y riesgo de lesiones.";
  } else {
    nivel = "Muy alto";
    ayuda = "Ayuda técnica compleja / evaluación especializada";
    fundamento = "Dependencia severa y alto riesgo clínico.";
  }

  evaluacion = {
    instrumento: "ICAT",
    version: "1.0",
    paciente: {
      codigo: codigo.value,
      edad: edad.value,
      sexo: sexo.value
    },
    evaluador: evaluador.value,
    fecha: fecha.value,
    escalas: { irat, tinetti, norton },
    ICAT: ICAT.toFixed(1),
    nivel,
    ayuda,
    fundamento,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  };

  resultados.style.display="block";
  resumen.textContent =
`ICAT: ${ICAT.toFixed(1)}
Nivel: ${nivel}
Ayuda recomendada: ${ayuda}

Fundamento clínico:
${fundamento}`;
}

/* ================= PDF ================= */
function generarPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  let y = 20;
  doc.setFontSize(16);
  doc.text("Índice Clínico de Ayuda Técnica (ICAT)", 105, y, {align:"center"});
  y+=20;

  doc.setFontSize(12);
  doc.text(`Código paciente: ${evaluacion.paciente.codigo}`,20,y); y+=8;
  doc.text(`Edad: ${evaluacion.paciente.edad}`,20,y); y+=8;
  doc.text(`Sexo: ${evaluacion.paciente.sexo}`,20,y); y+=8;
  doc.text(`Evaluador: ${evaluacion.evaluador}`,20,y); y+=8;
  doc.text(`Fecha: ${evaluacion.fecha}`,20,y); y+=15;

  doc.text(`IRAT: ${evaluacion.escalas.irat}`,20,y); y+=8;
  doc.text(`Tinetti: ${evaluacion.escalas.tinetti}`,20,y); y+=8;
  doc.text(`Norton: ${evaluacion.escalas.norton}`,20,y); y+=15;

  doc.text(`ICAT: ${evaluacion.ICAT}`,20,y); y+=8;
  doc.text(`Nivel: ${evaluacion.nivel}`,20,y); y+=8;
  doc.text(`Ayuda recomendada: ${evaluacion.ayuda}`,20,y); y+=12;

  doc.text("Fundamento clínico:",20,y); y+=8;
  doc.text(evaluacion.fundamento,20,y,{maxWidth:170});

  doc.save(`ICAT_${evaluacion.paciente.codigo}.pdf`);
}

/* ================= FIRESTORE ================= */
async function guardar() {
  await db.collection("ICAT_evaluaciones").add(evaluacion);
  alert("Evaluación guardada");
  cargarHistorial();
}

/* ================= HISTORIAL ================= */
async function cargarHistorial() {
  historial.innerHTML="";
  const snap = await db.collection("ICAT_evaluaciones")
    .orderBy("timestamp","desc").limit(10).get();

  snap.forEach(d=>{
    const li=document.createElement("li");
    const e=d.data();
    li.textContent = `${e.paciente.codigo} – ICAT ${e.ICAT} (${e.nivel})`;
    historial.appendChild(li);
  });
}
cargarHistorial();

/* ================= CSV ================= */
function exportarCSV() {
  const csv = Object.entries(evaluacion)
    .map(([k,v])=>`${k},${JSON.stringify(v)}`).join("\n");
  const blob = new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="ICAT.csv";
  a.click();
}
</script>

</body>
</html>
