<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluación Clínica Integral</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-bg: #f8f9fa;
            --dark-bg: #343a40;
            --border-color: #dee2e6;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--light-bg);
            color: var(--dark-bg);
        }

        /* --- Estilos de Autenticación (Login) --- */
        #login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-color), #0056b3);
        }

        #auth-form-container {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
        }
        
        #auth-error-message {
            color: var(--danger-color);
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
            display: none;
        }

        /* --- Layout Principal --- */
        #main-app-container {
            display: none; /* Oculto por defecto, se muestra al iniciar sesión */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            margin: 0;
            font-size: 1.5em;
        }

        #user-display {
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #user-display i {
            font-size: 1.2em;
        }

        /* --- Barra de Navegación --- */
        nav {
            background-color: var(--dark-bg);
            color: white;
            padding: 10px 0;
            display: flex;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 10px 20px;
            cursor: pointer;
            text-align: center;
            flex-shrink: 0;
            border-bottom: 3px solid transparent;
            transition: background-color 0.3s, border-bottom-color 0.3s;
        }

        .nav-tab:hover {
            background-color: #495057;
        }

        .nav-tab.active {
            background-color: var(--primary-color);
            border-bottom-color: var(--warning-color);
        }

        /* --- Contenido Principal --- */
        main {
            flex-grow: 1;
            padding: 20px;
            background-color: white;
        }

        .section {
            display: none;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
        }

        .section.active {
            display: block;
        }

        .section h2 {
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-top: 0;
            color: var(--primary-color);
        }

        /* --- Formularios y Controles --- */
        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
            outline: none;
        }

        .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .radio-option {
            background-color: var(--light-bg);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            flex-grow: 1;
            text-align: center;
        }

        .radio-option:hover {
            background-color: #e9ecef;
        }
        
        .radio-option input[type="radio"] {
            display: none;
        }

        .radio-option input[type="radio"]:checked + label {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .form-check {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        /* --- Botones --- */
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s, opacity 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: #0056b3;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background-color: #1e7e34;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background-color: #bd2130;
        }
        
        .btn-info {
            background-color: var(--info-color);
            color: white;
        }

        .btn-info:hover:not(:disabled) {
            background-color: #117a8b;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        .btn-group-center {
            justify-content: center;
        }

        /* --- Resultados y Riesgos --- */
        .results-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .result-box {
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .result-box strong {
            display: block;
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .low-risk {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .medium-risk {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .high-risk {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        #recomendaciones-lista {
            list-style: disc inside;
            padding-left: 20px;
        }
        
        #recomendaciones-lista li {
            margin-bottom: 8px;
            line-height: 1.4;
            border-left: 3px solid var(--primary-color);
            padding-left: 10px;
        }

        /* --- Historial --- */
        .historial-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--light-bg);
            margin-bottom: 8px;
            border-radius: 5px;
        }

        .historial-item:last-child {
            border-bottom: none;
        }

        .historial-info strong {
            display: block;
            font-size: 1.1em;
            color: var(--primary-color);
        }

        .historial-info span {
            font-size: 0.85em;
            color: var(--secondary-color);
        }

        .historial-actions button {
            margin-left: 10px;
        }
        
        .filters-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        
        .filters-container .form-group {
            flex: 1;
            min-width: 150px;
            margin-bottom: 0;
        }
        
        #pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
        }

        /* --- Utilidades --- */
        .text-center {
            text-align: center;
        }

        .text-danger {
            color: var(--danger-color);
            font-size: 0.85em;
            display: block;
            margin-top: 5px;
        }
        
        .firebase-status {
            font-size: 0.8em;
            padding: 5px 10px;
            border-radius: 4px;
            margin-left: 10px;
        }
        
        .firebase-connected {
            background-color: #d4edda;
            color: #155724;
        }

        .firebase-disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* --- Notificación Flotante --- */
        #notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            border-radius: 8px;
            color: white;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            font-weight: 600;
        }

        #notification.success {
            background-color: var(--success-color);
        }

        #notification.error {
            background-color: var(--danger-color);
        }

        #notification.info {
            background-color: var(--info-color);
        }
        
        /* Media Queries para responsividad */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 10px;
            }
            .nav-tab {
                padding: 10px 10px;
                font-size: 0.9em;
            }
            .btn-group {
                flex-direction: column;
                gap: 5px;
            }
            .filters-container {
                flex-direction: column;
                gap: 10px;
            }
            .filters-container .form-group {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <div id="auth-form-container">
            <h2 class="text-center" id="auth-title">Iniciar Sesión</h2>
            <p id="auth-error-message"></p>
            <form id="auth-form" data-mode="login">
                <div class="form-group">
                    <label for="auth-email" class="form-label">Email</label>
                    <input type="email" id="auth-email" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="auth-password" class="form-label">Contraseña</label>
                    <input type="password" id="auth-password" class="form-control" required>
                </div>
                <button type="submit" id="auth-submit-btn" class="btn btn-primary form-control mt-3">
                    <i class="fas fa-sign-in-alt"></i> Iniciar Sesión
                </button>
            </form>
            <p class="text-center mt-3">
                <a href="#" id="toggle-auth-mode">¿No tienes cuenta? Regístrate aquí</a>
            </p>
        </div>
    </div>

    <div id="main-app-container">
        
        <header>
            <h1><i class="fas fa-notes-medical"></i> Evaluación Clínica Digital</h1>
            <div id="user-display">
                <span></span>
                <span id="firebase-status" class="firebase-status firebase-disconnected">
                    <i class="fas fa-database"></i> Desconectado
                </span>
                <button id="btn-logout" class="btn btn-danger btn-sm">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                </button>
            </div>
        </header>

        <nav>
            <div class="nav-tab active" data-section="identificacion"><i class="fas fa-user-tag"></i> Identificación</div>
            <div class="nav-tab" data-section="evaluacion"><i class="fas fa-scale-balanced"></i> IRAT-5 (Complicaciones)</div>
            <div class="nav-tab" data-section="tinetti"><i class="fas fa-walking"></i> Tinetti (Caídas)</div>
            <div class="nav-tab" data-section="norton"><i class="fas fa-bed"></i> Norton (Úlceras)</div>
            <div class="nav-tab" data-section="resultados"><i class="fas fa-chart-line"></i> Resultados</div>
            <div class="nav-tab" data-section="historial"><i class="fas fa-history"></i> Historial</div>
            <button id="btn-nueva-evaluacion" class="btn btn-info btn-sm" onclick="iniciarNuevaEvaluacion()">
                <i class="fas fa-plus"></i> Nueva Evaluación
            </button>
        </nav>

        <main>
            
            <section id="identificacion" class="section active">
                <h2>Datos del Paciente y Evaluación</h2>
                <div class="form-group">
                    <label for="nombre" class="form-label">Nombre Completo (*)</label>
                    <input type="text" id="nombre" class="form-control" required>
                    <span id="error-nombre" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label for="rut" class="form-label">RUT / Identificación</label>
                    <input type="text" id="rut" class="form-control">
                </div>
                <div class="form-group">
                    <label for="edad" class="form-label">Edad (Años)</label>
                    <input type="number" id="edad" class="form-control" min="0">
                </div>
                <div class="form-group">
                    <label for="sexo" class="form-label">Sexo</label>
                    <select id="sexo" class="form-control">
                        <option value="F">Femenino</option>
                        <option value="M">Masculino</option>
                        <option value="O">Otro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="fecha" class="form-label">Fecha de Evaluación (*)</label>
                    <input type="date" id="fecha" class="form-control" required>
                    <span id="error-fecha" class="text-danger"></span>
                </div>
                <hr>
                <div class="form-group">
                    <label for="evaluador" class="form-label">Nombre del Evaluador (*)</label>
                    <input type="text" id="evaluador" class="form-control" required>
                    <span id="error-evaluador" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label for="institucion" class="form-label">Institución/Servicio</label>
                    <input type="text" id="institucion" class="form-control">
                </div>
                <div class="form-group">
                    <label for="historia-clinica" class="form-label">Historia Clínica / Notas</label>
                    <textarea id="historia-clinica" class="form-control" rows="3"></textarea>
                </div>
                <div class="btn-group">
                    <button id="siguiente-irat" class="btn btn-primary">Siguiente: IRAT-5 <i class="fas fa-arrow-right"></i></button>
                </div>
            </section>

            <section id="evaluacion" class="section">
                <h2>Escala IRAT-5 (Riesgo de Complicaciones Clínicas)</h2>
                <p>Puntaje Mínimo: 0 | Puntaje Máximo: 10</p>
                <div id="irat-form">
                    <h3>Cargando preguntas de IRAT-5...</h3>
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="cambiarSeccion('identificacion')"><i class="fas fa-arrow-left"></i> Anterior</button>
                    <button id="siguiente-tinetti" class="btn btn-primary">Siguiente: Tinetti <i class="fas fa-arrow-right"></i></button>
                </div>
            </section>

            <section id="tinetti" class="section">
                <h2>Escala de Equilibrio y Marcha de Tinetti (Riesgo de Caída)</h2>
                <p>Puntaje Mínimo: 0 | Puntaje Máximo: 28</p>
                
                <div class="form-check">
                    <input type="checkbox" id="tinetti-no-evaluable" class="form-control" style="width: auto;">
                    <label for="tinetti-no-evaluable" class="form-label" style="margin-bottom: 0;">
                        El paciente no puede realizar la prueba (ej. encamado, inconsciente).
                    </label>
                </div>

                <hr>
                
                <h3>A. Equilibrio (Máx 16 puntos)</h3>
                <div id="tinetti-equilibrio-form">
                     <p class="text-center">Cargando preguntas de Equilibrio...</p>
                </div>

                <hr>
                
                <h3>B. Marcha (Máx 12 puntos)</h3>
                <div id="tinetti-marcha-form">
                    <p class="text-center">Cargando preguntas de Marcha...</p>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="cambiarSeccion('evaluacion')"><i class="fas fa-arrow-left"></i> Anterior</button>
                    <button id="siguiente-norton" class="btn btn-primary">Siguiente: Norton <i class="fas fa-arrow-right"></i></button>
                </div>
            </section>

            <section id="norton" class="section">
                <h2>Escala de Norton (Riesgo de Úlcera por Presión)</h2>
                <p>Puntaje Mínimo: 5 | Puntaje Máximo: 20</p>
                
                <div class="form-group">
                    <label for="norton-fisico" class="form-label">1. Condición Física</label>
                    <select id="norton-fisico" class="form-control" required>
                        <option value="4">Buena (4 pts)</option>
                        <option value="3">Regular (3 pts)</option>
                        <option value="2">Mala (2 pts)</option>
                        <option value="1">Muy Mala (1 pt)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="norton-mental" class="form-label">2. Estado Mental</label>
                    <select id="norton-mental" class="form-control" required>
                        <option value="4">Alerta (4 pts)</option>
                        <option value="3">Apático (3 pts)</option>
                        <option value="2">Confuso (2 pts)</option>
                        <option value="1">Estuporoso (1 pt)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="norton-actividad" class="form-label">3. Actividad</label>
                    <select id="norton-actividad" class="form-control" required>
                        <option value="4">Deambula (4 pts)</option>
                        <option value="3">Camina con ayuda (3 pts)</option>
                        <option value="2">Sentado/a (2 pts)</option>
                        <option value="1">Encamado/a (1 pt)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="norton-movilidad" class="form-label">4. Movilidad</label>
                    <select id="norton-movilidad" class="form-control" required>
                        <option value="4">Total (4 pts)</option>
                        <option value="3">Disminuida (3 pts)</option>
                        <option value="2">Muy Limitada (2 pts)</option>
                        <option value="1">Inmóvil (1 pt)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="norton-incontinencia" class="form-label">5. Incontinencia</label>
                    <select id="norton-incontinencia" class="form-control" required>
                        <option value="4">Ninguna (4 pts)</option>
                        <option value="3">Ocasional (3 pts)</option>
                        <option value="2">Urinaria y/o Fecal (2 pts)</option>
                        <option value="1">Doble (1 pt)</option>
                    </select>
                </div>
                
                <div id="resultado-norton" class="result-box mt-4 medium-risk">
                    <strong>Puntaje Norton Actual</strong>
                    <p>Total: <span id="norton-score">20</span> / 20</p>
                    <p>Riesgo: <span id="norton-riesgo">Riesgo BAJO (Puntaje ≥ 15)</span></p>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="cambiarSeccion('tinetti')"><i class="fas fa-arrow-left"></i> Anterior</button>
                    <button id="siguiente-resultados" class="btn btn-success">Calcular y Ver Resultados <i class="fas fa-chart-bar"></i></button>
                </div>
            </section>

            <section id="resultados" class="section">
                <h2>Resultados e Intervenciones Sugeridas</h2>
                
                <div class="alert alert-info" style="background: var(--info-color); color: white; padding: 10px; border-radius: 5px;">
                    <i class="fas fa-user-check"></i> Paciente: <strong id="resumen-nombre">N/A</strong> | RUT: <span id="resumen-rut">N/A</span> | Fecha: <span id="resumen-fecha">N/A</span>
                </div>

                <h3>Puntajes Resumen</h3>
                <div class="results-container">
                    <div id="resumen-irat" class="result-box low-risk">
                        <p>Cargando...</p>
                    </div>
                    <div id="resumen-tinetti" class="result-box medium-risk">
                        <p>Cargando...</p>
                    </div>
                    <div id="resumen-norton-final" class="result-box high-risk">
                        <p>Cargando...</p>
                    </div>
                </div>

                <h3>Plan de Acción y Recomendaciones</h3>
                <ul id="recomendaciones-lista">
                    <li>Recomendaciones se generarán al calcular los resultados.</li>
                </ul>

                <div class="btn-group btn-group-center">
                    <button id="btn-descargar-pdf" class="btn btn-danger"><i class="fas fa-file-pdf"></i> Descargar PDF</button>
                    <button id="btn-guardar" class="btn btn-primary"><i class="fas fa-save"></i> Guardar en Historial</button>
                    <button id="btn-whatsapp" class="btn btn-success" style="background-color: #25D366;"><i class="fab fa-whatsapp"></i> Compartir Resumen</button>
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="cambiarSeccion('norton')"><i class="fas fa-arrow-left"></i> Anterior</button>
                </div>
            </section>

            <section id="historial" class="section">
                <h2>Historial de Evaluaciones</h2>
                
                <div class="filters-container">
                    <div class="form-group">
                        <label for="filter-nombre" class="form-label">Filtrar por Nombre</label>
                        <input type="text" id="filter-nombre" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="filter-fecha-desde" class="form-label">Fecha Desde</label>
                        <input type="date" id="filter-fecha-desde" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="filter-fecha-hasta" class="form-label">Fecha Hasta</label>
                        <input type="date" id="filter-fecha-hasta" class="form-control">
                    </div>
                    <button id="btn-aplicar-filtros" class="btn btn-primary" style="align-self: flex-start; margin-top: 10px;">
                        <i class="fas fa-filter"></i> Aplicar
                    </button>
                    <button id="btn-limpiar-filtros" class="btn btn-secondary" style="align-self: flex-start; margin-top: 10px;">
                        <i class="fas fa-undo"></i> Limpiar
                    </button>
                </div>
                
                <p id="total-evaluaciones" style="font-style: italic;"></p>

                <div id="historial-container">
                    <p class="text-center">Cargando historial...</p>
                </div>
                
                <div id="pagination-container">
                    <button id="btn-prev" class="btn btn-primary btn-sm"><i class="fas fa-chevron-left"></i> Anterior</button>
                    <span id="page-info">Página 1 de 1</span>
                    <button id="btn-next" class="btn btn-primary btn-sm">Siguiente <i class="fas fa-chevron-right"></i></button>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="cambiarSeccion('resultados')"><i class="fas fa-arrow-left"></i> Volver a Resultados</button>
                </div>
            </section>

        </main>
    </div>

    <div id="notification" style="display: none;"></div>

<script>
    // ====================================
    // ========== CONFIGURACIÓN FIREBASE (TUS DATOS CORREGIDOS) ==========
    // ====================================
    
    // Configuración proporcionada por el usuario (simplificada para compatibilidad con SDK v8)
    const firebaseConfig = {
      apiKey: "AIzaSyDJbtRuEwWVAsC1Nz6LbeF5a99LcUfAz4g",
      authDomain: "irat-5-evaluaciones.firebaseapp.com",
      projectId: "irat-5-evaluaciones",
      storageBucket: "irat-5-evaluaciones.firebasestorage.app",
      messagingSenderId: "487279274410",
      appId: "1:487279274410:web:146e9c35a0bf795c5423d3"
    };

    // ====================================
    // ========== VARIABLES GLOBALES ==========
    // ====================================
    let firebaseApp;
    let db;
    let auth; 
    let currentUser = null; 
    
    let datosCompletos = null; 
    let idEvaluacionActual = null; 
    let historialFirebase = [];
    let currentPage = 1;
    const itemsPerPage = 5;
    let lastVisible = null;
    let firstVisible = null;
    
    // Variables de puntajes
    let puntajeTotalIRAT = 0;
    let puntajeNorton = 15;
    let puntajeTinetti = 0;
    let nivelRiesgoIRAT = "";
    let nivelRiesgoNorton = "";
    let recomendaciones = [];
    let tinettiNoEvaluable = false;
    let respuestasTinetti = {};
    let respuestasIRAT = {};
    let respuestasNorton = {};

    // ====================================
    // ========== DEFINICIONES DE ESCALAS ACTUALIZADAS CON SELECT ==========
    // ====================================

    // IRAT-5 (Original con Amputaciones, 5 preguntas, Max 10 pts)
    const IRAT_DEFINITIONS = [
        { 
            question: "1. Condición de las Extremidades", 
            name: "irat-q1",
            options: [
                { label: "Sin amputación ni inmovilización", value: 0 }, 
                { label: "Amputación parcial/Inmovilización con riesgo", value: 1 }, 
                { label: "Amputación total/Inmovilización completa", value: 2 }
            ] 
        },
        { 
            question: "2. Estado Mental", 
            name: "irat-q2",
            options: [
                { label: "Consciente y Orientado", value: 0 }, 
                { label: "Desorientado/Confuso", value: 1 }, 
                { label: "Inconsciente/Estupor", value: 2 }
            ] 
        },
        { 
            question: "3. Nutrición (Apetito)", 
            name: "irat-q3",
            options: [
                { label: "Normal/Aceptable", value: 0 }, 
                { label: "Disminuido/Selectivo", value: 1 }, 
                { label: "Muy Pobre/Sonda", value: 2 }
            ] 
        },
        { 
            question: "4. Incontinencia (Doble)", 
            name: "irat-q4",
            options: [
                { label: "Continente", value: 0 }, 
                { label: "Solo Urinaria u Ocasional", value: 1 }, 
                { label: "Doble Incontinencia", value: 2 }
            ] 
        },
        { 
            question: "5. Piel (Integridad/Edema)", 
            name: "irat-q5",
            options: [
                { label: "Piel sana/Normal", value: 0 }, 
                { label: "Riesgo/Piel Frágil/Edema Leve", value: 1 }, 
                { label: "Lesión existente/Úlcera/Edema Grave", value: 2 }
            ] 
        }
    ];

    // TINETTI (Original: Equilibrio Max 16 pts, Marcha Max 12 pts, Total Max 28 pts)
    // 9 ítems de Equilibrio (EQ)
    const TINETTI_DEFINITIONS_EQUILIBRIO = [
        { question: "1. Equilibrio sentado", name: "tinetti-eq-q1", options: [{ label: "Seguro", value: 1 }, { label: "Inseguro", value: 0 }] },
        { question: "2. Levantarse (de la silla)", name: "tinetti-eq-q2", options: [{ label: "Se levanta sin ayuda", value: 2 }, { label: "Se levanta con ayuda", value: 1 }, { label: "Incapaz sin ayuda", value: 0 }] },
        { question: "3. Intentos de levantarse", name: "tinetti-eq-q3", options: [{ label: "Un intento", value: 1 }, { label: "Múltiples intentos", value: 0 }] },
        { question: "4. Equilibrio de pie (inmediato, primeros 5 seg)", name: "tinetti-eq-q4", options: [{ label: "Estable sin apoyo", value: 2 }, { label: "Usa apoyo/inestable", value: 1 }, { label: "Incapaz de mantenerse", value: 0 }] },
        { question: "5. Equilibrio de pie (general)", name: "tinetti-eq-q5", options: [{ label: "Estable", value: 2 }, { label: "Ligeramente inestable", value: 1 }, { label: "Muy inestable o requiere apoyo", value: 0 }] },
        { question: "6. Empujón (equilibrio tras empujón en esternón)", name: "tinetti-eq-q6", options: [{ label: "Estable", value: 1 }, { label: "Se tambalea/pierde equilibrio", value: 0 }] },
        { question: "7. Ojos cerrados (equilibrio de pie por 10 seg)", name: "tinetti-eq-q7", options: [{ label: "Estable", value: 1 }, { label: "Inestable", value: 0 }] },
        { question: "8. Giro de 360°", name: "tinetti-eq-q8", options: [{ label: "Continuo y estable", value: 2 }, { label: "Discontinuo/inestable", value: 1 }, { label: "Ayuda/incapaz", value: 0 }] },
        { question: "9. Sentarse", name: "tinetti-eq-q9", options: [{ label: "Seguro", value: 2 }, { label: "Usa brazos o cae", value: 1 }, { label: "Sin control", value: 0 }] }
    ]; // Máx 16 pts

    // 7 ítems de Marcha (MAR)
    const TINETTI_DEFINITIONS_MARCHA = [
        { question: "1. Inicio de la marcha", name: "tinetti-mar-q1", options: [{ label: "Sin titubeos", value: 1 }, { label: "Titubeante o arrastra", value: 0 }] },
        { question: "2. Longitud y altura del paso (pie derecho)", name: "tinetti-mar-q2", options: [{ label: "Sobrepasa y levanta totalmente", value: 2 }, { label: "Algún defecto (No sobrepasa o arrastra)", value: 1 }, { label: "Incapaz de caminar", value: 0 }] },
        { question: "3. Longitud y altura del paso (pie izquierdo)", name: "tinetti-mar-q3", options: [{ label: "Sobrepasa y levanta totalmente", value: 2 }, { label: "Algún defecto (No sobrepasa o arrastra)", value: 1 }, { label: "Incapaz de caminar", value: 0 }] },
        { question: "4. Simetría del paso", name: "tinetti-mar-q4", options: [{ label: "Pasos simétricos", value: 1 }, { label: "Pasos asimétricos", value: 0 }] },
        { question: "5. Continuidad del paso", name: "tinetti-mar-q5", options: [{ label: "Continuo", value: 1 }, { label: "Discontinuo", value: 0 }] },
        { question: "6. Trayectoria", name: "tinetti-mar-q6", options: [{ label: "Recta sin desvío", value: 2 }, { label: "Leve o moderada desviación", value: 1 }, { label: "Marcada desviación/usa apoyo", value: 0 }] },
        { question: "7. Tronco (balanceo/uso de ayuda)", name: "tinetti-mar-q7", options: [{ label: "No se balancea y no usa ayuda", value: 2 }, { label: "Se balancea o usa ayuda", value: 1 }, { label: "Requiere ayuda constante o incapaz", value: 0 }] }
    ]; // Máx 12 pts

    // ====================================
    // ========== INICIALIZACIÓN PRINCIPAL ==========
    // ====================================
    
    document.addEventListener('DOMContentLoaded', function() {
        // Esta es la primera línea de ejecución del script, y ocurre después de cargar todo el HTML.
        inicializarFirebase();
        configurarAutenticacion();
        configurarApp();
        mostrarNotificacion('Sistema cargado', 'success');
    });
    
    function configurarApp() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('fecha').value = today;
        
        inicializarNavegacion();
        configurarIRAT5(); 
        configurarTinetti();
        calcularNorton(); 
        configurarHistorial();
        configurarValidaciones();
        
        // Eventos de botones
        document.getElementById('siguiente-irat').addEventListener('click', () => {
            if(validarIdentificacion()) cambiarSeccion('evaluacion');
        });
        document.getElementById('siguiente-tinetti').addEventListener('click', () => cambiarSeccion('tinetti'));
        document.getElementById('siguiente-norton').addEventListener('click', () => cambiarSeccion('norton'));
        document.getElementById('siguiente-resultados').addEventListener('click', () => {
            calcularResultadosCompletos(true);
            cambiarSeccion('resultados');
        });
        document.getElementById('btn-guardar').addEventListener('click', guardarEnFirebase);
        document.getElementById('btn-descargar-pdf').addEventListener('click', generarPDF);
        document.getElementById('btn-whatsapp').addEventListener('click', compartirWhatsApp);
        document.getElementById('btn-logout').addEventListener('click', cerrarSesion);

        // Eventos de Norton
        ['norton-fisico', 'norton-mental', 'norton-actividad', 'norton-movilidad', 'norton-incontinencia'].forEach(id => {
            document.getElementById(id).addEventListener('change', calcularNorton);
        });
    }

    // ====================================
    // ========== FIREBASE & AUTHENTICATION ==========
    // ====================================
    
    function inicializarFirebase() {
        try {
            // Este es el punto crítico: si firebase-app.js no se cargó, fallará aquí.
            firebaseApp = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth(); 
            actualizarEstadoFirebase('Conectado a Firestore', 'firebase-connected');
        } catch (error) {
            console.error('Error inicializando Firebase:', error);
            actualizarEstadoFirebase('Error de conexión', 'firebase-disconnected');
        }
    }
    
    function configurarAutenticacion() {
        const authForm = document.getElementById('auth-form');
        authForm.dataset.mode = 'login'; 
        
        auth.onAuthStateChanged(user => {
            if (user) {
                // USUARIO LOGUEADO
                currentUser = user;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app-container').style.display = 'flex';
                document.getElementById('user-display').querySelector('span').textContent = user.email;
                
                if (document.getElementById('historial').classList.contains('active') || 
                    document.getElementById('main-app-container').style.display === 'flex') {
                    cargarHistorialFirebase(); 
                }
                
            } else {
                // USUARIO DESCONECTADO
                currentUser = null;
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('main-app-container').style.display = 'none';
                document.getElementById('user-display').querySelector('span').textContent = '';
            }
        });
        
        // Toggle Login/Register
        document.getElementById('toggle-auth-mode').addEventListener('click', (e) => {
            e.preventDefault();
            const mode = authForm.dataset.mode;
            const isLogin = mode === 'login';
            authForm.dataset.mode = isLogin ? 'register' : 'login';
            document.getElementById('auth-title').textContent = isLogin ? 'Registro de Usuario' : 'Iniciar Sesión';
            document.getElementById('auth-submit-btn').innerHTML = isLogin ? '<i class="fas fa-user-plus"></i> Registrar Cuenta' : '<i class="fas fa-sign-in-alt"></i> Iniciar Sesión';
            document.getElementById('toggle-auth-mode').textContent = isLogin ? '¿Ya tienes cuenta? Inicia Sesión aquí' : '¿No tienes cuenta? Regístrate aquí';
            document.getElementById('auth-error-message').style.display = 'none';
        });

        authForm.addEventListener('submit', handleAuthSubmit);
    }
    
    async function handleAuthSubmit(e) {
        e.preventDefault();
        
        const email = document.getElementById('auth-email').value;
        const password = document.getElementById('auth-password').value;
        const mode = document.getElementById('auth-form').dataset.mode;
        const errorElement = document.getElementById('auth-error-message');
        errorElement.style.display = 'none';
        
        try {
            if (mode === 'register') {
                await auth.createUserWithEmailAndPassword(email, password);
                mostrarNotificacion('Registro exitoso. Iniciando sesión...', 'success');
            } else {
                await auth.signInWithEmailAndPassword(email, password);
                mostrarNotificacion('Inicio de sesión exitoso', 'success');
            }
            
        } catch (error) {
            console.error("Error de autenticación:", error);
            let msg = 'Error desconocido. Intente de nuevo.';
            if (error.code === 'auth/email-already-in-use') {
                msg = 'El correo ya está registrado.';
            } else if (error.code === 'auth/invalid-email') {
                msg = 'El formato del correo es inválido.';
            } else if (error.code === 'auth/weak-password') {
                msg = 'La contraseña debe tener al menos 6 caracteres.';
            } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                msg = 'Correo o contraseña incorrectos.';
            } else if (error.code === 'auth/operation-not-allowed') {
                 msg = 'Error de Configuración: La autenticación por Email/Contraseña NO está habilitada en Firebase. Habilítala en la consola de Firebase.';
            }
            errorElement.textContent = msg;
            errorElement.style.display = 'block';
        }
    }

    function cerrarSesion() {
        auth.signOut().then(() => {
            mostrarNotificacion('Sesión cerrada correctamente', 'info');
            iniciarNuevaEvaluacion(false); 
        }).catch(error => {
            mostrarNotificacion('Error al cerrar sesión: ' + error.message, 'error');
        });
    }

    function actualizarEstadoFirebase(message, className) {
        const statusDiv = document.getElementById('firebase-status');
        statusDiv.innerHTML = `<i class="fas fa-database"></i> ${message}`;
        statusDiv.className = `firebase-status ${className}`;
    }
    
    // ====================================
    // ========== FIREBASE DATA STORAGE ==========
    // ====================================
    
    async function guardarEnFirebase() {
        if (!currentUser) {
            mostrarNotificacion('Debe iniciar sesión para guardar evaluaciones.', 'error');
            return;
        }
        
        if (!datosCompletos && !calcularResultadosCompletos(false)) {
            mostrarNotificacion('Debe completar la identificación y calcular los resultados.', 'error');
            return;
        }
        
        try {
            mostrarNotificacion(idEvaluacionActual ? 'Actualizando en Firebase...' : 'Guardando en Firebase...', 'info');
            
            const datosFirebase = {
                ...datosCompletos,
                userId: currentUser.uid, 
                userEmail: currentUser.email,
                fechaGuardado: firebase.firestore.FieldValue.serverTimestamp(),
                fechaEvaluacion: datosCompletos.paciente.fecha || new Date().toISOString().split('T')[0]
            };
            
            let docRef;
            
            if (idEvaluacionActual) {
                docRef = db.collection('evaluaciones').doc(idEvaluacionActual);
                await docRef.update(datosFirebase);
                mostrarNotificacion(`Evaluación actualizada (ID: ${idEvaluacionActual.substring(0, 8)}...)`, 'success');
            } else {
                docRef = await db.collection('evaluaciones').add(datosFirebase);
                idEvaluacionActual = docRef.id; 
                mostrarNotificacion(`Evaluación guardada (ID: ${docRef.id.substring(0, 8)}...)`, 'success');
            }
            
            cargarHistorialFirebase();
            
        } catch (error) {
            console.error('Error guardando en Firebase:', error);
            if (error.code === 'permission-denied') {
                mostrarNotificacion('Error: No tiene permiso para modificar esta evaluación (Solo puede editar las suyas).', 'error');
            } else {
                mostrarNotificacion('Error al guardar: ' + error.message, 'error');
            }
        }
    }

    async function cargarHistorialFirebase() {
        if (!currentUser) { 
            document.getElementById('historial-container').innerHTML = '<p style="text-align: center; padding: 30px;">Inicie sesión para ver el historial.</p>';
            document.getElementById('total-evaluaciones').textContent = '0 evaluaciones';
            return;
        }
        
        try {
            mostrarCargandoHistorial(true);
            
            const nombreFilter = document.getElementById('filter-nombre').value.trim().toLowerCase();
            const fechaDesdeFilter = document.getElementById('filter-fecha-desde').value;
            const fechaHastaFilter = document.getElementById('filter-fecha-hasta').value;
            
            let query = db.collection('evaluaciones');
            query = query.orderBy('fechaEvaluacion', 'desc');

            if (fechaDesdeFilter) {
                query = query.where('fechaEvaluacion', '>=', fechaDesdeFilter);
            }
            if (fechaHastaFilter) {
                const fechaHastaObj = new Date(fechaHastaFilter + 'T00:00:00');
                fechaHastaObj.setDate(fechaHastaObj.getDate() + 1);
                const fechaHastaExclusiva = fechaHastaObj.toISOString().split('T')[0];
                query = query.where('fechaEvaluacion', '<', fechaHastaExclusiva);
            }

            const snapshot = await query.get();
            
            historialFirebase = [];
            snapshot.forEach(doc => {
                historialFirebase.push({ id: doc.id, ...doc.data() });
            });
            
            let resultadosFiltrados = historialFirebase;
            if (nombreFilter) {
                resultadosFiltrados = historialFirebase.filter(evaluacion => {
                    const nombrePaciente = (evaluacion.paciente?.nombre || '').toLowerCase();
                    return nombrePaciente.includes(nombreFilter); 
                });
            }
            
            historialFirebase = resultadosFiltrados;
            
            actualizarVistaHistorial();
            actualizarEstadisticas(historialFirebase.length);
            actualizarPaginacion();
            
        } catch (error) {
            console.error('Error cargando historial Firebase:', error);
            mostrarErrorHistorial('Error de carga. Verifique la conexión o las reglas de seguridad.');
        } finally {
            mostrarCargandoHistorial(false);
        }
    }
    
    function mostrarCargandoHistorial(isLoading) {
        const container = document.getElementById('historial-container');
        if (isLoading) {
            container.innerHTML = `<div style="text-align: center; padding: 40px; color: #666;">
                <i class="fas fa-spinner fa-spin fa-2x" style="margin-bottom: 20px;"></i>
                <p>Cargando historial desde Firebase...</p>
            </div>`;
        } else if (container.querySelector('.fa-spin')) {
            container.innerHTML = ''; 
        }
    }
    
    function mostrarErrorHistorial(message) {
        document.getElementById('historial-container').innerHTML = `<p style="text-align: center; padding: 30px; color: ${var(--danger-color)};">${message}</p>`;
    }
    
    function actualizarEstadisticas(count) {
        document.getElementById('total-evaluaciones').textContent = `${count} evaluaciones en total (Filtros aplicados).`;
    }

    function actualizarVistaHistorial() {
        const container = document.getElementById('historial-container');
        container.innerHTML = '';
        
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const itemsToShow = historialFirebase.slice(startIndex, endIndex);

        if (itemsToShow.length === 0 && historialFirebase.length > 0) {
            currentPage = Math.max(1, Math.ceil(historialFirebase.length / itemsPerPage));
            actualizarVistaHistorial(); 
            return;
        }
        
        if (historialFirebase.length === 0) {
            container.innerHTML = '<p style="text-align: center; padding: 30px; color: #999;">No se encontraron evaluaciones con los filtros aplicados.</p>';
            return;
        }

        itemsToShow.forEach(evaluacion => {
            const item = document.createElement('div');
            const isOwner = evaluacion.userId === currentUser.uid;
            const ownerText = isOwner ? ' (Creada por mí)' : ` (Creada por: ${evaluacion.userEmail})`;
            
            item.className = 'historial-item';
            item.innerHTML = `
                <div class="historial-info">
                    <strong>${evaluacion.paciente.nombre}</strong>
                    <span>Fecha: ${evaluacion.paciente.fecha} | IRAT-5: ${evaluacion.resultados.irat.nivel} | Tinetti: ${evaluacion.resultados.tinetti.puntaje} pts ${ownerText}</span>
                </div>
                <div class="historial-actions">
                    <button class="btn btn-primary btn-sm" onclick="cargarEvaluacion('${evaluacion.id}')">
                        <i class="fas fa-eye"></i> Ver/Editar
                    </button>
                    ${isOwner ? `<button class="btn btn-danger btn-sm" onclick="eliminarEvaluacion('${evaluacion.id}', '${evaluacion.paciente.nombre}')">
                        <i class="fas fa-trash-alt"></i> Borrar
                    </button>` : ''}
                </div>
            `;
            container.appendChild(item);
        });
    }
    
    function actualizarPaginacion() {
        const totalPages = Math.ceil(historialFirebase.length / itemsPerPage);
        const prevBtn = document.getElementById('btn-prev');
        const nextBtn = document.getElementById('btn-next');
        const pageInfo = document.getElementById('page-info');
        
        document.getElementById('pagination-container').style.display = totalPages > 1 ? 'flex' : 'none'; 
        
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage === totalPages || historialFirebase.length === 0;
        pageInfo.textContent = `Página ${currentPage} de ${totalPages}`;
    }
    
    // Manejadores de Paginación y Filtros
    document.getElementById('btn-prev').addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            actualizarVistaHistorial();
            actualizarPaginacion();
        }
    });
    
    document.getElementById('btn-next').addEventListener('click', () => {
        const totalPages = Math.ceil(historialFirebase.length / itemsPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            actualizarVistaHistorial();
            actualizarPaginacion();
        }
    });

    document.getElementById('btn-aplicar-filtros').addEventListener('click', () => {
        currentPage = 1;
        cargarHistorialFirebase();
    });

    document.getElementById('btn-limpiar-filtros').addEventListener('click', () => {
        document.getElementById('filter-nombre').value = '';
        document.getElementById('filter-fecha-desde').value = '';
        document.getElementById('filter-fecha-hasta').value = '';
        currentPage = 1;
        cargarHistorialFirebase();
    });

    async function cargarEvaluacion(id) {
        try {
            mostrarNotificacion('Cargando evaluación...', 'info');
            const doc = await db.collection('evaluaciones').doc(id).get();
            if (!doc.exists) {
                mostrarNotificacion('Evaluación no encontrada.', 'error');
                return;
            }
            
            const data = doc.data();
            datosCompletos = data;
            idEvaluacionActual = id;
            
            // Cargar datos de paciente
            document.getElementById('nombre').value = data.paciente.nombre || '';
            document.getElementById('rut').value = data.paciente.rut || '';
            document.getElementById('edad').value = data.paciente.edad || '';
            document.getElementById('fecha').value = data.paciente.fecha || '';
            document.getElementById('sexo').value = data.paciente.sexo || '';
            document.getElementById('evaluador').value = data.paciente.evaluador || '';
            document.getElementById('institucion').value = data.paciente.institucion || '';
            document.getElementById('historia-clinica').value = data.paciente.historiaClinica || '';

            // Cargar respuestas de las escalas (IRAT, Tinetti, Norton)
            cargarRespuestasSelect(data.respuestas.irat, 'irat-form');
            cargarRespuestasSelect(data.respuestas.tinetti, 'tinetti-equilibrio-form'); 
            cargarRespuestasSelect(data.respuestas.tinetti, 'tinetti-marcha-form'); 
            
            // Cargar Norton (selects)
            document.getElementById('norton-fisico').value = data.respuestas.norton.fisico || 4;
            document.getElementById('norton-mental').value = data.respuestas.norton.mental || 4;
            document.getElementById('norton-actividad').value = data.respuestas.norton.actividad || 4;
            document.getElementById('norton-movilidad').value = data.respuestas.norton.movilidad || 4;
            document.getElementById('norton-incontinencia').value = data.respuestas.norton.incontinencia || 4;
            calcularNorton(); 
            
            // Cargar estado de Tinetti no evaluable
            tinettiNoEvaluable = data.respuestas.tinetti.not_evaluable || false;
            const tinettiCheck = document.getElementById('tinetti-no-evaluable');
            tinettiCheck.checked = tinettiNoEvaluable;
            tinettiCheck.dispatchEvent(new Event('change')); 

            calcularResultadosCompletos(true);
            cambiarSeccion('resultados');
            mostrarNotificacion(`Evaluación de ${data.paciente.nombre} cargada.`, 'success');

        } catch (error) {
            console.error('Error al cargar evaluación:', error);
            mostrarNotificacion('Error al cargar la evaluación.', 'error');
        }
    }
    
    function cargarRespuestasSelect(respuestas, containerId) {
        const container = document.getElementById(containerId);
        for (const key in respuestas) {
            const select = container.querySelector(`select[name="${key}"]`);
            if (select) {
                select.value = String(respuestas[key]);
            }
        }
    }

    async function eliminarEvaluacion(id, nombre) {
        if (!confirm(`¿Está seguro de eliminar la evaluación de ${nombre}? Esta acción es irreversible.`)) {
            return;
        }

        try {
            mostrarNotificacion('Eliminando evaluación...', 'info');
            await db.collection('evaluaciones').doc(id).delete();
            mostrarNotificacion(`Evaluación de ${nombre} eliminada correctamente.`, 'success');
            cargarHistorialFirebase(); 
            if (id === idEvaluacionActual) {
                iniciarNuevaEvaluacion(false); 
            }

        } catch (error) {
            console.error('Error al eliminar evaluación:', error);
            if (error.code === 'permission-denied') {
                 mostrarNotificacion('Error: Solo el creador de esta evaluación puede eliminarla.', 'error');
            } else {
                mostrarNotificacion('Error al eliminar: ' + error.message, 'error');
            }
        }
    }
    
    function iniciarNuevaEvaluacion(confirmacion = true) {
        if (confirmacion && !confirm('¿Está seguro de comenzar una nueva evaluación? Los datos no guardados se perderán.')) {
            return;
        }
        window.location.reload(); 
    }

    // ====================================
    // ========== NAVEGACIÓN Y VALIDACIÓN ==========
    // ====================================
    
    function inicializarNavegacion() {
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                cambiarSeccion(this.dataset.section);
            });
        });
    }

    function cambiarSeccion(targetId) {
        document.querySelectorAll('.section').forEach(section => {
            section.classList.remove('active');
        });
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.classList.remove('active');
        });

        document.getElementById(targetId).classList.add('active');
        const activeTab = document.querySelector(`.nav-tab[data-section="${targetId}"]`);
        if (activeTab) {
            activeTab.classList.add('active');
        }
        
        if (targetId === 'historial') {
            cargarHistorialFirebase();
        }
    }
    
    function validarIdentificacion() {
        let isValid = true;
        const nombre = document.getElementById('nombre');
        const fecha = document.getElementById('fecha');
        const evaluador = document.getElementById('evaluador');
        
        if (!nombre.value.trim()) {
            document.getElementById('error-nombre').textContent = 'El nombre es obligatorio.';
            isValid = false;
        } else {
            document.getElementById('error-nombre').textContent = '';
        }

        if (!fecha.value) {
            document.getElementById('error-fecha').textContent = 'La fecha es obligatoria.';
            isValid = false;
        } else {
            document.getElementById('error-fecha').textContent = '';
        }

        if (!evaluador.value.trim()) {
            document.getElementById('error-evaluador').textContent = 'El evaluador es obligatorio.';
            isValid = false;
        } else {
            document.getElementById('error-evaluador').textContent = '';
        }
        
        if (!isValid) {
            mostrarNotificacion('Complete los campos obligatorios de identificación (*)', 'error');
        }
        return isValid;
    }

    function mostrarNotificacion(message, type) {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = `notification ${type}`;
        notification.style.display = 'block';
        
        setTimeout(() => {
            notification.style.opacity = '1';
        }, 10);
        
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 500);
        }, 3000);
    }

    // ====================================
    // ========== LÓGICA DE ESCALAS CON SELECTS ==========
    // ====================================
    
    // Función genérica para generar selects
    function generateSelects(definitions, containerId, changeHandler) {
        const container = document.getElementById(containerId);
        const titleHtml = container.querySelector('h3') ? container.querySelector('h3').outerHTML : '';
        container.innerHTML = titleHtml; 
        
        definitions.forEach((item) => {
            const group = document.createElement('div');
            group.className = 'form-group';
            group.innerHTML = `<label class="form-label">${item.question}</label>`;
            
            const select = document.createElement('select');
            select.className = 'form-control';
            select.name = item.name;
            select.required = true;
            
            // Opción por defecto
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = "Seleccione el puntaje";
            select.appendChild(defaultOption);

            item.options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = String(option.value); 
                opt.textContent = `${option.label} (${option.value} pts)`;
                select.appendChild(opt);
            });
            
            select.addEventListener('change', changeHandler);
            
            group.appendChild(select);
            container.appendChild(group);
        });
        
        changeHandler(); 
    }

    // --- IRAT-5 ---
    function configurarIRAT5() {
        generateSelects(IRAT_DEFINITIONS, 'irat-form', calcularIRAT5);
    }

    function calcularIRAT5() {
        puntajeTotalIRAT = 0;
        respuestasIRAT = {};
        let allAnswered = true;
        
        IRAT_DEFINITIONS.forEach(def => {
            const select = document.querySelector(`select[name="${def.name}"]`);
            const value = parseInt(select ? select.value : NaN);

            if (isNaN(value)) {
                allAnswered = false;
            } else {
                puntajeTotalIRAT += value;
                respuestasIRAT[def.name] = value;
            }
        });

        if (puntajeTotalIRAT >= 5) {
            nivelRiesgoIRAT = "Riesgo Alto (Puntaje ≥ 5)";
        } else if (puntajeTotalIRAT >= 3) {
            nivelRiesgoIRAT = "Riesgo Medio (Puntaje 3-4)";
        } else {
            nivelRiesgoIRAT = "Riesgo Bajo (Puntaje 0-2)";
        }
    }
    
    // --- TINETTI ---
    function configurarTinetti() {
        generateSelects(TINETTI_DEFINITIONS_EQUILIBRIO, 'tinetti-equilibrio-form', calcularTinetti);
        generateSelects(TINETTI_DEFINITIONS_MARCHA, 'tinetti-marcha-form', calcularTinetti);

        document.getElementById('tinetti-no-evaluable').addEventListener('change', function() {
            tinettiNoEvaluable = this.checked;
            const disableState = this.checked;
            
            const containers = [document.getElementById('tinetti-equilibrio-form'), document.getElementById('tinetti-marcha-form')];
            
            containers.forEach(c => {
                c.querySelectorAll('select').forEach(select => {
                    select.disabled = disableState;
                    if (disableState) select.value = ""; 
                });
            });
            calcularTinetti();
        });

        calcularTinetti(); 
    }

    function calcularTinetti() {
        if (tinettiNoEvaluable) {
            puntajeTinetti = 0;
            respuestasTinetti = { not_evaluable: true };
            return;
        }
        
        puntajeTinetti = 0;
        respuestasTinetti = { not_evaluable: false };
        
        const processScale = (definitions) => {
            definitions.forEach((def) => {
                const select = document.querySelector(`select[name="${def.name}"]`);
                const value = parseInt(select ? select.value : NaN); 

                if (!isNaN(value)) {
                    puntajeTinetti += value;
                    respuestasTinetti[def.name] = value;
                }
            });
        };

        processScale(TINETTI_DEFINITIONS_EQUILIBRIO);
        processScale(TINETTI_DEFINITIONS_MARCHA);
    }

    // --- NORTON ---
    function calcularNorton() {
        puntajeNorton = 0;
        respuestasNorton = {};
        const factores = ['fisico', 'mental', 'actividad', 'movilidad', 'incontinencia'];

        factores.forEach(factor => {
            const select = document.getElementById(`norton-${factor}`);
            const value = parseInt(select ? select.value : 0); 
            
            if (!isNaN(value)) {
                puntajeNorton += value;
                respuestasNorton[factor] = value;
            }
        });

        if (puntajeNorton <= 12) {
            nivelRiesgoNorton = "Riesgo ALTO (Puntaje ≤ 12)";
            document.getElementById('resultado-norton').className = 'result-box mt-4 high-risk';
        } else if (puntajeNorton >= 13 && puntajeNorton <= 14) {
            nivelRiesgoNorton = "Riesgo MEDIO (Puntaje 13-14)";
            document.getElementById('resultado-norton').className = 'result-box mt-4 medium-risk';
        } else {
            nivelRiesgoNorton = "Riesgo BAJO (Puntaje ≥ 15)";
            document.getElementById('resultado-norton').className = 'result-box mt-4 low-risk';
        }

        document.getElementById('norton-score').textContent = puntajeNorton;
        document.getElementById('norton-riesgo').textContent = nivelRiesgoNorton;
    }


    // ====================================
    // ========== RESULTADOS Y PDF ==========
    // ====================================
    
    function calcularResultadosCompletos(shouldNotify) {
        calcularIRAT5();
        calcularTinetti();
        calcularNorton();
        
        if (!validarIdentificacion()) return false;

        const paciente = {
            nombre: document.getElementById('nombre').value.trim(),
            rut: document.getElementById('rut').value.trim(),
            edad: document.getElementById('edad').value.trim(),
            fecha: document.getElementById('fecha').value,
            sexo: document.getElementById('sexo').value,
            evaluador: document.getElementById('evaluador').value.trim(),
            institucion: document.getElementById('institucion').value.trim(),
            historiaClinica: document.getElementById('historia-clinica').value.trim()
        };
        
        generarRecomendaciones();

        datosCompletos = {
            paciente,
            respuestas: {
                irat: respuestasIRAT,
                tinetti: respuestasTinetti,
                norton: respuestasNorton
            },
            resultados: {
                irat: { puntaje: puntajeTotalIRAT, nivel: nivelRiesgoIRAT },
                tinetti: { puntaje: puntajeTinetti, nivel: determinarRiesgoTinetti() },
                norton: { puntaje: puntajeNorton, nivel: nivelRiesgoNorton }
            },
            recomendaciones: recomendaciones
        };
        
        renderizarResultados();

        if (shouldNotify) {
             mostrarNotificacion('Resultados calculados y listos.', 'success');
        }
        return true;
    }

    function determinarRiesgoTinetti() {
        if (tinettiNoEvaluable) return "No Evaluable (N/A)";
        if (puntajeTinetti < 19) return "Riesgo ALTO de caída";
        if (puntajeTinetti >= 19 && puntajeTinetti <= 24) return "Riesgo MODERADO de caída";
        return "Riesgo BAJO de caída";
    }

    function generarRecomendaciones() {
        recomendaciones = [];

        // Recomendaciones IRAT-5
        if (puntajeTotalIRAT >= 5) {
            recomendaciones.push("IRAT-5 (Riesgo Alto): Implementar un plan de cuidados intensivo para prevenir complicaciones.");
        } else if (puntajeTotalIRAT >= 3) {
            recomendaciones.push("IRAT-5 (Riesgo Medio): Monitorización activa y planes de intervención específicos en las áreas de mayor puntaje.");
        }
        if (respuestasIRAT['irat-q1'] > 0) recomendaciones.push("Movilidad/Traslado: Planificar asistencia en la movilización y fomentar la independencia segura (factor amputación/inmovilización).");
        if (respuestasIRAT['irat-q5'] > 0) recomendaciones.push("Piel: Realizar revisión cutánea diaria. Considerar superficies especiales para alivio de presión.");

        // Recomendaciones Tinetti
        const riesgoTinetti = determinarRiesgoTinetti();
        if (riesgoTinetti === "Riesgo ALTO de caída") {
            recomendaciones.push("Tinetti (Riesgo Alto): Iniciar programa de rehabilitación de equilibrio y marcha. Uso estricto de ayudas técnicas.");
        } else if (riesgoTinetti === "Riesgo MODERADO de caída") {
            recomendaciones.push("Tinetti (Riesgo Moderado): Evaluación ambiental (retirar obstáculos, buena iluminación). Entrenamiento de la fuerza y equilibrio.");
        }

        // Recomendaciones Norton
        if (puntajeNorton <= 12) {
            recomendaciones.push("Norton (Riesgo Alto de Úlcera): Realizar cambios posturales cada 2-3 horas. Usar colchón y cojín antiescaras.");
        } else if (puntajeNorton <= 14) {
            recomendaciones.push("Norton (Riesgo Medio de Úlcera): Proteger zonas de riesgo. Mantener la piel limpia y seca. Vigilancia nutricional.");
        }
    }

    function renderizarResultados() {
        if (!datosCompletos) return;
        const data = datosCompletos;

        // Info Paciente
        document.getElementById('resumen-nombre').textContent = data.paciente.nombre;
        document.getElementById('resumen-rut').textContent = data.paciente.rut || 'N/A';
        document.getElementById('resumen-fecha').textContent = data.paciente.fecha;

        // IRAT-5
        const iratDiv = document.getElementById('resumen-irat');
        const iratRiskClass = data.resultados.irat.nivel.includes('Alto') ? 'high-risk' : data.resultados.irat.nivel.includes('Medio') ? 'medium-risk' : 'low-risk';
        iratDiv.className = `result-box ${iratRiskClass}`;
        iratDiv.innerHTML = `
            <strong>IRAT-5: Riesgo de Complicaciones</strong>
            <p>Puntaje Total: <strong>${data.resultados.irat.puntaje} / 10</strong></p>
            <p>Nivel de Riesgo: <strong>${data.resultados.irat.nivel}</strong></p>
        `;

        // Tinetti
        const tinettiDiv = document.getElementById('resumen-tinetti');
        const tinettiRisk = data.resultados.tinetti.nivel;
        let tinettiRiskClass = 'low-risk';
        if (tinettiRisk.includes('ALTO')) {
            tinettiRiskClass = 'high-risk';
        } else if (tinettiRisk.includes('MODERADO')) {
            tinettiRiskClass = 'medium-risk';
        } else if (tinettiRisk.includes('No Evaluable')) {
            tinettiRiskClass = 'medium-risk'; 
        }

        tinettiDiv.className = `result-box ${tinettiRiskClass}`;
        tinettiDiv.innerHTML = `
            <strong>Tinetti: Riesgo de Caída</strong>
            <p>Puntaje Total: <strong>${data.resultados.tinetti.puntaje} / 28</strong></p>
            <p>Nivel de Riesgo: <strong>${tinettiRisk}</strong></p>
        `;
        
        // Norton
        const nortonDiv = document.getElementById('resumen-norton-final');
        const nortonRiskClass = data.resultados.norton.nivel.includes('ALTO') ? 'high-risk' : data.resultados.norton.nivel.includes('MEDIO') ? 'medium-risk' : 'low-risk';
        nortonDiv.className = `result-box ${nortonRiskClass}`;
        nortonDiv.innerHTML = `
            <strong>Norton: Riesgo de Úlcera por Presión</strong>
            <p>Puntaje Total: <strong>${data.resultados.norton.puntaje} / 20</strong></p>
            <p>Nivel de Riesgo: <strong>${data.resultados.norton.nivel}</strong></p>
        `;

        // Recomendaciones
        const recList = document.getElementById('recomendaciones-lista');
        recList.innerHTML = '';
        data.recomendaciones.forEach(rec => {
            const li = document.createElement('li');
            li.textContent = rec;
            recList.appendChild(li);
        });
        if (data.recomendaciones.length === 0) {
            recList.innerHTML = '<li>No se detectaron riesgos elevados que requieran acciones inmediatas específicas. Mantener vigilancia habitual.</li>';
        }
    }
    
    // --- PDF Generation ---
    function generarPDF() {
        if (!datosCompletos) {
            mostrarNotificacion('Primero debe calcular los resultados.', 'error');
            return;
        }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const data = datosCompletos;
        let y = 10;
        const margin = 15;
        const lineHeight = 7;

        // Título
        doc.setFontSize(16);
        doc.text(`Evaluación Clínica Integral - ${data.paciente.nombre}`, margin, y);
        y += lineHeight;
        doc.setFontSize(10);
        doc.text(`Fecha: ${data.paciente.fecha} | Evaluador: ${data.paciente.evaluador}`, margin, y);
        y += lineHeight * 2;

        // --- Sección de Identificación ---
        doc.setFontSize(12);
        doc.text("1. IDENTIFICACIÓN DEL PACIENTE", margin, y);
        y += lineHeight;
        doc.setFontSize(10);
        doc.text(`RUT: ${data.paciente.rut || 'N/A'} | Edad: ${data.paciente.edad || 'N/A'} | Sexo: ${data.paciente.sexo || 'N/A'}`, margin, y);
        y += lineHeight;
        doc.text(`HC: ${data.paciente.historiaClinica || 'N/A'} | Institución: ${data.paciente.institucion || 'N/A'}`, margin, y);
        y += lineHeight * 2;

        // --- Sección de Resultados ---
        doc.setFontSize(12);
        doc.text("2. RESULTADOS DE LAS ESCALAS", margin, y);
        y += lineHeight;
        
        // IRAT-5
        doc.setFontSize(10);
        doc.text(`IRAT-5: Riesgo de Complicaciones`, margin, y);
        y += lineHeight;
        doc.text(`Puntaje: ${data.resultados.irat.puntaje}/10`, margin, y);
        doc.text(`Nivel: ${data.resultados.irat.nivel}`, 80, y);
        y += lineHeight;

        // Tinetti
        doc.text(`TINETTI: Riesgo de Caída`, margin, y);
        y += lineHeight;
        doc.text(`Puntaje: ${data.resultados.tinetti.puntaje}/28`, margin, y);
        doc.text(`Nivel: ${data.resultados.tinetti.nivel}`, 80, y);
        y += lineHeight;
        
        // Norton
        doc.text(`NORTON: Riesgo de Úlcera por Presión`, margin, y);
        y += lineHeight;
        doc.text(`Puntaje: ${data.resultados.norton.puntaje}/20`, margin, y);
        doc.text(`Nivel: ${data.resultados.norton.nivel}`, 80, y);
        y += lineHeight * 2;

        // --- Sección de Recomendaciones ---
        doc.setFontSize(12);
        doc.text("3. RECOMENDACIONES / PLAN DE ACCIÓN", margin, y);
        y += lineHeight;
        doc.setFontSize(10);
        
        data.recomendaciones.forEach((rec, index) => {
            if (y > 280) {
                doc.addPage();
                y = 15;
            }
            doc.text(`- ${rec}`, margin, y);
            y += lineHeight;
        });
        
        doc.save(`Evaluacion_${data.paciente.nombre.replace(/\s/g, '_')}_${data.paciente.fecha}.pdf`);
        mostrarNotificacion('PDF generado correctamente.', 'success');
    }

    // --- WhatsApp Share ---
    function compartirWhatsApp() {
        if (!datosCompletos) {
            mostrarNotificacion('Primero debe calcular los resultados.', 'error');
            return;
        }

        const data = datosCompletos;
        let mensaje = `*RESUMEN DE EVALUACIÓN CLÍNICA*\n\n`;
        mensaje += `Paciente: ${data.paciente.nombre}\n`;
        mensaje += `Fecha: ${data.paciente.fecha}\n`;
        mensaje += `Evaluador: ${data.paciente.evaluador}\n\n`;

        mensaje += `*1. IRAT-5 (Riesgo Complicaciones)*\n`;
        mensaje += `Puntaje: ${data.resultados.irat.puntaje}/10\n`;
        mensaje += `Nivel: ${data.resultados.irat.nivel}\n\n`;

        mensaje += `*2. TINETTI (Riesgo Caída)*\n`;
        mensaje += `Puntaje: ${data.resultados.tinetti.puntaje}/28\n`;
        mensaje += `Nivel: ${data.resultados.tinetti.nivel}\n\n`;

        mensaje += `*3. NORTON (Riesgo Úlcera)*\n`;
        mensaje += `Puntaje: ${data.resultados.norton.puntaje}/20\n`;
        mensaje += `Nivel: ${data.resultados.norton.nivel}\n\n`;

        mensaje += `*PLAN DE ACCIÓN*:\n`;
        data.recomendaciones.forEach((rec, index) => {
            mensaje += `${index + 1}. ${rec}\n`;
        });
        if (data.recomendaciones.length === 0) mensaje += "Vigilancia habitual.\n";
        
        const encodedMessage = encodeURIComponent(mensaje);
        window.open(`https://api.whatsapp.com/send?text=${encodedMessage}`, '_blank');
        mostrarNotificacion('Abriendo WhatsApp para compartir.', 'info');
    }

    function configurarValidaciones() {
        // Placeholder
    }
    
    function configurarHistorial() {
        // Placeholder
    }
</script>
</body>
</html>
