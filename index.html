<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>ICAT – Índice Clínico de Ayuda Técnica</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
body{margin:0;font-family:Segoe UI,Arial;background:#eef2f7}
.header{background:linear-gradient(135deg,#1a237e,#3949ab);color:white;padding:30px;text-align:center}
.container{max-width:1400px;margin:30px auto;background:white;border-radius:16px;box-shadow:0 20px 40px rgba(0,0,0,.15)}
.section{padding:30px}
.card{background:#f9faff;border-radius:12px;padding:25px;margin-bottom:25px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px}
button{padding:12px 18px;border:none;border-radius:8px;cursor:pointer;font-weight:600}
.primary{background:#3949ab;color:white}
.success{background:#2e7d32;color:white}
.secondary{background:#546e7a;color:white}
input,select{width:100%;padding:8px;margin-top:5px}
pre{background:#eceff1;padding:15px;border-radius:8px;white-space:pre-wrap}
.hidden{display:none}
</style>
</head>

<body>

<div class="container">

<div class="header">
<h1>ICAT – Índice Clínico de Ayuda Técnica</h1>
<p>Modo sin autenticación · Uso clínico / piloto</p>
</div>

<div class="section">

<div class="card">
<h3>Datos del paciente (anonimizado)</h3>
<div class="grid">
<input id="codigo" placeholder="Código paciente">
<input id="edad" type="number" placeholder="Edad">
<input id="sexo" placeholder="Sexo">
<input id="evaluador" placeholder="Evaluador">
<input id="fecha" type="date">
</div>
</div>

<div class="card">
<h3>IRAT – Independencia Funcional</h3>
<div id="irat"></div>
</div>

<div class="card">
<h3>Tinetti – Equilibrio y Marcha</h3>
<div id="tinetti"></div>
</div>

<div class="card">
<h3>Norton – Riesgo de dependencia</h3>
<div id="norton"></div>
</div>

<button class="primary" onclick="calcular()">Calcular ICAT</button>

<div id="resultados" class="card hidden">
<h3>Resultados</h3>
<pre id="resumen"></pre>
<button class="primary" onclick="generarPDF()">PDF</button>
<button class="success" onclick="guardar()">Guardar</button>
<button class="secondary" onclick="exportarCSV()">CSV</button>
</div>

<div class="card">
<h3>Historial global de evaluaciones</h3>
<ul id="historial"></ul>
</div>

</div>
</div>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey:"AIzaSyDJbtRuEwWVAsC1Nz6LbeF5a99LcUfAz4g",
  projectId:"irat-5-evaluaciones"
});
const db=firebase.firestore();

/* ================= CUESTIONARIOS ================= */
function crear(id,n,max){
  let h="";
  for(let i=1;i<=n;i++){
    h+=`<label>Ítem ${i}</label>
    <select>${[...Array(max+1).keys()].map(v=>`<option value="${v}">${v}</option>`).join("")}</select><br><br>`;
  }
  document.getElementById(id).innerHTML=h;
}
crear("irat",5,4);
crear("tinetti",14,2);
crear("norton",5,4);

/* ================= CÁLCULO ================= */
let evaluacion=null;
const suma=id=>[...document.querySelectorAll(`#${id} select`)]
  .reduce((a,s)=>a+parseInt(s.value),0);

function calcular(){
  const irat=suma("irat");
  const tinetti=suma("tinetti");
  const norton=suma("norton");

  const ICAT=((irat/20)*40+((28-tinetti)/28)*35+((20-norton)/20)*25).toFixed(1);

  let nivel,ayuda,f;
  if(ICAT<20){nivel="Muy bajo";ayuda="Sin ayuda";f="Funcionalidad conservada."}
  else if(ICAT<40){nivel="Bajo";ayuda="Bastón";f="Leve compromiso funcional."}
  else if(ICAT<60){nivel="Moderado";ayuda="Andador";f="Riesgo funcional significativo."}
  else if(ICAT<80){nivel="Alto";ayuda="Silla de ruedas";f="Alta dependencia funcional."}
  else{nivel="Muy alto";ayuda="Ayuda técnica compleja";f="Dependencia severa."}

  evaluacion={
    instrumento:"ICAT",
    version:"1.0",
    evaluador:evaluador.value,
    paciente:{codigo:codigo.value,edad:edad.value,sexo:sexo.value},
    fecha:fecha.value,
    puntajes:{irat,tinetti,norton,ICAT},
    nivel,ayuda,fundamento:f,
    timestamp:firebase.firestore.FieldValue.serverTimestamp()
  };

  resultados.classList.remove("hidden");
  resumen.textContent=
`IRAT: ${irat}
Tinetti: ${tinetti}
Norton: ${norton}

ICAT: ${ICAT}
Nivel: ${nivel}
Ayuda recomendada: ${ayuda}

Fundamento clínico:
${f}`;
}

/* ================= PDF ================= */
function generarPDF(){
  const {jsPDF}=window.jspdf;
  const d=new jsPDF();
  let y=15;
  d.text("ICAT – Índice Clínico de Ayuda Técnica",105,y,{align:"center"});
  y+=15;
  d.text(JSON.stringify(evaluacion,null,2),10,y);
  d.save("ICAT.pdf");
}

/* ================= FIRESTORE ================= */
async function guardar(){
  await db.collection("ICAT_evaluaciones").add(evaluacion);
  alert("Evaluación guardada");
  cargarHistorial();
}

async function cargarHistorial(){
  historial.innerHTML="";
  const snap=await db.collection("ICAT_evaluaciones")
    .orderBy("timestamp","desc").limit(20).get();
  snap.forEach(d=>{
    const e=d.data();
    const li=document.createElement("li");
    li.textContent=`${e.paciente.codigo} – ICAT ${e.puntajes.ICAT} – ${e.ayuda}`;
    historial.appendChild(li);
  });
}
cargarHistorial();

/* ================= CSV ================= */
function exportarCSV(){
  const rows=[];
  Object.entries(evaluacion).forEach(([k,v])=>{
    rows.push(`${k},${JSON.stringify(v)}`);
  });
  const b=new Blob([rows.join("\n")],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(b);
  a.download="ICAT.csv";
  a.click();
}
</script>

</body>
</html>
