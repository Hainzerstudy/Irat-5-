Evaluador Cl√≠nico Integrado - Versi√≥n Alfa
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluador Cl√≠nico Integrado - Sistema Profesional</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* ===== VARIABLES Y RESET ===== */
        :root {
            --primary-color: #1e3c72;
            --secondary-color: #2a5298;
            --accent-color: #4CAF50;
            --warning-color: #FF9800;
            --danger-color: #F44336;
            --light-color: #f8f9fa;
            --dark-color: #333333;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --border-radius: 10px;
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7ff 0%, #e8ecff 100%);
            color: var(--dark-color);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }
        
        /* ===== CONTENEDOR PRINCIPAL ===== */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ===== HEADER MEJORADO ===== */
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.03' fill-rule='evenodd'/%3E%3C/svg%3E");
            opacity: 0.1;
        }
        
        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            font-weight: 600;
            position: relative;
            display: inline-block;
        }
        
        .header h1::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 25%;
            width: 50%;
            height: 3px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 2px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1rem;
            max-width: 600px;
            margin: 0 auto;
        }
        
        /* ===== SECCI√ìN DE AUTENTICACI√ìN ===== */
        .auth-section {
            padding: 40px;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
        }
        
        .auth-box {
            background: var(--light-color);
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 400px;
            animation: slideUp 0.5s ease;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .auth-title {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.8rem;
        }
        
        .auth-title i {
            margin-right: 10px;
        }
        
        /* ===== FORMULARIOS ===== */
        .form-section {
            padding: 30px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-color);
            font-size: 0.95rem;
        }
        
        .form-control {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
            background: white;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(30, 60, 114, 0.1);
        }
        
        /* ===== EVALUACI√ìN GRUPOS ===== */
        .evaluation-group {
            background: var(--light-color);
            padding: 25px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            border-left: 5px solid var(--primary-color);
            box-shadow: var(--shadow);
            transition: var(--transition);
        }
        
        .evaluation-group:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }
        
        .evaluation-group h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(30, 60, 114, 0.1);
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .evaluation-group h3 i {
            color: var(--secondary-color);
        }
        
        /* ===== ITEM ROWS ===== */
        .item-row {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            transition: var(--transition);
            background: white;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        
        .item-row:hover {
            background: #f8faff;
            transform: translateX(5px);
        }
        
        .item-label {
            flex: 1;
            font-weight: 500;
            color: #555;
            margin-right: 15px;
        }
        
        .item-score {
            min-width: 100px;
            text-align: center;
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--primary-color);
            padding: 8px 15px;
            background: rgba(30, 60, 114, 0.1);
            border-radius: 6px;
        }
        
        /* ===== TINETTI SCORE OPTIONS ===== */
        .tinetti-row {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px dashed #e0e0e0;
        }
        
        .tinetti-score-options {
            display: flex;
            gap: 15px;
            margin-left: auto;
        }
        
        .tinetti-score-options label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            transition: var(--transition);
            font-weight: normal;
        }
        
        .tinetti-score-options input[type="radio"] {
            display: none;
        }
        
        .tinetti-score-options input[type="radio"] + span {
            padding: 6px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            min-width: 40px;
            text-align: center;
            transition: var(--transition);
        }
        
        .tinetti-score-options input[type="radio"]:checked + span {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            font-weight: 600;
        }
        
        /* ===== RESULTADOS SECTION ===== */
        .results-section {
            background: linear-gradient(135deg, #f8faff 0%, #f0f4ff 100%);
            padding: 30px;
            border-radius: var(--border-radius);
            margin-top: 30px;
            border: 2px solid var(--primary-color);
        }
        
        .results-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .result-box {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border-top: 4px solid transparent;
        }
        
        .result-box:hover {
            transform: translateY(-5px);
        }
        
        .result-box strong {
            display: block;
            color: var(--primary-color);
            font-size: 0.9rem;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .resultado-valor {
            font-size: 2.2rem;
            font-weight: 700;
            margin: 10px 0;
            display: block;
        }
        
        /* ===== COLORS FOR RISK LEVELS ===== */
        .risk-success {
            color: #4CAF50;
        }
        
        .risk-warning {
            color: #FF9800;
        }
        
        .risk-danger {
            color: #F44336;
        }
        
        .risk-critical {
            color: #9C27B0;
        }
        
        /* ===== RECOMMENDATION CARDS ===== */
        .recommendation-card {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            border-left: 6px solid;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            transition: var(--transition);
        }
        
        .recommendation-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .recommendation-card strong {
            font-size: 1.1rem;
            margin-bottom: 10px;
            display: block;
        }
        
        .recommendation-card p {
            color: #666;
            line-height: 1.5;
        }
        
        /* ===== HISTORIAL ===== */
        #historial-list {
            list-style: none;
            padding: 0;
        }
        
        #historial-list li {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }
        
        #historial-list li:hover {
            transform: translateX(5px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }
        
        /* ===== BOTONES ===== */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-decoration: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 60, 114, 0.2);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #2E7D32, #4CAF50);
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #F44336, #C62828);
            color: white;
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #C62828, #F44336);
            transform: translateY(-2px);
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
        }
        
        /* ===== NOTIFICACIONES ===== */
        .notification-bar {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: var(--border-radius);
            color: white;
            font-weight: 500;
            z-index: 1000;
            display: none;
            animation: slideInRight 0.3s ease;
            max-width: 350px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .notification-success {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
        }
        
        .notification-error {
            background: linear-gradient(135deg, #F44336, #C62828);
        }
        
        .notification-warning {
            background: linear-gradient(135deg, #FF9800, #EF6C00);
        }
        
        .notification-info {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }
        
        /* ===== USER DISPLAY ===== */
        .user-display {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
        }
        
        .user-info {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        /* ===== ANIMACIONES Y EFECTOS ===== */
        .fade-in {
            animation: fadeIn 0.5s ease;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(30, 60, 114, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(30, 60, 114, 0); }
            100% { box-shadow: 0 0 0 0 rgba(30, 60, 114, 0); }
        }
        
        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
                margin: 10px auto;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .form-section,
            .auth-section {
                padding: 20px;
            }
            
            .results-summary {
                grid-template-columns: 1fr;
            }
            
            .item-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .tinetti-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .tinetti-score-options {
                margin-left: 0;
                width: 100%;
                justify-content: space-between;
            }
            
            .btn {
                width: 100%;
                margin-bottom: 10px;
            }
        }
        
        /* ===== LOADER ===== */
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER MEJORADO -->
        <div class="header">
            <h1><i class="fas fa-stethoscope"></i> Evaluador Cl√≠nico Integrado</h1>
            <p>Sistema profesional para evaluaci√≥n de riesgo de ca√≠das, movilidad y √∫lceras por presi√≥n</p>
            
            <div id="user-display" style="display: none;">
                <div class="user-info">
                    <i class="fas fa-user-md"></i>
                    <span id="current-user-email">Modo Desconectado</span>
                </div>
                <button class="btn btn-danger btn-sm" onclick="logout()" id="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
                </button>
            </div>
        </div>

        <!-- SECCI√ìN DE AUTENTICACI√ìN -->
        <section id="auth-section" class="auth-section">
            <div class="auth-box">
                <h2 class="auth-title" id="auth-title">
                    <i class="fas fa-lock"></i> Iniciar Sesi√≥n
                </h2>
                
                <div class="form-group">
                    <label class="form-label">Correo Electr√≥nico</label>
                    <input type="email" id="auth-email" class="form-control" placeholder="usuario@ejemplo.com" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Contrase√±a</label>
                    <input type="password" id="auth-password" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                
                <button class="btn btn-primary btn-block" onclick="handleAuth()" id="auth-button">
                    <i class="fas fa-sign-in-alt"></i> Iniciar Sesi√≥n
                </button>
                
                <p style="text-align: center; margin-top: 20px;">
                    <a href="#" id="toggle-auth-mode" onclick="toggleAuthModeFunc()" 
                       style="color: var(--primary-color); text-decoration: none; font-weight: 500;">
                        <i class="fas fa-user-plus"></i> Reg√≠strate aqu√≠
                    </a>
                </p>
            </div>
        </section>

        <!-- APLICACI√ìN PRINCIPAL (OCULTA INICIALMENTE) -->
        <section id="main-app" class="form-section" style="display: none;">
            <!-- DATOS DEL PACIENTE -->
            <div class="evaluation-group">
                <h3><i class="fas fa-user-circle"></i> Datos Generales del Paciente</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Nombre del Paciente *</label>
                        <input type="text" id="nombre" class="form-control" placeholder="Nombre completo">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Fecha de Evaluaci√≥n *</label>
                        <input type="date" id="fecha" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nombre del Evaluador *</label>
                        <input type="text" id="evaluador" class="form-control" placeholder="Profesional evaluador">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Edad del Paciente</label>
                        <input type="number" id="edad" class="form-control" placeholder="A√±os">
                    </div>
                </div>
            </div>

            <!-- IRAT-5 MODIFICADO CON NUEVAS PREGUNTAS -->
            <div class="evaluation-group" id="irat-section">
                <h3><i class="fas fa-walking"></i> IRAT-5 Modificado (Riesgo de Amputaci√≥n y Ca√≠da)</h3>
                
                <div class="item-row">
                    <div class="item-label">1. Equilibrio Unipodal (m√°ximo tiempo sostenido)</div>
                    <select id="equilibrio" class="form-control" style="width: 300px;" onchange="calcularIRAT()">
                        <option value="0">‚â• 30 segundos (0 pts)</option>
                        <option value="1">15-29 segundos (1 pts)</option>
                        <option value="2">5-14 segundos (2 pts)</option>
                        <option value="3">< 5 segundos (3 pts)</option>
                        <option value="4">No puede mantenerse (4 pts)</option>
                    </select>
                </div>
                
                <div class="item-row">
                    <div class="item-label">2. Tipo de Amputaci√≥n</div>
                    <select id="amputacion" class="form-control" style="width: 300px;" onchange="calcularIRAT()">
                        <option value="0">Sin amputaciones (0 pts)</option>
                        <option value="1">Amputaci√≥n transmetatarsiana (1 pts)</option>
                        <option value="3">Unilateral infracond√≠lea (3 pts + 1 riesgo ca√≠das)</option>
                        <option value="4">Bilateral infracond√≠lea (4 pts + 1 riesgo ca√≠das)</option>
                        <option value="5">Supracond√≠lea unilateral (5 pts + 1 riesgo ca√≠das)</option>
                        <option value="6">Supracond√≠lea bilateral (6 pts + 1 riesgo ca√≠das)</option>
                    </select>
                </div>
                
                <div class="item-row">
                    <div class="item-label">3. Funci√≥n de Brazos</div>
                    <select id="brazos" class="form-control" style="width: 300px;" onchange="calcularIRAT()">
                        <option value="0">Ambos brazos normales o fuerza ‚â•3 (0 pts)</option>
                        <option value="1">Problemas en un brazo/fuerza <3 (1 pts)</option>
                        <option value="2">Problemas en ambos brazos (2 pts)</option>
                    </select>
                </div>
                
                <div class="item-row">
                    <div class="item-label">4. Situaci√≥n Social</div>
                    <select id="social" class="form-control" style="width: 300px;" onchange="calcularIRAT()">
                        <option value="0">Cuidador profesional (0 pts)</option>
                        <option value="1">Cuidador informal (1 pts)</option>
                        <option value="2">Vive solo o sin cuidador (2 pts)</option>
                        <option value="3">Es cuidador de persona fr√°gil (3 pts)</option>
                    </select>
                </div>
                
                <div class="item-row">
                    <div class="item-label">5. Nivel de Cooperaci√≥n</div>
                    <select id="cooperacion" class="form-control" style="width: 300px;" onchange="calcularIRAT()">
                        <option value="0">Excelente - Sigue todas las instrucciones (0 pts)</option>
                        <option value="1">Buena - Sigue mayor√≠a de instrucciones (1 pts)</option>
                        <option value="2">Moderada - Requiere motivaci√≥n constante (2 pts)</option>
                        <option value="3">Mala - Se resiste o rechaza instrucciones (3 pts)</option>
                    </select>
                </div>
                
                <div class="item-row" style="background: linear-gradient(135deg, rgba(30,60,114,0.1), rgba(42,82,152,0.1));">
                    <div class="item-label" style="font-weight: 700; color: var(--primary-color);">
                        PUNTAJE TOTAL IRAT-5
                    </div>
                    <div class="item-score" id="puntaje-irat" style="font-size: 1.3rem; color: var(--primary-color);">0</div>
                </div>
            </div>

            <!-- TINETTI -->
            <div class="evaluation-group" id="tinetti-section">
                <h3><i class="fas fa-walking"></i> Test de Tinetti (Marcha y Equilibrio)</h3>
                <p style="color: #666; margin-bottom: 20px; font-style: italic;">
                    Indique el puntaje para cada componente (0, 1 o 2). M√°ximo 28 puntos.
                </p>

                <h4 style="color: var(--secondary-color); margin: 20px 0 15px 0;">I. Equilibrio (M√°x. 16)</h4>
                <!-- Solo mostr√© las primeras 3 preguntas por brevedad, incluye todas -->
                <div class="tinetti-row">
                    <div class="item-label">1. Equilibrio sentado</div>
                    <div class="tinetti-score-options">
                        <input type="radio" name="e1" value="0" id="e1_0" checked onclick="calcularTinetti(true)">
                        <label for="e1_0"><span>0</span></label>
                        <input type="radio" name="e1" value="1" id="e1_1" onclick="calcularTinetti(true)">
                        <label for="e1_1"><span>1</span></label>
                    </div>
                </div>
                
                <div class="tinetti-row">
                    <div class="item-label">2. Levantarse</div>
                    <div class="tinetti-score-options">
                        <input type="radio" name="e2" value="0" id="e2_0" onclick="calcularTinetti(true)">
                        <label for="e2_0"><span>0</span></label>
                        <input type="radio" name="e2" value="1" id="e2_1" onclick="calcularTinetti(true)">
                        <label for="e2_1"><span>1</span></label>
                        <input type="radio" name="e2" value="2" id="e2_2" onclick="calcularTinetti(true)">
                        <label for="e2_2"><span>2</span></label>
                    </div>
                </div>

                <h4 style="color: var(--secondary-color); margin: 25px 0 15px 0;">II. Marcha (M√°x. 12)</h4>
                <!-- Solo mostr√© las primeras 2 preguntas por brevedad -->
                <div class="tinetti-row">
                    <div class="item-label">10. Inicio de la marcha</div>
                    <div class="tinetti-score-options">
                        <input type="radio" name="m1" value="0" id="m1_0" checked onclick="calcularTinetti(true)">
                        <label for="m1_0"><span>0</span></label>
                        <input type="radio" name="m1" value="1" id="m1_1" onclick="calcularTinetti(true)">
                        <label for="m1_1"><span>1</span></label>
                    </div>
                </div>

                <div class="item-row" style="background: linear-gradient(135deg, rgba(30,60,114,0.1), rgba(42,82,152,0.1)); margin-top: 20px;">
                    <div class="item-label" style="font-weight: 700; color: var(--primary-color);">
                        PUNTAJE TOTAL TINETTI (M√°x 28)
                    </div>
                    <div class="item-score" id="puntaje-tinetti" style="font-size: 1.3rem; color: var(--primary-color);">0</div>
                </div>
            </div>

            <!-- NORTON -->
            <div class="evaluation-group" id="norton-section">
                <h3><i class="fas fa-bed"></i> Escala Norton (Riesgo de √ölcera por Presi√≥n)</h3>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Condici√≥n f√≠sica</label>
                        <select id="norton-fisica" class="form-control" onchange="calcularNorton()">
                            <option value="4">4. Buena</option>
                            <option value="3">3. Regular</option>
                            <option value="2">2. Pobre</option>
                            <option value="1">1. Muy Pobre</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Estado mental</label>
                        <select id="norton-mental" class="form-control" onchange="calcularNorton()">
                            <option value="4">4. Alerta</option>
                            <option value="3">3. Ap√°tico</option>
                            <option value="2">2. Confuso</option>
                            <option value="1">1. Estuporoso/Coma</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Actividad</label>
                        <select id="norton-actividad" class="form-control" onchange="calcularNorton()">
                            <option value="4">4. Ambulante</option>
                            <option value="3">3. Camina con ayuda</option>
                            <option value="2">2. En silla</option>
                            <option value="1">1. En cama</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Movilidad</label>
                        <select id="norton-movilidad" class="form-control" onchange="calcularNorton()">
                            <option value="4">4. Completa</option>
                            <option value="3">3. Disminuida</option>
                            <option value="2">2. Muy Limitada</option>
                            <option value="1">1. Inm√≥vil</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Incontinencia</label>
                        <select id="norton-incontinencia" class="form-control" onchange="calcularNorton()">
                            <option value="4">4. No</option>
                            <option value="3">3. Ocasional</option>
                            <option value="2">2. Urinaria</option>
                            <option value="1">1. Fecal y Urinaria</option>
                        </select>
                    </div>
                </div>
                
                <div class="item-row" style="background: linear-gradient(135deg, rgba(30,60,114,0.1), rgba(42,82,152,0.1));">
                    <div class="item-label" style="font-weight: 700; color: var(--primary-color);">
                        PUNTAJE TOTAL NORTON (M√°x 20)
                    </div>
                    <div class="item-score" id="puntaje-norton" style="font-size: 1.3rem; color: var(--primary-color);">20</div>
                </div>
            </div>

            <!-- BOTONES DE ACCI√ìN -->
            <div style="text-align: center; margin: 40px 0;">
                <button class="btn btn-success pulse" onclick="generarResultados()" style="padding: 16px 40px; font-size: 1.1rem;">
                    <i class="fas fa-calculator"></i> Generar Resultados Integrales
                </button>
                <button class="btn btn-secondary" onclick="resetForm()" style="margin-left: 15px;">
                    <i class="fas fa-undo"></i> Limpiar Formulario
                </button>
            </div>

            <!-- SECCI√ìN DE RESULTADOS -->
            <div class="results-section" id="results-section" style="display: none;">
                <h2 style="color: var(--primary-color); text-align: center; margin-bottom: 30px;">
                    <i class="fas fa-chart-line"></i> An√°lisis Cl√≠nico y Recomendaciones
                </h2>
                
                <div class="results-summary">
                    <div class="result-box" style="border-top-color: #4CAF50;">
                        <strong>Paciente</strong>
                        <span id="res-nombre" style="font-size: 1.2rem; font-weight: 600;">N/A</span>
                    </div>
                    
                    <div class="result-box" style="border-top-color: #2196F3;">
                        <strong>Fecha</strong>
                        <span id="res-fecha" style="font-size: 1.1rem; font-weight: 500;">N/A</span>
                    </div>
                    
                    <div class="result-box" style="border-top-color: var(--primary-color);">
                        <strong>IRAT-5</strong>
                        <span id="res-irat-total" class="resultado-valor">0</span>
                        <span id="res-irat-riesgo" class="risk-success">Riesgo Bajo</span>
                    </div>
                    
                    <div class="result-box" style="border-top-color: #FF9800;">
                        <strong>Tinetti</strong>
                        <span id="res-tinetti-total" class="resultado-valor">0 / 28</span>
                        <span>Marcha y Equilibrio</span>
                    </div>
                    
                    <div class="result-box" style="border-top-color: #9C27B0;">
                        <strong>Norton</strong>
                        <span id="res-norton-total" class="resultado-valor">20 / 20</span>
                        <span id="res-norton-riesgo" class="risk-success">Riesgo Bajo</span>
                    </div>
                    
                    <div class="result-box" style="border-top-color: var(--danger-color); background: linear-gradient(135deg, #fff9f9, #ffeaea);">
                        <strong>CLASIFICACI√ìN GLOBAL</strong>
                        <span id="res-global-riesgo" class="resultado-valor risk-success" style="font-size: 1.8rem;">BAJO</span>
                        <span style="color: #666; font-size: 0.9rem;">Recomendaciones personalizadas</span>
                    </div>
                </div>
                
                <h3 style="color: var(--primary-color); margin: 30px 0 20px 0;">
                    <i class="fas fa-clipboard-list"></i> Recomendaciones Interdisciplinarias
                </h3>
                
                <div id="recomendaciones-irat">
                    <!-- Las recomendaciones se generan din√°micamente aqu√≠ -->
                </div>
                
                <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 2px solid #eee;">
                    <button class="btn btn-success" onclick="saveReport()">
                        <i class="fas fa-save"></i> Guardar Evaluaci√≥n
                    </button>
                    <button class="btn btn-primary" onclick="generatePDF()" style="margin-left: 15px;">
                        <i class="fas fa-file-pdf"></i> Generar PDF Profesional
                    </button>
                    <button class="btn btn-secondary" onclick="shareResults()" style="margin-left: 15px;">
                        <i class="fas fa-share-alt"></i> Compartir
                    </button>
                </div>
            </div>

            <!-- HISTORIAL -->
            <div class="evaluation-group" style="margin-top: 40px;">
                <h3><i class="fas fa-history"></i> Historial de Evaluaciones</h3>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="loadHistorial(true)">
                        <i class="fas fa-sync-alt"></i> Actualizar Historial
                    </button>
                    
                    <button class="btn btn-danger" id="limpiar-historial-btn" style="display: none;">
                        <i class="fas fa-eraser"></i> Limpiar Historial (Admin)
                    </button>
                </div>
                
                <ul id="historial-list">
                    <li id="loading-history-msg">Cargando historial...</li>
                </ul>
            </div>
        </section>
        
        <!-- NOTIFICACI√ìN FLOTANTE -->
        <div id="notification-bar" class="notification-bar"></div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // ============================================
        // CONFIGURACI√ìN FIREBASE
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyDJbtRuEwWVAsC1Nz6LbeF5a99LcUfAz4g",
            authDomain: "irat-5-evaluaciones.firebaseapp.com",
            databaseURL: "https://irat-5-evaluaciones-default-rtdb.firebaseio.com",
            projectId: "irat-5-evaluaciones",
            storageBucket: "irat-5-evaluaciones.firebasestorage.app",
            messagingSenderId: "487279274410",
            appId: "1:487279274410:web:146e9c35a0bf795c5423d3",
            measurementId: "G-WSXJY5QHJS"
        };
        
        let app, db, auth;
        let authMode = 'login';
        let currentUser = null;
        let currentUserId = null;
        let lastReportData = {};
        
        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        function initFirebase() {
            try {
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                console.log("Firebase inicializado correctamente.");
                setupAuthStateListener();
            } catch (e) {
                console.error("Error al inicializar Firebase:", e);
                showNotification(`Error de conexi√≥n con Firebase`, 'error', 10000);
            }
        }
        
        window.onload = function() {
            initFirebase();
            // Configurar fecha actual
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fecha').value = today;
        };
        
        // ============================================
        // AUTENTICACI√ìN
        // ============================================
        function toggleAuthModeFunc() {
            if (authMode === 'login') {
                authMode = 'register';
                document.getElementById('auth-title').innerHTML = '<i class="fas fa-user-plus"></i> Registrar Nuevo Usuario';
                document.getElementById('auth-button').innerHTML = '<i class="fas fa-user-plus"></i> Registrar';
                document.getElementById('toggle-auth-mode').innerHTML = '<i class="fas fa-sign-in-alt"></i> Volver a Iniciar Sesi√≥n';
            } else {
                authMode = 'login';
                document.getElementById('auth-title').innerHTML = '<i class="fas fa-lock"></i> Iniciar Sesi√≥n';
                document.getElementById('auth-button').innerHTML = '<i class="fas fa-sign-in-alt"></i> Iniciar Sesi√≥n';
                document.getElementById('toggle-auth-mode').innerHTML = '<i class="fas fa-user-plus"></i> Reg√≠strate aqu√≠';
            }
        }
        
        async function handleAuth() {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
        
            if (!email || !password) {
                showNotification('Ingrese correo y contrase√±a.', 'warning');
                return;
            }
        
            try {
                if (authMode === 'register') {
                    await auth.createUserWithEmailAndPassword(email, password);
                    showNotification('Usuario registrado exitosamente.', 'success');
                } else {
                    await auth.signInWithEmailAndPassword(email, password);
                }
            } catch (error) {
                console.error("Error de autenticaci√≥n:", error);
                showNotification(`Error: ${error.message}`, 'error');
            }
        }
        
        function logout() {
            auth.signOut().then(() => {
                showNotification('Sesi√≥n cerrada correctamente.', 'info');
            }).catch((error) => {
                console.error("Error al cerrar sesi√≥n:", error);
                showNotification(`Error al cerrar sesi√≥n: ${error.message}`, 'error');
            });
        }
        
        async function checkAdminStatus(uid) {
            if (!db) return false;
            try {
                const doc = await db.collection('roles').doc(uid).get();
                return doc.exists && doc.data().role === 'admin';
            } catch (error) {
                console.error("Error al verificar rol:", error);
                return false;
            }
        }
        
        function setupAuthStateListener() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    currentUserId = user.uid;
                    
                    // Actualizar UI
                    document.getElementById('auth-section').style.display = 'none';
                    document.getElementById('main-app').style.display = 'block';
                    document.getElementById('user-display').style.display = 'flex';
                    document.getElementById('current-user-email').textContent = user.email;
                    
                    // Verificar rol de admin
                    checkAdminStatus(user.uid).then(isAdmin => {
                        if (isAdmin) {
                            document.getElementById('limpiar-historial-btn').style.display = 'inline-flex';
                            document.getElementById('limpiar-historial-btn').onclick = confirmAndClearHistorial;
                            showNotification('Acceso de administrador activado', 'warning');
                        }
                    });
                    
                    loadHistorial();
                    showNotification(`Bienvenido ${user.email}`, 'success');
                    
                } else {
                    currentUser = null;
                    currentUserId = null;
                    document.getElementById('auth-section').style.display = 'flex';
                    document.getElementById('main-app').style.display = 'none';
                    document.getElementById('user-display').style.display = 'none';
                    document.getElementById('limpiar-historial-btn').style.display = 'none';
                }
            });
        }
        
        // ============================================
        // C√ÅLCULOS DE EVALUACI√ìN
        // ============================================
        function calcularIRAT() {
            const items = ['equilibrio', 'amputacion', 'brazos', 'social', 'cooperacion'];
            let total = 0;
            items.forEach(id => {
                total += parseInt(document.getElementById(id).value) || 0;
            });
            
            // Agregar punto extra por riesgo de ca√≠da en amputaciones mayores
            const amputacion = parseInt(document.getElementById('amputacion').value) || 0;
            if (amputacion >= 3) total += 1;
            
            document.getElementById('puntaje-irat').textContent = total;
            return total;
        }
        
        function getIratAmputacionValue() {
            return parseInt(document.getElementById('amputacion').value) || 0;
        }
        
        function calcularTinetti(updateUI = true) {
            let total = 0;
            for (let i = 1; i <= 9; i++) {
                const radios = document.getElementsByName(`e${i}`);
                radios.forEach(radio => {
                    if (radio.checked) total += parseInt(radio.value);
                });
            }
            for (let i = 1; i <= 6; i++) {
                const radios = document.getElementsByName(`m${i}`);
                radios.forEach(radio => {
                    if (radio.checked) total += parseInt(radio.value);
                });
            }
            if (updateUI) document.getElementById('puntaje-tinetti').textContent = total;
            return total;
        }
        
        function calcularNorton() {
            const items = ['norton-fisica', 'norton-mental', 'norton-actividad', 'norton-movilidad', 'norton-incontinencia'];
            let total = 0;
            items.forEach(id => {
                total += parseInt(document.getElementById(id).value) || 0;
            });
            document.getElementById('puntaje-norton').textContent = total;
            return total;
        }
        
        // ============================================
        // CLASIFICACI√ìN COMBINADA (ACTUALIZADA)
        // ============================================
        function getCombinedClinicalClassification(iratScore, tinettiScore, nortonScore) {
            const iratAmputacion = getIratAmputacionValue();
            let recomendaciones = [];
            let nivelRiesgoGlobal = 'BAJO';
            
            // 1. L√≥gica por Amputaci√≥n
            if (iratAmputacion >= 3) {
                recomendaciones.push({
                    titulo: 'üö® Consideraci√≥n: Amputaci√≥n Presente',
                    texto: 'Requiere evaluaci√≥n y manejo prot√©sico urgente. Ense√±ar t√©cnicas de cuidado del mu√±√≥n para prevenir infecciones.',
                    color: 'danger',
                    tipo: 'Amputacion'
                });
                
                if (iratAmputacion === 4 || iratAmputacion === 6) {
                    recomendaciones.unshift({
                        titulo: "‚ôø Ayuda T√©cnica Principal: Silla de Ruedas",
                        texto: "Amputaci√≥n Bilateral. La ayuda principal de movilidad es la Silla de Ruedas.",
                        color: 'danger',
                        tipo: 'Movilidad Principal'
                    });
                    nivelRiesgoGlobal = 'CR√çTICO';
                }
            }
            
            // 2. Clasificaci√≥n por Movilidad (Tinetti)
            let ayudaPrincipalAsignada = recomendaciones.some(r => r.tipo === 'Movilidad Principal');
            if (!ayudaPrincipalAsignada) {
                if (tinettiScore <= 18) {
                    recomendaciones.push({ 
                        titulo: "üö∂ Ayuda T√©cnica Principal: Andador",
                        texto: "Tinetti Severo (Riesgo de Ca√≠da ALTO). Se recomienda Andador Fijo o de 2 ruedas.",
                        color: 'danger',
                        tipo: 'Movilidad Principal'
                    });
                    if (nivelRiesgoGlobal !== 'CR√çTICO') nivelRiesgoGlobal = 'ALTO';
                } else if (tinettiScore <= 24) {
                    recomendaciones.push({ 
                        titulo: "ü¶Ø Ayuda T√©cnica Principal: Bast√≥n de 4 Apoyos",
                        texto: "Tinetti Moderado. Se recomienda Bast√≥n de 4 Apoyos.",
                        color: 'warning',
                        tipo: 'Movilidad Principal'
                    });
                    if (nivelRiesgoGlobal === 'BAJO') nivelRiesgoGlobal = 'MODERADO';
                } else {
                    recomendaciones.push({ 
                        titulo: "üü¢ Ayuda T√©cnica Principal: Preventiva",
                        texto: "Tinetti √ìptimo. No se requiere ayuda t√©cnica principal.",
                        color: 'success',
                        tipo: 'Movilidad Principal'
                    });
                }
            }
            
            // 3. Riesgo de √ölcera (Norton)
            if (nortonScore <= 14) {
                recomendaciones.push({ 
                    titulo: 'üö® Riesgo de √ölcera por Presi√≥n ALTO', 
                    texto: 'Protocolo estricto de cambios posturales cada 2-3 horas.', 
                    color: 'danger', 
                    tipo: 'Ulcera' 
                });
                if (nivelRiesgoGlobal !== 'CR√çTICO' && nivelRiesgoGlobal !== 'ALTO') {
                    nivelRiesgoGlobal = 'ALTO';
                }
            }
            
            // 4. Recomendaciones Interdisciplinarias seg√∫n nivel de riesgo
            if (nivelRiesgoGlobal === 'CR√çTICO') {
                recomendaciones.push(
                    { titulo: 'KINESIOLOG√çA', texto: 'Inmediata. Transferencias cama-silla, fortalecimiento MMSS.', color: 'danger' },
                    { titulo: 'TERAPIA OCUPACIONAL', texto: 'Adaptaci√≥n del hogar para silla de ruedas.', color: 'danger' },
                    { titulo: 'NUTRICI√ìN', texto: 'Urgente. Evaluar ingesta proteica para cicatrizaci√≥n.', color: 'danger' }
                );
            } else if (nivelRiesgoGlobal === 'ALTO') {
                recomendaciones.push(
                    { titulo: 'KINESIOLOG√çA', texto: 'Intensiva. Reeducaci√≥n de marcha con andador.', color: 'danger' },
                    { titulo: 'TERAPIA OCUPACIONAL', texto: 'Barras de apoyo en ba√±o, eliminaci√≥n de alfombras.', color: 'warning' }
                );
            } else if (nivelRiesgoGlobal === 'MODERADO') {
                recomendaciones.push(
                    { titulo: 'KINESIOLOG√çA', texto: 'Moderada. Ejercicios en casa (programa Otago).', color: 'warning' },
                    { titulo: 'CONTROL M√âDICO', texto: 'Revisi√≥n de polifarmacia.', color: 'info' }
                );
            } else {
                recomendaciones.push(
                    { titulo: 'KINESIOLOG√çA', texto: 'Preventiva. Actividad f√≠sica regular.', color: 'success' },
                    { titulo: 'CONTROL ANUAL', texto: 'Revisi√≥n de audici√≥n y visi√≥n.', color: 'success' }
                );
            }
            
            return { 
                nivelRiesgoGlobal: nivelRiesgoGlobal, 
                colorGlobal: nivelRiesgoGlobal === 'CR√çTICO' ? 'critical' : 
                            nivelRiesgoGlobal === 'ALTO' ? 'danger' :
                            nivelRiesgoGlobal === 'MODERADO' ? 'warning' : 'success',
                recomendaciones: recomendaciones 
            };
        }
        
        // ============================================
        // GENERACI√ìN DE RESULTADOS
        // ============================================
        function generarResultados() {
            // Validar campos requeridos
            if (!document.getElementById('nombre').value || !document.getElementById('fecha').value || !document.getElementById('evaluador').value) {
                showNotification('Complete los datos del paciente antes de generar resultados.', 'warning');
                return;
            }
            
            const tinettiScore = calcularTinetti(false);
            const nortonScore = calcularNorton();
            const iratScore = calcularIRAT();
            
            // Clasificaci√≥n combinada
            const clasificacion = getCombinedClinicalClassification(iratScore, tinettiScore, nortonScore);
            
            // Determinar riesgos individuales
            let iratRiesgoTexto, iratRiesgoClase;
            if (iratScore <= 6) {
                iratRiesgoTexto = 'Riesgo Bajo';
                iratRiesgoClase = 'risk-success';
            } else if (iratScore <= 10) {
                iratRiesgoTexto = 'Riesgo Moderado';
                iratRiesgoClase = 'risk-warning';
            } else {
                iratRiesgoTexto = 'Riesgo Alto';
                iratRiesgoClase = 'risk-danger';
            }
            
            const nortonRiesgoTexto = nortonScore <= 14 ? 'Riesgo Alto' : 'Riesgo Bajo';
            const nortonRiesgoClase = nortonScore <= 14 ? 'risk-danger' : 'risk-success';
            
            // Actualizar UI
            document.getElementById('res-nombre').textContent = document.getElementById('nombre').value;
            document.getElementById('res-fecha').textContent = document.getElementById('fecha').value;
            document.getElementById('res-irat-total').textContent = iratScore;
            document.getElementById('res-irat-riesgo').textContent = iratRiesgoTexto;
            document.getElementById('res-irat-riesgo').className = `resultado-valor ${iratRiesgoClase}`;
            document.getElementById('res-tinetti-total').textContent = `${tinettiScore} / 28`;
            document.getElementById('res-norton-total').textContent = `${nortonScore} / 20`;
            document.getElementById('res-norton-riesgo').textContent = nortonRiesgoTexto;
            document.getElementById('res-norton-riesgo').className = `resultado-valor ${nortonRiesgoClase}`;
            document.getElementById('res-global-riesgo').textContent = clasificacion.nivelRiesgoGlobal;
            document.getElementById('res-global-riesgo').className = `resultado-valor risk-${clasificacion.colorGlobal}`;
            
            // Mostrar recomendaciones
            const recContainer = document.getElementById('recomendaciones-irat');
            recContainer.innerHTML = '';
            
            clasificacion.recomendaciones.forEach(rec => {
                const card = document.createElement('div');
                card.className = 'recommendation-card';
                let colorCode = '#6c757d';
                if (rec.color === 'danger') colorCode = '#F44336';
                if (rec.color === 'warning') colorCode = '#FF9800';
                if (rec.color === 'success') colorCode = '#4CAF50';
                
                card.style.borderLeftColor = colorCode;
                card.innerHTML = `<strong>${rec.titulo}</strong><p>${rec.texto}</p>`;
                recContainer.appendChild(card);
            });
            
            // Mostrar secci√≥n de resultados
            document.getElementById('results-section').style.display = 'block';
            
            // Guardar datos para Firebase/PDF
            lastReportData = {
                nombre: document.getElementById('nombre').value,
                fecha: document.getElementById('fecha').value,
                evaluador: document.getElementById('evaluador').value,
                edad: document.getElementById('edad').value,
                iratScore: iratScore,
                iratRiesgo: iratRiesgoTexto,
                tinettiScore: tinettiScore,
                nortonScore: nortonScore,
                nortonRiesgo: nortonRiesgoTexto,
                clasificacionGlobal: clasificacion.nivelRiesgoGlobal,
                recomendaciones: clasificacion.recomendaciones,
                timestamp: new Date().toISOString()
            };
            
            showNotification('Resultados generados correctamente.', 'success');
        }
        
        // ============================================
        // FIRESTORE OPERATIONS
        // ============================================
        async function saveReport() {
            if (!currentUser) {
                showNotification('Debe iniciar sesi√≥n para guardar.', 'error');
                return;
            }
            if (!lastReportData.nombre) {
                showNotification('Primero genere los resultados.', 'warning');
                return;
            }
            
            try {
                await db.collection('evaluaciones').add({
                    userId: currentUserId,
                    ...lastReportData,
                    firebaseTimestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                showNotification('Evaluaci√≥n guardada exitosamente.', 'success');
                loadHistorial();
            } catch (error) {
                console.error("Error al guardar:", error);
                showNotification(`Error: ${error.message}`, 'error');
            }
        }
        
        async function loadHistorial(forceRefresh = false) {
            if (!currentUserId) return;
            const historialList = document.getElementById('historial-list');
            historialList.innerHTML = '<li id="loading-history-msg">Cargando historial...</li>';
            
            try {
                const snapshot = await db.collection('evaluaciones')
                    .where('userId', '==', currentUserId)
                    .orderBy('firebaseTimestamp', 'desc')
                    .limit(20)
                    .get();
                
                historialList.innerHTML = '';
                if (snapshot.empty) {
                    historialList.innerHTML = '<li style="text-align: center; color: #666; padding: 40px;">No hay evaluaciones guardadas.</li>';
                    return;
                }
                
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const li = document.createElement('li');
                    const fecha = data.fecha || 'Sin fecha';
                    
                    li.innerHTML = `
                        <div>
                            <strong style="color: var(--primary-color);">${data.nombre || 'Sin nombre'}</strong>
                            <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                                ${fecha} | IRAT: ${data.iratScore || 0} | Tinetti: ${data.tinettiScore || 0}
                            </div>
                        </div>
                        <div>
                            <button class="btn btn-primary btn-sm" onclick="viewReport('${doc.id}')">
                                <i class="fas fa-eye"></i> Ver
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteReport('${doc.id}')" style="margin-left: 5px;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    historialList.appendChild(li);
                });
            } catch (error) {
                console.error("Error al cargar historial:", error);
                historialList.innerHTML = `<li>Error al cargar: ${error.message}</li>`;
            }
        }
        
        async function viewReport(docId) {
            try {
                const doc = await db.collection('evaluaciones').doc(docId).get();
                if (!doc.exists) {
                    showNotification('Reporte no encontrado.', 'error');
                    return;
                }
                const data = doc.data();
                
                // Cargar datos en el formulario
                document.getElementById('nombre').value = data.nombre || '';
                document.getElementById('fecha').value = data.fecha || '';
                document.getElementById('evaluador').value = data.evaluador || '';
                document.getElementById('edad').value = data.edad || '';
                
                // Recalcular resultados
                generarResultados();
                showNotification(`Evaluaci√≥n de ${data.nombre} cargada.`, 'info');
                
            } catch (error) {
                console.error("Error al cargar reporte:", error);
                showNotification(`Error: ${error.message}`, 'error');
            }
        }
        
        async function deleteReport(docId) {
            if (!confirm('¬øEliminar esta evaluaci√≥n?')) return;
            
            try {
                await db.collection('evaluaciones').doc(docId).delete();
                showNotification('Evaluaci√≥n eliminada.', 'success');
                loadHistorial();
            } catch (error) {
                console.error("Error al eliminar:", error);
                showNotification(`Error: ${error.message}`, 'error');
            }
        }
        
        async function confirmAndClearHistorial() {
            if (confirm("‚ö†Ô∏è ADVERTENCIA: Esta acci√≥n eliminar√° TODAS las evaluaciones. ¬øContinuar?")) {
                clearAllHistorial();
            }
        }
        
        async function clearAllHistorial() {
            if (!currentUser) {
                showNotification('Debe iniciar sesi√≥n.', 'error');
                return;
            }
            
            const isAdmin = await checkAdminStatus(currentUser.uid);
            if (!isAdmin) {
                showNotification('Solo administradores pueden limpiar el historial.', 'error');
                return;
            }
            
            showNotification('Limpiando historial...', 'warning', 5000);
            
            try {
                const snapshot = await db.collection('evaluaciones').limit(100).get();
                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                showNotification(`Se eliminaron ${snapshot.size} evaluaciones.`, 'success');
                loadHistorial();
            } catch (error) {
                console.error("Error al limpiar historial:", error);
                showNotification(`Error: ${error.message}`, 'error');
            }
        }
        
        // ============================================
        // UTILIDADES
        // ============================================
        function showNotification(message, type = 'info', duration = 3000) {
            const bar = document.getElementById('notification-bar');
            bar.textContent = message;
            bar.className = `notification-bar notification-${type}`;
            bar.style.display = 'block';
            
            setTimeout(() => {
                bar.style.display = 'none';
            }, duration);
        }
        
        function resetForm() {
            document.getElementById('nombre').value = '';
            document.getElementById('fecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('evaluador').value = '';
            document.getElementById('edad').value = '';
            
            // Reset IRAT
            ['equilibrio', 'amputacion', 'brazos', 'social', 'cooperacion'].forEach(id => {
                document.getElementById(id).selectedIndex = 0;
            });
            
            // Reset Tinetti
            document.querySelectorAll('#tinetti-section input[type="radio"]').forEach(radio => {
                if (radio.value === '0') radio.checked = true;
            });
            
            // Reset Norton
            ['norton-fisica', 'norton-mental', 'norton-actividad', 'norton-movilidad', 'norton-incontinencia'].forEach(id => {
                document.getElementById(id).selectedIndex = 0;
            });
            
            calcularIRAT();
            calcularTinetti();
            calcularNorton();
            
            document.getElementById('results-section').style.display = 'none';
            showNotification('Formulario reiniciado.', 'info');
        }
        
        function shareResults() {
            if (!lastReportData.nombre) {
                showNotification('Primero genere los resultados.', 'warning');
                return;
            }
            
            const text = `Evaluaci√≥n Cl√≠nica - ${lastReportData.nombre}\n` +
                        `Fecha: ${lastReportData.fecha}\n` +
                        `IRAT-5: ${lastReportData.iratScore} (${lastReportData.iratRiesgo})\n` +
                        `Tinetti: ${lastReportData.tinettiScore}/28\n` +
                        `Norton: ${lastReportData.nortonScore}/20 (${lastReportData.nortonRiesgo})\n` +
                        `Riesgo Global: ${lastReportData.clasificacionGlobal}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Evaluaci√≥n Cl√≠nica',
                    text: text,
                    url: window.location.href
                });
            } else if (navigator.clipboard) {
                navigator.clipboard.writeText(text)
                    .then(() => showNotification('Resultados copiados al portapapeles.', 'success'))
                    .catch(() => {
                        const textarea = document.createElement('textarea');
                        textarea.value = text;
                        document.body.appendChild(textarea);
                        textarea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textarea);
                        showNotification('Resultados copiados.', 'success');
                    });
            }
        }
        
        function generatePDF() {
            if (!lastReportData.nombre) {
                showNotification('Primero genere los resultados.', 'warning');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let y = 20;
            const margin = 20;
            const pageWidth = doc.internal.pageSize.width;
            
            // T√≠tulo
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(18);
            doc.setTextColor(30, 60, 114);
            doc.text("INFORME DE EVALUACI√ìN CL√çNICA", pageWidth / 2, y, { align: 'center' });
            y += 15;
            
            // Datos
            doc.setFontSize(11);
            doc.setTextColor(51, 51, 51);
            doc.text(`Paciente: ${lastReportData.nombre}`, margin, y);
            doc.text(`Fecha: ${lastReportData.fecha}`, pageWidth - margin, y, { align: 'right' });
            y += 10;
            doc.text(`Evaluador: ${lastReportData.evaluador || 'N/A'}`, margin, y);
            y += 15;
            
            // Resultados
            doc.setFont('helvetica', 'bold');
            doc.text("RESULTADOS:", margin, y);
            y += 8;
            doc.setFont('helvetica', 'normal');
            doc.text(`‚Ä¢ IRAT-5: ${lastReportData.iratScore} puntos - ${lastReportData.iratRiesgo}`, margin + 5, y);
            y += 7;
            doc.text(`‚Ä¢ Tinetti: ${lastReportData.tinettiScore}/28 puntos`, margin + 5, y);
            y += 7;
            doc.text(`‚Ä¢ Norton: ${lastReportData.nortonScore}/20 puntos - ${lastReportData.nortonRiesgo}`, margin + 5, y);
            y += 10;
            doc.setFont('helvetica', 'bold');
            doc.text(`RIESGO GLOBAL: ${lastReportData.clasificacionGlobal}`, margin, y);
            y += 15;
            
            // Recomendaciones
            doc.setFont('helvetica', 'bold');
            doc.text("RECOMENDACIONES:", margin, y);
            y += 8;
            doc.setFont('helvetica', 'normal');
            lastReportData.recomendaciones.forEach((rec, i) => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
                doc.text(`${i + 1}. ${rec.titulo}`, margin, y);
                y += 5;
                doc.text(rec.texto, margin + 5, y, { maxWidth: pageWidth - margin * 2 - 5 });
                y += 12;
            });
            
            // Pie de p√°gina
            const fechaGen = new Date().toLocaleDateString('es-ES');
            doc.setFontSize(9);
            doc.setTextColor(150, 150, 150);
            doc.text(`Generado el ${fechaGen} - Sistema Evaluador Cl√≠nico Integrado`, pageWidth / 2, 285, { align: 'center' });
            
            doc.save(`Evaluacion_${lastReportData.nombre.replace(/\s/g, '_')}_${lastReportData.fecha}.pdf`);
            showNotification('PDF generado correctamente.', 'success');
        }
    </script>
</body>
</html>
```

Principales Mejoras Implementadas:

1. Interfaz Elegante y Moderna:

¬∑ Gradientes profesionales y sombras suaves
¬∑ Animaciones fluidas (fadeIn, slideUp)
¬∑ Dise√±o responsive con grid flexible
¬∑ Iconograf√≠a Font Awesome integrada
¬∑ Colores profesionales (azul corporativo, indicadores de riesgo)

2. IRAT-5 Actualizado:

He reemplazado las preguntas originales con las nuevas que me indicaste:

1. Equilibrio Unipodal (0-4 puntos)
2. Tipo de Amputaci√≥n (0-6 puntos + riesgo adicional)
3. Funci√≥n de Brazos (0-2 puntos)
4. Situaci√≥n Social (0-3 puntos)
5. Nivel de Cooperaci√≥n (0-3 puntos)

3. Mejoras de UX:

¬∑ Botones con efectos hover y animaciones
¬∑ Tarjetas de recomendaciones con bordes de colores seg√∫n prioridad
¬∑ Notificaciones flotantes elegantes
¬∑ Loader visual para operaciones
¬∑ Efectos de transici√≥n en todos los elementos interactivos

4. Organizaci√≥n Visual:

¬∑ Header con gradiente y patr√≥n sutil
¬∑ Grupos de evaluaci√≥n con bordes izquierdos de color
¬∑ Grids responsivos para formularios
¬∑ Resultados en tarjetas organizadas
¬∑ Espaciado consistente y tipograf√≠a legible

5. Funcionalidades Mantenidas:

¬∑ Autenticaci√≥n Firebase completa
¬∑ CRUD completo con Firestore
¬∑ Historial con vista/eliminaci√≥n
¬∑ Generaci√≥n de PDF profesional
¬∑ Sistema de roles (admin/usuario)
¬∑ Compartir resultados

El sistema mantiene toda la funcionalidad original pero con una interfaz mucho m√°s profesional y amigable para uso cl√≠nico diario.
