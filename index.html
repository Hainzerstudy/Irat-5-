<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluación Clínica Integral + Control de Acceso</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* ==================================== */
        /* ========== ESTILOS GENERALES Y LOGIN ========== */
        /* ==================================== */
        :root {
            --primary-color: #1e3c72;
            --secondary-color: #2a5298;
            --accent-color: #4CAF50;
            --warning-color: #FF9800;
            --danger-color: #F44336;
            --light-color: #f8f9fa;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7ff;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 800px;
            margin: 20px auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        /* Login Screen */
        #login-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 100;
        }
        
        .login-card {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        
        .login-card h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.8rem;
        }
        
        .login-card .form-group {
            text-align: left;
            margin-bottom: 15px;
        }
        
        .login-card .form-label {
            color: #333;
            font-weight: 600;
            display: block;
            margin-bottom: 5px;
        }

        .login-card .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .toggle-form {
            margin-top: 20px;
            font-size: 0.9rem;
            color: #666;
            cursor: pointer;
        }
        
        .toggle-form:hover {
            text-decoration: underline;
            color: var(--primary-color);
        }
        
        /* Header y Botones de la App */
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        
        .user-display {
            margin-top: 10px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .user-display span {
            background: rgba(255,255,255,0.2);
            padding: 3px 10px;
            border-radius: 20px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }
        
        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        /* Navegación y Secciones */
        .nav-tabs {
            display: flex;
            justify-content: space-around;
            background-color: #f1f1f1;
            border-bottom: 2px solid var(--primary-color);
            flex-wrap: wrap;
        }
        
        .nav-tab {
            flex-grow: 1;
            padding: 15px 10px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            color: #555;
            transition: all 0.3s;
        }
        
        .nav-tab.active {
            background-color: white;
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
        }

        .section {
            padding: 30px;
            display: none;
        }
        
        .section.active {
            display: block;
        }

        .section-title {
            color: var(--primary-color);
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            font-size: 1.4rem;
        }

        /* Formulario */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .form-group {
            margin-bottom: 10px;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-top: 5px;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: var(--light-color);
        }
        
        .radio-group label {
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        .error-message {
            color: var(--danger-color);
            font-size: 0.8rem;
            margin-top: 5px;
        }

        /* Resultados */
        .result-box {
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 5px solid var(--primary-color);
            background: #f9f9f9;
        }

        .result-box.high-risk { border-left-color: var(--danger-color); background: #feebeb; }
        .result-box.medium-risk { border-left-color: var(--warning-color); background: #fff8e1; }
        .result-box.low-risk { border-left-color: var(--accent-color); background: #e8f5e9; }

        /* Historial */
        .historial-item {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .historial-info strong {
            display: block;
            font-size: 1.1rem;
            color: var(--primary-color);
        }
        
        .historial-info span {
            font-size: 0.9rem;
            color: #666;
        }

        .historial-actions button {
            margin-left: 10px;
        }

        /* Notificación */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px;
            border-radius: 5px;
            color: white;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        .notification.success { background-color: var(--accent-color); }
        .notification.error { background-color: var(--danger-color); }
        .notification.info { background-color: var(--primary-color); }
        
        .firebase-status {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1001;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
        }
        .firebase-connected { background-color: var(--accent-color); }
        .firebase-disconnected { background-color: var(--danger-color); }
    </style>
</head>
<body>
    
    <div id="firebase-status" class="firebase-status firebase-connected">
        <i class="fas fa-database"></i> Cargando...
    </div>

    <div id="login-screen" style="display: none;">
        <div class="login-card">
            <h2 id="auth-title">Iniciar Sesión</h2>
            <form id="auth-form">
                <div class="form-group">
                    <label class="form-label" for="auth-email">Correo Electrónico:</label>
                    <input type="email" id="auth-email" class="form-control" required placeholder="tu.correo@ejemplo.com">
                </div>
                <div class="form-group">
                    <label class="form-label" for="auth-password">Contraseña:</label>
                    <input type="password" id="auth-password" class="form-control" required placeholder="********">
                </div>
                <button type="submit" class="btn btn-primary" id="auth-submit-btn" style="width: 100%; margin-top: 20px;">
                    <i class="fas fa-sign-in-alt"></i> Iniciar Sesión
                </button>
            </form>
            <div id="auth-error-message" class="error-message" style="display: none; margin-top: 10px;"></div>
            
            <p class="toggle-form" id="toggle-auth-mode">¿No tienes cuenta? Regístrate aquí</p>
        </div>
    </div>
    
    <div id="main-app-container" style="display: none;">
        <div class="container">
            <div class="header">
                <h1><i class="fas fa-hospital-alt"></i> Evaluación Clínica Integral</h1>
                <p>IRAT-5 + Tinetti + Norton</p>
                <div id="user-display" class="user-display">
                    <i class="fas fa-user-md"></i> <span></span>
                </div>
            </div>
            
            <div class="nav-tabs">
                <button class="nav-tab active" data-section="identificacion">Identificación</button>
                <button class="nav-tab" data-section="evaluacion">IRAT-5</button>
                <button class="nav-tab" data-section="tinetti">Tinetti</button>
                <button class="nav-tab" data-section="norton">Norton</button>
                <button class="nav-tab" data-section="resultados">Resultados</button>
                <button class="nav-tab" data-section="historial">Historial</button>
            </div>
            
            <section id="identificacion" class="section active">
                <h2 class="section-title"><i class="fas fa-user"></i> Identificación del Paciente</h2>
                <button class="btn btn-danger btn-sm" id="btn-logout" style="position: absolute; top: 10px; right: 10px;">
                    <i class="fas fa-sign-out-alt"></i> Salir
                </button>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Nombre completo <span style="color:red">*</span></label>
                        <input type="text" id="nombre" class="form-control" placeholder="Nombre y apellidos del paciente" required>
                        <div id="error-nombre" class="error-message"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">RUT / Identificación</label>
                        <input type="text" id="rut" class="form-control" placeholder="Ej: 12.345.678-9">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Edad</label>
                        <input type="number" id="edad" class="form-control" placeholder="Edad en años">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Fecha evaluación <span style="color:red">*</span></label>
                        <input type="date" id="fecha" class="form-control" required>
                        <div id="error-fecha" class="error-message"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Sexo</label>
                        <select id="sexo" class="form-control">
                            <option value="">Seleccione...</option>
                            <option value="masculino">Masculino</option>
                            <option value="femenino">Femenino</option>
                            <option value="no especificado">No especificado</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Evaluador <span style="color:red">*</span></label>
                        <input type="text" id="evaluador" class="form-control" placeholder="Nombre del profesional" required>
                        <div id="error-evaluador" class="error-message"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Institución/Clínica</label>
                        <input type="text" id="institucion" class="form-control" placeholder="Nombre de la institución">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Número de Historia Clínica</label>
                        <input type="text" id="historia-clinica" class="form-control" placeholder="Número de identificación">
                    </div>
                </div>
                
                <div class="action-buttons" style="display:flex; justify-content: flex-end;">
                    <button class="btn btn-primary" id="siguiente-irat">
                        <i class="fas fa-arrow-right"></i> Siguiente: IRAT-5
                    </button>
                </div>
            </section>
            
            <section id="evaluacion" class="section">
                <h2 class="section-title"><i class="fas fa-clipboard-list"></i> Escala IRAT-5 Modificada</h2>
                <div class="form-grid" id="irat-form">
                    </div>
                <div class="action-buttons" style="display:flex; justify-content: space-between; margin-top: 20px;">
                    <button class="btn btn-warning" onclick="cambiarSeccion('identificacion')"><i class="fas fa-arrow-left"></i> Anterior</button>
                    <button class="btn btn-primary" id="siguiente-tinetti"><i class="fas fa-arrow-right"></i> Siguiente: Tinetti</button>
                </div>
            </section>

            <section id="tinetti" class="section">
                <h2 class="section-title"><i class="fas fa-walking"></i> Escala Tinetti (Equilibrio y Marcha)</h2>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="tinetti-no-evaluable">
                        La escala Tinetti no es evaluable (Marcar si el paciente no puede realizar las pruebas).
                    </label>
                </div>
                <div id="tinetti-equilibrio-form">
                    <h3>Equilibrio (Máx 16 pts)</h3>
                    </div>
                <div id="tinetti-marcha-form" style="margin-top: 20px;">
                    <h3>Marcha (Máx 12 pts)</h3>
                    </div>
                <div class="action-buttons" style="display:flex; justify-content: space-between; margin-top: 20px;">
                    <button class="btn btn-warning" onclick="cambiarSeccion('evaluacion')"><i class="fas fa-arrow-left"></i> Anterior</button>
                    <button class="btn btn-primary" id="siguiente-norton"><i class="fas fa-arrow-right"></i> Siguiente: Norton</button>
                </div>
            </section>

            <section id="norton" class="section">
                <h2 class="section-title"><i class="fas fa-procedures"></i> Escala de Norton (Riesgo de Úlceras)</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Condición Física</label>
                        <select id="norton-fisico" class="form-control" required>
                            <option value="4">Buena (4)</option>
                            <option value="3">Mediana (3)</option>
                            <option value="2">Pobre (2)</option>
                            <option value="1">Muy Pobre (1)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Estado Mental</label>
                        <select id="norton-mental" class="form-control" required>
                            <option value="4">Alerta (4)</option>
                            <option value="3">Apático (3)</option>
                            <option value="2">Confuso (2)</option>
                            <option value="1">Estuporoso (1)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Actividad</label>
                        <select id="norton-actividad" class="form-control" required>
                            <option value="4">Deambula solo (4)</option>
                            <option value="3">Deambula con ayuda (3)</option>
                            <option value="2">Sentado (2)</option>
                            <option value="1">Encamado (1)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Movilidad</label>
                        <select id="norton-movilidad" class="form-control" required>
                            <option value="4">Total (4)</option>
                            <option value="3">Disminuida (3)</option>
                            <option value="2">Muy limitada (2)</option>
                            <option value="1">Nula (1)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Incontinencia</label>
                        <select id="norton-incontinencia" class="form-control" required>
                            <option value="4">No (4)</option>
                            <option value="3">Ocasional (3)</option>
                            <option value="2">Urinaria (2)</option>
                            <option value="1">Doble (1)</option>
                        </select>
                    </div>
                </div>
                
                <div id="resultado-norton" class="result-box" style="margin-top: 20px;">
                    <strong>Puntaje Norton:</strong> <span id="norton-score">15</span><br>
                    <strong>Nivel de Riesgo:</strong> <span id="norton-riesgo">Sin Riesgo</span>
                </div>

                <div class="action-buttons" style="display:flex; justify-content: space-between; margin-top: 20px;">
                    <button class="btn btn-warning" onclick="cambiarSeccion('tinetti')"><i class="fas fa-arrow-left"></i> Anterior</button>
                    <button class="btn btn-primary" id="siguiente-resultados"><i class="fas fa-arrow-right"></i> Ver Resultados</button>
                </div>
            </section>

            <section id="resultados" class="section">
                <h2 class="section-title"><i class="fas fa-poll"></i> Resumen y Plan de Acción</h2>
                
                <div id="paciente-info-resumen" class="result-box" style="margin-bottom: 20px; background: #f0f4ff;">
                    <strong>Paciente:</strong> <span id="resumen-nombre">---</span> | 
                    <strong>ID:</strong> <span id="resumen-rut">---</span> |
                    <strong>Fecha:</strong> <span id="resumen-fecha">---</span>
                </div>

                <div id="resumen-irat" class="result-box"></div>
                
                <div id="resumen-tinetti" class="result-box" style="margin-top: 20px;"></div>
                
                <div id="resumen-norton-final" class="result-box" style="margin-top: 20px;"></div>

                <h3 style="color: var(--primary-color); margin-top: 30px; border-bottom: 1px solid #ddd; padding-bottom: 5px;">
                    <i class="fas fa-lightbulb"></i> Recomendaciones/Plan de Acción
                </h3>
                <ul id="recomendaciones-lista" style="padding-left: 20px; margin-top: 10px;">
                    </ul>

                <div class="action-buttons">
                    <button class="btn btn-warning" onclick="cambiarSeccion('norton')"><i class="fas fa-arrow-left"></i> Anterior</button>
                    <button class="btn btn-primary" id="btn-guardar"><i class="fas fa-save"></i> Guardar en Firebase</button>
                    <button class="btn btn-primary" id="btn-descargar-pdf"><i class="fas fa-file-pdf"></i> Descargar PDF</button>
                    <button class="btn btn-primary" id="btn-whatsapp"><i class="fab fa-whatsapp"></i> Compartir WhatsApp</button>
                    <button class="btn btn-primary" onclick="cambiarSeccion('historial')"><i class="fas fa-history"></i> Ir a Historial</button>
                </div>
            </section>

            <section id="historial" class="section">
                <h2 class="section-title"><i class="fas fa-history"></i> Historial de Evaluaciones</h2>
                
                <div class="info-box" style="padding: 15px; background: #e6e9f1; border-radius: 8px;">
                    <strong><i class="fas fa-info-circle"></i> Acceso Compartido</strong>
                    <p style="font-size: 0.9rem;">Usted puede ver todas las evaluaciones creadas por cualquier usuario de su equipo.</p>
                    <div id="firebase-stats" style="margin-top: 10px;">
                        <span id="total-evaluaciones">Cargando estadísticas...</span>
                    </div>
                </div>
                
                <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h4 style="margin-bottom: 15px; color: var(--primary-color);"><i class="fas fa-filter"></i> Filtros de búsqueda</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Nombre del paciente</label>
                            <input type="text" id="filter-nombre" class="form-control" placeholder="Buscar por nombre">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Fecha desde</label>
                            <input type="date" id="filter-fecha-desde" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Fecha hasta</label>
                            <input type="date" id="filter-fecha-hasta" class="form-control">
                        </div>
                    </div>
                    <div class="action-buttons" style="margin-top: 15px; justify-content: flex-start; gap: 10px;">
                        <button class="btn btn-primary" id="btn-aplicar-filtros">
                            <i class="fas fa-search"></i> Buscar
                        </button>
                        <button class="btn btn-warning" id="btn-limpiar-filtros">
                            <i class="fas fa-undo"></i> Limpiar
                        </button>
                    </div>
                </div>
                
                <div id="historial-container" class="historial-container">
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-spinner fa-spin fa-2x" style="margin-bottom: 20px;"></i>
                        <p>Cargando historial desde Firebase...</p>
                    </div>
                </div>
                
                <div id="pagination-container" style="display: none; margin-top: 20px; text-align: center;">
                    <div class="pagination">
                        <button class="btn btn-primary" id="btn-prev" disabled>
                            <i class="fas fa-chevron-left"></i> Anterior
                        </button>
                        <span id="page-info" style="margin: 0 15px; font-weight: 600;">Página 1</span>
                        <button class="btn btn-primary" id="btn-next">
                            Siguiente <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                
                <div class="action-buttons" style="display:flex; justify-content: flex-start; margin-top: 20px;">
                    <button class="btn btn-warning" onclick="cambiarSeccion('resultados')">
                        <i class="fas fa-arrow-left"></i> Volver a Resultados
                    </button>
                </div>
            </section>
        </div>
    </div>
    
    <div id="notification" class="notification"></div>

    <script>
        // ====================================
        // ========== CONFIGURACIÓN FIREBASE ==========
        // ====================================
        
        // ¡¡¡IMPORTANTE!!!: REEMPLAZA ESTOS VALORES CON TUS CREDENCIALES REALES
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDJbtRuEwWVAsC1Nz6LbeF5a99LcUfAz4g",
  authDomain: "irat-5-evaluaciones.firebaseapp.com",
  databaseURL: "https://irat-5-evaluaciones-default-rtdb.firebaseio.com",
  projectId: "irat-5-evaluaciones",
  storageBucket: "irat-5-evaluaciones.firebasestorage.app",
  messagingSenderId: "487279274410",
  appId: "1:487279274410:web:146e9c35a0bf795c5423d3",
  measurementId: "G-WSXJY5QHJS"
};

        // ====================================
        // ========== VARIABLES GLOBALES ==========
        // ====================================
        let firebaseApp;
        let db;
        let auth; 
        let currentUser = null; 
        
        let datosCompletos = null; 
        let idEvaluacionActual = null; 
        let historialFirebase = [];
        let currentPage = 1;
        const itemsPerPage = 5;
        let lastVisible = null;
        let firstVisible = null;
        
        // Variables de puntajes
        let puntajeTotalIRAT = 0;
        let puntajeNorton = 15;
        let puntajeTinetti = 0;
        let nivelRiesgoIRAT = "";
        let nivelRiesgoNorton = "";
        let recomendaciones = [];
        let tinettiNoEvaluable = false;
        let respuestasTinetti = {};
        let respuestasIRAT = {};
        let respuestasNorton = {};

        // Definiciones de las escalas
        const IRAT_DEFINITIONS = [
            { question: "1. Movilidad y Traslado", options: [{ label: "Independiente", value: 0 }, { label: "Requiere Ayuda", value: 1 }, { label: "Inmóvil", value: 2 }] },
            { question: "2. Estado Mental", options: [{ label: "Consciente y Orientado", value: 0 }, { label: "Desorientado/Confuso", value: 1 }, { label: "Inconsciente/Estupor", value: 2 }] },
            { question: "3. Nutrición (Apetito)", options: [{ label: "Normal/Aceptable", value: 0 }, { label: "Disminuido/Selectivo", value: 1 }, { label: "Muy Pobre/Sonda", value: 2 }] },
            { question: "4. Incontinencia (Doble)", options: [{ label: "Continente", value: 0 }, { label: "Solo Urinaria u Ocasional", value: 1 }, { label: "Doble Incontinencia", value: 2 }] },
            { question: "5. Piel (Integridad/Edema)", options: [{ label: "Piel sana/Normal", value: 0 }, { label: "Riesgo/Piel Frágil/Edema Leve", value: 1 }, { label: "Lesión existente/Úlcera/Edema Grave", value: 2 }] }
        ];

        const TINETTI_DEFINITIONS_EQUILIBRIO = [
            { question: "1. Equilibrio sentado", options: [{ label: "Seguro", value: 1 }, { label: "Inseguro", value: 0 }] },
            { question: "2. Levantarse (de la silla)", options: [{ label: "Se levanta sin ayuda", value: 2 }, { label: "Se levanta con ayuda", value: 1 }, { label: "Incapaz sin ayuda", value: 0 }] },
            { question: "3. Intentos de levantarse", options: [{ label: "Un intento", value: 1 }, { label: "Múltiples intentos", value: 0 }] },
            { question: "4. Equilibrio de pie (primeros 5 segundos)", options: [{ label: "Estable sin apoyo", value: 2 }, { label: "Usa apoyo/inestable", value: 1 }, { label: "Incapaz de mantenerse", value: 0 }] },
            { question: "5. Equilibrio de pie (general)", options: [{ label: "Estable (pies juntos, ojos cerrados)", value: 2 }, { label: "Ligeramente inestable", value: 1 }, { label: "Muy inestable o requiere apoyo", value: 0 }] },
            { question: "6. Empujón (equilibrio tras empujón en esternón)", options: [{ label: "Estable", value: 1 }, { label: "Se tambalea/pierde equilibrio", value: 0 }] },
            { question: "7. Ojos cerrados (equilibrio de pie por 10 segundos)", options: [{ label: "Estable", value: 1 }, { label: "Inestable", value: 0 }] },
            { question: "8. Giro de 360°", options: [{ label: "Continuo y estable", value: 2 }, { label: "Discontinuo/inestable", value: 1 }, { label: "Ayuda/incapaz", value: 0 }] },
            { question: "9. Sentarse", options: [{ label: "Seguro", value: 2 }, { label: "Usa brazos o cae", value: 1 }, { label: "Sin control", value: 0 }] }
        ]; // Máx 16 pts

        const TINETTI_DEFINITIONS_MARCHA = [
            { question: "1. Inicio de la marcha (al dar el primer paso)", options: [{ label: "Sin titubeos", value: 1 }, { label: "Titubeante o arrastra", value: 0 }] },
            { question: "2. Longitud del paso (pie derecho, no sobrepasa el izquierdo)", options: [{ label: "Sobrepasa", value: 1 }, { label: "No sobrepasa", value: 0 }] },
            { question: "3. Altura del paso (pie derecho, levanta totalmente)", options: [{ label: "Levanta totalmente", value: 1 }, { label: "Arrastra", value: 0 }] },
            { question: "4. Longitud del paso (pie izquierdo, no sobrepasa el derecho)", options: [{ label: "Sobrepasa", value: 1 }, { label: "No sobrepasa", value: 0 }] },
            { question: "5. Altura del paso (pie izquierdo, levanta totalmente)", options: [{ label: "Levanta totalmente", value: 1 }, { label: "Arrastra", value: 0 }] },
            { question: "6. Simetría del paso", options: [{ label: "Pasos simétricos", value: 1 }, { label: "Pasos asimétricos", value: 0 }] },
            { question: "7. Continuidad del paso", options: [{ label: "Continuo", value: 1 }, { label: "Discontinuo", value: 0 }] },
            { question: "8. Trayectoria (desviación al caminar)", options: [{ label: "Recta", value: 2 }, { label: "Leve desviación", value: 1 }, { label: "Marcada desviación", value: 0 }] },
            { question: "9. Tronco", options: [{ label: "No se balancea", value: 1 }, { label: "Balanceo", value: 0 }] },
            { question: "10. Postura al caminar (uso de ayuda)", options: [{ label: "Sin ayuda/No usa", value: 1 }, { label: "Usa ayuda", value: 0 }] },
            { question: "11. Ancho de la base (separación de los pies)", options: [{ label: "Estrecha o talones casi juntos", value: 1 }, { label: "Separada", value: 0 }] }
        ]; // Máx 12 pts

        // ====================================
        // ========== INICIALIZACIÓN PRINCIPAL ==========
        // ====================================
        
        document.addEventListener('DOMContentLoaded', function() {
            inicializarFirebase();
            configurarAutenticacion();
            configurarApp();
            mostrarNotificacion('Sistema cargado', 'success');
        });
        
        function configurarApp() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fecha').value = today;
            
            inicializarNavegacion();
            configurarIRAT5();
            configurarTinetti();
            calcularNorton(); // Cálculo inicial de 15 (sin riesgo)
            configurarHistorial();
            configurarValidaciones();
            
            // Eventos de botones
            document.getElementById('siguiente-irat').addEventListener('click', () => {
                if(validarIdentificacion()) cambiarSeccion('evaluacion');
            });
            document.getElementById('siguiente-tinetti').addEventListener('click', () => cambiarSeccion('tinetti'));
            document.getElementById('siguiente-norton').addEventListener('click', () => cambiarSeccion('norton'));
            document.getElementById('siguiente-resultados').addEventListener('click', () => {
                calcularResultadosCompletos(true);
                cambiarSeccion('resultados');
            });
            document.getElementById('btn-guardar').addEventListener('click', guardarEnFirebase);
            document.getElementById('btn-descargar-pdf').addEventListener('click', generarPDF);
            document.getElementById('btn-whatsapp').addEventListener('click', compartirWhatsApp);
            document.getElementById('btn-logout').addEventListener('click', cerrarSesion);

            // Eventos de Norton
            ['norton-fisico', 'norton-mental', 'norton-actividad', 'norton-movilidad', 'norton-incontinencia'].forEach(id => {
                document.getElementById(id).addEventListener('change', calcularNorton);
            });
        }


        // ====================================
        // ========== FIREBASE & AUTHENTICATION ==========
        // ====================================
        
        function inicializarFirebase() {
            try {
                firebaseApp = firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth(); // Inicializar Auth
                actualizarEstadoFirebase('Conectado a Firestore', 'firebase-connected');
            } catch (error) {
                console.error('Error inicializando Firebase:', error);
                actualizarEstadoFirebase('Error de conexión', 'firebase-disconnected');
                mostrarNotificacion('Error conectando a Firebase. Revisa tus credenciales.', 'error');
            }
        }
        
        function configurarAutenticacion() {
            const authForm = document.getElementById('auth-form');
            authForm.dataset.mode = 'login'; 
            
            auth.onAuthStateChanged(user => {
                if (user) {
                    // USUARIO LOGUEADO
                    currentUser = user;
                    console.log("Usuario autenticado:", user.email, "UID:", user.uid);
                    
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('main-app-container').style.display = 'block';
                    document.getElementById('user-display').querySelector('span').textContent = user.email;
                    
                    // Solo cargar historial si estamos en la vista de historial o si la app acaba de cargar
                    if (document.getElementById('historial').classList.contains('active') || 
                        document.getElementById('main-app-container').style.display === 'block') {
                        cargarHistorialFirebase(); 
                    }
                    
                } else {
                    // USUARIO DESCONECTADO
                    currentUser = null;
                    document.getElementById('login-screen').style.display = 'flex';
                    document.getElementById('main-app-container').style.display = 'none';
                    document.getElementById('user-display').querySelector('span').textContent = '';
                }
            });
            
            // Toggle Login/Register
            document.getElementById('toggle-auth-mode').addEventListener('click', () => {
                const mode = authForm.dataset.mode;
                const isLogin = mode === 'login';
                authForm.dataset.mode = isLogin ? 'register' : 'login';
                document.getElementById('auth-title').textContent = isLogin ? 'Registro de Usuario' : 'Iniciar Sesión';
                document.getElementById('auth-submit-btn').innerHTML = isLogin ? '<i class="fas fa-user-plus"></i> Registrar Cuenta' : '<i class="fas fa-sign-in-alt"></i> Iniciar Sesión';
                document.getElementById('toggle-auth-mode').textContent = isLogin ? '¿Ya tienes cuenta? Inicia Sesión aquí' : '¿No tienes cuenta? Regístrate aquí';
                document.getElementById('auth-error-message').style.display = 'none';
            });

            authForm.addEventListener('submit', handleAuthSubmit);
        }
        
        async function handleAuthSubmit(e) {
            e.preventDefault();
            
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const mode = document.getElementById('auth-form').dataset.mode;
            const errorElement = document.getElementById('auth-error-message');
            errorElement.style.display = 'none';
            
            try {
                if (mode === 'register') {
                    await auth.createUserWithEmailAndPassword(email, password);
                    mostrarNotificacion('Registro exitoso. Iniciando sesión...', 'success');
                } else {
                    await auth.signInWithEmailAndPassword(email, password);
                    mostrarNotificacion('Inicio de sesión exitoso', 'success');
                }
                
            } catch (error) {
                console.error("Error de autenticación:", error);
                let msg = 'Error desconocido. Intente de nuevo.';
                if (error.code === 'auth/email-already-in-use') {
                    msg = 'El correo ya está registrado.';
                } else if (error.code === 'auth/invalid-email') {
                    msg = 'El formato del correo es inválido.';
                } else if (error.code === 'auth/weak-password') {
                    msg = 'La contraseña debe tener al menos 6 caracteres.';
                } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    msg = 'Correo o contraseña incorrectos.';
                }
                errorElement.textContent = msg;
                errorElement.style.display = 'block';
            }
        }

        function cerrarSesion() {
            auth.signOut().then(() => {
                mostrarNotificacion('Sesión cerrada correctamente', 'info');
                // Limpiar la aplicación después de cerrar sesión
                iniciarNuevaEvaluacion(false); 
            }).catch(error => {
                mostrarNotificacion('Error al cerrar sesión: ' + error.message, 'error');
            });
        }

        function actualizarEstadoFirebase(message, className) {
            const statusDiv = document.getElementById('firebase-status');
            statusDiv.innerHTML = `<i class="fas fa-database"></i> ${message}`;
            statusDiv.className = `firebase-status ${className}`;
        }
        
        // ====================================
        // ========== FIREBASE DATA STORAGE ==========
        // ====================================
        
        async function guardarEnFirebase() {
            if (!currentUser) {
                mostrarNotificacion('Debe iniciar sesión para guardar evaluaciones.', 'error');
                return;
            }
            
            // Asegurarse de que los resultados estén calculados y válidos
            if (!datosCompletos && !calcularResultadosCompletos(false)) {
                mostrarNotificacion('Debe completar la identificación y calcular los resultados.', 'error');
                return;
            }
            
            try {
                mostrarNotificacion(idEvaluacionActual ? 'Actualizando en Firebase...' : 'Guardando en Firebase...', 'info');
                
                const datosFirebase = {
                    ...datosCompletos,
                    userId: currentUser.uid, // ID del usuario logueado (CRUCIAL para reglas)
                    userEmail: currentUser.email,
                    fechaGuardado: firebase.firestore.FieldValue.serverTimestamp(),
                    fechaEvaluacion: datosCompletos.paciente.fecha || new Date().toISOString().split('T')[0]
                };
                
                let docRef;
                
                if (idEvaluacionActual) {
                    docRef = db.collection('evaluaciones').doc(idEvaluacionActual);
                    // Regla de seguridad asegura que solo el dueño puede actualizar
                    await docRef.update(datosFirebase);
                    mostrarNotificacion(`Evaluación actualizada (ID: ${idEvaluacionActual.substring(0, 8)}...)`, 'success');
                } else {
                    docRef = await db.collection('evaluaciones').add(datosFirebase);
                    idEvaluacionActual = docRef.id; 
                    mostrarNotificacion(`Evaluación guardada (ID: ${docRef.id.substring(0, 8)}...)`, 'success');
                }
                
                // Recargar historial después de guardar
                cargarHistorialFirebase();
                
            } catch (error) {
                console.error('Error guardando en Firebase:', error);
                if (error.code === 'permission-denied') {
                    mostrarNotificacion('Error: No tiene permiso para modificar esta evaluación (Solo puede editar las suyas).', 'error');
                } else {
                    mostrarNotificacion('Error al guardar: ' + error.message, 'error');
                }
            }
        }

        async function cargarHistorialFirebase() {
            if (!currentUser) { 
                document.getElementById('historial-container').innerHTML = '<p style="text-align: center; padding: 30px;">Inicie sesión para ver el historial.</p>';
                document.getElementById('total-evaluaciones').textContent = '0 evaluaciones';
                return;
            }
            
            try {
                mostrarCargandoHistorial(true);
                
                const nombreFilter = document.getElementById('filter-nombre').value.trim().toLowerCase();
                const fechaDesdeFilter = document.getElementById('filter-fecha-desde').value;
                const fechaHastaFilter = document.getElementById('filter-fecha-hasta').value;
                
                let query = db.collection('evaluaciones');
                query = query.orderBy('fechaEvaluacion', 'desc');

                // Aplicar filtros de fecha (si existen)
                if (fechaDesdeFilter) {
                    query = query.where('fechaEvaluacion', '>=', fechaDesdeFilter);
                }
                if (fechaHastaFilter) {
                    const fechaHastaObj = new Date(fechaHastaFilter + 'T00:00:00');
                    fechaHastaObj.setDate(fechaHastaObj.getDate() + 1);
                    const fechaHastaExclusiva = fechaHastaObj.toISOString().split('T')[0];
                    query = query.where('fechaEvaluacion', '<', fechaHastaExclusiva);
                }

                // Obtener todos los documentos que cumplen el filtro de fecha (permitido por las reglas de acceso compartido)
                const snapshot = await query.get();
                
                historialFirebase = [];
                snapshot.forEach(doc => {
                    historialFirebase.push({ id: doc.id, ...doc.data() });
                });
                
                // Filtrado por Nombre (Lado del Cliente)
                let resultadosFiltrados = historialFirebase;
                if (nombreFilter) {
                    resultadosFiltrados = historialFirebase.filter(evaluacion => {
                        const nombrePaciente = (evaluacion.paciente?.nombre || '').toLowerCase();
                        return nombrePaciente.includes(nombreFilter); 
                    });
                }
                
                historialFirebase = resultadosFiltrados;
                
                // Aplicar paginación local
                actualizarVistaHistorial();
                actualizarEstadisticas(historialFirebase.length);
                actualizarPaginacion();
                
            } catch (error) {
                console.error('Error cargando historial Firebase:', error);
                mostrarErrorHistorial('Error de carga. Verifique la conexión o las reglas de seguridad.');
            } finally {
                mostrarCargandoHistorial(false);
            }
        }
        
        // ... (El resto de las funciones de historial, filtros, etc.) ...

        function mostrarCargandoHistorial(isLoading) {
            const container = document.getElementById('historial-container');
            if (isLoading) {
                container.innerHTML = `<div style="text-align: center; padding: 40px; color: #666;">
                    <i class="fas fa-spinner fa-spin fa-2x" style="margin-bottom: 20px;"></i>
                    <p>Cargando historial desde Firebase...</p>
                </div>`;
            } else if (container.querySelector('.fa-spin')) {
                container.innerHTML = ''; // Limpiar el spinner si ya no carga
            }
        }
        
        function actualizarEstadisticas(count) {
            document.getElementById('total-evaluaciones').textContent = `${count} evaluaciones en total (Filtros aplicados).`;
        }

        function actualizarVistaHistorial() {
            const container = document.getElementById('historial-container');
            container.innerHTML = '';
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const itemsToShow = historialFirebase.slice(startIndex, endIndex);

            if (itemsToShow.length === 0 && historialFirebase.length > 0) {
                // Si la página actual no tiene items pero el historial total sí (ej. borrado o fin de página)
                currentPage = Math.max(1, Math.ceil(historialFirebase.length / itemsPerPage));
                actualizarVistaHistorial(); // Recargar la vista
                return;
            }
            
            if (historialFirebase.length === 0) {
                mostrarHistorialVacio(true);
                return;
            }

            itemsToShow.forEach(evaluacion => {
                const item = document.createElement('div');
                const isOwner = evaluacion.userId === currentUser.uid;
                const ownerText = isOwner ? ' (Creada por mí)' : ` (Creada por: ${evaluacion.userEmail})`;
                
                item.className = 'historial-item';
                item.innerHTML = `
                    <div class="historial-info">
                        <strong>${evaluacion.paciente.nombre}</strong>
                        <span>Fecha: ${evaluacion.paciente.fecha} | IRAT-5: ${evaluacion.resultados.irat.nivel} | Tinetti: ${evaluacion.resultados.tinetti.puntaje} pts ${ownerText}</span>
                    </div>
                    <div class="historial-actions">
                        <button class="btn btn-primary btn-sm" onclick="cargarEvaluacion('${evaluacion.id}')">
                            <i class="fas fa-eye"></i> Ver/Editar
                        </button>
                        ${isOwner ? `<button class="btn btn-danger btn-sm" onclick="eliminarEvaluacion('${evaluacion.id}', '${evaluacion.paciente.nombre}')">
                            <i class="fas fa-trash-alt"></i> Borrar
                        </button>` : ''}
                    </div>
                `;
                container.appendChild(item);
            });
        }
        
        function actualizarPaginacion() {
            const totalPages = Math.ceil(historialFirebase.length / itemsPerPage);
            const prevBtn = document.getElementById('btn-prev');
            const nextBtn = document.getElementById('btn-next');
            const pageInfo = document.getElementById('page-info');
            
            document.getElementById('pagination-container').style.display = totalPages > 1 ? 'block' : 'none';
            
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages || historialFirebase.length === 0;
            pageInfo.textContent = `Página ${currentPage} de ${totalPages}`;
        }
        
        // Manejadores de Paginación
        document.getElementById('btn-prev').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                actualizarVistaHistorial();
                actualizarPaginacion();
            }
        });
        
        document.getElementById('btn-next').addEventListener('click', () => {
            const totalPages = Math.ceil(historialFirebase.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                actualizarVistaHistorial();
                actualizarPaginacion();
            }
        });

        document.getElementById('btn-aplicar-filtros').addEventListener('click', () => {
            currentPage = 1;
            cargarHistorialFirebase();
        });

        document.getElementById('btn-limpiar-filtros').addEventListener('click', () => {
            document.getElementById('filter-nombre').value = '';
            document.getElementById('filter-fecha-desde').value = '';
            document.getElementById('filter-fecha-hasta').value = '';
            currentPage = 1;
            cargarHistorialFirebase();
        });

        async function cargarEvaluacion(id) {
            try {
                mostrarNotificacion('Cargando evaluación...', 'info');
                const doc = await db.collection('evaluaciones').doc(id).get();
                if (!doc.exists) {
                    mostrarNotificacion('Evaluación no encontrada.', 'error');
                    return;
                }
                
                const data = doc.data();
                // 1. Cargar variables globales
                datosCompletos = data;
                idEvaluacionActual = id;
                
                // 2. Cargar datos de paciente
                document.getElementById('nombre').value = data.paciente.nombre || '';
                document.getElementById('rut').value = data.paciente.rut || '';
                document.getElementById('edad').value = data.paciente.edad || '';
                document.getElementById('fecha').value = data.paciente.fecha || '';
                document.getElementById('sexo').value = data.paciente.sexo || '';
                document.getElementById('evaluador').value = data.paciente.evaluador || '';
                document.getElementById('institucion').value = data.paciente.institucion || '';
                document.getElementById('historia-clinica').value = data.paciente.historiaClinica || '';

                // 3. Cargar respuestas de las escalas (IRAT, Tinetti, Norton)
                cargarRespuestas(data.respuestas.irat, 'irat');
                cargarRespuestas(data.respuestas.tinetti, 'tinetti');
                
                // Cargar Norton (selects)
                document.getElementById('norton-fisico').value = data.respuestas.norton.fisico || 4;
                document.getElementById('norton-mental').value = data.respuestas.norton.mental || 4;
                document.getElementById('norton-actividad').value = data.respuestas.norton.actividad || 4;
                document.getElementById('norton-movilidad').value = data.respuestas.norton.movilidad || 4;
                document.getElementById('norton-incontinencia').value = data.respuestas.norton.incontinencia || 4;
                calcularNorton(); // Recalcular puntaje
                
                // 4. Mover a resultados y calcular
                calcularResultadosCompletos(true);
                cambiarSeccion('resultados');
                mostrarNotificacion(`Evaluación de ${data.paciente.nombre} cargada.`, 'success');

            } catch (error) {
                console.error('Error al cargar evaluación:', error);
                mostrarNotificacion('Error al cargar la evaluación.', 'error');
            }
        }
        
        function cargarRespuestas(respuestas, prefix) {
            for (const key in respuestas) {
                const element = document.querySelector(`input[name="${prefix}-${key}"][value="${respuestas[key]}"]`);
                if (element) {
                    element.checked = true;
                }
            }
        }

        async function eliminarEvaluacion(id, nombre) {
            if (!confirm(`¿Está seguro de eliminar la evaluación de ${nombre}? Esta acción es irreversible.`)) {
                return;
            }

            try {
                mostrarNotificacion('Eliminando evaluación...', 'info');
                // La regla de seguridad de Firestore verifica que solo el dueño pueda eliminar
                await db.collection('evaluaciones').doc(id).delete();
                mostrarNotificacion(`Evaluación de ${nombre} eliminada correctamente.`, 'success');
                cargarHistorialFirebase(); // Recargar el historial
                if (id === idEvaluacionActual) {
                    iniciarNuevaEvaluacion(false); // Si eliminamos la que está abierta
                }

            } catch (error) {
                console.error('Error al eliminar evaluación:', error);
                if (error.code === 'permission-denied') {
                     mostrarNotificacion('Error: Solo el creador de esta evaluación puede eliminarla.', 'error');
                } else {
                    mostrarNotificacion('Error al eliminar: ' + error.message, 'error');
                }
            }
        }
        
        function iniciarNuevaEvaluacion(confirmacion = true) {
            if (confirmacion && !confirm('¿Está seguro de comenzar una nueva evaluación? Los datos no guardados se perderán.')) {
                return;
            }
            // Recargar para limpiar todos los inputs y estados de la aplicación
            window.location.reload(); 
        }

        // ====================================
        // ========== NAVEGACIÓN Y VALIDACIÓN ==========
        // ====================================
        
        function inicializarNavegacion() {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    cambiarSeccion(this.dataset.section);
                });
            });
        }

        function cambiarSeccion(targetId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(targetId).classList.add('active');
            document.querySelector(`.nav-tab[data-section="${targetId}"]`).classList.add('active');
            
            // Si el usuario navega al historial, forzamos la recarga de Firebase (por si cerró sesión)
            if (targetId === 'historial') {
                cargarHistorialFirebase();
            }
        }
        
        function validarIdentificacion() {
            let isValid = true;
            const nombre = document.getElementById('nombre');
            const fecha = document.getElementById('fecha');
            const evaluador = document.getElementById('evaluador');
            
            if (!nombre.value) {
                document.getElementById('error-nombre').textContent = 'El nombre es obligatorio.';
                isValid = false;
            } else {
                document.getElementById('error-nombre').textContent = '';
            }

            if (!fecha.value) {
                document.getElementById('error-fecha').textContent = 'La fecha es obligatoria.';
                isValid = false;
            } else {
                document.getElementById('error-fecha').textContent = '';
            }

            if (!evaluador.value) {
                document.getElementById('error-evaluador').textContent = 'El evaluador es obligatorio.';
                isValid = false;
            } else {
                document.getElementById('error-evaluador').textContent = '';
            }
            
            if (!isValid) {
                mostrarNotificacion('Complete los campos obligatorios de identificación (*)', 'error');
            }
            return isValid;
        }

        function mostrarNotificacion(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.opacity = '1';
            }, 10);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 500);
            }, 3000);
        }

        // ====================================
        // ========== LÓGICA DE ESCALAS ==========
        // ====================================
        
        // --- IRAT-5 ---
        function configurarIRAT5() {
            const container = document.getElementById('irat-form');
            IRAT_DEFINITIONS.forEach((item, index) => {
                const group = document.createElement('div');
                group.className = 'form-group';
                group.innerHTML = `<label class="form-label">${item.question}</label>`;
                
                const radioGroup = document.createElement('div');
                radioGroup.className = 'radio-group';
                
                item.options.forEach(option => {
                    const id = `irat-${index + 1}-${option.value}`;
                    const label = document.createElement('label');
                    label.innerHTML = `
                        <input type="radio" name="irat-q${index + 1}" value="${option.value}" required>
                        ${option.label} (${option.value} pts)
                    `;
                    radioGroup.appendChild(label);
                });
                
                radioGroup.querySelectorAll('input').forEach(input => {
                    input.addEventListener('change', calcularIRAT5);
                });
                
                group.appendChild(radioGroup);
                container.appendChild(group);
            });
            calcularIRAT5(); // Cargar estado inicial
        }

        function calcularIRAT5() {
            puntajeTotalIRAT = 0;
            respuestasIRAT = {};
            let allAnswered = true;
            
            for (let i = 1; i <= IRAT_DEFINITIONS.length; i++) {
                const name = `irat-q${i}`;
                const selected = document.querySelector(`input[name="${name}"]:checked`);
                if (selected) {
                    const value = parseInt(selected.value);
                    puntajeTotalIRAT += value;
                    respuestasIRAT[name] = value;
                } else {
                    allAnswered = false;
                }
            }

            if (puntajeTotalIRAT >= 5) {
                nivelRiesgoIRAT = "Riesgo Alto (Puntaje ≥ 5)";
            } else if (puntajeTotalIRAT >= 3) {
                nivelRiesgoIRAT = "Riesgo Medio (Puntaje 3-4)";
            } else {
                nivelRiesgoIRAT = "Riesgo Bajo (Puntaje 0-2)";
            }
        }
        
        // --- TINETTI ---
        function configurarTinetti() {
            const equilibrioContainer = document.getElementById('tinetti-equilibrio-form');
            const marchaContainer = document.getElementById('tinetti-marcha-form');
            
            const renderQuestions = (definitions, container, sectionPrefix) => {
                container.innerHTML = container.querySelector('h3').outerHTML; // Mantener el título
                definitions.forEach((item, index) => {
                    const group = document.createElement('div');
                    group.className = 'form-group';
                    group.innerHTML = `<label class="form-label">${item.question}</label>`;
                    
                    const radioGroup = document.createElement('div');
                    radioGroup.className = 'radio-group';
                    
                    item.options.forEach(option => {
                        const name = `${sectionPrefix}-q${index + 1}`;
                        const label = document.createElement('label');
                        label.innerHTML = `
                            <input type="radio" name="${name}" value="${option.value}" required>
                            ${option.label} (${option.value} pts)
                        `;
                        radioGroup.appendChild(label);
                    });
                    
                    radioGroup.querySelectorAll('input').forEach(input => {
                        input.addEventListener('change', calcularTinetti);
                    });
                    
                    group.appendChild(radioGroup);
                    container.appendChild(group);
                });
            };

            renderQuestions(TINETTI_DEFINITIONS_EQUILIBRIO, equilibrioContainer, 'tinetti-eq');
            renderQuestions(TINETTI_DEFINITIONS_MARCHA, marchaContainer, 'tinetti-mar');

            document.getElementById('tinetti-no-evaluable').addEventListener('change', function() {
                tinettiNoEvaluable = this.checked;
                const disableState = this.checked;
                [equilibrioContainer, marchaContainer].forEach(c => {
                    c.querySelectorAll('input[type="radio"]').forEach(input => {
                        input.disabled = disableState;
                        if (disableState) input.checked = false;
                    });
                });
                calcularTinetti();
            });

            calcularTinetti(); // Cargar estado inicial
        }

        function calcularTinetti() {
            if (tinettiNoEvaluable) {
                puntajeTinetti = 0;
                respuestasTinetti = { not_evaluable: true };
                return;
            }
            
            puntajeTinetti = 0;
            respuestasTinetti = { not_evaluable: false };
            
            const processScale = (definitions, sectionPrefix) => {
                definitions.forEach((item, index) => {
                    const name = `${sectionPrefix}-q${index + 1}`;
                    const selected = document.querySelector(`input[name="${name}"]:checked`);
                    if (selected) {
                        const value = parseInt(selected.value);
                        puntajeTinetti += value;
                        respuestasTinetti[name] = value;
                    }
                });
            };

            processScale(TINETTI_DEFINITIONS_EQUILIBRIO, 'tinetti-eq');
            processScale(TINETTI_DEFINITIONS_MARCHA, 'tinetti-mar');
        }

        // --- NORTON ---
        function calcularNorton() {
            puntajeNorton = 0;
            respuestasNorton = {};
            const factores = ['fisico', 'mental', 'actividad', 'movilidad', 'incontinencia'];
            let allAnswered = true;

            factores.forEach(factor => {
                const select = document.getElementById(`norton-${factor}`);
                const value = parseInt(select.value);
                
                if (isNaN(value)) {
                    allAnswered = false;
                } else {
                    puntajeNorton += value;
                    respuestasNorton[factor] = value;
                }
            });

            if (puntajeNorton <= 12) {
                nivelRiesgoNorton = "Riesgo ALTO (Puntaje ≤ 12)";
                document.getElementById('resultado-norton').className = 'result-box high-risk';
            } else if (puntajeNorton >= 13 && puntajeNorton <= 14) {
                nivelRiesgoNorton = "Riesgo MEDIO (Puntaje 13-14)";
                document.getElementById('resultado-norton').className = 'result-box medium-risk';
            } else {
                nivelRiesgoNorton = "Riesgo BAJO (Puntaje ≥ 15)";
                document.getElementById('resultado-norton').className = 'result-box low-risk';
            }

            document.getElementById('norton-score').textContent = puntajeNorton;
            document.getElementById('norton-riesgo').textContent = nivelRiesgoNorton;
        }


        // ====================================
        // ========== RESULTADOS Y PDF ==========
        // ====================================
        
        function calcularResultadosCompletos(shouldNotify) {
            // 1. Recalcular todas las escalas
            calcularIRAT5();
            calcularTinetti();
            calcularNorton();
            
            // 2. Recopilar datos de identificación (Validación ya pasó al cambiar de sección)
            if (!validarIdentificacion()) return false;

            const paciente = {
                nombre: document.getElementById('nombre').value.trim(),
                rut: document.getElementById('rut').value.trim(),
                edad: document.getElementById('edad').value.trim(),
                fecha: document.getElementById('fecha').value,
                sexo: document.getElementById('sexo').value,
                evaluador: document.getElementById('evaluador').value.trim(),
                institucion: document.getElementById('institucion').value.trim(),
                historiaClinica: document.getElementById('historia-clinica').value.trim()
            };
            
            // 3. Generar recomendaciones
            generarRecomendaciones();

            // 4. Almacenar datos completos en la variable global
            datosCompletos = {
                paciente,
                respuestas: {
                    irat: respuestasIRAT,
                    tinetti: respuestasTinetti,
                    norton: respuestasNorton
                },
                resultados: {
                    irat: { puntaje: puntajeTotalIRAT, nivel: nivelRiesgoIRAT },
                    tinetti: { puntaje: puntajeTinetti, nivel: determinarRiesgoTinetti() },
                    norton: { puntaje: puntajeNorton, nivel: nivelRiesgoNorton }
                },
                recomendaciones: recomendaciones
            };
            
            // 5. Renderizar en la sección de resultados
            renderizarResultados();

            if (shouldNotify) {
                 mostrarNotificacion('Resultados calculados y listos.', 'success');
            }
            return true;
        }

        function determinarRiesgoTinetti() {
            if (tinettiNoEvaluable) return "No Evaluable (N/A)";
            if (puntajeTinetti < 19) return "Riesgo ALTO de caída";
            if (puntajeTinetti >= 19 && puntajeTinetti <= 24) return "Riesgo MODERADO de caída";
            return "Riesgo BAJO de caída";
        }

        function generarRecomendaciones() {
            recomendaciones = [];

            // Recomendaciones IRAT-5
            if (puntajeTotalIRAT >= 5) {
                recomendaciones.push("IRAT-5 (Riesgo Alto): Implementar un plan de cuidados intensivo para prevenir complicaciones.");
            } else if (puntajeTotalIRAT >= 3) {
                recomendaciones.push("IRAT-5 (Riesgo Medio): Monitorización activa y planes de intervención específicos en las áreas de mayor puntaje.");
            }
            if (respuestasIRAT['irat-q1'] > 0) recomendaciones.push("Movilidad/Traslado: Planificar asistencia en la movilización y fomentar la independencia segura.");
            if (respuestasIRAT['irat-q5'] > 0) recomendaciones.push("Piel: Realizar revisión cutánea diaria. Considerar superficies especiales para alivio de presión.");

            // Recomendaciones Tinetti
            const riesgoTinetti = determinarRiesgoTinetti();
            if (riesgoTinetti === "Riesgo ALTO de caída") {
                recomendaciones.push("Tinetti (Riesgo Alto): Iniciar programa de rehabilitación de equilibrio y marcha. Uso estricto de ayudas técnicas.");
            } else if (riesgoTinetti === "Riesgo MODERADO de caída") {
                recomendaciones.push("Tinetti (Riesgo Moderado): Evaluación ambiental (retirar obstáculos, buena iluminación). Entrenamiento de la fuerza y equilibrio.");
            }

            // Recomendaciones Norton
            if (puntajeNorton <= 12) {
                recomendaciones.push("Norton (Riesgo Alto de Úlcera): Realizar cambios posturales cada 2-3 horas. Usar colchón y cojín antiescaras.");
            } else if (puntajeNorton <= 14) {
                recomendaciones.push("Norton (Riesgo Medio de Úlcera): Proteger zonas de riesgo. Mantener la piel limpia y seca. Vigilancia nutricional.");
            }
        }

        function renderizarResultados() {
            if (!datosCompletos) return;
            const data = datosCompletos;

            // Info Paciente
            document.getElementById('resumen-nombre').textContent = data.paciente.nombre;
            document.getElementById('resumen-rut').textContent = data.paciente.rut;
            document.getElementById('resumen-fecha').textContent = data.paciente.fecha;

            // IRAT-5
            const iratDiv = document.getElementById('resumen-irat');
            const iratRiskClass = data.resultados.irat.nivel.includes('Alto') ? 'high-risk' : data.resultados.irat.nivel.includes('Medio') ? 'medium-risk' : 'low-risk';
            iratDiv.className = `result-box ${iratRiskClass}`;
            iratDiv.innerHTML = `
                <strong>IRAT-5: Riesgo de Complicaciones</strong>
                <p>Puntaje Total: <strong>${data.resultados.irat.puntaje} / 10</strong></p>
                <p>Nivel de Riesgo: <strong>${data.resultados.irat.nivel}</strong></p>
            `;

            // Tinetti
            const tinettiDiv = document.getElementById('resumen-tinetti');
            const tinettiRisk = data.resultados.tinetti.nivel;
            const tinettiRiskClass = tinettiRisk.includes('ALTO') ? 'high-risk' : tinettiRisk.includes('MODERADO') ? 'medium-risk' : 'low-risk';
            tinettiDiv.className = `result-box ${tinettiRiskClass}`;
            tinettiDiv.innerHTML = `
                <strong>Tinetti: Riesgo de Caída</strong>
                <p>Puntaje Total: <strong>${data.resultados.tinetti.puntaje} / 28</strong></p>
                <p>Nivel de Riesgo: <strong>${tinettiRisk}</strong></p>
            `;
            
            // Norton
            const nortonDiv = document.getElementById('resumen-norton-final');
            const nortonRiskClass = data.resultados.norton.nivel.includes('ALTO') ? 'high-risk' : data.resultados.norton.nivel.includes('MEDIO') ? 'medium-risk' : 'low-risk';
            nortonDiv.className = `result-box ${nortonRiskClass}`;
            nortonDiv.innerHTML = `
                <strong>Norton: Riesgo de Úlcera por Presión</strong>
                <p>Puntaje Total: <strong>${data.resultados.norton.puntaje} / 20</strong></p>
                <p>Nivel de Riesgo: <strong>${data.resultados.norton.nivel}</strong></p>
            `;

            // Recomendaciones
            const recList = document.getElementById('recomendaciones-lista');
            recList.innerHTML = '';
            data.recomendaciones.forEach(rec => {
                const li = document.createElement('li');
                li.textContent = rec;
                recList.appendChild(li);
            });
            if (data.recomendaciones.length === 0) {
                recList.innerHTML = '<li>No se detectaron riesgos elevados que requieran acciones inmediatas específicas. Mantener vigilancia habitual.</li>';
            }
        }
        
        // --- PDF Generation ---
        function generarPDF() {
            if (!datosCompletos) {
                mostrarNotificacion('Primero debe calcular los resultados.', 'error');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const data = datosCompletos;
            let y = 10;
            const margin = 15;
            const lineHeight = 7;

            // Título
            doc.setFontSize(16);
            doc.text(`Evaluación Clínica Integral - ${data.paciente.nombre}`, margin, y);
            y += lineHeight;
            doc.setFontSize(10);
            doc.text(`Fecha: ${data.paciente.fecha} | Evaluador: ${data.paciente.evaluador}`, margin, y);
            y += lineHeight * 2;

            // --- Sección de Identificación ---
            doc.setFontSize(12);
            doc.text("1. IDENTIFICACIÓN DEL PACIENTE", margin, y);
            y += lineHeight;
            doc.setFontSize(10);
            doc.text(`RUT: ${data.paciente.rut} | Edad: ${data.paciente.edad} | Sexo: ${data.paciente.sexo}`, margin, y);
            y += lineHeight * 2;

            // --- Sección de Resultados ---
            doc.setFontSize(12);
            doc.text("2. RESULTADOS DE LAS ESCALAS", margin, y);
            y += lineHeight;
            
            // IRAT-5
            doc.setFontSize(10);
            doc.text(`IRAT-5: Riesgo de Complicaciones`, margin, y);
            y += lineHeight;
            doc.text(`Puntaje: ${data.resultados.irat.puntaje}/10`, margin, y);
            doc.text(`Nivel: ${data.resultados.irat.nivel}`, 80, y);
            y += lineHeight;

            // Tinetti
            doc.text(`TINETTI: Riesgo de Caída`, margin, y);
            y += lineHeight;
            doc.text(`Puntaje: ${data.resultados.tinetti.puntaje}/28`, margin, y);
            doc.text(`Nivel: ${data.resultados.tinetti.nivel}`, 80, y);
            y += lineHeight;
            
            // Norton
            doc.text(`NORTON: Riesgo de Úlcera por Presión`, margin, y);
            y += lineHeight;
            doc.text(`Puntaje: ${data.resultados.norton.puntaje}/20`, margin, y);
            doc.text(`Nivel: ${data.resultados.norton.nivel}`, 80, y);
            y += lineHeight * 2;

            // --- Sección de Recomendaciones ---
            doc.setFontSize(12);
            doc.text("3. RECOMENDACIONES / PLAN DE ACCIÓN", margin, y);
            y += lineHeight;
            doc.setFontSize(10);
            
            data.recomendaciones.forEach((rec, index) => {
                // Si llegamos al final de la página, añadimos una nueva
                if (y > 280) {
                    doc.addPage();
                    y = 15;
                }
                doc.text(`- ${rec}`, margin, y);
                y += lineHeight;
            });
            
            doc.save(`Evaluacion_${data.paciente.nombre.replace(/\s/g, '_')}_${data.paciente.fecha}.pdf`);
            mostrarNotificacion('PDF generado correctamente.', 'success');
        }

        // --- WhatsApp Share ---
        function compartirWhatsApp() {
            if (!datosCompletos) {
                mostrarNotificacion('Primero debe calcular los resultados.', 'error');
                return;
            }

            const data = datosCompletos;
            let mensaje = `*RESUMEN DE EVALUACIÓN CLÍNICA*\n\n`;
            mensaje += `Paciente: ${data.paciente.nombre}\n`;
            mensaje += `Fecha: ${data.paciente.fecha}\n`;
            mensaje += `Evaluador: ${data.paciente.evaluador}\n\n`;

            mensaje += `*1. IRAT-5 (Riesgo Complicaciones)*\n`;
            mensaje += `Puntaje: ${data.resultados.irat.puntaje}/10\n`;
            mensaje += `Nivel: ${data.resultados.irat.nivel}\n\n`;

            mensaje += `*2. TINETTI (Riesgo Caída)*\n`;
            mensaje += `Puntaje: ${data.resultados.tinetti.puntaje}/28\n`;
            mensaje += `Nivel: ${data.resultados.tinetti.nivel}\n\n`;

            mensaje += `*3. NORTON (Riesgo Úlcera)*\n`;
            mensaje += `Puntaje: ${data.resultados.norton.puntaje}/20\n`;
            mensaje += `Nivel: ${data.resultados.norton.nivel}\n\n`;

            mensaje += `*PLAN DE ACCIÓN*:\n`;
            data.recomendaciones.forEach((rec, index) => {
                mensaje += `${index + 1}. ${rec}\n`;
            });
            if (data.recomendaciones.length === 0) mensaje += "Vigilancia habitual.\n";
            
            const encodedMessage = encodeURIComponent(mensaje);
            window.open(`https://api.whatsapp.com/send?text=${encodedMessage}`, '_blank');
            mostrarNotificacion('Abriendo WhatsApp para compartir.', 'info');
        }

        // ====================================
        // ========== INICIALIZACIÓN DE EVENTOS EN EL DOM ==========
        // ====================================
        function configurarValidaciones() {
            // Placeholder para futuras validaciones de input
        }
        
        function configurarHistorial() {
            // Funciones de filtros/paginación ya configuradas en el código superior.
        }

    </script>
</body>
</html>
