<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluación Clínica IRAT-5 Modificado + Tinetti</title>
    <!-- Biblioteca para PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #1e3c72;
            --secondary-color: #2a5298;
            --accent-color: #4CAF50;
            --warning-color: #FF9800;
            --danger-color: #F44336;
            --light-color: #f8f9fa;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7ff;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 0.9rem;
        }
        
        .section {
            padding: 25px;
            display: none;
        }
        
        .section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section-title {
            color: var(--primary-color);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--primary-color);
            font-size: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .form-control {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        select.form-control {
            background-color: white;
            cursor: pointer;
        }
        
        .question-group {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid var(--primary-color);
        }
        
        .question-text {
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--secondary-color);
        }
        
        .score-display {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            margin: 25px 0;
        }
        
        .score-value {
            font-size: 3.5rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .risk-level {
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
            color: white;
            text-align: center;
        }
        
        .risk-low { background: linear-gradient(135deg, #4CAF50, #2E7D32); }
        .risk-moderate { background: linear-gradient(135deg, #FF9800, #EF6C00); }
        .risk-high { background: linear-gradient(135deg, #F44336, #C62828); }
        .risk-very-high { background: linear-gradient(135deg, #9C27B0, #6A1B9A); }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 10px 5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #FF9800, #EF6C00);
            color: white;
        }
        
        .action-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .nav-tabs {
            display: flex;
            background: #f0f2f5;
            border-bottom: 2px solid #e0e0e0;
            overflow-x: auto;
        }
        
        .nav-tab {
            padding: 15px 20px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 500;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
        }
        
        .nav-tab.active {
            border-bottom-color: var(--primary-color);
            background: white;
            color: var(--primary-color);
        }
        
        .recommendations-grid {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }
        
        .recommendation-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid var(--accent-color);
        }
        
        /* Sección Compartir */
        .share-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }
        
        .share-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .share-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-color);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .share-icon {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        /* Notificaciones */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            background: var(--accent-color);
            color: white;
            font-weight: 500;
            z-index: 1000;
            display: none;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Modal para compartir */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1001;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close-modal {
            float: right;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .section {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .score-value {
                font-size: 2.8rem;
            }
            
            .btn {
                width: 100%;
                margin: 5px 0;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .share-options {
                grid-template-columns: 1fr;
            }
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .info-box {
            background: #e8f4fd;
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .warning-box {
            background: #fff3e0;
            border-left: 4px solid var(--warning-color);
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        /* Resultados para PDF */
        #pdf-content {
            background: white;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        
        .pdf-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #1e3c72;
            padding-bottom: 20px;
        }
        
        .pdf-section {
            margin-bottom: 25px;
            page-break-inside: avoid;
        }
        
        .pdf-title {
            color: #1e3c72;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-hospital-alt"></i> IRAT-5 + Tinetti</h1>
            <p>Evaluación Clínica de Riesgo de Caídas</p>
        </div>
        
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-section="identificacion">Identificación</button>
            <button class="nav-tab" data-section="evaluacion">IRAT-5</button>
            <button class="nav-tab" data-section="tinetti">Tinetti</button>
            <button class="nav-tab" data-section="resultados">Resultados</button>
            <button class="nav-tab" data-section="compartir">Compartir</button>
        </div>
        
        <!-- Sección 1: Identificación -->
        <section id="identificacion" class="section active">
            <h2 class="section-title"><i class="fas fa-user"></i> Identificación del Paciente</h2>
            
            <div class="form-group">
                <label class="form-label">Nombre completo</label>
                <input type="text" id="nombre" class="form-control" placeholder="Nombre del paciente">
            </div>
            
            <div class="form-group">
                <label class="form-label">Edad</label>
                <input type="number" id="edad" class="form-control" placeholder="Edad en años">
            </div>
            
            <div class="form-group">
                <label class="form-label">Sexo</label>
                <select id="sexo" class="form-control">
                    <option value="">Seleccione...</option>
                    <option value="masculino">Masculino</option>
                    <option value="femenino">Femenino</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Evaluador</label>
                <input type="text" id="evaluador" class="form-control" placeholder="Nombre del profesional">
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" id="siguiente-irat">
                    <i class="fas fa-arrow-right"></i> Siguiente: IRAT-5
                </button>
            </div>
        </section>
        
        <!-- Sección 2: IRAT-5 -->
        <section id="evaluacion" class="section">
            <h2 class="section-title"><i class="fas fa-clipboard-list"></i> Evaluación IRAT-5</h2>
            
            <div class="question-group">
                <div class="question-text">1. Equilibrio Unipodal</div>
                <select id="equilibrio" class="form-control">
                    <option value="">Seleccione...</option>
                    <option value="0">≥ 30 segundos (0 pts)</option>
                    <option value="1">15-29 segundos (1 pts)</option>
                    <option value="2">5-14 segundos (2 pts)</option>
                    <option value="3">< 5 segundos (3 pts)</option>
                    <option value="4">No puede mantenerse (4 pts)</option>
                </select>
            </div>
            
            <div class="question-group">
                <div class="question-text">2. Tipo de Amputación</div>
                <select id="amputacion" class="form-control">
                    <option value="">Seleccione...</option>
                    <option value="0">Sin amputaciones (0 pts)</option>
                    <option value="1">Transmetatarsiana (1 pts)</option>
                    <option value="3">Unilateral infracondílea (3 pts + 1 riesgo)</option>
                    <option value="4">Bilateral infracondílea (4 pts + 1 riesgo)</option>
                    <option value="5">Supracondílea unilateral (5 pts + 1 riesgo)</option>
                    <option value="6">Supracondílea bilateral (6 pts + 1 riesgo)</option>
                </select>
            </div>
            
            <div class="warning-box">
                <strong><i class="fas fa-exclamation-triangle"></i> Consideraciones:</strong><br>
                • Bilaterales: Requieren silla de ruedas<br>
                • Unilaterales: Andador fijo (sin ruedas) inicial
            </div>
            
            <div class="question-group">
                <div class="question-text">3. Función de Brazos</div>
                <select id="brazos" class="form-control">
                    <option value="">Seleccione...</option>
                    <option value="0">Ambos brazos normales (0 pts)</option>
                    <option value="1">Problemas en un brazo (1 pts)</option>
                    <option value="2">Problemas en ambos brazos (2 pts)</option>
                </select>
            </div>
            
            <div class="question-group">
                <div class="question-text">4. Situación Social</div>
                <select id="social" class="form-control">
                    <option value="">Seleccione...</option>
                    <option value="0">Cuidador profesional (0 pts)</option>
                    <option value="1">Cuidador informal (1 pts)</option>
                    <option value="2">Vive solo (2 pts)</option>
                    <option value="3">Cuida persona frágil (3 pts)</option>
                </select>
            </div>
            
            <div class="question-group">
                <div class="question-text">5. Cooperación</div>
                <select id="cooperacion" class="form-control">
                    <option value="">Seleccione...</option>
                    <option value="0">Excelente (0 pts)</option>
                    <option value="1">Buena (1 pts)</option>
                    <option value="2">Moderada (2 pts)</option>
                    <option value="3">Mala (3 pts)</option>
                </select>
            </div>
            
            <div class="score-display">
                <div>Puntaje IRAT-5</div>
                <div class="score-value" id="puntaje-irat">0</div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-warning" id="volver-identificacion">
                    <i class="fas fa-arrow-left"></i> Anterior
                </button>
                <button class="btn btn-primary" id="siguiente-tinetti">
                    Siguiente: Tinetti <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </section>
        
        <!-- Sección 3: Tinetti -->
        <section id="tinetti" class="section">
            <h2 class="section-title"><i class="fas fa-walking"></i> Test de Tinetti</h2>
            
            <div class="info-box">
                <strong>Instrucciones:</strong> Tinetti aporta puntos al IRAT-5:<br>
                • ≥ 25 puntos = 0 puntos IRAT-5<br>
                • 19-24 puntos = 2 puntos IRAT-5<br>
                • ≤ 18 puntos = 4 puntos IRAT-5
            </div>
            
            <div class="question-group">
                <div class="question-text">Puntaje Total Tinetti</div>
                <select id="puntaje-tinetti" class="form-control">
                    <option value="28">28 puntos (Bajo riesgo)</option>
                    <option value="25">25-27 puntos (Bajo riesgo)</option>
                    <option value="22">22-24 puntos (Moderado riesgo)</option>
                    <option value="19">19-21 puntos (Moderado riesgo)</option>
                    <option value="16">16-18 puntos (Alto riesgo)</option>
                    <option value="13">13-15 puntos (Alto riesgo)</option>
                    <option value="10">≤ 12 puntos (Alto riesgo)</option>
                </select>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-warning" id="volver-irat">
                    <i class="fas fa-arrow-left"></i> Anterior
                </button>
                <button class="btn btn-success" id="calcular-resultados">
                    <i class="fas fa-calculator"></i> Calcular Resultados
                </button>
            </div>
        </section>
        
        <!-- Sección 4: Resultados -->
        <section id="resultados" class="section">
            <h2 class="section-title"><i class="fas fa-chart-line"></i> Resultados</h2>
            
            <div id="contenido-resultados">
                <p style="text-align: center; color: #666; padding: 40px;">
                    Complete todas las secciones y haga clic en "Calcular Resultados"
                </p>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-warning" id="volver-tinetti">
                    <i class="fas fa-arrow-left"></i> Anterior
                </button>
                <button class="btn btn-primary" id="ir-compartir">
                    Compartir Resultados <i class="fas fa-share-alt"></i>
                </button>
            </div>
        </section>
        
        <!-- Sección 5: Compartir -->
        <section id="compartir" class="section">
            <h2 class="section-title"><i class="fas fa-share-alt"></i> Compartir Resultados</h2>
            
            <div class="share-options">
                <div class="share-card" id="generar-pdf">
                    <div class="share-icon">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <h3>PDF</h3>
                    <p>Generar documento PDF</p>
                </div>
                
                <div class="share-card" id="compartir-whatsapp">
                    <div class="share-icon">
                        <i class="fab fa-whatsapp"></i>
                    </div>
                    <h3>WhatsApp</h3>
                    <p>Compartir por chat</p>
                </div>
                
                <div class="share-card" id="copiar-enlace">
                    <div class="share-icon">
                        <i class="fas fa-link"></i>
                    </div>
                    <h3>Copiar Enlace</h3>
                    <p>Copiar URL de resultados</p>
                </div>
                
                <div class="share-card" id="nueva-evaluacion">
                    <div class="share-icon">
                        <i class="fas fa-plus-circle"></i>
                    </div>
                    <h3>Nueva Evaluación</h3>
                    <p>Empezar de nuevo</p>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-warning" id="volver-resultados">
                    <i class="fas fa-arrow-left"></i> Anterior
                </button>
            </div>
        </section>
    </div>
    
    <!-- Contenido para PDF (oculto) -->
    <div id="pdf-content" style="display: none;">
        <div class="pdf-header">
            <h1>EVALUACIÓN CLÍNICA IRAT-5 + TINETTI</h1>
            <h2>Informe de Resultados</h2>
            <p>Fecha: <span id="pdf-fecha"></span></p>
        </div>
        
        <div class="pdf-section">
            <h3 class="pdf-title">Datos del Paciente</h3>
            <p><strong>Nombre:</strong> <span id="pdf-nombre"></span></p>
            <p><strong>Edad:</strong> <span id="pdf-edad"></span> años</p>
            <p><strong>Sexo:</strong> <span id="pdf-sexo"></span></p>
            <p><strong>Evaluador:</strong> <span id="pdf-evaluador"></span></p>
        </div>
        
        <div class="pdf-section">
            <h3 class="pdf-title">Resultados de Evaluación</h3>
            <p><strong>Puntaje IRAT-5:</strong> <span id="pdf-puntaje-irat"></span></p>
            <p><strong>Nivel de Riesgo:</strong> <span id="pdf-riesgo"></span></p>
            <p><strong>Test de Tinetti:</strong> <span id="pdf-tinetti"></span></p>
            <p><strong>Recomendaciones:</strong></p>
            <div id="pdf-recomendaciones"></div>
        </div>
        
        <div class="pdf-section">
            <h3 class="pdf-title">Consideraciones Especiales</h3>
            <div id="pdf-consideraciones"></div>
        </div>
        
        <div class="pdf-section">
            <h3 class="pdf-title">Firmas</h3>
            <p>_________________________________________</p>
            <p>Profesional a cargo</p>
            <br>
            <p>_________________________________________</p>
            <p>Paciente / Familiar</p>
        </div>
    </div>
    
    <!-- Modal para compartir -->
    <div id="modal-compartir" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h3>Compartir Resultados</h3>
            <p>Seleccione cómo desea compartir:</p>
            <div class="share-options">
                <div class="share-card" id="whatsapp-modal">
                    <i class="fab fa-whatsapp" style="font-size: 2rem; color: #25D366;"></i>
                    <p>WhatsApp</p>
                </div>
                <div class="share-card" id="email-modal">
                    <i class="fas fa-envelope" style="font-size: 2rem; color: #EA4335;"></i>
                    <p>Email</p>
                </div>
                <div class="share-card" id="sms-modal">
                    <i class="fas fa-sms" style="font-size: 2rem; color: #34B7F1;"></i>
                    <p>SMS</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notificación -->
    <div id="notification" class="notification"></div>

    <script>
        // Variables globales
        let puntajeIrat = 0;
        let nivelRiesgo = "";
        let recomendaciones = [];
        
        // Navegación entre secciones
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const sectionId = tab.getAttribute('data-section');
                
                // Actualizar tabs activos
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Mostrar sección correspondiente
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById(sectionId).classList.add('active');
            });
        });
        
        // Botones de navegación
        document.getElementById('siguiente-irat').addEventListener('click', () => {
            document.querySelector('[data-section="evaluacion"]').click();
        });
        
        document.getElementById('volver-identificacion').addEventListener('click', () => {
            document.querySelector('[data-section="identificacion"]').click();
        });
        
        document.getElementById('siguiente-tinetti').addEventListener('click', () => {
            document.querySelector('[data-section="tinetti"]').click();
        });
        
        document.getElementById('volver-irat').addEventListener('click', () => {
            document.querySelector('[data-section="evaluacion"]').click();
        });
        
        document.getElementById('volver-tinetti').addEventListener('click', () => {
            document.querySelector('[data-section="tinetti"]').click();
        });
        
        document.getElementById('ir-compartir').addEventListener('click', () => {
            document.querySelector('[data-section="compartir"]').click();
        });
        
        document.getElementById('volver-resultados').addEventListener('click', () => {
            document.querySelector('[data-section="resultados"]').click();
        });
        
        // Calcular puntaje IRAT-5 en tiempo real
        const selectsIRAT = ['equilibrio', 'amputacion', 'brazos', 'social', 'cooperacion'];
        selectsIRAT.forEach(id => {
            document.getElementById(id).addEventListener('change', calcularPuntajeIRAT);
        });
        
        function calcularPuntajeIRAT() {
            puntajeIrat = 0;
            
            // Sumar valores de selects
            selectsIRAT.forEach(id => {
                const select = document.getElementById(id);
                if (select.value) {
                    puntajeIrat += parseInt(select.value);
                }
            });
            
            // Puntos extra por amputación
            const amputacion = document.getElementById('amputacion').value;
            if (amputacion && parseInt(amputacion) >= 3) {
                puntajeIrat += 1;
            }
            
            // Actualizar display
            document.getElementById('puntaje-irat').textContent = puntajeIrat;
        }
        
        // Calcular resultados completos
        document.getElementById('calcular-resultados').addEventListener('click', calcularResultadosCompletos);
        
        function calcularResultadosCompletos() {
            // Validar que todos los campos estén completos
            const camposRequeridos = ['nombre', 'equilibrio', 'amputacion', 'brazos', 'social', 'cooperacion'];
            let valido = true;
            
            camposRequeridos.forEach(id => {
                const campo = document.getElementById(id);
                if (!campo.value) {
                    valido = false;
                    campo.style.borderColor = 'red';
                } else {
                    campo.style.borderColor = '#e0e0e0';
                }
            });
            
            if (!valido) {
                mostrarNotificacion('Complete todos los campos requeridos', 'error');
                return;
            }
            
            // Obtener datos
            const nombre = document.getElementById('nombre').value;
            const edad = document.getElementById('edad').value;
            const evaluador = document.getElementById('evaluador').value;
            const tinetti = parseInt(document.getElementById('puntaje-tinetti').value);
            
            // Añadir puntos del Tinetti
            let puntosTinetti = 0;
            if (tinetti >= 25) puntosTinetti = 0;
            else if (tinetti >= 19) puntosTinetti = 2;
            else puntosTinetti = 4;
            
            const puntajeTotal = puntajeIrat + puntosTinetti;
            
            // Determinar nivel de riesgo
            if (puntajeTotal <= 6) {
                nivelRiesgo = "BAJO RIESGO";
            } else if (puntajeTotal <= 9) {
                nivelRiesgo = "RIESGO MODERADO";
            } else if (puntajeTotal <= 12) {
                nivelRiesgo = "ALTO RIESGO";
            } else {
                nivelRiesgo = "MUY ALTO RIESGO";
            }
            
            // Generar recomendaciones
            recomendaciones = generarRecomendaciones(puntajeTotal, amputacion);
            
            // Mostrar resultados
            mostrarResultados(nombre, edad, evaluador, puntajeTotal, tinetti);
            
            // Ir a sección de resultados
            document.querySelector('[data-section="resultados"]').click();
            
            mostrarNotificacion('Resultados calculados exitosamente', 'success');
        }
        
        function generarRecomendaciones(puntaje, tipoAmputacion) {
            const recs = [];
            
            // Recomendaciones por nivel de riesgo
            if (puntaje <= 6) {
                recs.push("Bastón simple si es necesario");
                recs.push("Ejercicios de equilibrio básicos");
                recs.push("Revisión domiciliaria básica");
            } else if (puntaje <= 9) {
                recs.push("Andador con ruedas");
                recs.push("Cojín antiescaras");
                recs.push("Barras de apoyo en baño");
                recs.push("Ejercicios de fortalecimiento");
            } else if (puntaje <= 12) {
                recs.push("Andador fijo (sin ruedas)");
                recs.push("Colchón estático de alta densidad");
                recs.push("Supervisión durante deambulación");
                recs.push("Adaptaciones domiciliarias prioritarias");
            } else {
                recs.push("Silla de ruedas adaptada");
                recs.push("Colchón alternante de aire");
                recs.push("Plan de movilización cada 2-3 horas");
                recs.push("Entrenamiento formal para cuidadores");
            }
            
            // Recomendaciones por amputación
            const ampValue = parseInt(tipoAmputacion);
            if (ampValue === 4 || ampValue === 6) {
                recs.push("SILLA DE RUEDAS OBLIGATORIA - No puede usar bastón/andador");
                recs.push("Evaluación protésica bilateral especializada");
                recs.push("Adaptación completa del domicilio");
            } else if (ampValue === 3 || ampValue === 5) {
                recs.push("ANDADOR ARTICULADO O FIJO (sin ruedas) como ayuda inicial");
                recs.push("No usar andadores con ruedas inicialmente");
                recs.push("Evaluación protésica unilateral");
            }
            
            return recs;
        }
        
        function mostrarResultados(nombre, edad, evaluador, puntajeTotal, tinetti) {
            const riesgoColor = nivelRiesgo.includes("BAJO") ? "risk-low" :
                               nivelRiesgo.includes("MODERADO") ? "risk-moderate" :
                               nivelRiesgo.includes("ALTO") ? "risk-high" : "risk-very-high";
            
            const riesgoTinetti = tinetti >= 25 ? "Bajo riesgo de caídas" :
                                 tinetti >= 19 ? "Riesgo moderado de caídas" : "Alto riesgo de caídas";
            
            const html = `
                <div class="score-display">
                    <div>Puntaje Total IRAT-5</div>
                    <div class="score-value">${puntajeTotal}</div>
                    <div>Puntos de corte: 0-6 (Bajo) | 7-9 (Moderado) | 10-12 (Alto) | ≥13 (Muy Alto)</div>
                </div>
                
                <div class="risk-level ${riesgoColor}">
                    <h3 style="margin-bottom: 10px;">${nivelRiesgo}</h3>
                    <p>${obtenerDescripcionRiesgo(puntajeTotal)}</p>
                    <p style="margin-top: 10px;"><i class="fas fa-walking"></i> Tinetti: ${tinetti}/28 - ${riesgoTinetti}</p>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h4 style="color: var(--primary-color); margin-bottom: 15px;">
                        <i class="fas fa-user"></i> Datos del Paciente
                    </h4>
                    <p><strong>Nombre:</strong> ${nombre || "No especificado"}</p>
                    <p><strong>Edad:</strong> ${edad || "No especificado"} años</p>
                    <p><strong>Evaluador:</strong> ${evaluador || "No especificado"}</p>
                    <p><strong>Fecha:</strong> ${new Date().toLocaleDateString('es-ES')}</p>
                </div>
                
                <h3 style="color: var(--primary-color); margin: 25px 0 15px 0;">
                    <i class="fas fa-prescription-bottle-alt"></i> Recomendaciones
                </h3>
                
                <div class="recommendations-grid">
                    ${recomendaciones.map((rec, index) => `
                        <div class="recommendation-card">
                            <div style="font-weight: 600; color: var(--primary-color);">
                                <i class="fas fa-check-circle"></i> Recomendación ${index + 1}
                            </div>
                            <p style="margin-top: 8px;">${rec}</p>
                        </div>
                    `).join('')}
                </div>
                
                <div class="warning-box" style="margin-top: 30px;">
                    <strong><i class="fas fa-exclamation-triangle"></i> Notas importantes:</strong>
                    <ul style="margin-top: 10px; padding-left: 20px;">
                        <li>Estas recomendaciones son una guía, no reemplazan la evaluación clínica</li>
                        <li>La progresión de ayudas técnicas debe ser supervisada por profesional</li>
                        <li>Próxima evaluación recomendada: ${obtenerProximaFecha()}</li>
                    </ul>
                </div>
            `;
            
            document.getElementById('contenido-resultados').innerHTML = html;
        }
        
        function obtenerDescripcionRiesgo(puntaje) {
            if (puntaje <= 6) return "Ayudas básicas o ninguna. Bastón simple o sin ayuda.";
            if (puntaje <= 9) return "Ayudas intermedias. Andador con ruedas + cojín antiescaras.";
            if (puntaje <= 12) return "Ayudas avanzadas. Andador fijo + colchón estático.";
            return "Ayudas de movilización. Silla de ruedas + colchón alternante.";
        }
        
        function obtenerProximaFecha() {
            const fecha = new Date();
            fecha.setMonth(fecha.getMonth() + 3);
            return fecha.toLocaleDateString('es-ES');
        }
        
        // ========== FUNCIONALIDAD PARA COMPARTIR ==========
        
        // 1. Generar PDF
        document.getElementById('generar-pdf').addEventListener('click', generarPDF);
        
        async function generarPDF() {
            mostrarNotificacion('Generando PDF...', 'info');
            
            try {
                // Preparar datos para PDF
                prepararContenidoPDF();
                
                // Crear PDF usando jsPDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                // Agregar contenido HTML como imagen
                const pdfElement = document.getElementById('pdf-content');
                const canvas = await html2canvas(pdfElement, {
                    scale: 2,
                    useCORS: true,
                    logging: false
                });
                
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 190;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                
                // Guardar PDF
                const nombrePaciente = document.getElementById('nombre').value || 'Paciente';
                pdf.save(`IRAT5_${nombrePaciente}_${new Date().toISOString().split('T')[0]}.pdf`);
                
                mostrarNotificacion('PDF generado exitosamente', 'success');
            } catch (error) {
                console.error('Error generando PDF:', error);
                mostrarNotificacion('Error al generar PDF', 'error');
            }
        }
        
        function prepararContenidoPDF() {
            // Actualizar datos en el contenido PDF
            document.getElementById('pdf-fecha').textContent = new Date().toLocaleDateString('es-ES');
            document.getElementById('pdf-nombre').textContent = document.getElementById('nombre').value || 'No especificado';
            document.getElementById('pdf-edad').textContent = document.getElementById('edad').value || 'No especificado';
            document.getElementById('pdf-sexo').textContent = document.getElementById('sexo').value || 'No especificado';
            document.getElementById('pdf-evaluador').textContent = document.getElementById('evaluador').value || 'No especificado';
            
            const puntaje = document.getElementById('puntaje-irat').textContent;
            document.getElementById('pdf-puntaje-irat').textContent = puntaje;
            document.getElementById('pdf-riesgo').textContent = nivelRiesgo || 'No calculado';
            
            const tinetti = document.getElementById('puntaje-tinetti').value;
            document.getElementById('pdf-tinetti').textContent = `${tinetti}/28 puntos`;
            
            // Agregar recomendaciones
            const recsDiv = document.getElementById('pdf-recomendaciones');
            recsDiv.innerHTML = '';
            recomendaciones.forEach(rec => {
                const p = document.createElement('p');
                p.textContent = `• ${rec}`;
                recsDiv.appendChild(p);
            });
            
            // Consideraciones especiales
            const consideracionesDiv = document.getElementById('pdf-consideraciones');
            consideracionesDiv.innerHTML = '';
            const amputacion = document.getElementById('amputacion').value;
            if (amputacion) {
                const ampValue = parseInt(amputacion);
                if (ampValue >= 3) {
                    const p = document.createElement('p');
                    p.textContent = ampValue === 4 || ampValue === 6 ? 
                        '• Paciente con amputación bilateral: Requiere silla de ruedas obligatoriamente' :
                        '• Paciente con amputación unilateral: Iniciar con andador fijo (sin ruedas)';
                    consideracionesDiv.appendChild(p);
                }
            }
        }
        
        // 2. Compartir por WhatsApp
        document.getElementById('compartir-whatsapp').addEventListener('click', compartirWhatsApp);
        
        function compartirWhatsApp() {
            const nombre = document.getElementById('nombre').value || 'Paciente';
            const puntaje = document.getElementById('puntaje-irat').textContent;
            
            const mensaje = `*Resultados IRAT-5*%0A%0A` +
                           `Paciente: ${nombre}%0A` +
                           `Puntaje: ${puntaje}%0A` +
                           `Riesgo: ${nivelRiesgo}%0A%0A` +
                           `Evaluación completada el ${new Date().toLocaleDateString('es-ES')}`;
            
            const url = `https://api.whatsapp.com/send?text=${mensaje}`;
            
            // Abrir en nueva ventana
            window.open(url, '_blank');
            
            mostrarNotificacion('Abriendo WhatsApp...', 'info');
        }
        
        // 3. Copiar enlace de resultados
        document.getElementById('copiar-enlace').addEventListener('click', copiarEnlace);
        
        function copiarEnlace() {
            // Crear un resumen de resultados
            const datos = {
                nombre: document.getElementById('nombre').value,
                puntaje: document.getElementById('puntaje-irat').textContent,
                riesgo: nivelRiesgo,
                fecha: new Date().toISOString()
            };
            
            // Convertir a JSON y codificar
            const datosCodificados = btoa(JSON.stringify(datos));
            const enlace = `${window.location.origin}${window.location.pathname}#resultados=${datosCodificados}`;
            
            // Copiar al portapapeles
            navigator.clipboard.writeText(enlace)
                .then(() => {
                    mostrarNotificacion('Enlace copiado al portapapeles', 'success');
                })
                .catch(() => {
                    // Fallback para navegadores antiguos
                    const tempInput = document.createElement('input');
                    tempInput.value = enlace;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempInput);
                    mostrarNotificacion('Enlace copiado', 'success');
                });
        }
        
        // 4. Nueva evaluación
        document.getElementById('nueva-evaluacion').addEventListener('click', nuevaEvaluacion);
        
        function nuevaEvaluacion() {
            if (confirm('¿Está seguro de comenzar una nueva evaluación? Se perderán los datos actuales.')) {
                // Limpiar formularios
                document.querySelectorAll('input, select').forEach(element => {
                    if (element.type !== 'button') {
                        element.value = '';
                    }
                });
                
                // Resetear variables
                puntajeIrat = 0;
                nivelRiesgo = "";
                recomendaciones = [];
                
                // Resetear displays
                document.getElementById('puntaje-irat').textContent = '0';
                document.getElementById('contenido-resultados').innerHTML = `
                    <p style="text-align: center; color: #666; padding: 40px;">
                        Complete todas las secciones y haga clic en "Calcular Resultados"
                    </p>
                `;
                
                // Ir a identificación
                document.querySelector('[data-section="identificacion"]').click();
                
                mostrarNotificacion('Nueva evaluación lista', 'success');
            }
        }
        
        // Modal para compartir
        const modal = document.getElementById('modal-compartir');
        const closeModal = document.querySelector('.close-modal');
        
        closeModal.addEventListener('click', () => {
            modal.style.display = 'none';
        });
        
        window.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });
        
        // Funciones auxiliares
        function mostrarNotificacion(mensaje, tipo) {
            const notificacion = document.getElementById('notification');
            notificacion.textContent = mensaje;
            notificacion.style.background = tipo === 'error' ? 'var(--danger-color)' :
                                           tipo === 'info' ? 'var(--primary-color)' : 'var(--accent-color)';
            notificacion.style.display = 'block';
            
            setTimeout(() => {
                notificacion.style.display = 'none';
            }, 3000);
        }
        
        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            // Configurar fecha actual en inputs de fecha si existen
            const fechaInputs = document.querySelectorAll('input[type="date"]');
            fechaInputs.forEach(input => {
                input.valueAsDate = new Date();
            });
            
            mostrarNotificacion('App IRAT-5 cargada correctamente', 'info');
        });
    </script>
</body>
</html>
