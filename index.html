<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluación Clínica IRAT-5 Modificado + Control de Acceso</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* ... (ESTILOS CSS: Mantenemos la mayoría de los estilos anteriores) ... */
        :root {
            --primary-color: #1e3c72;
            --secondary-color: #2a5298;
            --accent-color: #4CAF50;
            --warning-color: #FF9800;
            --danger-color: #F44336;
            --light-color: #f8f9fa;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7ff;
            color: #333;
            line-height: 1.6;
            padding: 0; /* Quitamos el padding del body para la pantalla de login */
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        /* Estilos específicos para la pantalla de Login */
        #login-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }
        
        .login-card {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        
        .login-card h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.8rem;
        }
        
        .login-card .form-group {
            text-align: left;
        }
        
        .login-card .form-label {
            color: #333;
        }
        
        .toggle-form {
            margin-top: 20px;
            font-size: 0.9rem;
            color: #666;
            cursor: pointer;
        }
        
        .toggle-form:hover {
            text-decoration: underline;
            color: var(--primary-color);
        }
        
        /* Contenedor principal de la aplicación */
        #main-app-container {
            padding: 20px; /* Restauramos el padding para el contenido de la app */
            display: none; /* OCULTA LA APP HASTA EL LOGIN */
        }

        /* Estilos del header de la app */
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 0.9rem;
        }
        
        .section {
            padding: 25px;
            display: none;
        }
        
        .section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        /* ... (Resto de estilos de secciones, botones, notificaciones, etc. - Se mantienen igual) ... */
        
        .action-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 10px 5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #F44336, #C62828);
            color: white;
        }

        .user-display {
            margin-top: 10px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .user-display span {
            background: rgba(255,255,255,0.2);
            padding: 3px 10px;
            border-radius: 20px;
        }

        .firebase-status {
            /* Mantenemos el estilo de estado de Firebase */
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1001;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
        }
        
        /* Resto del CSS (omito por brevedad, pero debe estar completo en tu archivo) */
        
    </style>
</head>
<body>
    
    <div id="firebase-status" class="firebase-status firebase-connected">
        <i class="fas fa-database"></i> Cargando...
    </div>

    <div id="login-screen" style="display: none;">
        <div class="login-card">
            <h2 id="auth-title">Iniciar Sesión</h2>
            <form id="auth-form">
                <div class="form-group">
                    <label class="form-label" for="auth-email">Correo Electrónico:</label>
                    <input type="email" id="auth-email" class="form-control" required placeholder="tu.correo@ejemplo.com">
                </div>
                <div class="form-group">
                    <label class="form-label" for="auth-password">Contraseña:</label>
                    <input type="password" id="auth-password" class="form-control" required placeholder="********">
                </div>
                <button type="submit" class="btn btn-primary" id="auth-submit-btn" style="width: 100%; margin-top: 20px;">
                    <i class="fas fa-sign-in-alt"></i> Iniciar Sesión
                </button>
            </form>
            <div id="auth-error-message" class="error-message" style="display: none; margin-top: 10px; color: var(--danger-color);"></div>
            
            <p class="toggle-form" id="toggle-auth-mode">¿No tienes cuenta? Regístrate aquí</p>
        </div>
    </div>
    
    <div id="main-app-container" style="display: none;">
        <div class="container">
            <div class="header">
                <h1><i class="fas fa-hospital-alt"></i> IRAT-5 + Tinetti + Norton</h1>
                <p>Evaluación Clínica Integral de Riesgo - Sistema Profesional</p>
                <div id="user-display" class="user-display">
                    <i class="fas fa-user-md"></i> <span></span>
                    <button class="btn btn-danger btn-sm" id="btn-logout" style="padding: 5px 10px; font-size: 0.8rem;">
                        <i class="fas fa-sign-out-alt"></i> Salir
                    </button>
                </div>
            </div>
            
            <div class="nav-tabs">
                <button class="nav-tab active" data-section="identificacion">Identificación</button>
                <button class="nav-tab" data-section="evaluacion">IRAT-5</button>
                <button class="nav-tab" data-section="tinetti">Tinetti</button>
                <button class="nav-tab" data-section="norton">Norton</button>
                <button class="nav-tab" data-section="resultados">Resultados</button>
                <button class="nav-tab" data-section="historial">Historial</button>
                <button class="nav-tab" data-section="compartir">Compartir</button>
            </div>
            
            <section id="identificacion" class="section active">
                <h2 class="section-title"><i class="fas fa-user"></i> Identificación del Paciente</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Nombre completo <span style="color:red">*</span></label>
                        <input type="text" id="nombre" class="form-control" placeholder="Nombre y apellidos del paciente" required>
                        <div id="error-nombre" class="error-message"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">RUT / Identificación</label>
                        <input type="text" id="rut" class="form-control" placeholder="Ej: 12.345.678-9">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Edad</label>
                        <input type="number" id="edad" class="form-control" placeholder="Edad en años">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Fecha evaluación <span style="color:red">*</span></label>
                        <input type="date" id="fecha" class="form-control" required>
                        <div id="error-fecha" class="error-message"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Sexo</label>
                        <select id="sexo" class="form-control">
                            <option value="">Seleccione...</option>
                            <option value="masculino">Masculino</option>
                            <option value="femenino">Femenino</option>
                            <option value="no especificado">No especificado</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Evaluador <span style="color:red">*</span></label>
                        <input type="text" id="evaluador" class="form-control" placeholder="Nombre del profesional" required>
                        <div id="error-evaluador" class="error-message"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Institución/Clínica</label>
                        <input type="text" id="institucion" class="form-control" placeholder="Nombre de la institución">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Número de Historia Clínica</label>
                        <input type="text" id="historia-clinica" class="form-control" placeholder="Número de identificación">
                    </div>
                </div>
                
                <div class="action-buttons">
                    <div></div>
                    <button class="btn btn-primary" id="siguiente-irat">
                        <i class="fas fa-arrow-right"></i> Siguiente: IRAT-5
                    </button>
                </div>
            </section>
            
            <section id="historial" class="section">
                <h2 class="section-title"><i class="fas fa-history"></i> Historial de Evaluaciones</h2>
                
                <div class="info-box">
                    <strong><i class="fas fa-database"></i> Historial Compartido</strong>
                    <p>Usted puede ver todas las evaluaciones creadas por cualquier usuario de su equipo.</p>
                    <div id="firebase-stats" style="margin-top: 10px;">
                        <span id="total-evaluaciones">Cargando estadísticas...</span>
                    </div>
                </div>
                
                <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h4 style="margin-bottom: 15px; color: var(--primary-color);">
                        <i class="fas fa-filter"></i> Filtros de búsqueda
                    </h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Nombre del paciente</label>
                            <input type="text" id="filter-nombre" class="form-control" placeholder="Buscar por nombre">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Fecha desde</label>
                            <input type="date" id="filter-fecha-desde" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Fecha hasta</label>
                            <input type="date" id="filter-fecha-hasta" class="form-control">
                        </div>
                    </div>
                    <div class="action-buttons" style="margin-top: 15px;">
                        <button class="btn btn-primary" id="btn-aplicar-filtros">
                            <i class="fas fa-search"></i> Buscar
                        </button>
                        <button class="btn btn-warning" id="btn-limpiar-filtros">
                            <i class="fas fa-undo"></i> Limpiar
                        </button>
                    </div>
                </div>
                
                <div id="historial-container" class="historial-container">
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-spinner fa-spin fa-2x" style="margin-bottom: 20px;"></i>
                        <p>Cargando historial desde Firebase...</p>
                    </div>
                </div>
                
                <div id="pagination-container" style="display: none; margin-top: 20px;">
                    <div class="pagination">
                        <button class="btn btn-primary" id="btn-prev" disabled>
                            <i class="fas fa-chevron-left"></i> Anterior
                        </button>
                        <span id="page-info" style="margin: 0 15px;">Página 1</span>
                        <button class="btn btn-primary" id="btn-next">
                            Siguiente <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-warning" id="volver-resultados-historial">
                        <i class="fas fa-arrow-left"></i> Anterior
                    </button>
                </div>
            </section>
            
            </div>
    </div>
    
    <div id="notification" class="notification"></div>

    <script>
        // ========== CONFIGURACIÓN FIREBASE ==========
        // ¡REEMPLAZA ESTOS VALORES CON TUS CREDENCIALES REALES

        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDJbtRuEwWVAsC1Nz6LbeF5a99LcUfAz4g",
  authDomain: "irat-5-evaluaciones.firebaseapp.com",
  databaseURL: "https://irat-5-evaluaciones-default-rtdb.firebaseio.com",
  projectId: "irat-5-evaluaciones",
  storageBucket: "irat-5-evaluaciones.firebasestorage.app",
  messagingSenderId: "487279274410",
  appId: "1:487279274410:web:146e9c35a0bf795c5423d3",
  measurementId: "G-WSXJY5QHJS"
};
        // ========== VARIABLES GLOBALES ==========
        let firebaseApp;
        let db;
        let auth; // NUEVO: Módulo de autenticación
        let currentUser = null; // NUEVO: Almacena la información del usuario logueado
        
        let datosCompletos = null; 
        let idEvaluacionActual = null; 
        let historialFirebase = [];
        let currentPage = 1;
        const itemsPerPage = 5;
        let lastVisible = null;
        let firstVisible = null;
        
        // Variables del formulario (MANTENER)
        let puntajeTotalIRAT = 0;
        let puntajeNorton = 15;
        let puntajeTinetti = 0;
        let nivelRiesgoIRAT = "";
        let nivelRiesgoNorton = "";
        let recomendaciones = [];
        let tinettiNoEvaluable = false;
        let respuestasTinetti = {};
        let respuestasIRAT = {};
        let respuestasNorton = {};

        // ========== INICIALIZACIÓN PRINCIPAL ==========
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar Firebase
            inicializarFirebase();
            
            // Configurar la autenticación ANTES de la aplicación
            configurarAutenticacion();
            
            // Configurar el resto de la aplicación solo después de que Firebase esté listo
            configurarApp();
            
            calcularNorton();
            mostrarNotificacion('Sistema cargado', 'success');
        });
        
        function configurarApp() {
            // Configurar fecha actual
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fecha').value = today;
            
            // Configurar navegación
            inicializarNavegacion();
            
            // Configurar componentes del formulario
            configurarTinetti();
            configurarIRAT5();
            configurarCompartir();
            configurarHistorial();
            configurarValidaciones();
            
            // Configurar eventos de Norton
            ['norton-fisico', 'norton-mental', 'norton-actividad', 'norton-movilidad', 'norton-incontinencia'].forEach(id => {
                document.getElementById(id).addEventListener('change', calcularNorton);
            });
        }


        // ========== INICIALIZAR FIREBASE Y AUTH ==========
        function inicializarFirebase() {
            try {
                firebaseApp = firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth(); // Inicializar Auth
                
                actualizarEstadoFirebase('Conectado a Firestore', 'firebase-connected');
                
            } catch (error) {
                console.error('Error inicializando Firebase:', error);
                actualizarEstadoFirebase('Error de conexión a Firestore', 'firebase-disconnected');
                mostrarNotificacion('Error conectando a Firebase. Revisa tus credenciales.', 'error');
            }
        }
        
        // ========== CONTROL DE ACCESO (LOGIN/REGISTRO) ==========
        function configurarAutenticacion() {
            
            // 1. LISTENER DE ESTADO DE AUTENTICACIÓN
            auth.onAuthStateChanged(user => {
                if (user) {
                    // USUARIO LOGUEADO
                    currentUser = user;
                    console.log("Usuario autenticado:", user.email, "UID:", user.uid);
                    
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('main-app-container').style.display = 'block';
                    document.getElementById('user-display').innerHTML = `
                        <i class="fas fa-user-md"></i> <span>${user.email}</span>
                        <button class="btn btn-danger btn-sm" id="btn-logout" style="padding: 5px 10px; font-size: 0.8rem;">
                            <i class="fas fa-sign-out-alt"></i> Salir
                        </button>`;
                    
                    document.getElementById('btn-logout').addEventListener('click', cerrarSesion);
                    
                    // Solo cargamos el historial si la app está visible (para evitar errores de inicialización)
                    if (document.getElementById('historial').classList.contains('active') || 
                        document.getElementById('main-app-container').style.display === 'block') {
                        cargarHistorialFirebase(); 
                    }
                    
                } else {
                    // USUARIO DESCONECTADO
                    currentUser = null;
                    document.getElementById('login-screen').style.display = 'flex';
                    document.getElementById('main-app-container').style.display = 'none';
                    document.getElementById('user-display').innerHTML = '';
                    
                    // Si no hay usuario, forzamos la vista de login
                    document.getElementById('auth-title').textContent = 'Iniciar Sesión';
                    document.getElementById('auth-submit-btn').innerHTML = '<i class="fas fa-sign-in-alt"></i> Iniciar Sesión';
                    document.getElementById('toggle-auth-mode').textContent = '¿No tienes cuenta? Regístrate aquí';
                    document.getElementById('auth-form').dataset.mode = 'login';
                }
            });
            
            // 2. FORMULARIO DE AUTH
            const authForm = document.getElementById('auth-form');
            authForm.dataset.mode = 'login'; // Estado inicial
            
            document.getElementById('toggle-auth-mode').addEventListener('click', () => {
                const mode = authForm.dataset.mode;
                if (mode === 'login') {
                    authForm.dataset.mode = 'register';
                    document.getElementById('auth-title').textContent = 'Registro de Usuario';
                    document.getElementById('auth-submit-btn').innerHTML = '<i class="fas fa-user-plus"></i> Registrar Cuenta';
                    document.getElementById('toggle-auth-mode').textContent = '¿Ya tienes cuenta? Inicia Sesión aquí';
                } else {
                    authForm.dataset.mode = 'login';
                    document.getElementById('auth-title').textContent = 'Iniciar Sesión';
                    document.getElementById('auth-submit-btn').innerHTML = '<i class="fas fa-sign-in-alt"></i> Iniciar Sesión';
                    document.getElementById('toggle-auth-mode').textContent = '¿No tienes cuenta? Regístrate aquí';
                }
                document.getElementById('auth-error-message').style.display = 'none'; // Limpiar errores
            });

            authForm.addEventListener('submit', handleAuthSubmit);
        }
        
        async function handleAuthSubmit(e) {
            e.preventDefault();
            
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const mode = document.getElementById('auth-form').dataset.mode;
            const errorElement = document.getElementById('auth-error-message');
            errorElement.style.display = 'none';
            
            try {
                if (mode === 'register') {
                    await auth.createUserWithEmailAndPassword(email, password);
                    mostrarNotificacion('Registro exitoso. Iniciando sesión...', 'success');
                } else {
                    await auth.signInWithEmailAndPassword(email, password);
                    mostrarNotificacion('Inicio de sesión exitoso', 'success');
                }
                
            } catch (error) {
                console.error("Error de autenticación:", error);
                let msg = 'Error desconocido. Intente de nuevo.';
                if (error.code === 'auth/email-already-in-use') {
                    msg = 'El correo ya está registrado.';
                } else if (error.code === 'auth/invalid-email') {
                    msg = 'El formato del correo es inválido.';
                } else if (error.code === 'auth/weak-password') {
                    msg = 'La contraseña debe tener al menos 6 caracteres.';
                } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    msg = 'Correo o contraseña incorrectos.';
                }
                errorElement.textContent = msg;
                errorElement.style.display = 'block';
            }
        }

        function cerrarSesion() {
            auth.signOut().then(() => {
                mostrarNotificacion('Sesión cerrada correctamente', 'info');
                iniciarNuevaEvaluacion(false); // Limpiar datos sin pedir confirmación
            }).catch(error => {
                mostrarNotificacion('Error al cerrar sesión: ' + error.message, 'error');
            });
        }
        
        // ========== CARGAR HISTORIAL DESDE FIREBASE (AJUSTE CLAVE) ==========
        async function cargarHistorialFirebase(direction = 'first') {
            // Si el usuario no está logueado, no intentamos cargar
            if (!currentUser) { 
                mostrarHistorialVacio(false);
                return;
            }
            
            try {
                // ... (El resto de la lógica de filtros y paginación se mantiene igual) ...
                mostrarCargandoHistorial(true);
                
                const nombreFilter = document.getElementById('filter-nombre').value.trim().toLowerCase();
                const fechaDesdeFilter = document.getElementById('filter-fecha-desde').value;
                const fechaHastaFilter = document.getElementById('filter-fecha-hasta').value;
                
                let query = db.collection('evaluaciones');
                let reversed = false;
                
                // *** IMPORTANTE: No añadimos la cláusula .where('userId', '==', currentUser.uid) ***
                // Esto permite que el query recupere TODOS los documentos, y las reglas de seguridad
                // compartidas en la consola de Firebase permitirán la lectura para todos los logueados.
                
                if (direction === 'prev' && firstVisible) {
                    query = query.orderBy('fechaEvaluacion', 'asc');
                    query = query.endBefore(firstVisible);
                    reversed = true;
                } else {
                    query = query.orderBy('fechaEvaluacion', 'desc');
                    if (direction === 'next' && lastVisible) {
                        query = query.startAfter(lastVisible);
                    }
                }
                
                if (fechaDesdeFilter) {
                    query = query.where('fechaEvaluacion', '>=', fechaDesdeFilter);
                }
                
                if (fechaHastaFilter) {
                    const fechaHastaObj = new Date(fechaHastaFilter + 'T00:00:00');
                    fechaHastaObj.setDate(fechaHastaObj.getDate() + 1);
                    const fechaHastaExclusiva = fechaHastaObj.toISOString().split('T')[0];
                    query = query.where('fechaEvaluacion', '<', fechaHastaExclusiva);
                }
                
                query = query.limit(itemsPerPage);
                
                const snapshot = await query.get();
                
                if (snapshot.empty) {
                    historialFirebase = [];
                    mostrarHistorialVacio(nombreFilter.length > 0 || fechaDesdeFilter || fechaHastaFilter);
                    actualizarEstadisticas(0);
                    actualizarPaginacion();
                    return;
                }
                
                historialFirebase = [];
                snapshot.forEach(doc => {
                    historialFirebase.push({ id: doc.id, ...doc.data() });
                });
                
                if (reversed) {
                    historialFirebase.reverse();
                }
                
                // Filtrado por Nombre (Lado del Cliente)
                let resultadosFiltrados = historialFirebase;
                
                if (nombreFilter) {
                    resultadosFiltrados = historialFirebase.filter(evaluacion => {
                        const nombrePaciente = (evaluacion.paciente?.nombre || '').toLowerCase();
                        return nombrePaciente.includes(nombreFilter); 
                    });
                }
                
                historialFirebase = resultadosFiltrados;
                
                lastVisible = snapshot.docs[snapshot.docs.length - 1];
                firstVisible = snapshot.docs[0];
                
                actualizarVistaHistorial();
                actualizarEstadisticas(historialFirebase.length);
                actualizarPaginacion();
                
            } catch (error) {
                console.error('Error cargando historial Firebase:', error);
                // Si el error es de permisos (aunque se haya ajustado la regla)
                if (error.code === 'permission-denied') {
                    mostrarErrorHistorial('Acceso denegado. Revise las Reglas de Firestore o su estado de autenticación.');
                } else {
                    mostrarErrorHistorial(error.message);
                }
            } finally {
                mostrarCargandoHistorial(false);
            }
        }
        
        // ========== GUARDADO EN FIREBASE (AJUSTE CLAVE) ==========
        async function guardarEnFirebase() {
            if (!currentUser) {
                mostrarNotificacion('Debe iniciar sesión para guardar evaluaciones.', 'error');
                return;
            }
            
            if (!datosCompletos) {
                // Intentar calcular si no se ha hecho
                if (document.getElementById('resultados').classList.contains('active')) {
                     calcularResultadosCompletos(false);
                }
                if (!datosCompletos) {
                    mostrarNotificacion('Primero calcule los resultados para guardar la evaluación.', 'error');
                    return;
                }
            }
            
            try {
                mostrarNotificacion(idEvaluacionActual ? 'Actualizando en Firebase...' : 'Guardando en Firebase...', 'info');
                
                // Preparar datos para Firebase
                const datosFirebase = {
                    ...datosCompletos,
                    userId: currentUser.uid, // ASIGNAR EL ID DEL USUARIO LOGUEADO
                    userEmail: currentUser.email,
                    fechaGuardado: firebase.firestore.FieldValue.serverTimestamp(),
                    fechaEvaluacion: datosCompletos.paciente.fecha || new Date().toISOString().split('T')[0]
                };
                
                let docRef;
                
                if (idEvaluacionActual) {
                    // Si existe ID, actualizamos (solo si el usuario es el dueño - regla de Firestore)
                    docRef = db.collection('evaluaciones').doc(idEvaluacionActual);
                    await docRef.update(datosFirebase);
                    mostrarNotificacion(`Evaluación actualizada correctamente (ID: ${idEvaluacionActual.substring(0, 8)}...)`, 'success');
                } else {
                    // Si no existe ID, guardamos como nuevo
                    docRef = await db.collection('evaluaciones').add(datosFirebase);
                    idEvaluacionActual = docRef.id; 
                    mostrarNotificacion(`Evaluación guardada correctamente (ID: ${docRef.id.substring(0, 8)}...)`, 'success');
                }
                
                if (document.getElementById('historial').classList.contains('active')) {
                    cargarHistorialFirebase();
                }
                
            } catch (error) {
                console.error('Error guardando en Firebase:', error);
                // Si el error es de permisos, es porque el usuario intenta editar un documento que no es suyo.
                if (error.code === 'permission-denied') {
                    mostrarNotificacion('Error al guardar: No tiene permiso para modificar esta evaluación (Solo puede editar las suyas).', 'error');
                } else {
                    mostrarNotificacion('Error al guardar: ' + error.message, 'error');
                }
            }
        }
        
        // ========== FUNCIONES ADICIONALES (MANTENIDAS) ==========
        
        // ... (El resto de funciones como mostrarCargandoHistorial, mostrarHistorialVacio, etc. se mantienen igual) ...
        
        function iniciarNuevaEvaluacion(confirmacion = true) {
            if (confirmacion && !confirm('¿Está seguro de comenzar una nueva evaluación? Los datos no guardados se perderán.')) {
                return;
            }
            // Reiniciar variables para una nueva evaluación
            datosCompletos = null;
            idEvaluacionActual = null;
            puntajeTotalIRAT = 0;
            puntajeNorton = 15;
            puntajeTinetti = 0;
            tinettiNoEvaluable = false;
            respuestasTinetti = {};
            respuestasIRAT = {};
            respuestasNorton = {};

            // Recargar página para limpiar inputs y selects
            window.location.reload(); 
            
            // Si no recargas, tienes que implementar el reset de todos los campos manualmente
            // cambiarSeccion('identificacion');
            // document.getElementById('nombre').value = '';
            // ... etc.
        }
        
        // ... (Todas las demás funciones como inicializarNavegacion, cambiarSeccion, validar, calcularTinetti, etc. deben estar aquí) ...
        
    </script>
    
    <script>
    // ... (Copia aquí el resto del JavaScript de la respuesta anterior) ...
    </script>
</body>
</html>
