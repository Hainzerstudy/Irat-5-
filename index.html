<script>
    // ====================================
    // ========== CONFIGURACIÓN FIREBASE ==========
    // ====================================
    
    // ¡¡¡IMPORTANTE!!!: REEMPLAZA ESTOS VALORES CON TUS CREDENCIALES REALES
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDJbtRuEwWVAsC1Nz6LbeF5a99LcUfAz4g",
  authDomain: "irat-5-evaluaciones.firebaseapp.com",
  databaseURL: "https://irat-5-evaluaciones-default-rtdb.firebaseio.com",
  projectId: "irat-5-evaluaciones",
  storageBucket: "irat-5-evaluaciones.firebasestorage.app",
  messagingSenderId: "487279274410",
  appId: "1:487279274410:web:146e9c35a0bf795c5423d3",
  measurementId: "G-WSXJY5QHJS"
};
    // ====================================
    // ========== VARIABLES GLOBALES ==========
    // ====================================
    let firebaseApp;
    let db;
    let auth; 
    let currentUser = null; 
    
    let datosCompletos = null; 
    let idEvaluacionActual = null; 
    let historialFirebase = [];
    let currentPage = 1;
    const itemsPerPage = 5;
    let lastVisible = null;
    let firstVisible = null;
    
    // Variables de puntajes
    let puntajeTotalIRAT = 0;
    let puntajeNorton = 15;
    let puntajeTinetti = 0;
    let nivelRiesgoIRAT = "";
    let nivelRiesgoNorton = "";
    let recomendaciones = [];
    let tinettiNoEvaluable = false;
    let respuestasTinetti = {};
    let respuestasIRAT = {};
    let respuestasNorton = {};

    // ====================================
    // ========== DEFINICIONES DE ESCALAS ACTUALIZADAS CON SELECT ==========
    // ====================================

    // IRAT-5 (Original con Amputaciones, 5 preguntas, Max 10 pts)
    const IRAT_DEFINITIONS = [
        { 
            question: "1. Condición de las Extremidades", 
            name: "irat-q1",
            options: [
                { label: "Sin amputación ni inmovilización", value: 0 }, 
                { label: "Amputación parcial/Inmovilización con riesgo", value: 1 }, 
                { label: "Amputación total/Inmovilización completa", value: 2 }
            ] 
        },
        { 
            question: "2. Estado Mental", 
            name: "irat-q2",
            options: [
                { label: "Consciente y Orientado", value: 0 }, 
                { label: "Desorientado/Confuso", value: 1 }, 
                { label: "Inconsciente/Estupor", value: 2 }
            ] 
        },
        { 
            question: "3. Nutrición (Apetito)", 
            name: "irat-q3",
            options: [
                { label: "Normal/Aceptable", value: 0 }, 
                { label: "Disminuido/Selectivo", value: 1 }, 
                { label: "Muy Pobre/Sonda", value: 2 }
            ] 
        },
        { 
            question: "4. Incontinencia (Doble)", 
            name: "irat-q4",
            options: [
                { label: "Continente", value: 0 }, 
                { label: "Solo Urinaria u Ocasional", value: 1 }, 
                { label: "Doble Incontinencia", value: 2 }
            ] 
        },
        { 
            question: "5. Piel (Integridad/Edema)", 
            name: "irat-q5",
            options: [
                { label: "Piel sana/Normal", value: 0 }, 
                { label: "Riesgo/Piel Frágil/Edema Leve", value: 1 }, 
                { label: "Lesión existente/Úlcera/Edema Grave", value: 2 }
            ] 
        }
    ];

    // TINETTI (Original: Equilibrio Max 16 pts, Marcha Max 12 pts, Total Max 28 pts)
    // 9 ítems de Equilibrio (EQ)
    const TINETTI_DEFINITIONS_EQUILIBRIO = [
        { question: "1. Equilibrio sentado", name: "tinetti-eq-q1", options: [{ label: "Seguro", value: 1 }, { label: "Inseguro", value: 0 }] },
        { question: "2. Levantarse (de la silla)", name: "tinetti-eq-q2", options: [{ label: "Se levanta sin ayuda", value: 2 }, { label: "Se levanta con ayuda", value: 1 }, { label: "Incapaz sin ayuda", value: 0 }] },
        { question: "3. Intentos de levantarse", name: "tinetti-eq-q3", options: [{ label: "Un intento", value: 1 }, { label: "Múltiples intentos", value: 0 }] },
        { question: "4. Equilibrio de pie (inmediato, primeros 5 seg)", name: "tinetti-eq-q4", options: [{ label: "Estable sin apoyo", value: 2 }, { label: "Usa apoyo/inestable", value: 1 }, { label: "Incapaz de mantenerse", value: 0 }] },
        { question: "5. Equilibrio de pie (general)", name: "tinetti-eq-q5", options: [{ label: "Estable", value: 2 }, { label: "Ligeramente inestable", value: 1 }, { label: "Muy inestable o requiere apoyo", value: 0 }] },
        { question: "6. Empujón (equilibrio tras empujón en esternón)", name: "tinetti-eq-q6", options: [{ label: "Estable", value: 1 }, { label: "Se tambalea/pierde equilibrio", value: 0 }] },
        { question: "7. Ojos cerrados (equilibrio de pie por 10 seg)", name: "tinetti-eq-q7", options: [{ label: "Estable", value: 1 }, { label: "Inestable", value: 0 }] },
        { question: "8. Giro de 360°", name: "tinetti-eq-q8", options: [{ label: "Continuo y estable", value: 2 }, { label: "Discontinuo/inestable", value: 1 }, { label: "Ayuda/incapaz", value: 0 }] },
        { question: "9. Sentarse", name: "tinetti-eq-q9", options: [{ label: "Seguro", value: 2 }, { label: "Usa brazos o cae", value: 1 }, { label: "Sin control", value: 0 }] }
    ]; // Máx 16 pts

    // 7 ítems de Marcha (MAR)
    const TINETTI_DEFINITIONS_MARCHA = [
        { question: "1. Inicio de la marcha", name: "tinetti-mar-q1", options: [{ label: "Sin titubeos", value: 1 }, { label: "Titubeante o arrastra", value: 0 }] },
        { question: "2. Longitud y altura del paso (pie derecho)", name: "tinetti-mar-q2", options: [{ label: "Sobrepasa y levanta totalmente", value: 2 }, { label: "Algún defecto (No sobrepasa o arrastra)", value: 1 }, { label: "Incapaz de caminar", value: 0 }] },
        { question: "3. Longitud y altura del paso (pie izquierdo)", name: "tinetti-mar-q3", options: [{ label: "Sobrepasa y levanta totalmente", value: 2 }, { label: "Algún defecto (No sobrepasa o arrastra)", value: 1 }, { label: "Incapaz de caminar", value: 0 }] },
        { question: "4. Simetría del paso", name: "tinetti-mar-q4", options: [{ label: "Pasos simétricos", value: 1 }, { label: "Pasos asimétricos", value: 0 }] },
        { question: "5. Continuidad del paso", name: "tinetti-mar-q5", options: [{ label: "Continuo", value: 1 }, { label: "Discontinuo", value: 0 }] },
        { question: "6. Trayectoria", name: "tinetti-mar-q6", options: [{ label: "Recta sin desvío", value: 2 }, { label: "Leve o moderada desviación", value: 1 }, { label: "Marcada desviación/usa apoyo", value: 0 }] },
        { question: "7. Tronco (balanceo/uso de ayuda)", name: "tinetti-mar-q7", options: [{ label: "No se balancea y no usa ayuda", value: 2 }, { label: "Se balancea o usa ayuda", value: 1 }, { label: "Requiere ayuda constante o incapaz", value: 0 }] }
    ]; // Máx 12 pts

    // ====================================
    // ========== INICIALIZACIÓN PRINCIPAL ==========
    // ====================================
    
    document.addEventListener('DOMContentLoaded', function() {
        inicializarFirebase();
        configurarAutenticacion();
        configurarApp();
        mostrarNotificacion('Sistema cargado', 'success');
    });
    
    function configurarApp() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('fecha').value = today;
        
        inicializarNavegacion();
        // CUIDADO: Usamos las funciones de configuración que generan SELECTS
        configurarIRAT5(); 
        configurarTinetti();
        calcularNorton(); 
        configurarHistorial();
        configurarValidaciones();
        
        // Eventos de botones (Igual que antes)
        document.getElementById('siguiente-irat').addEventListener('click', () => {
            if(validarIdentificacion()) cambiarSeccion('evaluacion');
        });
        document.getElementById('siguiente-tinetti').addEventListener('click', () => cambiarSeccion('tinetti'));
        document.getElementById('siguiente-norton').addEventListener('click', () => cambiarSeccion('norton'));
        document.getElementById('siguiente-resultados').addEventListener('click', () => {
            calcularResultadosCompletos(true);
            cambiarSeccion('resultados');
        });
        document.getElementById('btn-guardar').addEventListener('click', guardarEnFirebase);
        document.getElementById('btn-descargar-pdf').addEventListener('click', generarPDF);
        document.getElementById('btn-whatsapp').addEventListener('click', compartirWhatsApp);
        document.getElementById('btn-logout').addEventListener('click', cerrarSesion);

        // Eventos de Norton (Igual que antes, usa selects)
        ['norton-fisico', 'norton-mental', 'norton-actividad', 'norton-movilidad', 'norton-incontinencia'].forEach(id => {
            document.getElementById(id).addEventListener('change', calcularNorton);
        });
    }

    // ====================================
    // ========== FIREBASE & AUTHENTICATION (SIN CAMBIOS) ==========
    // ====================================
    
    function inicializarFirebase() {
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth(); // Inicializar Auth
            actualizarEstadoFirebase('Conectado a Firestore', 'firebase-connected');
        } catch (error) {
            console.error('Error inicializando Firebase:', error);
            actualizarEstadoFirebase('Error de conexión', 'firebase-disconnected');
            mostrarNotificacion('Error conectando a Firebase. Revisa tus credenciales.', 'error');
        }
    }
    
    function configurarAutenticacion() {
        const authForm = document.getElementById('auth-form');
        authForm.dataset.mode = 'login'; 
        
        auth.onAuthStateChanged(user => {
            if (user) {
                // USUARIO LOGUEADO
                currentUser = user;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app-container').style.display = 'block';
                document.getElementById('user-display').querySelector('span').textContent = user.email;
                
                if (document.getElementById('historial').classList.contains('active') || 
                    document.getElementById('main-app-container').style.display === 'block') {
                    cargarHistorialFirebase(); 
                }
                
            } else {
                // USUARIO DESCONECTADO
                currentUser = null;
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('main-app-container').style.display = 'none';
                document.getElementById('user-display').querySelector('span').textContent = '';
            }
        });
        
        // Toggle Login/Register
        document.getElementById('toggle-auth-mode').addEventListener('click', () => {
            const mode = authForm.dataset.mode;
            const isLogin = mode === 'login';
            authForm.dataset.mode = isLogin ? 'register' : 'login';
            document.getElementById('auth-title').textContent = isLogin ? 'Registro de Usuario' : 'Iniciar Sesión';
            document.getElementById('auth-submit-btn').innerHTML = isLogin ? '<i class="fas fa-user-plus"></i> Registrar Cuenta' : '<i class="fas fa-sign-in-alt"></i> Iniciar Sesión';
            document.getElementById('toggle-auth-mode').textContent = isLogin ? '¿Ya tienes cuenta? Inicia Sesión aquí' : '¿No tienes cuenta? Regístrate aquí';
            document.getElementById('auth-error-message').style.display = 'none';
        });

        authForm.addEventListener('submit', handleAuthSubmit);
    }
    
    async function handleAuthSubmit(e) {
        e.preventDefault();
        
        const email = document.getElementById('auth-email').value;
        const password = document.getElementById('auth-password').value;
        const mode = document.getElementById('auth-form').dataset.mode;
        const errorElement = document.getElementById('auth-error-message');
        errorElement.style.display = 'none';
        
        try {
            if (mode === 'register') {
                await auth.createUserWithEmailAndPassword(email, password);
                mostrarNotificacion('Registro exitoso. Iniciando sesión...', 'success');
            } else {
                await auth.signInWithEmailAndPassword(email, password);
                mostrarNotificacion('Inicio de sesión exitoso', 'success');
            }
            
        } catch (error) {
            console.error("Error de autenticación:", error);
            let msg = 'Error desconocido. Intente de nuevo.';
            if (error.code === 'auth/email-already-in-use') {
                msg = 'El correo ya está registrado.';
            } else if (error.code === 'auth/invalid-email') {
                msg = 'El formato del correo es inválido.';
            } else if (error.code === 'auth/weak-password') {
                msg = 'La contraseña debe tener al menos 6 caracteres.';
            } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                msg = 'Correo o contraseña incorrectos.';
            }
            errorElement.textContent = msg;
            errorElement.style.display = 'block';
        }
    }

    function cerrarSesion() {
        auth.signOut().then(() => {
            mostrarNotificacion('Sesión cerrada correctamente', 'info');
            iniciarNuevaEvaluacion(false); 
        }).catch(error => {
            mostrarNotificacion('Error al cerrar sesión: ' + error.message, 'error');
        });
    }

    function actualizarEstadoFirebase(message, className) {
        const statusDiv = document.getElementById('firebase-status');
        statusDiv.innerHTML = `<i class="fas fa-database"></i> ${message}`;
        statusDiv.className = `firebase-status ${className}`;
    }
    
    // ====================================
    // ========== FIREBASE DATA STORAGE (SIN CAMBIOS) ==========
    // ====================================
    
    async function guardarEnFirebase() {
        if (!currentUser) {
            mostrarNotificacion('Debe iniciar sesión para guardar evaluaciones.', 'error');
            return;
        }
        
        if (!datosCompletos && !calcularResultadosCompletos(false)) {
            mostrarNotificacion('Debe completar la identificación y calcular los resultados.', 'error');
            return;
        }
        
        try {
            mostrarNotificacion(idEvaluacionActual ? 'Actualizando en Firebase...' : 'Guardando en Firebase...', 'info');
            
            const datosFirebase = {
                ...datosCompletos,
                userId: currentUser.uid, 
                userEmail: currentUser.email,
                fechaGuardado: firebase.firestore.FieldValue.serverTimestamp(),
                fechaEvaluacion: datosCompletos.paciente.fecha || new Date().toISOString().split('T')[0]
            };
            
            let docRef;
            
            if (idEvaluacionActual) {
                docRef = db.collection('evaluaciones').doc(idEvaluacionActual);
                await docRef.update(datosFirebase);
                mostrarNotificacion(`Evaluación actualizada (ID: ${idEvaluacionActual.substring(0, 8)}...)`, 'success');
            } else {
                docRef = await db.collection('evaluaciones').add(datosFirebase);
                idEvaluacionActual = docRef.id; 
                mostrarNotificacion(`Evaluación guardada (ID: ${docRef.id.substring(0, 8)}...)`, 'success');
            }
            
            cargarHistorialFirebase();
            
        } catch (error) {
            console.error('Error guardando en Firebase:', error);
            if (error.code === 'permission-denied') {
                mostrarNotificacion('Error: No tiene permiso para modificar esta evaluación (Solo puede editar las suyas).', 'error');
            } else {
                mostrarNotificacion('Error al guardar: ' + error.message, 'error');
            }
        }
    }

    async function cargarHistorialFirebase() {
        if (!currentUser) { 
            document.getElementById('historial-container').innerHTML = '<p style="text-align: center; padding: 30px;">Inicie sesión para ver el historial.</p>';
            document.getElementById('total-evaluaciones').textContent = '0 evaluaciones';
            return;
        }
        
        try {
            mostrarCargandoHistorial(true);
            
            const nombreFilter = document.getElementById('filter-nombre').value.trim().toLowerCase();
            const fechaDesdeFilter = document.getElementById('filter-fecha-desde').value;
            const fechaHastaFilter = document.getElementById('filter-fecha-hasta').value;
            
            let query = db.collection('evaluaciones');
            query = query.orderBy('fechaEvaluacion', 'desc');

            if (fechaDesdeFilter) {
                query = query.where('fechaEvaluacion', '>=', fechaDesdeFilter);
            }
            if (fechaHastaFilter) {
                const fechaHastaObj = new Date(fechaHastaFilter + 'T00:00:00');
                fechaHastaObj.setDate(fechaHastaObj.getDate() + 1);
                const fechaHastaExclusiva = fechaHastaObj.toISOString().split('T')[0];
                query = query.where('fechaEvaluacion', '<', fechaHastaExclusiva);
            }

            const snapshot = await query.get();
            
            historialFirebase = [];
            snapshot.forEach(doc => {
                historialFirebase.push({ id: doc.id, ...doc.data() });
            });
            
            let resultadosFiltrados = historialFirebase;
            if (nombreFilter) {
                resultadosFiltrados = historialFirebase.filter(evaluacion => {
                    const nombrePaciente = (evaluacion.paciente?.nombre || '').toLowerCase();
                    return nombrePaciente.includes(nombreFilter); 
                });
            }
            
            historialFirebase = resultadosFiltrados;
            
            actualizarVistaHistorial();
            actualizarEstadisticas(historialFirebase.length);
            actualizarPaginacion();
            
        } catch (error) {
            console.error('Error cargando historial Firebase:', error);
            mostrarErrorHistorial('Error de carga. Verifique la conexión o las reglas de seguridad.');
        } finally {
            mostrarCargandoHistorial(false);
        }
    }
    
    function mostrarCargandoHistorial(isLoading) {
        const container = document.getElementById('historial-container');
        if (isLoading) {
            container.innerHTML = `<div style="text-align: center; padding: 40px; color: #666;">
                <i class="fas fa-spinner fa-spin fa-2x" style="margin-bottom: 20px;"></i>
                <p>Cargando historial desde Firebase...</p>
            </div>`;
        } else if (container.querySelector('.fa-spin')) {
            container.innerHTML = ''; 
        }
    }
    
    function actualizarEstadisticas(count) {
        document.getElementById('total-evaluaciones').textContent = `${count} evaluaciones en total (Filtros aplicados).`;
    }

    function actualizarVistaHistorial() {
        const container = document.getElementById('historial-container');
        container.innerHTML = '';
        
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const itemsToShow = historialFirebase.slice(startIndex, endIndex);

        if (itemsToShow.length === 0 && historialFirebase.length > 0) {
            currentPage = Math.max(1, Math.ceil(historialFirebase.length / itemsPerPage));
            actualizarVistaHistorial(); 
            return;
        }
        
        if (historialFirebase.length === 0) {
            container.innerHTML = '<p style="text-align: center; padding: 30px; color: #999;">No se encontraron evaluaciones con los filtros aplicados.</p>';
            return;
        }

        itemsToShow.forEach(evaluacion => {
            const item = document.createElement('div');
            const isOwner = evaluacion.userId === currentUser.uid;
            const ownerText = isOwner ? ' (Creada por mí)' : ` (Creada por: ${evaluacion.userEmail})`;
            
            item.className = 'historial-item';
            item.innerHTML = `
                <div class="historial-info">
                    <strong>${evaluacion.paciente.nombre}</strong>
                    <span>Fecha: ${evaluacion.paciente.fecha} | IRAT-5: ${evaluacion.resultados.irat.nivel} | Tinetti: ${evaluacion.resultados.tinetti.puntaje} pts ${ownerText}</span>
                </div>
                <div class="historial-actions">
                    <button class="btn btn-primary btn-sm" onclick="cargarEvaluacion('${evaluacion.id}')">
                        <i class="fas fa-eye"></i> Ver/Editar
                    </button>
                    ${isOwner ? `<button class="btn btn-danger btn-sm" onclick="eliminarEvaluacion('${evaluacion.id}', '${evaluacion.paciente.nombre}')">
                        <i class="fas fa-trash-alt"></i> Borrar
                    </button>` : ''}
                </div>
            `;
            container.appendChild(item);
        });
    }
    
    function actualizarPaginacion() {
        const totalPages = Math.ceil(historialFirebase.length / itemsPerPage);
        const prevBtn = document.getElementById('btn-prev');
        const nextBtn = document.getElementById('btn-next');
        const pageInfo = document.getElementById('page-info');
        
        document.getElementById('pagination-container').style.display = totalPages > 1 ? 'block' : 'none';
        
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage === totalPages || historialFirebase.length === 0;
        pageInfo.textContent = `Página ${currentPage} de ${totalPages}`;
    }
    
    // Manejadores de Paginación y Filtros (Sin cambios)
    document.getElementById('btn-prev').addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            actualizarVistaHistorial();
            actualizarPaginacion();
        }
    });
    
    document.getElementById('btn-next').addEventListener('click', () => {
        const totalPages = Math.ceil(historialFirebase.length / itemsPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            actualizarVistaHistorial();
            actualizarPaginacion();
        }
    });

    document.getElementById('btn-aplicar-filtros').addEventListener('click', () => {
        currentPage = 1;
        cargarHistorialFirebase();
    });

    document.getElementById('btn-limpiar-filtros').addEventListener('click', () => {
        document.getElementById('filter-nombre').value = '';
        document.getElementById('filter-fecha-desde').value = '';
        document.getElementById('filter-fecha-hasta').value = '';
        currentPage = 1;
        cargarHistorialFirebase();
    });

    async function cargarEvaluacion(id) {
        try {
            mostrarNotificacion('Cargando evaluación...', 'info');
            const doc = await db.collection('evaluaciones').doc(id).get();
            if (!doc.exists) {
                mostrarNotificacion('Evaluación no encontrada.', 'error');
                return;
            }
            
            const data = doc.data();
            datosCompletos = data;
            idEvaluacionActual = id;
            
            // Cargar datos de paciente
            document.getElementById('nombre').value = data.paciente.nombre || '';
            document.getElementById('rut').value = data.paciente.rut || '';
            document.getElementById('edad').value = data.paciente.edad || '';
            document.getElementById('fecha').value = data.paciente.fecha || '';
            document.getElementById('sexo').value = data.paciente.sexo || '';
            document.getElementById('evaluador').value = data.paciente.evaluador || '';
            document.getElementById('institucion').value = data.paciente.institucion || '';
            document.getElementById('historia-clinica').value = data.paciente.historiaClinica || '';

            // Cargar respuestas de las escalas (IRAT, Tinetti, Norton)
            cargarRespuestasSelect(data.respuestas.irat, 'irat-form');
            cargarRespuestasSelect(data.respuestas.tinetti, 'tinetti-equilibrio-form'); // Asume que las respuestas Tinetti están planas
            cargarRespuestasSelect(data.respuestas.tinetti, 'tinetti-marcha-form'); // Asume que las respuestas Tinetti están planas
            
            // Cargar Norton (selects)
            document.getElementById('norton-fisico').value = data.respuestas.norton.fisico || 4;
            document.getElementById('norton-mental').value = data.respuestas.norton.mental || 4;
            document.getElementById('norton-actividad').value = data.respuestas.norton.actividad || 4;
            document.getElementById('norton-movilidad').value = data.respuestas.norton.movilidad || 4;
            document.getElementById('norton-incontinencia').value = data.respuestas.norton.incontinencia || 4;
            calcularNorton(); 
            
            // Cargar estado de Tinetti no evaluable
            tinettiNoEvaluable = data.respuestas.tinetti.not_evaluable || false;
            const tinettiCheck = document.getElementById('tinetti-no-evaluable');
            tinettiCheck.checked = tinettiNoEvaluable;
            tinettiCheck.dispatchEvent(new Event('change')); // Dispara el evento para deshabilitar los selects si es necesario

            calcularResultadosCompletos(true);
            cambiarSeccion('resultados');
            mostrarNotificacion(`Evaluación de ${data.paciente.nombre} cargada.`, 'success');

        } catch (error) {
            console.error('Error al cargar evaluación:', error);
            mostrarNotificacion('Error al cargar la evaluación.', 'error');
        }
    }
    
    function cargarRespuestasSelect(respuestas, containerId) {
        const container = document.getElementById(containerId);
        for (const key in respuestas) {
            const select = container.querySelector(`select[name="${key}"]`);
            if (select) {
                select.value = respuestas[key];
            }
        }
    }

    async function eliminarEvaluacion(id, nombre) {
        if (!confirm(`¿Está seguro de eliminar la evaluación de ${nombre}? Esta acción es irreversible.`)) {
            return;
        }

        try {
            mostrarNotificacion('Eliminando evaluación...', 'info');
            await db.collection('evaluaciones').doc(id).delete();
            mostrarNotificacion(`Evaluación de ${nombre} eliminada correctamente.`, 'success');
            cargarHistorialFirebase(); 
            if (id === idEvaluacionActual) {
                iniciarNuevaEvaluacion(false); 
            }

        } catch (error) {
            console.error('Error al eliminar evaluación:', error);
            if (error.code === 'permission-denied') {
                 mostrarNotificacion('Error: Solo el creador de esta evaluación puede eliminarla.', 'error');
            } else {
                mostrarNotificacion('Error al eliminar: ' + error.message, 'error');
            }
        }
    }
    
    function iniciarNuevaEvaluacion(confirmacion = true) {
        if (confirmacion && !confirm('¿Está seguro de comenzar una nueva evaluación? Los datos no guardados se perderán.')) {
            return;
        }
        window.location.reload(); 
    }

    // ====================================
    // ========== NAVEGACIÓN Y VALIDACIÓN (SIN CAMBIOS) ==========
    // ====================================
    
    function inicializarNavegacion() {
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                cambiarSeccion(this.dataset.section);
            });
        });
    }

    function cambiarSeccion(targetId) {
        document.querySelectorAll('.section').forEach(section => {
            section.classList.remove('active');
        });
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.classList.remove('active');
        });

        document.getElementById(targetId).classList.add('active');
        document.querySelector(`.nav-tab[data-section="${targetId}"]`).classList.add('active');
        
        if (targetId === 'historial') {
            cargarHistorialFirebase();
        }
    }
    
    function validarIdentificacion() {
        let isValid = true;
        const nombre = document.getElementById('nombre');
        const fecha = document.getElementById('fecha');
        const evaluador = document.getElementById('evaluador');
        
        if (!nombre.value) {
            document.getElementById('error-nombre').textContent = 'El nombre es obligatorio.';
            isValid = false;
        } else {
            document.getElementById('error-nombre').textContent = '';
        }

        if (!fecha.value) {
            document.getElementById('error-fecha').textContent = 'La fecha es obligatoria.';
            isValid = false;
        } else {
            document.getElementById('error-fecha').textContent = '';
        }

        if (!evaluador.value) {
            document.getElementById('error-evaluador').textContent = 'El evaluador es obligatorio.';
            isValid = false;
        } else {
            document.getElementById('error-evaluador').textContent = '';
        }
        
        if (!isValid) {
            mostrarNotificacion('Complete los campos obligatorios de identificación (*)', 'error');
        }
        return isValid;
    }

    function mostrarNotificacion(message, type) {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = `notification ${type}`;
        notification.style.display = 'block';
        
        setTimeout(() => {
            notification.style.opacity = '1';
        }, 10);
        
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 500);
        }, 3000);
    }

    // ====================================
    // ========== LÓGICA DE ESCALAS CON SELECTS ==========
    // ====================================
    
    // Función genérica para generar selects
    function generateSelects(definitions, containerId, changeHandler) {
        const container = document.getElementById(containerId);
        // Mantiene el título si existe
        const titleHtml = container.querySelector('h3') ? container.querySelector('h3').outerHTML : '';
        container.innerHTML = titleHtml; 
        
        definitions.forEach((item) => {
            const group = document.createElement('div');
            group.className = 'form-group';
            group.innerHTML = `<label class="form-label">${item.question}</label>`;
            
            const select = document.createElement('select');
            select.className = 'form-control';
            select.name = item.name;
            select.required = true;
            
            // Opción por defecto
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = "Seleccione el puntaje";
            select.appendChild(defaultOption);

            item.options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option.value;
                opt.textContent = `${option.label} (${option.value} pts)`;
                select.appendChild(opt);
            });
            
            select.addEventListener('change', changeHandler);
            
            group.appendChild(select);
            container.appendChild(group);
        });
        
        changeHandler(); // Llamada inicial
    }

    // --- IRAT-5 ---
    function configurarIRAT5() {
        generateSelects(IRAT_DEFINITIONS, 'irat-form', calcularIRAT5);
    }

    function calcularIRAT5() {
        puntajeTotalIRAT = 0;
        respuestasIRAT = {};
        let allAnswered = true;
        
        IRAT_DEFINITIONS.forEach(def => {
            const select = document.querySelector(`select[name="${def.name}"]`);
            const value = parseInt(select.value);

            if (isNaN(value)) {
                allAnswered = false;
            } else {
                puntajeTotalIRAT += value;
                respuestasIRAT[def.name] = value;
            }
        });

        if (puntajeTotalIRAT >= 5) {
            nivelRiesgoIRAT = "Riesgo Alto (Puntaje ≥ 5)";
        } else if (puntajeTotalIRAT >= 3) {
            nivelRiesgoIRAT = "Riesgo Medio (Puntaje 3-4)";
        } else {
            nivelRiesgoIRAT = "Riesgo Bajo (Puntaje 0-2)";
        }
    }
    
    // --- TINETTI ---
    function configurarTinetti() {
        generateSelects(TINETTI_DEFINITIONS_EQUILIBRIO, 'tinetti-equilibrio-form', calcularTinetti);
        generateSelects(TINETTI_DEFINITIONS_MARCHA, 'tinetti-marcha-form', calcularTinetti);

        document.getElementById('tinetti-no-evaluable').addEventListener('change', function() {
            tinettiNoEvaluable = this.checked;
            const disableState = this.checked;
            
            const containers = [document.getElementById('tinetti-equilibrio-form'), document.getElementById('tinetti-marcha-form')];
            
            containers.forEach(c => {
                c.querySelectorAll('select').forEach(select => {
                    select.disabled = disableState;
                    if (disableState) select.value = ""; // Limpiar selección si se deshabilita
                });
            });
            calcularTinetti();
        });

        calcularTinetti(); // Cargar estado inicial
    }

    function calcularTinetti() {
        if (tinettiNoEvaluable) {
            puntajeTinetti = 0;
            respuestasTinetti = { not_evaluable: true };
            return;
        }
        
        puntajeTinetti = 0;
        respuestasTinetti = { not_evaluable: false };
        
        const processScale = (definitions) => {
            definitions.forEach((def) => {
                const select = document.querySelector(`select[name="${def.name}"]`);
                const value = parseInt(select.value);

                if (!isNaN(value)) {
                    puntajeTinetti += value;
                    respuestasTinetti[def.name] = value;
                }
            });
        };

        processScale(TINETTI_DEFINITIONS_EQUILIBRIO);
        processScale(TINETTI_DEFINITIONS_MARCHA);
    }

    // --- NORTON (Sin cambios en lógica, ya usa selects) ---
    function calcularNorton() {
        puntajeNorton = 0;
        respuestasNorton = {};
        const factores = ['fisico', 'mental', 'actividad', 'movilidad', 'incontinencia'];

        factores.forEach(factor => {
            const select = document.getElementById(`norton-${factor}`);
            const value = parseInt(select.value);
            
            if (!isNaN(value)) {
                puntajeNorton += value;
                respuestasNorton[factor] = value;
            }
        });

        if (puntajeNorton <= 12) {
            nivelRiesgoNorton = "Riesgo ALTO (Puntaje ≤ 12)";
            document.getElementById('resultado-norton').className = 'result-box high-risk';
        } else if (puntajeNorton >= 13 && puntajeNorton <= 14) {
            nivelRiesgoNorton = "Riesgo MEDIO (Puntaje 13-14)";
            document.getElementById('resultado-norton').className = 'result-box medium-risk';
        } else {
            nivelRiesgoNorton = "Riesgo BAJO (Puntaje ≥ 15)";
            document.getElementById('resultado-norton').className = 'result-box low-risk';
        }

        document.getElementById('norton-score').textContent = puntajeNorton;
        document.getElementById('norton-riesgo').textContent = nivelRiesgoNorton;
    }


    // ====================================
    // ========== RESULTADOS Y PDF (LÓGICA DE CÁLCULO MANTENIDA) ==========
    // ====================================
    
    function calcularResultadosCompletos(shouldNotify) {
        calcularIRAT5();
        calcularTinetti();
        calcularNorton();
        
        if (!validarIdentificacion()) return false;

        const paciente = {
            nombre: document.getElementById('nombre').value.trim(),
            rut: document.getElementById('rut').value.trim(),
            edad: document.getElementById('edad').value.trim(),
            fecha: document.getElementById('fecha').value,
            sexo: document.getElementById('sexo').value,
            evaluador: document.getElementById('evaluador').value.trim(),
            institucion: document.getElementById('institucion').value.trim(),
            historiaClinica: document.getElementById('historia-clinica').value.trim()
        };
        
        generarRecomendaciones();

        datosCompletos = {
            paciente,
            respuestas: {
                irat: respuestasIRAT,
                tinetti: respuestasTinetti,
                norton: respuestasNorton
            },
            resultados: {
                irat: { puntaje: puntajeTotalIRAT, nivel: nivelRiesgoIRAT },
                tinetti: { puntaje: puntajeTinetti, nivel: determinarRiesgoTinetti() },
                norton: { puntaje: puntajeNorton, nivel: nivelRiesgoNorton }
            },
            recomendaciones: recomendaciones
        };
        
        renderizarResultados();

        if (shouldNotify) {
             mostrarNotificacion('Resultados calculados y listos.', 'success');
        }
        return true;
    }

    function determinarRiesgoTinetti() {
        if (tinettiNoEvaluable) return "No Evaluable (N/A)";
        if (puntajeTinetti < 19) return "Riesgo ALTO de caída";
        if (puntajeTinetti >= 19 && puntajeTinetti <= 24) return "Riesgo MODERADO de caída";
        return "Riesgo BAJO de caída";
    }

    function generarRecomendaciones() {
        recomendaciones = [];

        // Recomendaciones IRAT-5
        if (puntajeTotalIRAT >= 5) {
            recomendaciones.push("IRAT-5 (Riesgo Alto): Implementar un plan de cuidados intensivo para prevenir complicaciones.");
        } else if (puntajeTotalIRAT >= 3) {
            recomendaciones.push("IRAT-5 (Riesgo Medio): Monitorización activa y planes de intervención específicos en las áreas de mayor puntaje.");
        }
        if (respuestasIRAT['irat-q1'] > 0) recomendaciones.push("Movilidad/Traslado: Planificar asistencia en la movilización y fomentar la independencia segura (factor amputación).");
        if (respuestasIRAT['irat-q5'] > 0) recomendaciones.push("Piel: Realizar revisión cutánea diaria. Considerar superficies especiales para alivio de presión.");

        // Recomendaciones Tinetti
        const riesgoTinetti = determinarRiesgoTinetti();
        if (riesgoTinetti === "Riesgo ALTO de caída") {
            recomendaciones.push("Tinetti (Riesgo Alto): Iniciar programa de rehabilitación de equilibrio y marcha. Uso estricto de ayudas técnicas.");
        } else if (riesgoTinetti === "Riesgo MODERADO de caída") {
            recomendaciones.push("Tinetti (Riesgo Moderado): Evaluación ambiental (retirar obstáculos, buena iluminación). Entrenamiento de la fuerza y equilibrio.");
        }

        // Recomendaciones Norton
        if (puntajeNorton <= 12) {
            recomendaciones.push("Norton (Riesgo Alto de Úlcera): Realizar cambios posturales cada 2-3 horas. Usar colchón y cojín antiescaras.");
        } else if (puntajeNorton <= 14) {
            recomendaciones.push("Norton (Riesgo Medio de Úlcera): Proteger zonas de riesgo. Mantener la piel limpia y seca. Vigilancia nutricional.");
        }
    }

    function renderizarResultados() {
        if (!datosCompletos) return;
        const data = datosCompletos;

        // Info Paciente
        document.getElementById('resumen-nombre').textContent = data.paciente.nombre;
        document.getElementById('resumen-rut').textContent = data.paciente.rut;
        document.getElementById('resumen-fecha').textContent = data.paciente.fecha;

        // IRAT-5
        const iratDiv = document.getElementById('resumen-irat');
        const iratRiskClass = data.resultados.irat.nivel.includes('Alto') ? 'high-risk' : data.resultados.irat.nivel.includes('Medio') ? 'medium-risk' : 'low-risk';
        iratDiv.className = `result-box ${iratRiskClass}`;
        iratDiv.innerHTML = `
            <strong>IRAT-5: Riesgo de Complicaciones</strong>
            <p>Puntaje Total: <strong>${data.resultados.irat.puntaje} / 10</strong></p>
            <p>Nivel de Riesgo: <strong>${data.resultados.irat.nivel}</strong></p>
        `;

        // Tinetti
        const tinettiDiv = document.getElementById('resumen-tinetti');
        const tinettiRisk = data.resultados.tinetti.nivel;
        const tinettiRiskClass = tinettiRisk.includes('ALTO') ? 'high-risk' : tinettiRisk.includes('MODERADO') ? 'medium-risk' : 'low-risk';
        tinettiDiv.className = `result-box ${tinettiRiskClass}`;
        tinettiDiv.innerHTML = `
            <strong>Tinetti: Riesgo de Caída</strong>
            <p>Puntaje Total: <strong>${data.resultados.tinetti.puntaje} / 28</strong></p>
            <p>Nivel de Riesgo: <strong>${tinettiRisk}</strong></p>
        `;
        
        // Norton
        const nortonDiv = document.getElementById('resumen-norton-final');
        const nortonRiskClass = data.resultados.norton.nivel.includes('ALTO') ? 'high-risk' : data.resultados.norton.nivel.includes('MEDIO') ? 'medium-risk' : 'low-risk';
        nortonDiv.className = `result-box ${nortonRiskClass}`;
        nortonDiv.innerHTML = `
            <strong>Norton: Riesgo de Úlcera por Presión</strong>
            <p>Puntaje Total: <strong>${data.resultados.norton.puntaje} / 20</strong></p>
            <p>Nivel de Riesgo: <strong>${data.resultados.norton.nivel}</strong></p>
        `;

        // Recomendaciones
        const recList = document.getElementById('recomendaciones-lista');
        recList.innerHTML = '';
        data.recomendaciones.forEach(rec => {
            const li = document.createElement('li');
            li.textContent = rec;
            recList.appendChild(li);
        });
        if (data.recomendaciones.length === 0) {
            recList.innerHTML = '<li>No se detectaron riesgos elevados que requieran acciones inmediatas específicas. Mantener vigilancia habitual.</li>';
        }
    }
    
    // --- PDF Generation (SIN CAMBIOS) ---
    function generarPDF() {
        if (!datosCompletos) {
            mostrarNotificacion('Primero debe calcular los resultados.', 'error');
            return;
        }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const data = datosCompletos;
        let y = 10;
        const margin = 15;
        const lineHeight = 7;

        // Título
        doc.setFontSize(16);
        doc.text(`Evaluación Clínica Integral - ${data.paciente.nombre}`, margin, y);
        y += lineHeight;
        doc.setFontSize(10);
        doc.text(`Fecha: ${data.paciente.fecha} | Evaluador: ${data.paciente.evaluador}`, margin, y);
        y += lineHeight * 2;

        // --- Sección de Identificación ---
        doc.setFontSize(12);
        doc.text("1. IDENTIFICACIÓN DEL PACIENTE", margin, y);
        y += lineHeight;
        doc.setFontSize(10);
        doc.text(`RUT: ${data.paciente.rut} | Edad: ${data.paciente.edad} | Sexo: ${data.paciente.sexo}`, margin, y);
        y += lineHeight * 2;

        // --- Sección de Resultados ---
        doc.setFontSize(12);
        doc.text("2. RESULTADOS DE LAS ESCALAS", margin, y);
        y += lineHeight;
        
        // IRAT-5
        doc.setFontSize(10);
        doc.text(`IRAT-5: Riesgo de Complicaciones`, margin, y);
        y += lineHeight;
        doc.text(`Puntaje: ${data.resultados.irat.puntaje}/10`, margin, y);
        doc.text(`Nivel: ${data.resultados.irat.nivel}`, 80, y);
        y += lineHeight;

        // Tinetti
        doc.text(`TINETTI: Riesgo de Caída`, margin, y);
        y += lineHeight;
        doc.text(`Puntaje: ${data.resultados.tinetti.puntaje}/28`, margin, y);
        doc.text(`Nivel: ${data.resultados.tinetti.nivel}`, 80, y);
        y += lineHeight;
        
        // Norton
        doc.text(`NORTON: Riesgo de Úlcera por Presión`, margin, y);
        y += lineHeight;
        doc.text(`Puntaje: ${data.resultados.norton.puntaje}/20`, margin, y);
        doc.text(`Nivel: ${data.resultados.norton.nivel}`, 80, y);
        y += lineHeight * 2;

        // --- Sección de Recomendaciones ---
        doc.setFontSize(12);
        doc.text("3. RECOMENDACIONES / PLAN DE ACCIÓN", margin, y);
        y += lineHeight;
        doc.setFontSize(10);
        
        data.recomendaciones.forEach((rec, index) => {
            if (y > 280) {
                doc.addPage();
                y = 15;
            }
            doc.text(`- ${rec}`, margin, y);
            y += lineHeight;
        });
        
        doc.save(`Evaluacion_${data.paciente.nombre.replace(/\s/g, '_')}_${data.paciente.fecha}.pdf`);
        mostrarNotificacion('PDF generado correctamente.', 'success');
    }

    // --- WhatsApp Share (SIN CAMBIOS) ---
    function compartirWhatsApp() {
        if (!datosCompletos) {
            mostrarNotificacion('Primero debe calcular los resultados.', 'error');
            return;
        }

        const data = datosCompletos;
        let mensaje = `*RESUMEN DE EVALUACIÓN CLÍNICA*\n\n`;
        mensaje += `Paciente: ${data.paciente.nombre}\n`;
        mensaje += `Fecha: ${data.paciente.fecha}\n`;
        mensaje += `Evaluador: ${data.paciente.evaluador}\n\n`;

        mensaje += `*1. IRAT-5 (Riesgo Complicaciones)*\n`;
        mensaje += `Puntaje: ${data.resultados.irat.puntaje}/10\n`;
        mensaje += `Nivel: ${data.resultados.irat.nivel}\n\n`;

        mensaje += `*2. TINETTI (Riesgo Caída)*\n`;
        mensaje += `Puntaje: ${data.resultados.tinetti.puntaje}/28\n`;
        mensaje += `Nivel: ${data.resultados.tinetti.nivel}\n\n`;

        mensaje += `*3. NORTON (Riesgo Úlcera)*\n`;
        mensaje += `Puntaje: ${data.resultados.norton.puntaje}/20\n`;
        mensaje += `Nivel: ${data.resultados.norton.nivel}\n\n`;

        mensaje += `*PLAN DE ACCIÓN*:\n`;
        data.recomendaciones.forEach((rec, index) => {
            mensaje += `${index + 1}. ${rec}\n`;
        });
        if (data.recomendaciones.length === 0) mensaje += "Vigilancia habitual.\n";
        
        const encodedMessage = encodeURIComponent(mensaje);
        window.open(`https://api.whatsapp.com/send?text=${encodedMessage}`, '_blank');
        mostrarNotificacion('Abriendo WhatsApp para compartir.', 'info');
    }

    function configurarValidaciones() {
        // Placeholder
    }
    
    function configurarHistorial() {
        // Placeholder
    }
</script>
