<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>ICAT – Índice Clínico de Ayuda Técnica</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
body{margin:0;font-family:Segoe UI,Arial;background:#eef2f7}
.header{background:linear-gradient(135deg,#1a237e,#3949ab);color:white;padding:30px;text-align:center}
.container{max-width:1400px;margin:30px auto;background:white;border-radius:16px;box-shadow:0 20px 40px rgba(0,0,0,.15)}
.section{padding:30px}
.card{background:#f9faff;border-radius:12px;padding:25px;margin-bottom:25px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px}
button{padding:12px 18px;border:none;border-radius:8px;cursor:pointer;font-weight:600}
.primary{background:#3949ab;color:white}
.secondary{background:#546e7a;color:white}
.danger{background:#c62828;color:white}
input,select{width:100%;padding:8px;margin-top:5px}
pre{background:#eceff1;padding:15px;border-radius:8px;white-space:pre-wrap}
.hidden{display:none}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login" class="container">
<div class="header">
<h1>ICAT</h1>
<p>Acceso profesional</p>
</div>
<div class="section">
<div class="card">
<input id="email" type="email" placeholder="Correo institucional">
<input id="password" type="password" placeholder="Contraseña">
<br><br>
<button class="primary" onclick="login()">Ingresar</button>
</div>
</div>
</div>

<!-- APP -->
<div id="app" class="container hidden">
<div class="header">
<h2>ICAT – Evaluación Clínica</h2>
<p id="usuario"></p>
<button class="danger" onclick="logout()">Cerrar sesión</button>
</div>

<div class="section">

<div class="card">
<h3>Datos del paciente (anonimizado)</h3>
<div class="grid">
<input id="codigo" placeholder="Código paciente">
<input id="edad" type="number" placeholder="Edad">
<input id="sexo" placeholder="Sexo">
<input id="fecha" type="date">
</div>
</div>

<div class="card">
<h3>IRAT</h3>
<div id="irat"></div>
</div>

<div class="card">
<h3>Tinetti</h3>
<div id="tinetti"></div>
</div>

<div class="card">
<h3>Norton</h3>
<div id="norton"></div>
</div>

<button class="primary" onclick="calcular()">Calcular ICAT</button>

<div id="resultados" class="card hidden">
<h3>Resultados</h3>
<pre id="resumen"></pre>
<button class="primary" onclick="generarPDF()">PDF</button>
<button class="secondary" onclick="guardar()">Guardar</button>
</div>

<div class="card">
<h3>Historial global</h3>
<ul id="historial"></ul>
</div>

</div>
</div>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey:"AIzaSyDJbtRuEwWVAsC1Nz6LbeF5a99LcUfAz4g",
  authDomain:"irat-5-evaluaciones.firebaseapp.com",
  projectId:"irat-5-evaluaciones"
});
const auth=firebase.auth();
const db=firebase.firestore();

/* ================= AUTH ================= */
function login(){
  const email=document.getElementById("email").value;
  const password=document.getElementById("password").value;

  auth.signInWithEmailAndPassword(email,password)
    .catch(e=>alert("Error de acceso"));
}

function logout(){
  auth.signOut();
}

auth.onAuthStateChanged(async user=>{
  if(user){
    const autorizado=await db.collection("usuarios_autorizados")
      .where("email","==",user.email).get();
    if(autorizado.empty){
      alert("Usuario no autorizado");
      logout();
      return;
    }
    document.getElementById("login").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    document.getElementById("usuario").textContent=user.email;
    cargarHistorial();
  }else{
    document.getElementById("login").classList.remove("hidden");
    document.getElementById("app").classList.add("hidden");
  }
});

/* ================= CUESTIONARIOS ================= */
function crear(id,n,max){
  let h="";
  for(let i=1;i<=n;i++){
    h+=`<label>Ítem ${i}</label>
    <select>${[...Array(max+1).keys()].map(v=>`<option value="${v}">${v}</option>`).join("")}</select><br><br>`;
  }
  document.getElementById(id).innerHTML=h;
}
crear("irat",5,4);
crear("tinetti",14,2);
crear("norton",5,4);

/* ================= CÁLCULO ================= */
let evaluacion=null;
const suma=id=>[...document.querySelectorAll(`#${id} select`)]
  .reduce((a,s)=>a+parseInt(s.value),0);

function calcular(){
  const irat=suma("irat");
  const tinetti=suma("tinetti");
  const norton=suma("norton");

  const ICAT=((irat/20)*40+((28-tinetti)/28)*35+((20-norton)/20)*25).toFixed(1);

  evaluacion={
    evaluador:{uid:auth.currentUser.uid,email:auth.currentUser.email},
    paciente:{codigo:codigo.value,edad:edad.value,sexo:sexo.value},
    puntajes:{irat,tinetti,norton,ICAT},
    timestamp:firebase.firestore.FieldValue.serverTimestamp()
  };

  resultados.classList.remove("hidden");
  resumen.textContent=`ICAT: ${ICAT}`;
}

/* ================= FIRESTORE ================= */
async function guardar(){
  await db.collection("ICAT_evaluaciones").add(evaluacion);
  alert("Evaluación guardada");
  cargarHistorial();
}

async function cargarHistorial(){
  historial.innerHTML="";
  const snap=await db.collection("ICAT_evaluaciones")
    .orderBy("timestamp","desc").limit(20).get();
  snap.forEach(d=>{
    const e=d.data();
    const li=document.createElement("li");
    li.textContent=`${e.paciente.codigo} – ICAT ${e.puntajes.ICAT}`;
    historial.appendChild(li);
  });
}

/* ================= PDF ================= */
function generarPDF(){
  const {jsPDF}=window.jspdf;
  const d=new jsPDF();
  d.text(JSON.stringify(evaluacion,null,2),10,10);
  d.save("ICAT.pdf");
}
</script>

</body>
</html>
