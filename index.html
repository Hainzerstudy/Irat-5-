<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluación Clínica IRAT-5 Modificado + Tinetti + Norton</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* ----------------------------------------------------------- */
        /* ESTILOS CSS                        */
        /* ----------------------------------------------------------- */
        :root {
            --primary-color: #1e3c72;
            --secondary-color: #2a5298;
            --accent-color: #4CAF50;
            --warning-color: #FF9800;
            --danger-color: #F44336;
            --light-color: #f8f9fa;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7ff;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 0.9rem;
        }
        
        .section {
            padding: 25px;
            display: none;
        }
        
        .section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section-title {
            color: var(--primary-color);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--primary-color);
            font-size: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .form-control {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        select.form-control {
            background-color: white;
            cursor: pointer;
        }
        
        .question-group {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid var(--primary-color);
        }
        
        .question-text {
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--secondary-color);
        }
        
        .score-display {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            margin: 25px 0;
        }
        
        .score-value {
            font-size: 3.5rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .risk-level {
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
            color: white;
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .risk-low { background: linear-gradient(135deg, #4CAF50, #2E7D32); }
        .risk-moderate { background: linear-gradient(135deg, #FF9800, #EF6C00); }
        .risk-high { background: linear-gradient(135deg, #F44336, #C62828); }
        .risk-very-high { background: linear-gradient(135deg, #9C27B0, #6A1B9A); }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 10px 5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #FF9800, #EF6C00);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #F44336, #C62828);
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
        }
        
        .action-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .nav-tabs {
            display: flex;
            background: #f0f2f5;
            border-bottom: 2px solid #e0e0e0;
            overflow-x: auto;
        }
        
        .nav-tab {
            padding: 15px 20px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 500;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .nav-tab:hover {
            background: rgba(255,255,255,0.5);
        }
        
        .nav-tab.active {
            border-bottom-color: var(--primary-color);
            background: white;
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .recommendations-grid {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }
        
        .recommendation-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid var(--accent-color);
        }
        
        /* Sección Compartir */
        .share-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .share-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .share-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-color);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .share-icon {
            font-size: 2.8rem;
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        .share-card h3 {
            margin: 10px 0;
            color: var(--primary-color);
        }
        
        .share-card p {
            color: #666;
            font-size: 0.9rem;
        }
        
        /* Notificaciones */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            display: none;
            animation: slideIn 0.3s ease;
            max-width: 350px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .notification.success {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
        }
        
        .notification.error {
            background: linear-gradient(135deg, #F44336, #C62828);
        }
        
        .notification.info {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }
        
        .notification.warning {
            background: linear-gradient(135deg, #FF9800, #EF6C00);
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Grid para formularios */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        /* Sección Tinetti completa */
        .tinetti-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .tinetti-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .tinetti-section h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.1rem;
            background: rgba(30, 60, 114, 0.1);
            padding: 10px;
            border-radius: 5px;
        }
        
        .tinetti-option {
            margin-bottom: 10px;
            padding: 12px 15px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tinetti-option:hover {
            border-color: var(--primary-color);
            background: #f0f7ff;
        }
        
        .tinetti-option.selected {
            border-color: var(--accent-color);
            background: #e8f5e9;
            font-weight: 600;
        }
        
        .tinetti-score-box {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        /* Estilos para resultados */
        .resultados-detallados {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .resultado-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .resultado-item:last-child {
            border-bottom: none;
        }
        
        .resultado-label {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .resultado-valor {
            font-weight: 500;
        }
        
        /* Informe profesional */
        .informe-profesional {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin: 20px 0;
            border: 2px solid #e0e0e0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .cabecera-informe {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--primary-color);
        }
        
        .logo-informe {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .titulo-informe {
            color: var(--primary-color);
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        
        .subtitulo-informe {
            color: #666;
            font-size: 1rem;
        }
        
        .seccion-informe {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .seccion-informe h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .tabla-informe {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        .tabla-informe th {
            background: var(--primary-color);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        
        .tabla-informe td {
            padding: 10px 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .tabla-informe tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .firma-informe {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }
        
        /* Firebase específico */
        .firebase-status {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1001;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            background-color: #4CAF50; /* Conectado por defecto sin auth */
            color: white;
        }
        
        .firebase-connected {
            background-color: #4CAF50;
        }
        
        .firebase-disconnected {
            background-color: #F44336;
        }
        
        .historial-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid var(--primary-color);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .historial-item:hover {
            background: #e8f4fd;
            transform: translateX(5px);
        }
        
        .historial-item h4 {
            color: var(--primary-color);
            margin-bottom: 8px;
        }
        
        .historial-item p {
            margin: 5px 0;
            font-size: 0.9rem;
            color: #666;
        }
        
        .firebase-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .firebase-actions button {
            padding: 5px 10px;
            font-size: 0.8rem;
            flex: 1;
            min-width: 80px;
        }
        
        .historial-container {
            max-height: 500px;
            overflow-y: auto;
            margin: 20px 0;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .section {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .score-value {
                font-size: 2.8rem;
            }
            
            .btn {
                width: 100%;
                margin: 5px 0;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .share-options {
                grid-template-columns: 1fr;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .informe-profesional {
                padding: 20px;
            }
            
            .firebase-actions {
                flex-direction: column;
            }
            
            .firebase-actions button {
                width: 100%;
            }
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .info-box {
            background: #e8f4fd;
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .warning-box {
            background: #fff3e0;
            border-left: 4px solid var(--warning-color);
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .error-input {
            border-color: var(--danger-color) !important;
            background-color: #fff5f5;
        }
        
        .error-message {
            color: var(--danger-color);
            font-size: 0.875rem;
            margin-top: 5px;
            display: none;
        }
        
        .user-display {
            margin-top: 10px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .user-display span {
            background: rgba(255,255,255,0.2);
            padding: 3px 10px;
            border-radius: 20px;
        }
        
        /* Nuevos estilos para autenticación */
        #login-register {
            text-align: center;
            max-width: 400px;
            margin: 50px auto;
            padding: 30px;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            background: #fff;
        }

        #login-register h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .toggle-form {
            margin-top: 20px;
            font-size: 0.9rem;
        }

        .toggle-form a {
            color: var(--secondary-color);
            cursor: pointer;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div id="notification" class="notification success"></div>

    <div id="firebase-status" class="firebase-status firebase-disconnected">
        <i class="fas fa-database"></i> Desconectado...
    </div>

    <section id="auth-section" class="section active">
        <div id="login-register">
            <h2 id="auth-title">Iniciar Sesión</h2>
            
            <div class="form-group">
                <label class="form-label">Correo Electrónico</label>
                <input type="email" id="auth-email" class="form-control" placeholder="su.correo@clinica.com" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Contraseña</label>
                <input type="password" id="auth-password" class="form-control" placeholder="Contraseña" required>
            </div>

            <button class="btn btn-primary" id="auth-button">
                <i class="fas fa-sign-in-alt"></i> Iniciar Sesión
            </button>

            <div class="toggle-form">
                ¿No tienes cuenta? 
                <a id="toggle-auth-mode">Regístrate aquí</a>
            </div>
        </div>
    </section>

    <div class="container" id="main-app" style="display: none;">
        <div class="header">
            <h1><i class="fas fa-hospital-alt"></i> IRAT-5 + Tinetti + Norton</h1>
            <p>Evaluación Clínica Integral de Riesgo - Sistema Profesional</p>
            <div id="user-display" class="user-display">
                <i class="fas fa-user-md"></i> <span>Cargando usuario...</span>
            </div>
            <button class="btn btn-danger btn-secondary" id="logout-button" style="margin-top: 10px;">
                <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
            </button>
        </div>
        
        <div class="nav-tabs">
            <button class="nav-tab active" data-section="identificacion">Identificación</button>
            <button class="nav-tab" data-section="evaluacion">IRAT-5</button>
            <button class="nav-tab" data-section="tinetti">Tinetti</button>
            <button class="nav-tab" data-section="norton">Norton</button>
            <button class="nav-tab" data-section="resultados">Resultados</button>
            <button class="nav-tab" data-section="historial">Historial</button>
            <button class="nav-tab" data-section="compartir">Compartir</button>
        </div>
        
        <section id="identificacion" class="section active">
            <h2 class="section-title"><i class="fas fa-user"></i> Identificación del Paciente</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Nombre completo <span style="color:red">*</span></label>
                    <input type="text" id="nombre" class="form-control" placeholder="Nombre y apellidos del paciente" required>
                    <div id="error-nombre" class="error-message"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">RUT / Identificación</label>
                    <input type="text" id="rut" class="form-control" placeholder="Ej: 12.345.678-9">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Edad</label>
                    <input type="number" id="edad" class="form-control" placeholder="Edad en años">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Fecha evaluación <span style="color:red">*</span></label>
                    <input type="date" id="fecha" class="form-control" required>
                    <div id="error-fecha" class="error-message"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Sexo</label>
                    <select id="sexo" class="form-control">
                        <option value="">Seleccione...</option>
                        <option value="masculino">Masculino</option>
                        <option value="femenino">Femenino</option>
                        <option value="no especificado">No especificado</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Evaluador <span style="color:red">*</span></label>
                    <input type="text" id="evaluador" class="form-control" placeholder="Nombre del profesional" required>
                    <div id="error-evaluador" class="error-message"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Institución/Clínica</label>
                    <input type="text" id="institucion" class="form-control" placeholder="Nombre de la institución">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Número de Historia Clínica</label>
                    <input type="text" id="historia-clinica" class="form-control" placeholder="Número de identificación">
                </div>
            </div>
            
            <div class="action-buttons">
                <div></div>
                <button class="btn btn-primary" id="siguiente-irat">
                    <i class="fas fa-arrow-right"></i> Siguiente: IRAT-5
                </button>
            </div>
        </section>
        
        <section id="evaluacion" class="section">
            <h2 class="section-title"><i class="fas fa-clipboard-list"></i> Evaluación IRAT-5 Modificado</h2>
            
            <div class="question-group">
                <div class="question-text">1. Equilibrio Unipodal <span style="color:red">*</span></div>
                <select id="equilibrio" class="form-control" required>
                    <option value="">Seleccione...</option>
                    <option value="0">≥ 30 segundos (0 pts)</option>
                    <option value="1">15-29 segundos (1 pts)</option>
                    <option value="2">5-14 segundos (2 pts)</option>
                    <option value="3">< 5 segundos (3 pts)</option>
                    <option value="4">No puede mantenerse (4 pts)</option>
                </select>
                <div id="error-equilibrio" class="error-message"></div>
            </div>
            
            <div class="question-group">
                <div class="question-text">2. Tipo de Amputación <span style="color:red">*</span></div>
                <select id="amputacion" class="form-control" required>
                    <option value="">Seleccione...</option>
                    <option value="0">Sin amputaciones (0 pts)</option>
                    <option value="1">Amputación transmetatarsiana (1 pts)</option>
                    <option value="3">Unilateral infracondílea (3 pts + 1 riesgo caídas)</option>
                    <option value="4">Bilateral infracondílea (4 pts + 1 riesgo caídas)</option>
                    <option value="5">Supracondílea unilateral (5 pts + 1 riesgo caídas)</option>
                    <option value="6">Supracondílea bilateral (6 pts + 1 riesgo caídas)</option>
                </select>
                <div id="error-amputacion" class="error-message"></div>
            </div>
            
            <div class="warning-box">
                <strong><i class="fas fa-exclamation-triangle"></i> Consideraciones amputaciones:</strong><br>
                • Bilaterales: Requieren silla de ruedas (NO bastón/andador)<br>
                • Unilaterales: Iniciar con andador articulado/fijo (sin ruedas)
            </div>
            
            <div class="question-group">
                <div class="question-text">3. Función de Brazos <span style="color:red">*</span></div>
                <select id="brazos" class="form-control" required>
                    <option value="">Seleccione...</option>
                    <option value="0">Ambos brazos normales o fuerza ≥3 (0 pts)</option>
                    <option value="1">Problemas en un brazo/fuerza <3 (1 pts)</option>
                    <option value="2">Problemas en ambos brazos (2 pts)</option>
                </select>
                <div id="error-brazos" class="error-message"></div>
            </div>
            
            <div class="question-group">
                <div class="question-text">4. Situación Social <span style="color:red">*</span></div>
                <select id="social" class="form-control" required>
                    <option value="">Seleccione...</option>
                    <option value="0">Cuidador profesional (0 pts)</option>
                    <option value="1">Cuidador informal (1 pts)</option>
                    <option value="2">Vive solo o sin cuidador (2 pts)</option>
                    <option value="3">Es cuidador de persona frágil (3 pts)</option>
                </select>
                <div id="error-social" class="error-message"></div>
            </div>
            
            <div class="question-group">
                <div class="question-text">5. Nivel de Cooperación <span style="color:red">*</span></div>
                <select id="cooperacion" class="form-control" required>
                    <option value="">Seleccione...</option>
                    <option value="0">Excelente - Sigue todas las instrucciones (0 pts)</option>
                    <option value="1">Buena - Sigue mayoría de instrucciones (1 pts)</option>
                    <option value="2">Moderada - Requiere motivación constante (2 pts)</option>
                    <option value="3">Mala - Se resiste o rechaza instrucciones (3 pts)</option>
                </select>
                <div id="error-cooperacion" class="error-message"></div>
            </div>
            
            <div class="score-display">
                <div>Puntaje IRAT-5 (preliminar)</div>
                <div class="score-value" id="puntaje-irat">0</div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-warning" id="volver-identificacion">
                    <i class="fas fa-arrow-left"></i> Anterior
                </button>
                <button class="btn btn-primary" id="siguiente-tinetti">
                    Siguiente: Tinetti <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </section>
        
        <section id="tinetti" class="section">
            <h2 class="section-title"><i class="fas fa-walking"></i> Test de Tinetti Completo</h2>
            
            <div class="info-box">
                <strong>Conversión a puntos IRAT-5:</strong><br>
                • Tinetti ≥ 25 puntos = 0 puntos IRAT-5<br>
                • Tinetti 19-24 puntos = 2 puntos IRAT-5<br>
                • Tinetti ≤ 18 puntos = 4 puntos IRAT-5<br>
                • No evaluable = 4 puntos IRAT-5 (máximo riesgo)
            </div>
            
            <div class="tinetti-container">
                <div class="question-group">
                    <div class="question-text">¿Es evaluable el Test de Tinetti? <span style="color:red">*</span></div>
                    <div id="opcion-no-evaluable" class="tinetti-option" data-puntaje="0" data-irat="4">
                        <strong>NO EVALUABLE</strong><br>
                        <small>Paciente no puede realizar la prueba (máximo riesgo - 4 puntos IRAT-5)</small>
                    </div>
                    <div id="error-tinetti-evaluable" class="error-message"></div>
                </div>
                
                <div id="test-tinetti-completo">
                    <div class="tinetti-section">
                        <h4>EQUILIBRIO (Máximo 16 puntos)</h4>
                        
                        <div class="question-group">
                            <div class="question-text">1. Sentado sin apoyo</div>
                            <div class="tinetti-option" data-puntaje="1" data-grupo="balance1">
                                <strong>1 punto - Estable, seguro</strong>
                            </div>
                            <div class="tinetti-option" data-puntaje="0" data-grupo="balance1">
                                <strong>0 puntos - Se cae o se desliza</strong>
                            </div>
                        </div>
                        
                        <div class="question-group">
                            <div class="question-text">2. Levantarse</div>
                            <div class="tinetti-option" data-puntaje="2" data-grupo="balance2">
                                <strong>2 puntos - Capaz sin usar brazos</strong>
                            </div>
                            <div class="tinetti-option" data-puntaje="1" data-grupo="balance2">
                                <strong>1 punto - Capaz, usa brazos para ayudarse</strong>
                            </div>
                            <div class="tinetti-option" data-puntaje="0" data-grupo="balance2">
                                <strong>0 puntos - Incapaz sin ayuda</strong>
                            </div>
                        </div>
                        
                        <div class="question-group">
                            <div class="question-text">3. Intentos de levantarse</div>
                            <div class="tinetti-option" data-puntaje="2" data-grupo="balance3">
                                <strong>2 puntos - Capaz, se levanta con un intento</strong>
                            </div>
                            <div class="tinetti-option" data-puntaje="1" data-grupo="balance3">
                                <strong>1 punto - Capaz, requiere más de un intento</strong>
                            </div>
                            <div class="tinetti-option" data-puntaje="0" data-grupo="balance3">
                                <strong>0 puntos - Incapaz sin ayuda</strong>
                            </div>
                        </div>
                        
                        <div class="question-group">
                            <div class="question-text">4. Equilibrio inmediato al levantarse (primeros 5 segundos)</div>
                            <div class="tinetti-option" data-puntaje="2" data-grupo="balance4">
                                <strong>2 puntos - Estable sin apoyo</strong>
                            </div>
                            <div class="tinetti-option" data-puntaje="1" data-grupo="balance4">
                                <strong>1 punto - Estable pero usa bastón o andador</strong>
                            </div>
                            <div class="tinetti-option" data-puntaje="0" data-grupo="balance4">
                                <strong>0 puntos - Inestable (se tambalea, mueve pies)</strong>
                            </div>
                        </div>
                        
                        <div class="question-group">
                            <div class="question-text">5. Equilibrio de pie</div>
                            <div class="tinetti-option" data-puntaje="2" data-grupo="balance5">
                                <strong>2 puntos - Estable sin apoyo estrecho</strong>
                            </div>
                            <div class="tinetti-option" data-puntaje="1" data-grupo="balance5">
                                <strong>1 punto - Estable con apoyo amplio o usa bastón/andador</strong>
                            </div>
                            <div class="tinetti-option" data-puntaje="0" data-grupo="balance5">
                                <strong>0 puntos - Inestable</strong>
                            </div>
                        </div>
                        
                        <div class="question-group">
                            <div class="question-text">6. Equilibrio con ojos cerrados</div>
                            <div class="tinetti-option" data-puntaje="1" data-grupo="balance6">
                                <strong>1 punto - Estable</strong>
                            </div>
                            <div class="tinetti-option" data-puntaje="0" data-grupo="balance6">
                                <strong>0 puntos - Inestable</strong>
                            </div>
                        </div>
                        
                        <div class="question-group">
                            <div class="question-text">7. Girar 360 grados</div>
                            <div class="tinetti-option" data-puntaje="2" data-grupo="balance7">
                                <strong>2 puntos - Continuo y estable</strong>
                            </div>
                            <div class="tinetti-option" data-puntaje="1" data-grupo="balance7">
                                <strong>1 punto - Pasos continuos</strong>
                            </div>
                            <div class="tinetti-option" data-puntaje="0" data-grupo="balance7">
                                <strong>0 puntos - Pasos discontinuos</strong>
                            </div>
                        </div>
                        
                        <div class="question-group">
                            <div class="question-text">8. Sentarse</div>
                            <div class="tinetti-option" data-puntaje="2" data-grupo="balance8">
                                <strong>2 puntos - Seguro, movimientos suaves</strong>
                            </div>
                            <div class="tinetti-option" data-puntaje="1" data-grupo="balance8">
                                <strong>1 punto - Usa brazos o no es suave</strong>
                            </div>
                            <div class="tinetti-option" data-puntaje="0" data-grupo="balance8">
                                <strong>0 puntos - Inseguro (mal alineamiento, distancia)</strong>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tinetti-section">
                        <h4>MARCHA (Máximo 12 puntos)</h4>
                        
                        <div class="question-group">
                            <div class="question-text">9. Inicio de la marcha (inmediatamente después de ordenar "camine")</div>
                            <div class="tinetti-option" data-puntaje="1" data-grupo="gait9">
                                <strong>1 punto - Sin vacilación</strong>
                            </div>
                            <div class="tinetti-option" data-puntaje="0" data-grupo="gait9">
                                <strong>0 puntos - Cualquier vacilación o múltiples intentos</strong>
                            </div>
                        </div>
                        
                        <div class="question-group">
                            <div class="question-text">10. Longitud y altura del paso (pie derecho)</div>
                            <div class="tinetti-option" data-puntaje="1" data-grupo="gait10">
                                <strong>1 punto - Pasa al derecho</strong>
                            </div>
                            <div class="tinetti-option" data-puntaje="0" data-grupo="gait10">
                                <strong>0 puntos - Pie izquierdo no pasa al derecho</strong>
                            </div>
                        </div>
                        
                        <div class="question-group">
                            <div class="question-text">11. Longitud y altura del paso (pie izquierdo)</div>
                            <div class="tinetti-option" data-puntaje="1" data-grupo="gait11">
                                <strong>1 punto - Pasa al izquierdo</strong>
                            </div>
                            <div class="tinetti-option" data-puntaje="0" data-grupo="gait11">
                                <strong>0 puntos - Pie derecho no pasa al izquierdo</strong>
                            </div>
                        </div>
                        
                        <div class="question-group">
                            <div class="question-text">12. Simetría del paso</div>
                            <div class="tinetti-option" data-puntaje="1" data-grupo="gait12">
                                <strong>1 punto - Simétrico</strong>
                            </div>
                            <div class="tinetti-option" data-puntaje="0" data-grupo="gait12">
                                <strong>0 puntos - Asimétrico</strong>
                            </div>
                        </div>
                        
                        <div class="question-group">
                            <div class="question-text">13. Continuidad del paso</div>
                            <div class="tinetti-option" data-puntaje="1" data-grupo="gait13">
                                <strong>1 punto - Continuo</strong>
                            </div>
                            <div class="tinetti-option" data-puntaje="0" data-grupo="gait13">
                                <strong>0 puntos - Interrumpido o discontinuo</strong>
                            </div>
                        </div>
                        
                        <div class="question-group">
                            <div class="question-text">14. Desviación de la marcha</div>
                            <div class="tinetti-option" data-puntaje="2" data-grupo="gait14">
                                <strong>2 puntos - Sin desviación</strong>
                            </div>
                            <div class="tinetti-option" data-puntaje="1" data-grupo="gait14">
                                <strong>1 punto - Se desvía levemente/usa dispositivo</strong>
                            </div>
                            <div class="tinetti-option" data-puntaje="0" data-grupo="gait14">
                                <strong>0 puntos - Se desvía marcadamente</strong>
                            </div>
                        </div>
                        
                        <div class="question-group">
                            <div class="question-text">15. Tronco</div>
                            <div class="tinetti-option" data-puntaje="2" data-grupo="gait15">
                                <strong>2 puntos - Sin oscilación, sin flexión</strong>
                            </div>
                            <div class="tinetti-option" data-puntaje="1" data-grupo="gait15">
                                <strong>1 punto - Usa brazos o balancea tronco</strong>
                            </div>
                            <div class="tinetti-option" data-puntaje="0" data-grupo="gait15">
                                <strong>0 puntos - Marcada oscilación/flexión lateral</strong>
                            </div>
                        </div>
                        
                        <div class="question-group">
                            <div class="question-text">16. Separación de los pies al caminar</div>
                            <div class="tinetti-option" data-puntaje="1" data-grupo="gait16">
                                <strong>1 punto - Pies casi juntos (pero sin tocarse)</strong>
                            </div>
                            <div class="tinetti-option" data-puntaje="0" data-grupo="gait16">
                                <strong>0 puntos - Talones separados o marcha amplia</strong>
                            </div>
                        </div>
                    </div>
                </div> <div class="tinetti-score-box">
                    <div>Puntaje Tinetti Total</div>
                    <div class="score-value" id="puntaje-tinetti-total">0 / 28</div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-warning" id="volver-irat">
                    <i class="fas fa-arrow-left"></i> Anterior
                </button>
                <button class="btn btn-primary" id="siguiente-norton">
                    Siguiente: Norton <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </section>

        <section id="norton" class="section">
            <h2 class="section-title"><i class="fas fa-bed"></i> Escala de Norton</h2>
            
            <div class="info-box">
                <strong>Riesgo de Úlceras por Presión:</strong><br>
                • Menor o igual a 14 puntos = Riesgo de Úlcera
            </div>

            <div class="question-group">
                <div class="question-text">1. Condición Física</div>
                <select id="norton-fisica" class="form-control" data-norton-max="4">
                    <option value="4">Buena (4 pts)</option>
                    <option value="3">Mediana (3 pts)</option>
                    <option value="2">Mala (2 pts)</option>
                    <option value="1">Muy mala (1 pts)</option>
                </select>
            </div>
            
            <div class="question-group">
                <div class="question-text">2. Estado Mental</div>
                <select id="norton-mental" class="form-control" data-norton-max="4">
                    <option value="4">Alerta (4 pts)</option>
                    <option value="3">Apático (3 pts)</option>
                    <option value="2">Confuso (2 pts)</option>
                    <option value="1">Estuporoso (1 pts)</option>
                </select>
            </div>

            <div class="question-group">
                <div class="question-text">3. Actividad</div>
                <select id="norton-actividad" class="form-control" data-norton-max="4">
                    <option value="4">Deambula (4 pts)</option>
                    <option value="3">Camina con ayuda (3 pts)</option>
                    <option value="2">Sentado (2 pts)</option>
                    <option value="1">Encamado (1 pts)</option>
                </select>
            </div>

            <div class="question-group">
                <div class="question-text">4. Movilidad</div>
                <select id="norton-movilidad" class="form-control" data-norton-max="4">
                    <option value="4">Total (4 pts)</option>
                    <option value="3">Algo limitada (3 pts)</option>
                    <option value="2">Muy limitada (2 pts)</option>
                    <option value="1">Inmóvil (1 pts)</option>
                </select>
            </div>

            <div class="question-group">
                <div class="question-text">5. Incontinencia</div>
                <select id="norton-incontinencia" class="form-control" data-norton-max="4">
                    <option value="4">Ninguna (4 pts)</option>
                    <option value="3">Ocasional (3 pts)</option>
                    <option value="2">Urinaria (2 pts)</option>
                    <option value="1">Doble (urinaria y fecal) (1 pts)</option>
                </select>
            </div>

            <div class="score-display">
                <div>Puntaje Norton Total</div>
                <div class="score-value" id="puntaje-norton">20 / 20</div>
                <div id="riesgo-norton" class="risk-level risk-low">Sin Riesgo</div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-warning" id="volver-tinetti">
                    <i class="fas fa-arrow-left"></i> Anterior
                </button>
                <button class="btn btn-success" id="finalizar-evaluacion">
                    Finalizar y Ver Resultados <i class="fas fa-check-circle"></i>
                </button>
            </div>
        </section>
        
        <section id="resultados" class="section">
            <h2 class="section-title"><i class="fas fa-chart-bar"></i> Resultados y Recomendaciones</h2>
            
            <div class="resultados-detallados">
                <div class="resultado-item">
                    <span class="resultado-label">Paciente</span>
                    <span class="resultado-valor" id="res-nombre">N/A</span>
                </div>
                <div class="resultado-item">
                    <span class="resultado-label">Evaluador</span>
                    <span class="resultado-valor" id="res-evaluador">N/A</span>
                </div>
                <div class="resultado-item">
                    <span class="resultado-label">Fecha</span>
                    <span class="resultado-valor" id="res-fecha">N/A</span>
                </div>
            </div>

            <h3>Resumen de Riesgos</h3>
            <div class="resultados-detallados">
                <div class="resultado-item">
                    <span class="resultado-label">Puntaje IRAT-5 Total</span>
                    <span class="resultado-valor" id="res-irat-total">0</span>
                </div>
                <div class="resultado-item">
                    <span class="resultado-label">Nivel de Riesgo IRAT-5</span>
                    <span class="resultado-valor" id="res-irat-riesgo">N/A</span>
                </div>
                <div class="resultado-item">
                    <span class="resultado-label">Puntaje Tinetti Total</span>
                    <span class="resultado-valor" id="res-tinetti-total">0 / 28</span>
                </div>
                <div class="resultado-item">
                    <span class="resultado-label">Puntaje Norton Total</span>
                    <span class="resultado-valor" id="res-norton-total">20 / 20</span>
                </div>
                <div class="resultado-item">
                    <span class="resultado-label">Riesgo Norton (Úlceras)</span>
                    <span class="resultado-valor" id="res-norton-riesgo">N/A</span>
                </div>
            </div>

            <h3><i class="fas fa-tasks"></i> Plan de Recomendaciones</h3>
            <div class="recommendations-grid" id="recomendaciones-irat">
                </div>
            
            <div class="action-buttons">
                <button class="btn btn-warning" id="volver-norton">
                    <i class="fas fa-arrow-left"></i> Anterior
                </button>
                <button class="btn btn-success" id="guardar-evaluacion">
                    <i class="fas fa-save"></i> Guardar Evaluación (Firestore)
                </button>
                <button class="btn btn-secondary" id="generar-pdf">
                    <i class="fas fa-file-pdf"></i> Generar Informe PDF
                </button>
            </div>
        </section>

        <section id="historial" class="section">
            <h2 class="section-title"><i class="fas fa-history"></i> Historial de Evaluaciones</h2>
            
            <div class="firebase-actions">
                <button class="btn btn-primary" id="cargar-historial-btn">
                    <i class="fas fa-sync-alt"></i> Recargar Historial
                </button>
                <button class="btn btn-danger" id="limpiar-historial-btn" title="Solo visible si el usuario es administrador">
                    <i class="fas fa-trash-alt"></i> Limpiar Historial (Admin)
                </button>
            </div>
            
            <div class="historial-container" id="historial-list">
                <p>Cargando evaluaciones...</p>
                </div>

            <div class="pagination" id="pagination-controls">
                </div>

            <div class="action-buttons">
                <button class="btn btn-warning" id="volver-historial">
                    <i class="fas fa-arrow-left"></i> Volver a Resultados
                </button>
            </div>
        </section>

        <section id="compartir" class="section">
            <h2 class="section-title"><i class="fas fa-share-alt"></i> Compartir y Exportar</h2>
            
            <p class="info-box">Seleccione una opción para compartir o exportar el último informe generado.</p>
            
            <div class="share-options">
                <div class="share-card" id="share-pdf">
                    <i class="fas fa-file-pdf share-icon"></i>
                    <h3>Exportar PDF</h3>
                    <p>Guarde el informe completo en su dispositivo.</p>
                </div>
                <div class="share-card" id="share-email">
                    <i class="fas fa-envelope share-icon"></i>
                    <h3>Enviar por Correo</h3>
                    <p>Envíe el informe a un colega o al paciente (si la app tuviera backend).</p>
                </div>
                <div class="share-card" id="share-whatsapp">
                    <i class="fab fa-whatsapp share-icon"></i>
                    <h3>Compartir por WhatsApp</h3>
                    <p>Genere un mensaje con el resumen de resultados.</p>
                </div>
                <div class="share-card" id="share-data">
                    <i class="fas fa-code share-icon"></i>
                    <h3>Exportar Datos JSON</h3>
                    <p>Exportar datos brutos de la evaluación para análisis.</p>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-warning" data-section-target="resultados">
                    <i class="fas fa-arrow-left"></i> Volver a Resultados
                </button>
            </div>
        </section>

    </div> <script>
        // -----------------------------------------------------------
        // 1. CONFIGURACIÓN E INICIALIZACIÓN DE FIREBASE
        // -----------------------------------------------------------
        const firebaseConfig = {
            apiKey: "TU_API_KEY", // ⚠️ REEMPLAZA ESTO
            authDomain: "TU_AUTH_DOMAIN", // ⚠️ REEMPLAZA ESTO
            projectId: "TU_PROJECT_ID", // ⚠️ REEMPLAZA ESTO
            storageBucket: "TU_STORAGE_BUCKET", // ⚠️ REEMPLAZA ESTO
            messagingSenderId: "TU_MESSAGING_SENDER_ID", // ⚠️ REEMPLAZA ESTO
            appId: "TU_APP_ID" // ⚠️ REEMPLAZA ESTO
        };

        let app, db, auth;
        let authMode = 'login'; // 'login' o 'register'
        let currentUser = null;
        let currentUserId = null;
        let isFetchingHistory = false;
        let lastVisible = null;
        const PAGE_SIZE = 10;
        let lastReportData = null; // Para guardar el último informe generado

        try {
            app = firebase.initializeApp(firebaseConfig);
            db = app.firestore();
            auth = app.auth(); // Inicializar el servicio de autenticación
            document.getElementById('firebase-status').textContent = 'Conectado a Firebase';
            document.getElementById('firebase-status').classList.remove('firebase-disconnected');
            document.getElementById('firebase-status').classList.add('firebase-connected');
        } catch (error) {
            console.error("Error al inicializar Firebase:", error);
            showNotification('Error: No se pudo conectar a Firebase. Revisa la consola y las credenciales.', 'error');
            document.getElementById('firebase-status').textContent = 'Error de conexión';
            document.getElementById('firebase-status').classList.remove('firebase-connected');
            document.getElementById('firebase-status').classList.add('firebase-disconnected');
        }

        // -----------------------------------------------------------
        // 2. UTILIDADES Y MANEJO DE VISTAS
        // -----------------------------------------------------------

        function showNotification(message, type = 'info', duration = 3000) {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.className = `notification ${type}`;
            notif.style.display = 'block';
            setTimeout(() => {
                notif.style.display = 'none';
            }, duration);
        }

        function switchSection(targetId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            const targetSection = document.getElementById(targetId);
            if (targetSection) {
                targetSection.classList.add('active');
                const targetTab = document.querySelector(`.nav-tab[data-section="${targetId}"]`);
                if (targetTab) {
                    targetTab.classList.add('active');
                }
            }

            // Acciones específicas al cambiar de sección
            if (targetId === 'resultados') {
                generarResultados();
            } else if (targetId === 'historial') {
                loadHistorial();
            }
        }

        // -----------------------------------------------------------
        // 3. LÓGICA DE AUTENTICACIÓN (LOGIN / REGISTRO)
        // -----------------------------------------------------------

        const authTitle = document.getElementById('auth-title');
        const authButton = document.getElementById('auth-button');
        const authEmail = document.getElementById('auth-email');
        const authPassword = document.getElementById('auth-password');
        const toggleAuthMode = document.getElementById('toggle-auth-mode');
        const authSection = document.getElementById('auth-section');
        const mainApp = document.getElementById('main-app');

        toggleAuthMode.addEventListener('click', () => {
            if (authMode === 'login') {
                authMode = 'register';
                authTitle.textContent = 'Crear Cuenta';
                authButton.innerHTML = '<i class="fas fa-user-plus"></i> Registrarse';
                toggleAuthMode.textContent = 'Volver a Iniciar Sesión';
            } else {
                authMode = 'login';
                authTitle.textContent = 'Iniciar Sesión';
                authButton.innerHTML = '<i class="fas fa-sign-in-alt"></i> Iniciar Sesión';
                toggleAuthMode.textContent = 'Regístrate aquí';
            }
        });

        authButton.addEventListener('click', async () => {
            const email = authEmail.value;
            const password = authPassword.value;

            if (!email || !password) {
                showNotification('Introduce un correo y una contraseña.', 'warning');
                return;
            }

            try {
                if (authMode === 'login') {
                    await auth.signInWithEmailAndPassword(email, password);
                    showNotification('Inicio de sesión exitoso.', 'success');
                } else {
                    await auth.createUserWithEmailAndPassword(email, password);
                    showNotification('Registro exitoso. ¡Bienvenido!', 'success');
                }
            } catch (error) {
                console.error("Error de autenticación:", error);
                let message = 'Error de autenticación. ';
                if (error.code === 'auth/user-not-found') {
                    message += 'Usuario no encontrado.';
                } else if (error.code === 'auth/wrong-password') {
                    message += 'Contraseña incorrecta.';
                } else if (error.code === 'auth/email-already-in-use') {
                    message += 'El correo ya está registrado.';
                } else {
                    message += error.message;
                }
                showNotification(message, 'error', 5000);
            }
        });

        document.getElementById('logout-button').addEventListener('click', async () => {
            try {
                await auth.signOut();
                showNotification('Sesión cerrada correctamente.', 'info');
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
                showNotification('Error al cerrar sesión: ' + error.message, 'error');
            }
        });

        // Observador de estado de autenticación (CRÍTICO)
        auth.onAuthStateChanged(user => {
            const userDisplay = document.getElementById('user-display').querySelector('span');
            
            if (user) {
                // Usuario autenticado
                currentUser = user;
                currentUserId = user.uid;
                authSection.style.display = 'none';
                mainApp.style.display = 'block';
                userDisplay.textContent = user.email;
                showNotification('Bienvenido, ' + user.email, 'success');
                loadHistorial(true); // Cargar historial al iniciar sesión
            } else {
                // Usuario desautenticado
                currentUser = null;
                currentUserId = null;
                authSection.style.display = 'block';
                mainApp.style.display = 'none';
                userDisplay.textContent = 'Modo Desconectado';
                // Resetear a login si no estaba ya en el login
                authMode = 'login'; 
                authTitle.textContent = 'Iniciar Sesión';
                authButton.innerHTML = '<i class="fas fa-sign-in-alt"></i> Iniciar Sesión';
                toggleAuthMode.textContent = 'Regístrate aquí';
            }
        });

        // -----------------------------------------------------------
        // 4. LÓGICA DE LA EVALUACIÓN (IRAT, TINETTI, NORTON)
        // -----------------------------------------------------------

        // Manejadores de Eventos para Navegación
        document.getElementById('siguiente-irat').addEventListener('click', () => {
            if (validateForm('identificacion')) {
                switchSection('evaluacion');
            }
        });
        document.getElementById('volver-identificacion').addEventListener('click', () => switchSection('identificacion'));
        
        document.getElementById('siguiente-tinetti').addEventListener('click', () => {
            if (validateForm('evaluacion')) {
                switchSection('tinetti');
            }
        });
        document.getElementById('volver-irat').addEventListener('click', () => switchSection('evaluacion'));
        
        document.getElementById('siguiente-norton').addEventListener('click', () => {
            if (validateForm('tinetti')) {
                switchSection('norton');
            }
        });
        document.getElementById('volver-tinetti').addEventListener('click', () => switchSection('tinetti'));

        document.getElementById('finalizar-evaluacion').addEventListener('click', () => {
             // Norton tiene validación automática, solo calcular y cambiar
             calcularNorton();
             switchSection('resultados');
        });

        document.getElementById('volver-norton').addEventListener('click', () => switchSection('norton'));

        // Eventos de Navegación por Pestañas
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                const targetId = e.target.dataset.section;
                // No permitir navegar si no hay usuario o si se intenta ir a secciones funcionales sin login
                if (!currentUser && (targetId === 'historial' || targetId === 'resultados' || targetId === 'compartir')) {
                    showNotification('Debes iniciar sesión para acceder a esta sección.', 'warning');
                    return;
                }
                switchSection(targetId);
            });
        });

        // Lógica de Selección de Tinetti
        document.querySelectorAll('.tinetti-option').forEach(option => {
            option.addEventListener('click', (e) => {
                const target = e.currentTarget;
                const group = target.dataset.grupo;
                const isNoEvaluable = target.id === 'opcion-no-evaluable';
                
                if (isNoEvaluable) {
                    // Si se selecciona "No Evaluable", deseleccionar todos los demás
                    document.querySelectorAll('#test-tinetti-completo .tinetti-option').forEach(opt => opt.classList.remove('selected'));
                    target.classList.toggle('selected');
                    document.getElementById('test-tinetti-completo').style.display = target.classList.contains('selected') ? 'none' : 'block';
                } else {
                    // Si se selecciona una opción de Tinetti, deseleccionar "No Evaluable" y el resto del grupo
                    document.getElementById('opcion-no-evaluable').classList.remove('selected');
                    document.getElementById('test-tinetti-completo').style.display = 'block';

                    document.querySelectorAll(`.tinetti-option[data-grupo="${group}"]`).forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    target.classList.add('selected');
                }
                calcularIRAT();
                calcularTinetti();
            });
        });

        // Lógica de Cálculo IRAT
        document.querySelectorAll('#evaluacion select').forEach(select => {
            select.addEventListener('change', calcularIRAT);
        });

        function calcularIRAT() {
            let puntajeIRAT = 0;
            
            // 1. Preguntas directas de IRAT-5
            const equilibrio = parseInt(document.getElementById('equilibrio').value) || 0;
            const amputacion = parseInt(document.getElementById('amputacion').value) || 0;
            const brazos = parseInt(document.getElementById('brazos').value) || 0;
            const social = parseInt(document.getElementById('social').value) || 0;
            const cooperacion = parseInt(document.getElementById('cooperacion').value) || 0;

            puntajeIRAT += equilibrio + amputacion + brazos + social + cooperacion;

            // 2. Componente Tinetti (Convertido a IRAT)
            let tinettiIRAT = 0;
            const tinettiNoEvaluable = document.getElementById('opcion-no-evaluable').classList.contains('selected');
            
            if (tinettiNoEvaluable) {
                tinettiIRAT = 4; // Máximo riesgo si no es evaluable
            } else {
                const puntajeTinetti = calcularTinetti(false); // Obtener puntaje Tinetti sin actualizar UI
                if (puntajeTinetti <= 18) {
                    tinettiIRAT = 4;
                } else if (puntajeTinetti >= 19 && puntajeTinetti <= 24) {
                    tinettiIRAT = 2;
                } else if (puntajeTinetti >= 25) {
                    tinettiIRAT = 0;
                }
            }

            puntajeIRAT += tinettiIRAT;

            // Mostrar el resultado
            document.getElementById('puntaje-irat').textContent = puntajeIRAT;
        }

        // Lógica de Cálculo Tinetti
        function calcularTinetti(updateUI = true) {
            let puntajeTinetti = 0;
            const tinettiNoEvaluable = document.getElementById('opcion-no-evaluable').classList.contains('selected');

            if (!tinettiNoEvaluable) {
                // Sumar todos los puntos de las opciones seleccionadas
                document.querySelectorAll('#test-tinetti-completo .tinetti-option.selected').forEach(option => {
                    puntajeTinetti += parseInt(option.dataset.puntaje) || 0;
                });
            }

            if (updateUI) {
                document.getElementById('puntaje-tinetti-total').textContent = `${puntajeTinetti} / 28`;
            }

            return puntajeTinetti;
        }

        // Lógica de Cálculo Norton
        document.querySelectorAll('#norton select').forEach(select => {
            select.addEventListener('change', calcularNorton);
        });

        function calcularNorton() {
            let puntajeNorton = 0;
            
            // Sumar los 5 componentes
            const fisica = parseInt(document.getElementById('norton-fisica').value) || 0;
            const mental = parseInt(document.getElementById('norton-mental').value) || 0;
            const actividad = parseInt(document.getElementById('norton-actividad').value) || 0;
            const movilidad = parseInt(document.getElementById('norton-movilidad').value) || 0;
            const incontinencia = parseInt(document.getElementById('norton-incontinencia').value) || 0;

            puntajeNorton = fisica + mental + actividad + movilidad + incontinencia;

            const riesgoNortonElement = document.getElementById('riesgo-norton');

            // Determinar el riesgo
            let riesgoTexto = '';
            let riesgoClase = '';
            if (puntajeNorton <= 14) {
                riesgoTexto = 'Alto Riesgo (≤ 14 pts)';
                riesgoClase = 'risk-high';
            } else {
                riesgoTexto = 'Bajo Riesgo (> 14 pts)';
                riesgoClase = 'risk-low';
            }
            
            // Actualizar UI
            document.getElementById('puntaje-norton').textContent = `${puntajeNorton} / 20`;
            riesgoNortonElement.textContent = riesgoTexto;
            riesgoNortonElement.className = `risk-level ${riesgoClase}`;

            return puntajeNorton;
        }

        // Validación de Formularios (Solo campos requeridos de Identificación e IRAT)
        function validateForm(sectionId) {
            let isValid = true;
            let requiredFields = [];

            if (sectionId === 'identificacion') {
                requiredFields = ['nombre', 'fecha', 'evaluador'];
            } else if (sectionId === 'evaluacion') {
                requiredFields = ['equilibrio', 'amputacion', 'brazos', 'social', 'cooperacion'];
            } else if (sectionId === 'tinetti') {
                 // Para Tinetti, solo basta con que haya una selección o que "No evaluable" esté seleccionado.
                 const tinettiNoEvaluable = document.getElementById('opcion-no-evaluable').classList.contains('selected');
                 const tinettiScore = calcularTinetti(false);
                 if (!tinettiNoEvaluable && tinettiScore === 0) {
                    // Es evaluable, pero no se ha seleccionado nada aún
                    document.getElementById('error-tinetti-evaluable').textContent = 'Debe realizar la evaluación o marcar como NO EVALUABLE.';
                    document.getElementById('error-tinetti-evaluable').style.display = 'block';
                    isValid = false;
                 } else {
                    document.getElementById('error-tinetti-evaluable').style.display = 'none';
                 }
                 return isValid;
            }

            requiredFields.forEach(id => {
                const element = document.getElementById(id);
                const errorElement = document.getElementById(`error-${id}`);
                
                if (!element.value || element.value.trim() === "") {
                    element.classList.add('error-input');
                    errorElement.textContent = 'Este campo es requerido.';
                    errorElement.style.display = 'block';
                    isValid = false;
                } else {
                    element.classList.remove('error-input');
                    errorElement.style.display = 'none';
                }
            });

            if (!isValid) {
                showNotification('Por favor, complete todos los campos requeridos (*).', 'error');
            }
            return isValid;
        }

        // Generar la sección de resultados
        function generarResultados() {
            calcularIRAT();
            calcularTinetti();
            calcularNorton();

            // 1. Obtener puntajes finales
            const iratScore = parseInt(document.getElementById('puntaje-irat').textContent);
            const tinettiScore = calcularTinetti(false);
            const nortonScore = calcularNorton();
            
            // 2. Determinar Riesgo IRAT
            let iratRiesgoTexto;
            let iratRiesgoClase;
            if (iratScore <= 6) {
                iratRiesgoTexto = 'Riesgo Bajo';
                iratRiesgoClase = 'risk-low';
            } else if (iratScore >= 7 && iratScore <= 10) {
                iratRiesgoTexto = 'Riesgo Moderado';
                iratRiesgoClase = 'risk-moderate';
            } else {
                iratRiesgoTexto = 'Riesgo Alto';
                iratRiesgoClase = 'risk-high';
            }

            // 3. Determinar Riesgo Norton
            const nortonRiesgoTexto = nortonScore <= 14 ? 'Riesgo Alto de Úlcera' : 'Riesgo Bajo de Úlcera';
            const nortonRiesgoClase = nortonScore <= 14 ? 'risk-high' : 'risk-low';

            // 4. Actualizar Resumen
            document.getElementById('res-nombre').textContent = document.getElementById('nombre').value || 'Sin nombre';
            document.getElementById('res-evaluador').textContent = document.getElementById('evaluador').value || 'N/A';
            document.getElementById('res-fecha').textContent = document.getElementById('fecha').value || 'N/A';
            document.getElementById('res-irat-total').textContent = iratScore;
            document.getElementById('res-irat-riesgo').textContent = iratRiesgoTexto;
            document.getElementById('res-irat-riesgo').className = `resultado-valor ${iratRiesgoClase}`;
            document.getElementById('res-tinetti-total').textContent = `${tinettiScore} / 28`;
            document.getElementById('res-norton-total').textContent = `${nortonScore} / 20`;
            document.getElementById('res-norton-riesgo').textContent = nortonRiesgoTexto;
            document.getElementById('res-norton-riesgo').className = `resultado-valor ${nortonRiesgoClase}`;

            // 5. Generar Recomendaciones (Ejemplo simple)
            const recContainer = document.getElementById('recomendaciones-irat');
            recContainer.innerHTML = '';
            
            let recomendaciones = [];
            if (iratScore > 10) {
                recomendaciones.push({ titulo: '🚨 Riesgo de Caída ALTO', texto: 'Requiere supervisión constante, adaptar el hogar y evaluar necesidad de silla de ruedas. Iniciar entrenamiento de transferencias urgentes.', color: 'danger' });
            } else if (iratScore > 6) {
                recomendaciones.push({ titulo: '⚠️ Riesgo de Caída MODERADO', texto: 'Implementar bastón o andador. Iniciar entrenamiento de marcha y equilibrio (ej. Tinetti). Revisar medicación.', color: 'warning' });
            } else {
                recomendaciones.push({ titulo: '✅ Riesgo de Caída BAJO', texto: 'Continuar ejercicios de fortalecimiento y equilibrio. Reevaluación en 3-6 meses.', color: 'success' });
            }

            if (nortonScore <= 14) {
                 recomendaciones.push({ titulo: '🚨 Riesgo de Úlcera', texto: 'Cambios posturales cada 2-3 horas. Uso de colchón de presión alterna. Inspección diaria de piel.', color: 'danger' });
            }

            if (tinettiScore < 25) {
                recomendaciones.push({ titulo: '🚶 Déficit en Marcha/Equilibrio', texto: 'Derivación a fisioterapeuta para programa de reeducación de marcha y fortalecimiento muscular específico.', color: 'info' });
            }

            recomendaciones.forEach(rec => {
                const card = document.createElement('div');
                card.className = 'recommendation-card';
                card.style.borderLeftColor = rec.color === 'danger' ? '#F44336' : rec.color === 'warning' ? '#FF9800' : rec.color === 'success' ? '#4CAF50' : '#1e3c72';
                card.innerHTML = `<strong>${rec.titulo}</strong><p>${rec.texto}</p>`;
                recContainer.appendChild(card);
            });
            
            // Guardar el informe final para PDF/Compartir
            lastReportData = {
                nombre: document.getElementById('nombre').value,
                fecha: document.getElementById('fecha').value,
                evaluador: document.getElementById('evaluador').value,
                iratScore: iratScore,
                iratRiesgo: iratRiesgoTexto,
                tinettiScore: tinettiScore,
                nortonScore: nortonScore,
                nortonRiesgo: nortonRiesgoTexto,
                recomendaciones: recomendaciones
            };
        }

        // -----------------------------------------------------------
        // 5. INTERACCIÓN CON FIRESTORE (GUARDAR/CARGAR HISTORIAL)
        // -----------------------------------------------------------

        document.getElementById('guardar-evaluacion').addEventListener('click', async () => {
            if (!currentUser) {
                showNotification('Debe iniciar sesión para guardar la evaluación.', 'error');
                return;
            }
            if (!lastReportData) {
                showNotification('Primero debe finalizar la evaluación y ver los resultados.', 'warning');
                return;
            }

            const dataToSave = {
                ...lastReportData,
                userId: currentUserId,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                // Campos de identificación
                rut: document.getElementById('rut').value,
                edad: document.getElementById('edad').value,
                sexo: document.getElementById('sexo').value,
                institucion: document.getElementById('institucion').value,
                historiaClinica: document.getElementById('historia-clinica').value
            };

            try {
                // Guarda la evaluación en la colección 'evaluaciones'
                await db.collection('evaluaciones').add(dataToSave);
                showNotification(`Evaluación de ${dataToSave.nombre} guardada exitosamente.`, 'success');
                // Recargar el historial después de guardar
                loadHistorial(true);
            } catch (error) {
                console.error("Error al guardar en Firestore:", error);
                showNotification('Error al guardar la evaluación. ' + error.message, 'error', 5000);
            }
        });

        async function loadHistorial(reset = false) {
            if (!currentUser) {
                // Esto se maneja en onAuthStateChanged, pero por seguridad.
                return;
            }

            if (isFetchingHistory) return;
            isFetchingHistory = true;

            const historialList = document.getElementById('historial-list');
            const paginationControls = document.getElementById('pagination-controls');

            if (reset) {
                historialList.innerHTML = '<p>Cargando evaluaciones...</p>';
                paginationControls.innerHTML = '';
                lastVisible = null;
            }

            try {
                let query = db.collection('evaluaciones')
                              .where('userId', '==', currentUserId)
                              .orderBy('timestamp', 'desc')
                              .limit(PAGE_SIZE);

                if (lastVisible && !reset) {
                    query = query.startAfter(lastVisible);
                }

                const snapshot = await query.get();
                const evaluations = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Borrar solo si es la primera carga (reset=true) o si no hay más elementos
                if (reset) {
                    historialList.innerHTML = '';
                } else if (evaluations.length === 0) {
                    showNotification('No hay más evaluaciones antiguas para cargar.', 'info');
                }

                if (evaluations.length === 0 && reset) {
                     historialList.innerHTML = '<p>Aún no ha guardado ninguna evaluación.</p>';
                }

                evaluations.forEach(eval => {
                    const date = eval.timestamp ? eval.timestamp.toDate().toLocaleDateString() : 'Fecha no disponible';
                    const item = document.createElement('div');
                    item.className = 'historial-item';
                    item.innerHTML = `
                        <h4>${eval.nombre} (${date})</h4>
                        <p><strong>IRAT-5:</strong> ${eval.iratScore} (${eval.iratRiesgo})</p>
                        <p><strong>Norton:</strong> ${eval.nortonScore} / 20</p>
                        <button class="btn btn-secondary btn-sm" onclick="viewReport('${eval.id}')">Ver Informe</button>
                    `;
                    historialList.appendChild(item);
                });

                if (snapshot.docs.length > 0) {
                    lastVisible = snapshot.docs[snapshot.docs.length - 1];
                } else {
                    lastVisible = null;
                }
                
                // Paginación (simple: solo cargar más)
                paginationControls.innerHTML = '';
                if (snapshot.docs.length === PAGE_SIZE) {
                    const loadMoreBtn = document.createElement('button');
                    loadMoreBtn.className = 'btn btn-primary';
                    loadMoreBtn.textContent = 'Cargar Más Evaluaciones';
                    loadMoreBtn.onclick = () => loadHistorial(false);
                    paginationControls.appendChild(loadMoreBtn);
                }

            } catch (error) {
                console.error("Error al cargar historial:", error);
                historialList.innerHTML = `<p style="color:red;">Error al cargar el historial: ${error.message}</p>`;
            } finally {
                isFetchingHistory = false;
            }
        }

        // Función de ejemplo para ver informe
        async function viewReport(docId) {
            try {
                const docRef = db.collection('evaluaciones').doc(docId);
                const doc = await docRef.get();
                if (doc.exists) {
                    const data = doc.data();
                    showNotification(`Cargando informe de ${data.nombre}. Se cargaría en los campos para edición.`, 'info');
                    // Aquí se implementaría la lógica para rellenar todos los campos del formulario con 'data'
                    // y luego cambiar a la sección de resultados/identificación.
                    
                    // Ejemplo: Rellenar identificación
                    document.getElementById('nombre').value = data.nombre || '';
                    document.getElementById('fecha').value = data.fecha || '';
                    document.getElementById('evaluador').value = data.evaluador || '';
                    // ... (y todos los demás campos)
                    
                    // Finalmente, ir a resultados
                    lastReportData = data;
                    generarResultados();
                    switchSection('resultados');
                } else {
                    showNotification('El informe solicitado no existe.', 'error');
                }
            } catch (error) {
                console.error("Error al cargar el informe:", error);
                showNotification('Error al cargar el informe: ' + error.message, 'error');
            }
        }
        
        document.getElementById('cargar-historial-btn').addEventListener('click', () => loadHistorial(true));

        // -----------------------------------------------------------
        // 6. FUNCIONALIDAD DE PDF Y COMPARTIR
        // -----------------------------------------------------------

        document.getElementById('generar-pdf').addEventListener('click', generarPDF);
        document.getElementById('share-pdf').addEventListener('click', generarPDF); // Alias para sección compartir

        function generarPDF() {
            if (!lastReportData) {
                showNotification('Primero debe finalizar la evaluación y ver los resultados.', 'warning');
                return;
            }

            // Usando jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            let y = 20;

            doc.setFontSize(18);
            doc.text("INFORME CLÍNICO MULTIESCALA", 105, y, null, null, "center");
            y += 10;
            doc.setFontSize(10);
            doc.text(`Evaluador: ${lastReportData.evaluador} | Fecha: ${lastReportData.fecha}`, 105, y, null, null, "center");
            y += 10;
            
            // Sección Paciente
            doc.setDrawColor(30, 60, 114);
            doc.line(20, y, 190, y);
            y += 5;
            doc.setFontSize(14);
            doc.text("DATOS DEL PACIENTE", 20, y);
            y += 8;
            doc.setFontSize(10);
            doc.text(`Nombre: ${lastReportData.nombre}`, 20, y);
            doc.text(`Edad: ${document.getElementById('edad').value || 'N/A'}`, 100, y);
            y += 5;
            doc.text(`ID/RUT: ${document.getElementById('rut').value || 'N/A'}`, 20, y);
            y += 10;

            // Sección Resultados IRAT-5
            doc.setDrawColor(30, 60, 114);
            doc.line(20, y, 190, y);
            y += 5;
            doc.setFontSize(14);
            doc.text("IRAT-5 (Riesgo de Caída)", 20, y);
            y += 8;
            doc.setFontSize(10);
            doc.text(`Puntaje Total: ${lastReportData.iratScore}`, 20, y);
            doc.text(`Nivel de Riesgo: ${lastReportData.iratRiesgo}`, 100, y);
            y += 10;

            // Sección Resultados TINETTI
            doc.setDrawColor(30, 60, 114);
            doc.line(20, y, 190, y);
            y += 5;
            doc.setFontSize(14);
            doc.text("TEST DE TINETTI", 20, y);
            y += 8;
            doc.setFontSize(10);
            doc.text(`Puntaje Total: ${lastReportData.tinettiScore} / 28`, 20, y);
            y += 10;

            // Sección Resultados NORTON
            doc.setDrawColor(30, 60, 114);
            doc.line(20, y, 190, y);
            y += 5;
            doc.setFontSize(14);
            doc.text("ESCALA DE NORTON (Riesgo de Úlcera)", 20, y);
            y += 8;
            doc.setFontSize(10);
            doc.text(`Puntaje Total: ${lastReportData.nortonScore} / 20`, 20, y);
            doc.text(`Nivel de Riesgo: ${lastReportData.nortonRiesgo}`, 100, y);
            y += 10;
            
            // Sección Recomendaciones
            doc.setDrawColor(30, 60, 114);
            doc.line(20, y, 190, y);
            y += 5;
            doc.setFontSize(14);
            doc.text("PLAN DE RECOMENDACIONES", 20, y);
            y += 8;
            
            doc.setFontSize(10);
            const recomendacionesTexto = lastReportData.recomendaciones.map(r => `• ${r.titulo}: ${r.texto}`).join('\n');
            const splitText = doc.splitTextToSize(recomendacionesTexto, 160);
            doc.text(splitText, 20, y);

            doc.save(`Informe_${lastReportData.nombre.replace(/\s/g, '_')}_${lastReportData.fecha}.pdf`);
            showNotification('Informe PDF generado.', 'success');
        }

        document.getElementById('share-whatsapp').addEventListener('click', () => {
            if (!lastReportData) {
                showNotification('Genere el informe primero para compartir.', 'warning');
                return;
            }
            const resumen = `
*INFORME CLÍNICO RÁPIDO*
Paciente: ${lastReportData.nombre}
Fecha: ${lastReportData.fecha}

📊 *Resultados:*
• IRAT-5 (Caídas): ${lastReportData.iratScore} (${lastReportData.iratRiesgo})
• Tinetti: ${lastReportData.tinettiScore} / 28
• Norton (Úlceras): ${lastReportData.nortonScore} (${lastReportData.nortonRiesgo})

📝 *Recomendaciones:*
${lastReportData.recomendaciones.map(r => `• ${r.titulo}`).join('\n')}

_Generado por ${lastReportData.evaluador}_
            `.trim();
            
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(resumen)}`;
            window.open(whatsappUrl, '_blank');
            showNotification('Abriendo WhatsApp para compartir resumen.', 'info');
        });

        document.getElementById('share-data').addEventListener('click', () => {
            if (!lastReportData) {
                showNotification('Genere el informe primero para exportar datos.', 'warning');
                return;
            }
            const json = JSON.stringify(lastReportData, null, 2);
            const blob = new Blob([json], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Datos_${lastReportData.nombre.replace(/\s/g, '_')}_${lastReportData.fecha}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification('Datos JSON exportados.', 'success');
        });

        // Inicializar cálculos al cargar
        document.addEventListener('DOMContentLoaded', () => {
            // Establecer valores por defecto para que los cálculos iniciales sean válidos
            document.querySelectorAll('#evaluacion select, #norton select').forEach(select => {
                if (!select.value) {
                    // Seleccionar la primera opción por defecto (la menos riesgosa)
                    if (select.options.length > 1) {
                         select.value = select.options[1].value;
                    }
                }
            });

            // Forzar los primeros cálculos
            calcularIRAT();
            calcularTinetti();
            calcularNorton();
            
            // Mostrar la sección de autenticación por defecto hasta que onAuthStateChanged decida
            authSection.style.display = 'block';
            mainApp.style.display = 'none';

            // Configurar la fecha actual por defecto en el campo de fecha
            document.getElementById('fecha').valueAsDate = new Date();
        });
        
    </script>
</body>
</html>
