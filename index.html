<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluador Cl√≠nico Integrado</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* Estilos Generales */
        body { font-family: 'Arial', sans-serif; background-color: #f4f7f6; color: #333; margin: 0; padding: 0; }
        .container { max-width: 1200px; margin: 20px auto; padding: 20px; background: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        h1 { color: #1e3c72; text-align: center; border-bottom: 2px solid #ddd; padding-bottom: 10px; margin-bottom: 20px; }
        h2 { color: #1e3c72; margin-top: 30px; border-left: 5px solid #ff5a60; padding-left: 10px; }
        button { background-color: #ff5a60; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; }
        button:hover { background-color: #e04e53; }
        .btn-secondary { background-color: #6c757d; }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-save { background-color: #4CAF50; }
        .btn-save:hover { background-color: #45a049; }
        .btn-admin { background-color: #1e3c72; }
        .btn-admin:hover { background-color: #152c52; }

        /* Formulario y Evaluaci√≥n */
        .form-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="date"], select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        .evaluation-group { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .evaluation-group h3 { margin-top: 0; color: #ff5a60; }
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px dashed #eee; }
        .item-row:last-child { border-bottom: none; }
        .item-label { flex-grow: 1; margin-right: 15px; }
        .item-score { width: 100px; text-align: right; font-weight: bold; color: #1e3c72; }

        /* Resultados y Notificaciones */
        .results-section { background-color: #f0f8ff; padding: 20px; border-radius: 8px; border: 1px solid #cceeff; margin-top: 30px; }
        .results-summary { display: flex; justify-content: space-around; flex-wrap: wrap; margin-bottom: 20px; }
        .result-box { text-align: center; padding: 15px; border-radius: 8px; flex: 1; min-width: 150px; margin: 10px; background-color: #fff; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); }
        .result-box strong { display: block; font-size: 1.1em; color: #1e3c72; margin-bottom: 5px; }
        .resultado-valor { font-size: 1.8em; font-weight: bold; }
        
        .risk-success { color: #4CAF50; }
        .risk-warning { color: #FF9800; }
        .risk-danger { color: #F44336; }

        /* Tarjetas de Recomendaci√≥n */
        .recommendation-card { margin-top: 15px; padding: 15px; border-radius: 8px; border-left: 8px solid; background-color: #f9f9f9; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); }
        .recommendation-card strong { font-size: 1.1em; }
        
        /* Historial y Autenticaci√≥n */
        .auth-section, #main-app { padding: 20px; }
        .auth-section { text-align: center; }
        .auth-section input { max-width: 300px; margin: 5px auto; }

        #historial-list { list-style: none; padding: 0; }
        #historial-list li { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; background-color: #f9f9f9; margin-bottom: 5px; border-radius: 4px; }
        #historial-list li:hover { background-color: #f0f0f0; }
        
        .notification-bar { position: fixed; top: 0; left: 0; width: 100%; text-align: center; padding: 10px; color: white; z-index: 1000; transition: all 0.5s ease-in-out; display: none; }
        .notification-success { background-color: #4CAF50; }
        .notification-error { background-color: #F44336; }
        .notification-warning { background-color: #FF9800; }
        .notification-info { background-color: #2196F3; }

        /* Cabecera */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background-color: #1e3c72; color: white; border-radius: 8px 8px 0 0; }
        #user-display { display: flex; align-items: center; font-size: 0.9em; }
        #user-display i { margin-right: 8px; }
        .logout-btn { background-color: transparent; border: 1px solid white; padding: 5px 10px; margin-left: 15px; }
        .logout-btn:hover { background-color: #ff5a60; border-color: #ff5a60; }

        /* Ocultar secci√≥n por defecto */
        #main-app { display: none; }

        /* Estilos de Tinetti para la fila */
        .tinetti-row { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px dashed #eee; }
        .tinetti-row .item-label { flex: 1; }
        .tinetti-score-options { display: flex; gap: 10px; }
        .tinetti-score-options label { font-weight: normal; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 style="color: white; border-bottom: none; margin: 0; padding: 0;">Evaluador Cl√≠nico Integrado</h1>
            <div id="user-display">
                <i class="fas fa-user"></i>
                <span>Modo Desconectado</span>
                <button class="logout-btn" onclick="logout()" id="logout-btn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
                </button>
            </div>
        </div>

        <section id="auth-section" class="auth-section">
            <h2 id="auth-title">Iniciar Sesi√≥n</h2>
            <input type="text" id="auth-email" placeholder="Correo Electr√≥nico" required>
            <input type="password" id="auth-password" placeholder="Contrase√±a" required>
            <button id="auth-button" onclick="handleAuth()"><i class="fas fa-sign-in-alt"></i> Iniciar Sesi√≥n</button>
            <p style="margin-top: 15px;">
                <a href="#" id="toggle-auth-mode" onclick="toggleAuthModeFunc()">Reg√≠strate aqu√≠</a>
            </p>
        </section>

        <section id="main-app">
            
            <h2>Datos Generales del Paciente</h2>
            <div class="form-section">
                <div>
                    <label for="nombre">Nombre del Paciente:</label>
                    <input type="text" id="nombre">
                </div>
                <div>
                    <label for="fecha">Fecha de Evaluaci√≥n:</label>
                    <input type="date" id="fecha">
                </div>
                <div>
                    <label for="evaluador">Nombre del Evaluador:</label>
                    <input type="text" id="evaluador">
                </div>
            </div>

            <div class="evaluation-group" id="irat-section">
                <h3>IRAT-5 (Riesgo de Amputaci√≥n y Ca√≠da)</h3>
                <div class="item-row">
                    <div class="item-label">Amputaci√≥n</div>
                    <select id="amputacion" onchange="calcularIRAT()">
                        <option value="0">0. Ausencia</option>
                        <option value="3">3. Unilateral Infracond√≠lea / Transmetatarsiana</option>
                        <option value="4">4. Bilateral Infracond√≠lea</option>
                        <option value="5">5. Unilateral Supracond√≠lea</option>
                        <option value="6">6. Bilateral Supracond√≠lea</option>
                    </select>
                </div>
                <div class="item-row">
                    <div class="item-label">D√©ficit Visual Severo (con correcci√≥n)</div>
                    <select id="visual" onchange="calcularIRAT()">
                        <option value="0">0. No</option>
                        <option value="1">1. S√≠</option>
                    </select>
                </div>
                <div class="item-row">
                    <div class="item-label">Polifarmacia (5 o m√°s medicamentos)</div>
                    <select id="polifarmacia" onchange="calcularIRAT()">
                        <option value="0">0. No</option>
                        <option value="1">1. S√≠</option>
                    </select>
                </div>
                <div class="item-row">
                    <div class="item-label">Uso de Benzodiazepinas/Neurol√©pticos</div>
                    <select id="farmacos" onchange="calcularIRAT()">
                        <option value="0">0. No</option>
                        <option value="1">1. S√≠</option>
                    </select>
                </div>
                <div class="item-row">
                    <div class="item-label">Antecedente de Ca√≠da en los √∫ltimos 6 meses</div>
                    <select id="caida" onchange="calcularIRAT()">
                        <option value="0">0. No</option>
                        <option value="1">1. S√≠</option>
                    </select>
                </div>
                <div class="item-row" style="background-color: #f0f0f0;">
                    <div class="item-label">PUNTAJE TOTAL IRAT-5</div>
                    <div class="item-score" id="puntaje-irat">0</div>
                </div>
            </div>

            <div class="evaluation-group" id="tinetti-section">
                <h3>Tinetti (Marcha y Equilibrio)</h3>
                <p style="font-style: italic;">Indique el puntaje para cada componente (0, 1 o 2). M√°ximo 28 puntos.</p>

                <h4 style="color: #3f68a8;">I. Equilibrio (M√°x. 16)</h4>
                <div class="tinetti-row">
                    <div class="item-label">1. Equilibrio sentado</div>
                    <div class="tinetti-score-options">
                        <input type="radio" name="e1" value="0" id="e1_0" checked onclick="calcularTinetti(true)"><label for="e1_0">0</label>
                        <input type="radio" name="e1" value="1" id="e1_1" onclick="calcularTinetti(true)"><label for="e1_1">1</label>
                    </div>
                </div>
                <div class="tinetti-row">
                    <div class="item-label">2. Levantarse</div>
                    <div class="tinetti-score-options">
                        <input type="radio" name="e2" value="0" id="e2_0" checked onclick="calcularTinetti(true)"><label for="e2_0">0</label>
                        <input type="radio" name="e2" value="1" id="e2_1" onclick="calcularTinetti(true)"><label for="e2_1">1</label>
                        <input type="radio" name="e2" value="2" id="e2_2" onclick="calcularTinetti(true)"><label for="e2_2">2</label>
                    </div>
                </div>
                <div class="tinetti-row">
                    <div class="item-label">3. Intentos para levantarse</div>
                    <div class="tinetti-score-options">
                        <input type="radio" name="e3" value="0" id="e3_0" checked onclick="calcularTinetti(true)"><label for="e3_0">0</label>
                        <input type="radio" name="e3" value="1" id="e3_1" onclick="calcularTinetti(true)"><label for="e3_1">1</label>
                        <input type="radio" name="e3" value="2" id="e3_2" onclick="calcularTinetti(true)"><label for="e3_2">2</label>
                    </div>
                </div>
                <div class="tinetti-row">
                    <div class="item-label">4. Equilibrio de pie (inmediato 5s)</div>
                    <div class="tinetti-score-options">
                        <input type="radio" name="e4" value="0" id="e4_0" checked onclick="calcularTinetti(true)"><label for="e4_0">0</label>
                        <input type="radio" name="e4" value="1" id="e4_1" onclick="calcularTinetti(true)"><label for="e4_1">1</label>
                        <input type="radio" name="e4" value="2" id="e4_2" onclick="calcularTinetti(true)"><label for="e4_2">2</label>
                    </div>
                </div>
                <div class="tinetti-row">
                    <div class="item-label">5. Equilibrio de pie (mantenido)</div>
                    <div class="tinetti-score-options">
                        <input type="radio" name="e5" value="0" id="e5_0" checked onclick="calcularTinetti(true)"><label for="e5_0">0</label>
                        <input type="radio" name="e5" value="1" id="e5_1" onclick="calcularTinetti(true)"><label for="e5_1">1</label>
                        <input type="radio" name="e5" value="2" id="e5_2" onclick="calcularTinetti(true)"><label for="e5_2">2</label>
                    </div>
                </div>
                <div class="tinetti-row">
                    <div class="item-label">6. Tensi√≥n al empuje</div>
                    <div class="tinetti-score-options">
                        <input type="radio" name="e6" value="0" id="e6_0" checked onclick="calcularTinetti(true)"><label for="e6_0">0</label>
                        <input type="radio" name="e6" value="1" id="e6_1" onclick="calcularTinetti(true)"><label for="e6_1">1</label>
                        <input type="radio" name="e6" value="2" id="e6_2" onclick="calcularTinetti(true)"><label for="e6_2">2</label>
                    </div>
                </div>
                <div class="tinetti-row">
                    <div class="item-label">7. Ojos cerrados (mantenerse de pie)</div>
                    <div class="tinetti-score-options">
                        <input type="radio" name="e7" value="0" id="e7_0" checked onclick="calcularTinetti(true)"><label for="e7_0">0</label>
                        <input type="radio" name="e7" value="1" id="e7_1" onclick="calcularTinetti(true)"><label for="e7_1">1</label>
                    </div>
                </div>
                <div class="tinetti-row">
                    <div class="item-label">8. Giro de 360¬∫</div>
                    <div class="tinetti-score-options">
                        <input type="radio" name="e8" value="0" id="e8_0" checked onclick="calcularTinetti(true)"><label for="e8_0">0</label>
                        <input type="radio" name="e8" value="1" id="e8_1" onclick="calcularTinetti(true)"><label for="e8_1">1</label>
                        <input type="radio" name="e8" value="2" id="e8_2" onclick="calcularTinetti(true)"><label for="e8_2">2</label>
                    </div>
                </div>
                <div class="tinetti-row">
                    <div class="item-label">9. Sentarse</div>
                    <div class="tinetti-score-options">
                        <input type="radio" name="e9" value="0" id="e9_0" checked onclick="calcularTinetti(true)"><label for="e9_0">0</label>
                        <input type="radio" name="e9" value="1" id="e9_1" onclick="calcularTinetti(true)"><label for="e9_1">1</label>
                        <input type="radio" name="e9" value="2" id="e9_2" onclick="calcularTinetti(true)"><label for="e9_2">2</label>
                    </div>
                </div>
                
                <h4 style="color: #3f68a8;">II. Marcha (M√°x. 12)</h4>
                <div class="tinetti-row">
                    <div class="item-label">10. Inicio de la marcha</div>
                    <div class="tinetti-score-options">
                        <input type="radio" name="m1" value="0" id="m1_0" checked onclick="calcularTinetti(true)"><label for="m1_0">0</label>
                        <input type="radio" name="m1" value="1" id="m1_1" onclick="calcularTinetti(true)"><label for="m1_1">1</label>
                    </div>
                </div>
                <div class="tinetti-row">
                    <div class="item-label">11. Longitud/Altura del paso</div>
                    <div class="tinetti-score-options">
                        <input type="radio" name="m2" value="0" id="m2_0" checked onclick="calcularTinetti(true)"><label for="m2_0">0</label>
                        <input type="radio" name="m2" value="1" id="m2_1" onclick="calcularTinetti(true)"><label for="m2_1">1</label>
                        <input type="radio" name="m2" value="2" id="m2_2" onclick="calcularTinetti(true)"><label for="m2_2">2</label>
                    </div>
                </div>
                <div class="tinetti-row">
                    <div class="item-label">12. Simetr√≠a del paso</div>
                    <div class="tinetti-score-options">
                        <input type="radio" name="m3" value="0" id="m3_0" checked onclick="calcularTinetti(true)"><label for="m3_0">0</label>
                        <input type="radio" name="m3" value="1" id="m3_1" onclick="calcularTinetti(true)"><label for="m3_1">1</label>
                        <input type="radio" name="m3" value="2" id="m3_2" onclick="calcularTinetti(true)"><label for="m3_2">2</label>
                    </div>
                </div>
                <div class="tinetti-row">
                    <div class="item-label">13. Continuidad del paso</div>
                    <div class="tinetti-score-options">
                        <input type="radio" name="m4" value="0" id="m4_0" checked onclick="calcularTinetti(true)"><label for="m4_0">0</label>
                        <input type="radio" name="m4" value="1" id="m4_1" onclick="calcularTinetti(true)"><label for="m4_1">1</label>
                    </div>
                </div>
                <div class="tinetti-row">
                    <div class="item-label">14. Trayectoria</div>
                    <div class="tinetti-score-options">
                        <input type="radio" name="m5" value="0" id="m5_0" checked onclick="calcularTinetti(true)"><label for="m5_0">0</label>
                        <input type="radio" name="m5" value="1" id="m5_1" onclick="calcularTinetti(true)"><label for="m5_1">1</label>
                        <input type="radio" name="m5" value="2" id="m5_2" onclick="calcularTinetti(true)"><label for="m5_2">2</label>
                    </div>
                </div>
                <div class="tinetti-row">
                    <div class="item-label">15. Tronco</div>
                    <div class="tinetti-score-options">
                        <input type="radio" name="m6" value="0" id="m6_0" checked onclick="calcularTinetti(true)"><label for="m6_0">0</label>
                        <input type="radio" name="m6" value="1" id="m6_1" onclick="calcularTinetti(true)"><label for="m6_1">1</label>
                        <input type="radio" name="m6" value="2" id="m6_2" onclick="calcularTinetti(true)"><label for="m6_2">2</label>
                    </div>
                </div>
                <div class="item-row" style="background-color: #f0f0f0; margin-top: 15px;">
                    <div class="item-label">PUNTAJE TOTAL TINETTI (M√°x 28)</div>
                    <div class="item-score" id="puntaje-tinetti">0</div>
                </div>
            </div>

            <div class="evaluation-group" id="norton-section">
                <h3>Norton (Riesgo de √ölcera por Presi√≥n)</h3>
                <p style="font-style: italic;">Indique el puntaje para cada componente (1 a 4). M√≠nimo 5, M√°ximo 20 puntos.</p>

                <div class="item-row">
                    <div class="item-label">Condici√≥n f√≠sica</div>
                    <select id="norton-fisica" onchange="calcularNorton()">
                        <option value="4">4. Buena</option>
                        <option value="3">3. Regular</option>
                        <option value="2">2. Pobre</option>
                        <option value="1">1. Muy Pobre</option>
                    </select>
                </div>
                <div class="item-row">
                    <div class="item-label">Estado mental</div>
                    <select id="norton-mental" onchange="calcularNorton()">
                        <option value="4">4. Alerta</option>
                        <option value="3">3. Ap√°tico</option>
                        <option value="2">2. Confuso</option>
                        <option value="1">1. Estuporoso/Coma</option>
                    </select>
                </div>
                <div class="item-row">
                    <div class="item-label">Actividad</div>
                    <select id="norton-actividad" onchange="calcularNorton()">
                        <option value="4">4. Ambulante</option>
                        <option value="3">3. Camina con ayuda</option>
                        <option value="2">2. En silla</option>
                        <option value="1">1. En cama</option>
                    </select>
                </div>
                <div class="item-row">
                    <div class="item-label">Movilidad</div>
                    <select id="norton-movilidad" onchange="calcularNorton()">
                        <option value="4">4. Completa</option>
                        <option value="3">3. Disminuida</option>
                        <option value="2">2. Muy Limitada</option>
                        <option value="1">1. Inm√≥vil</option>
                    </select>
                </div>
                <div class="item-row">
                    <div class="item-label">Incontinencia</div>
                    <select id="norton-incontinencia" onchange="calcularNorton()">
                        <option value="4">4. No</option>
                        <option value="3">3. Ocasional</option>
                        <option value="2">2. Urinaria</option>
                        <option value="1">1. Fecal y Urinaria</option>
                    </select>
                </div>
                <div class="item-row" style="background-color: #f0f0f0;">
                    <div class="item-label">PUNTAJE TOTAL NORTON (M√°x 20)</div>
                    <div class="item-score" id="puntaje-norton">20</div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn-save" onclick="generarResultados()"><i class="fas fa-calculator"></i> Generar Resultados</button>
                <button class="btn-secondary" onclick="resetForm()"><i class="fas fa-undo"></i> Limpiar Formulario</button>
            </div>

            <div class="results-section" id="results-section" style="display: none;">
                <h2>An√°lisis Cl√≠nico y Recomendaciones</h2>
                
                <div class="results-summary">
                    <div class="result-box">
                        <strong>Paciente</strong>
                        <span id="res-nombre">N/A</span>
                    </div>
                    <div class="result-box">
                        <strong>Fecha</strong>
                        <span id="res-fecha">N/A</span>
                    </div>
                    <div class="result-box" style="border: 2px solid #1e3c72;">
                        <strong>IRAT-5 (Ca√≠da/Amputaci√≥n)</strong>
                        <span id="res-irat-total" class="resultado-valor">0</span>
                        <p id="res-irat-riesgo" class="resultado-valor risk-success" style="font-size: 1em;"></p>
                    </div>
                    <div class="result-box" style="border: 2px solid #1e3c72;">
                        <strong>Tinetti (Movilidad)</strong>
                        <span id="res-tinetti-total" class="resultado-valor">0 / 28</span>
                        <p style="font-size: 1em;">Riesgo</p>
                    </div>
                    <div class="result-box" style="border: 2px solid #1e3c72;">
                        <strong>Norton (√ölcera)</strong>
                        <span id="res-norton-total" class="resultado-valor">0 / 20</span>
                        <p id="res-norton-riesgo" class="resultado-valor risk-success" style="font-size: 1em;"></p>
                    </div>
                     <div class="result-box" style="border: 3px solid #ff5a60; background-color: #fff9f9;">
                        <strong>CLASIFICACI√ìN COMBINADA</strong>
                        <span id="res-global-riesgo" class="resultado-valor risk-success" style="font-size: 1.5em;">BAJO</span>
                        <p style="font-size: 0.9em;">Recomendaciones clave a continuaci√≥n.</p>
                    </div>
                </div>
                
                <h3 style="margin-top: 15px;">Recomendaciones y Ayudas T√©cnicas (Priorizadas)</h3>
                <div id="recomendaciones-irat">
                    </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn-secondary" onclick="saveReport()"><i class="fas fa-save"></i> Guardar Evaluaci√≥n</button>
                    <button onclick="generatePDF()"><i class="fas fa-file-pdf"></i> Generar PDF</button>
                </div>
            </div>

            <h2 style="margin-top: 40px;">Historial de Evaluaciones</h2>
            <div style="text-align: right; margin-bottom: 10px;">
                <button class="btn-admin" id="limpiar-historial-btn" style="display:none;"><i class="fas fa-eraser"></i> Limpiar Historial (Admin)</button>
                <button class="btn-secondary" onclick="loadHistorial(true)"><i class="fas fa-sync-alt"></i> Recargar</button>
            </div>
            <ul id="historial-list">
                <li id="loading-history-msg">Cargando historial...</li>
            </ul>
        </section>
        
        <div id="notification-bar" class="notification-bar"></div>

    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // ------------------------------------------------------------------
        // CONFIGURACI√ìN E INICIALIZACI√ìN DE FIREBASE
        // ------------------------------------------------------------------
        
        // üö® CR√çTICO: REEMPLACE ESTAS VARIABLES CON SUS PROPIAS CREDENCIALES DE FIREBASE
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDJbtRuEwWVAsC1Nz6LbeF5a99LcUfAz4g",
  authDomain: "irat-5-evaluaciones.firebaseapp.com",
  databaseURL: "https://irat-5-evaluaciones-default-rtdb.firebaseio.com",
  projectId: "irat-5-evaluaciones",
  storageBucket: "irat-5-evaluaciones.firebasestorage.app",
  messagingSenderId: "487279274410",
  appId: "1:487279274410:web:146e9c35a0bf795c5423d3",
  measurementId: "G-WSXJY5QHJS"
};
        
        let app, db, auth;
        let authMode = 'login'; // 'login' o 'register'
        let currentUser = null;
        let currentUserId = null;
        let lastReportData = {}; // Guarda los √∫ltimos resultados generados para el PDF/Guardar
        
        // Elementos de la UI
        const authSection = document.getElementById('auth-section');
        const mainApp = document.getElementById('main-app');
        const authTitle = document.getElementById('auth-title');
        const authButton = document.getElementById('auth-button');
        const toggleAuthMode = document.getElementById('toggle-auth-mode');
        const logoutBtn = document.getElementById('logout-btn');
        
        function initFirebase() {
            try {
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                console.log("Firebase inicializado correctamente.");
                setupAuthStateListener();
            } catch (e) {
                console.error("Error al inicializar Firebase. Revise las credenciales.", e);
                showNotification(`Error: No se pudo conectar a Firebase. Revise la consola.`, 'error', 10000);
            }
        }
        
        // Iniciar Firebase al cargar la p√°gina
        window.onload = initFirebase;
        
        // ------------------------------------------------------------------
        // L√ìGICA DE AUTENTICACI√ìN
        // ------------------------------------------------------------------
        
        function toggleAuthModeFunc() {
            if (authMode === 'login') {
                authMode = 'register';
                authTitle.textContent = 'Registrar Nuevo Usuario';
                authButton.innerHTML = '<i class="fas fa-user-plus"></i> Registrar';
                toggleAuthMode.textContent = 'Volver a Iniciar Sesi√≥n';
            } else {
                authMode = 'login';
                authTitle.textContent = 'Iniciar Sesi√≥n';
                authButton.innerHTML = '<i class="fas fa-sign-in-alt"></i> Iniciar Sesi√≥n';
                toggleAuthMode.textContent = 'Reg√≠strate aqu√≠';
            }
        }
        
        async function handleAuth() {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
        
            if (!email || !password) {
                showNotification('Ingrese correo y contrase√±a.', 'warning');
                return;
            }
        
            try {
                if (authMode === 'register') {
                    await auth.createUserWithEmailAndPassword(email, password);
                    showNotification('Usuario registrado exitosamente. Iniciando sesi√≥n...', 'success');
                    // Nota: onAuthStateChanged manejar√° la transici√≥n de UI
                } else {
                    await auth.signInWithEmailAndPassword(email, password);
                    // Nota: onAuthStateChanged manejar√° la transici√≥n de UI
                }
            } catch (error) {
                console.error("Error de autenticaci√≥n:", error);
                showNotification(`Error: ${error.message}`, 'error');
            }
        }
        
        function logout() {
            auth.signOut().then(() => {
                showNotification('Sesi√≥n cerrada.', 'info');
                // onAuthStateChanged manejar√° la transici√≥n de UI
            }).catch((error) => {
                console.error("Error al cerrar sesi√≥n:", error);
                showNotification(`Error al cerrar sesi√≥n: ${error.message}`, 'error');
            });
        }
        
        /**
         * Verifica si el usuario actual es un administrador consultando Firestore.
         */
        async function checkAdminStatus(uid) {
            if (!db) return false;
            try {
                // Asume una colecci√≥n 'roles' con documentos { UID: { role: 'admin' } }
                const doc = await db.collection('roles').doc(uid).get();
                return doc.exists && doc.data().role === 'admin';
            } catch (error) {
                console.error("Error al verificar el rol de administrador:", error);
                return false;
            }
        }
        
        /**
         * Actualiza la UI bas√°ndose en el rol del usuario.
         */
        function updateUIAfterAuth(user) {
            const limpiarBtn = document.getElementById('limpiar-historial-btn');
            limpiarBtn.style.display = 'none'; // Ocultar por defecto
        
            if (user) {
                checkAdminStatus(user.uid).then(isAdmin => {
                    if (isAdmin) {
                        limpiarBtn.style.display = 'inline-flex'; // Mostrar si es administrador
                        limpiarBtn.onclick = confirmAndClearHistorial; // Asignar la funci√≥n de limpieza
                        showNotification('Acceso de Administrador activado.', 'warning');
                    }
                }).catch(e => console.error("Error al actualizar UI con roles:", e));
            }
        }
        
        function setupAuthStateListener() {
            const userDisplay = document.getElementById('user-display').querySelector('span');
        
            auth.onAuthStateChanged(user => {
                if (user) {
                    // Usuario autenticado
                    currentUser = user;
                    currentUserId = user.uid;
                    authSection.style.display = 'none';
                    mainApp.style.display = 'block';
                    userDisplay.textContent = user.email;
                    logoutBtn.style.display = 'inline-block';
                    
                    // üö® CR√çTICO: Verificar y actualizar la UI con el rol
                    updateUIAfterAuth(user); 
                    loadHistorial(true);
                } else {
                    // Usuario desautenticado
                    currentUser = null;
                    currentUserId = null;
                    authSection.style.display = 'block';
                    mainApp.style.display = 'none';
                    userDisplay.textContent = 'Modo Desconectado';
                    logoutBtn.style.display = 'none';
                    
                    // Ocultar bot√≥n de limpieza al cerrar sesi√≥n
                    document.getElementById('limpiar-historial-btn').style.display = 'none';
                    
                    authMode = 'login'; 
                    authTitle.textContent = 'Iniciar Sesi√≥n';
                    authButton.innerHTML = '<i class="fas fa-sign-in-alt"></i> Iniciar Sesi√≥n';
                    toggleAuthMode.textContent = 'Reg√≠strate aqu√≠';
                }
            });
        }

        // ------------------------------------------------------------------
        // FUNCIONES DE C√ÅLCULO
        // ------------------------------------------------------------------

        function calcularIRAT() {
            if (!document.getElementById('amputacion')) return 0;
            const items = ['amputacion', 'visual', 'polifarmacia', 'farmacos', 'caida'];
            let total = 0;
            items.forEach(id => {
                total += parseInt(document.getElementById(id).value) || 0;
            });
            document.getElementById('puntaje-irat').textContent = total;
            return total;
        }

        /**
         * Obtiene el valor de Amputaci√≥n (para usar en la clasificaci√≥n combinada)
         */
        function getIratAmputacionValue() {
            return parseInt(document.getElementById('amputacion').value) || 0;
        }

        /**
         * Calcula el puntaje Tinetti.
         * @param {boolean} updateUI - Si es true, actualiza el valor en la UI.
         */
        function calcularTinetti(updateUI = true) {
            let total = 0;
            // Equilibrio (e1 a e9)
            for (let i = 1; i <= 9; i++) {
                const radios = document.getElementsByName(`e${i}`);
                radios.forEach(radio => {
                    if (radio.checked) {
                        total += parseInt(radio.value);
                    }
                });
            }
            // Marcha (m1 a m6)
            for (let i = 1; i <= 6; i++) {
                const radios = document.getElementsByName(`m${i}`);
                radios.forEach(radio => {
                    if (radio.checked) {
                        total += parseInt(radio.value);
                    }
                });
            }

            if (updateUI) {
                document.getElementById('puntaje-tinetti').textContent = total;
            }
            return total;
        }

        function calcularNorton() {
            if (!document.getElementById('norton-fisica')) return 0;
            const items = ['norton-fisica', 'norton-mental', 'norton-actividad', 'norton-movilidad', 'norton-incontinencia'];
            let total = 0;
            items.forEach(id => {
                total += parseInt(document.getElementById(id).value) || 0;
            });
            document.getElementById('puntaje-norton').textContent = total;
            return total;
        }

        // ------------------------------------------------------------------
        // L√ìGICA DE CLASIFICACI√ìN COMBINADA (ACTUALIZADA CON INTERDISCIPLINA Y CONTROL)
        // ------------------------------------------------------------------

        /**
         * Crea una clasificaci√≥n cl√≠nica unificada y genera las recomendaciones 
         * de ayuda t√©cnica y plan de acci√≥n interdisciplinar.
         */
        function getCombinedClinicalClassification(iratScore, tinettiScore, nortonScore) {
            const iratAmputacion = getIratAmputacionValue();
            let recomendaciones = [];
            let nivelRiesgoGlobal = 'BAJO';
            let colorGlobal = 'success';
            
            // 1. L√≥gica por Amputaci√≥n (IRAT - CR√çTICO si >= 3)
            if (iratAmputacion >= 3) {
                // Amputaci√≥n Unilateral/Bilateral Infracond√≠lea/Supracond√≠lea
                recomendaciones.push({
                    titulo: 'üö® Consideraci√≥n: Amputaci√≥n Presente',
                    texto: 'Requiere evaluaci√≥n y manejo prot√©sico urgente (o adaptaci√≥n si ya posee pr√≥tesis). Ense√±ar t√©cnicas de cuidado del mu√±√≥n para prevenir infecciones y √∫lceras.',
                    color: 'danger',
                    tipo: 'Amputacion'
                });
                
                if (iratAmputacion === 4 || iratAmputacion === 6) { 
                    // Amputaci√≥n Bilateral
                    recomendaciones.unshift({ // PRIORIZAR esta ayuda
                        titulo: "‚ôø Ayuda T√©cnica Principal: Silla de Ruedas",
                        texto: "Amputaci√≥n Bilateral. La ayuda principal de movilidad es la Silla de Ruedas. Dispositivos de marcha (andador/bast√≥n) contraindicados hasta adaptaci√≥n prot√©sica. Requiere entrenamiento en silla.",
                        color: 'danger',
                        tipo: 'Movilidad Principal'
                    });
                    nivelRiesgoGlobal = 'CR√çTICO';
                    colorGlobal = 'danger';
                }
            }

            // 2. Clasificaci√≥n por Movilidad (Tinetti) y Asignaci√≥n de Ayuda Principal
            let ayudaPrincipalAsignada = recomendaciones.some(r => r.tipo === 'Movilidad Principal');

            if (!ayudaPrincipalAsignada) {
                if (tinettiScore <= 18) {
                    // Riesgo Alto de Ca√≠da - Tinetti Severo
                    recomendaciones.push({ 
                        titulo: "üö∂ Ayuda T√©cnica Principal: Andador (Fijo o con Ruedas)",
                        texto: "Tinetti Severo (Riesgo de Ca√≠da ALTO). Se recomienda Andador Fijo o de 2 ruedas (si hay fuerza en MMSS) y entrenamiento de marcha supervisado intensivo.",
                        color: 'danger',
                        tipo: 'Movilidad Principal'
                    });
                    if (nivelRiesgoGlobal !== 'CR√çTICO') {
                        nivelRiesgoGlobal = 'ALTO';
                        colorGlobal = 'danger';
                    }
                } else if (tinettiScore <= 24) {
                    // Riesgo Moderado de Ca√≠da - Tinetti Moderado
                    recomendaciones.push({ 
                        titulo: "ü¶Ø Ayuda T√©cnica Principal: Bast√≥n de 4 Apoyos",
                        texto: "Tinetti Moderado. Se recomienda Bast√≥n de 4 Apoyos (o de 3/1 si hay coordinaci√≥n) y entrenamiento espec√≠fico de equilibrio y marcha.",
                        color: 'warning',
                        tipo: 'Movilidad Principal'
                    });
                    if (nivelRiesgoGlobal === 'BAJO') {
                        nivelRiesgoGlobal = 'MODERADO';
                        colorGlobal = 'warning';
                    }
                } else {
                    recomendaciones.push({ 
                        titulo: "üü¢ Ayuda T√©cnica Principal: Preventiva / No Requerida",
                        texto: "Tinetti √ìptimo. No se requiere ayuda t√©cnica principal. Uso de bast√≥n simple solo en exteriores o terrenos irregulares. Mantener actividad f√≠sica y reevaluaci√≥n.",
                        color: 'success',
                        tipo: 'Movilidad Principal'
                    });
                }
            }
            
            // 3. Clasificaci√≥n por riesgo de √ölcera (Norton - ALTO si <= 14)
            if (nortonScore <= 14) {
                recomendaciones.push({ 
                    titulo: 'üö® Riesgo de √ölcera por Presi√≥n ALTO', 
                    texto: 'Protocolo estricto de cambios posturales cada 2-3 horas (registro obligatorio). Uso inmediato de colch√≥n y coj√≠n de presi√≥n alterna o viscoel√°stico.', 
                    color: 'danger', 
                    tipo: 'Ulcera' 
                });
                if (nivelRiesgoGlobal !== 'CR√çTICO' && nivelRiesgoGlobal !== 'ALTO') {
                    nivelRiesgoGlobal = 'ALTO';
                    colorGlobal = 'danger';
                }
            }

            // 4. Recomendaciones Interdisciplinarias y de Nivel de Riesgo Global
            
            // --- Recomendaciones para RIESGO CR√çTICO ---
            if (nivelRiesgoGlobal === 'CR√çTICO') {
                recomendaciones.push(
                    { titulo: 'KINESIOLOG√çA/TERAPIA F√çSICA', texto: 'Inmediata. √ânfasis en el entrenamiento de transferencias (cama-silla), fortalecimiento de MMSS y acondicionamiento del tronco (Kinesiterapia).', color: 'danger' },
                    { titulo: 'TERAPIA OCUPACIONAL', texto: 'Evaluaci√≥n y adaptaci√≥n del hogar y el entorno para permitir el uso seguro de la silla de ruedas (rampas, ancho de puertas).', color: 'danger' },
                    { titulo: 'INTERCONSULTA NUTRICI√ìN', texto: 'Urgente. Evaluar ingesta proteica y estado nutricional para favorecer la cicatrizaci√≥n y prevenir el deterioro muscular (Sarcopenia).', color: 'danger' },
                    { titulo: 'INTERCONSULTA M√âDICA', texto: 'Urgente con Especialista (Cirujano, Geriatra) para manejo del dolor, polifarmacia y manejo de comorbilidades agudas.', color: 'danger' },
                    { titulo: 'ENFERMER√çA', texto: 'Protocolo de inspecci√≥n de piel 3 veces al d√≠a y manejo avanzado de heridas (si existen). Entrenar a cuidadores.', color: 'danger' },
                    { titulo: 'CUIDADOR', texto: 'Se requiere cuidador 24 horas al d√≠a, capacitado en manejo de cambios posturales y transferencias seguras.', color: 'danger' },
                    { titulo: 'REVISI√ìN EX√ÅMENES CL√çNICOS', texto: 'Urgente. Revisar resultados de Hemograma, Glicemia, Electrolitos y funci√≥n renal. Considerar gases arteriales si hay compromiso respiratorio.', color: 'danger' },
                    { titulo: 'FECHA DE CONTROL PR√ìXIMO', texto: 'Control Interdisciplinar (M√©dico y Kinesi√≥logo) semanal, dadas las condiciones de criticidad y necesidad de ajustes inmediatos.', color: 'danger' }
                );
            } 
            // --- Recomendaciones para RIESGO ALTO ---
            else if (nivelRiesgoGlobal === 'ALTO') {
                recomendaciones.push(
                    { titulo: 'KINESIOLOG√çA/TERAPIA F√çSICA', texto: 'Intensiva. Foco en la reeducaci√≥n de la marcha con el andador, entrenamiento de equilibrio din√°mico y fortalecimiento espec√≠fico de m√∫sculos clave (Kinesiterapia).', color: 'danger' },
                    { titulo: 'TERAPIA OCUPACIONAL', texto: 'Adaptaci√≥n del entorno: instalaci√≥n de barras de apoyo en ba√±o, eliminaci√≥n de alfombras y optimizaci√≥n de iluminaci√≥n para reducir ca√≠das.', color: 'danger' },
                    { titulo: 'INTERCONSULTA M√âDICA', texto: 'Prioritaria. Revisi√≥n de polifarmacia, especialmente sedantes y antihipertensivos que puedan causar inestabilidad.', color: 'danger' },
                    { titulo: 'ENFERMER√çA/ATENCI√ìN DOMICILIARIA', texto: 'Monitoreo diario de la piel en puntos de presi√≥n. Educaci√≥n a paciente y familia sobre el uso correcto del dispositivo de ayuda t√©cnica.', color: 'warning' },
                    { titulo: 'NUTRICI√ìN', texto: 'Optimizaci√≥n de la hidrataci√≥n y soporte cal√≥rico-proteico si hay riesgo de √∫lcera o desnutrici√≥n.', color: 'warning' },
                    { titulo: 'PSICOLOG√çA', texto: 'Soporte emocional por la p√©rdida de autonom√≠a y miedo a caer (Ptofobia). Fomentar la participaci√≥n activa.', color: 'warning' },
                    { titulo: 'REVISI√ìN EX√ÅMENES CL√çNICOS', texto: 'Urgente. Evaluar Vitamina D, Calcio, B12 y perfil tiroideo, ya que son causas comunes de debilidad y riesgo de ca√≠da en adultos mayores.', color: 'danger' },
                    { titulo: 'FECHA DE CONTROL PR√ìXIMO', texto: 'Control Interdisciplinar (Kinesiolog√≠a y T. Ocupacional) cada 1-2 semanas hasta mejorar puntaje de Tinetti a >18. Control m√©dico mensual.', color: 'danger' }
                );
                // Recomendaci√≥n adicional de IRAT Alto (si no fue el factor dominante)
                if (iratScore >= 11) {
                    recomendaciones.push({ titulo: 'üö® Riesgo de Ca√≠da por IRAT ALTO', texto: 'Urgente: Revisi√≥n de la Agudeza Visual y eliminaci√≥n de calzado inestable. Uso de alarma personal.', color: 'danger' });
                }
            } 
            // --- Recomendaciones para RIESGO MODERADO ---
            else if (nivelRiesgoGlobal === 'MODERADO') {
                recomendaciones.push(
                    { titulo: 'KINESIOLOG√çA/TERAPIA F√çSICA', texto: 'Moderada. Programa de ejercicios en casa (Ejercicios de Otago o similares) y reentrenamiento de la marcha con el bast√≥n para mejorar la confianza.', color: 'warning' },
                    { titulo: 'TERAPIA OCUPACIONAL', texto: 'Recomendaciones b√°sicas de seguridad en el hogar (cables, altura de sillas) y simplificaci√≥n de tareas diarias.', color: 'warning' },
                    { titulo: 'INTERCONSULTA M√âDICA', texto: 'Control. Revisi√≥n de polifarmacia, especialmente de ansiol√≠ticos e hipn√≥ticos. Seguimiento de la presi√≥n arterial y control de glicemia.', color: 'info' },
                    { titulo: 'CUIDADO', texto: 'Fomentar la autonom√≠a, pero con supervisi√≥n intermitente. El paciente debe ser capaz de realizar la mayor√≠a de las AVD por s√≠ mismo.', color: 'info' },
                    { titulo: 'EDUCACI√ìN', texto: 'Ense√±ar al paciente t√©cnicas para levantarse del suelo de forma segura en caso de ca√≠da (si es viable).', color: 'info' },
                    { titulo: 'EQUILIBRIO', texto: 'Realizar ejercicios de equilibrio sobre una pierna (con apoyo) 3 veces por semana para mejorar la estabilidad y reflejos.', color: 'warning' },
                    { titulo: 'REVISI√ìN EX√ÅMENES CL√çNICOS', texto: 'Control de rutina. Verificar Hemoglobina y Ferritina (anemia), y Creatinina (funci√≥n renal) como factores de riesgo de fatiga y ca√≠da.', color: 'info' },
                    { titulo: 'FECHA DE CONTROL PR√ìXIMO', texto: 'Control Kinesiol√≥gico y Terapia Ocupacional cada 4-6 semanas. Reevaluaci√≥n global en 3 meses.', color: 'warning' }
                );
            }
            // --- Recomendaciones para RIESGO BAJO ---
            else if (nivelRiesgoGlobal === 'BAJO') {
                recomendaciones.push(
                    { titulo: 'KINESIOLOG√çA/TERAPIA F√çSICA', texto: 'Preventiva. Mantener un programa de actividad f√≠sica regular (caminatas, Tai Chi) que incluya fortalecimiento y estiramientos.', color: 'success' },
                    { titulo: 'TERAPIA OCUPACIONAL', texto: 'Chequeo anual de riesgos ergon√≥micos y de ca√≠das. Mantener los objetos de uso diario a la altura accesible.', color: 'success' },
                    { titulo: 'CONTROL M√âDICO', texto: 'Control anual para revisi√≥n de audici√≥n y visi√≥n. Fomentar vacunaci√≥n anual contra la influenza y neumococo.', color: 'success' },
                    { titulo: 'NUTRICI√ìN', texto: 'Dieta balanceada rica en calcio y Vitamina D. Ingesta adecuada de l√≠quidos.', color: 'success' },
                    { titulo: 'AUTOCUIDADO', texto: 'Uso de calzado firme y cerrado. Evitar el sedentarismo y fomentar la participaci√≥n social activa.', color: 'success' },
                    { titulo: 'REVISI√ìN EX√ÅMENES CL√çNICOS', texto: 'De rutina. Revisar Perfil Lip√≠dico y Glicemia anualmente. Considerar Densitometr√≠a √ìsea seg√∫n edad y factores de riesgo.', color: 'success' },
                    { titulo: 'FECHA DE CONTROL PR√ìXIMO', texto: 'Reevaluaci√≥n de Tinetti, IRAT y Norton de manera anual o ante cualquier cambio de salud significativo.', color: 'success' }
                );
            }
            
            // Asignar el nivel de riesgo final y su color (si no fue CR√çTICO inicialmente)
            if (recomendaciones.some(r => r.color === 'danger')) {
                colorGlobal = 'danger';
                if (nivelRiesgoGlobal !== 'CR√çTICO') nivelRiesgoGlobal = 'ALTO';
            } else if (recomendaciones.some(r => r.color === 'warning')) {
                colorGlobal = 'warning';
                if (nivelRiesgoGlobal === 'BAJO') nivelRiesgoGlobal = 'MODERADO';
            } else {
                colorGlobal = 'success';
            }


            return { 
                nivelRiesgoGlobal: nivelRiesgoGlobal, 
                colorGlobal: colorGlobal.toUpperCase(), 
                recomendaciones: recomendaciones 
            };
        }

        // ------------------------------------------------------------------
        // L√ìGICA DE UI Y RESULTADOS
        // ------------------------------------------------------------------

        // Generar la secci√≥n de resultados
        function generarResultados() {
            calcularIRAT();
            const tinettiScore = calcularTinetti(false);
            const nortonScore = calcularNorton();
            const iratScore = parseInt(document.getElementById('puntaje-irat').textContent);

            // 1. Determinar Clasificaci√≥n Combinada y Recomendaciones
            const clasificacion = getCombinedClinicalClassification(iratScore, tinettiScore, nortonScore);
            
            // 2. Determinar Riesgo IRAT
            let iratRiesgoTexto;
            let iratRiesgoClase;
            if (iratScore <= 6) {
                iratRiesgoTexto = 'Riesgo Bajo';
                iratRiesgoClase = 'risk-success';
            } else if (iratScore >= 7 && iratScore <= 10) {
                iratRiesgoTexto = 'Riesgo Moderado';
                iratRiesgoClase = 'risk-warning';
            } else {
                iratRiesgoTexto = 'Riesgo Alto';
                iratRiesgoClase = 'risk-danger';
            }

            // 3. Determinar Riesgo Norton
            const nortonRiesgoTexto = nortonScore <= 14 ? 'Riesgo Alto de √ölcera' : 'Riesgo Bajo de √ölcera';
            const nortonRiesgoClase = nortonScore <= 14 ? 'risk-danger' : 'risk-success';

            // 4. Actualizar Resumen de Puntajes
            document.getElementById('res-nombre').textContent = document.getElementById('nombre').value || 'Sin nombre';
            document.getElementById('res-fecha').textContent = document.getElementById('fecha').value || 'N/A';
            document.getElementById('res-irat-total').textContent = iratScore;
            document.getElementById('res-irat-riesgo').textContent = iratRiesgoTexto;
            document.getElementById('res-irat-riesgo').className = `resultado-valor ${iratRiesgoClase}`;
            document.getElementById('res-tinetti-total').textContent = `${tinettiScore} / 28`;
            document.getElementById('res-norton-total').textContent = `${nortonScore} / 20`;
            document.getElementById('res-norton-riesgo').textContent = nortonRiesgoTexto;
            document.getElementById('res-norton-riesgo').className = `resultado-valor ${nortonRiesgoClase}`;

            // 5. Actualizar Resumen Global
            document.getElementById('res-global-riesgo').textContent = clasificacion.nivelRiesgoGlobal;
            document.getElementById('res-global-riesgo').className = `resultado-valor risk-${clasificacion.colorGlobal.toLowerCase()}`;

            // 6. Mostrar las tarjetas de recomendaci√≥n en la UI
            const recContainer = document.getElementById('recomendaciones-irat');
            recContainer.innerHTML = '';
            
            clasificacion.recomendaciones.forEach(rec => {
                const card = document.createElement('div');
                card.className = 'recommendation-card';
                let colorCode = '#6c757d'; // default info
                if (rec.color === 'danger') colorCode = '#F44336';
                if (rec.color === 'warning') colorCode = '#FF9800';
                if (rec.color === 'success') colorCode = '#4CAF50';
                
                card.style.borderLeftColor = colorCode;
                card.innerHTML = `<strong>${rec.titulo}</strong><p>${rec.texto}</p>`;
                recContainer.appendChild(card);
            });
            
            document.getElementById('results-section').style.display = 'block';

            // 7. Guardar el informe final para PDF/Compartir
            lastReportData = {
                nombre: document.getElementById('nombre').value,
                fecha: document.getElementById('fecha').value,
                evaluador: document.getElementById('evaluador').value,
                iratScore: iratScore,
                iratRiesgo: iratRiesgoTexto,
                tinettiScore: tinettiScore,
                nortonScore: nortonScore,
                nortonRiesgo: nortonRiesgoTexto,
                clasificacionGlobal: clasificacion.nivelRiesgoGlobal,
                recomendaciones: clasificacion.recomendaciones,
                // Guardar los inputs para poder cargar el reporte completo
                iratInputs: ['amputacion', 'visual', 'polifarmacia', 'farmacos', 'caida'].map(id => ({ id: id, value: document.getElementById(id).value })),
                nortonInputs: ['norton-fisica', 'norton-mental', 'norton-actividad', 'norton-movilidad', 'norton-incontinencia'].map(id => ({ id: id, value: document.getElementById(id).value })),
                tinettiInputs: [...document.querySelectorAll('#tinetti-section input[type="radio"]:checked')].map(input => ({ name: input.name, value: input.value }))
            };
        }

        // ------------------------------------------------------------------
        // MANEJO DE FIRESTORE (GUARDAR, CARGAR, ELIMINAR, ADMIN)
        // ------------------------------------------------------------------

        async function saveReport() {
            if (!currentUser) {
                showNotification('Debe iniciar sesi√≥n para guardar una evaluaci√≥n.', 'error');
                return;
            }
            if (!lastReportData.nombre || !lastReportData.fecha) {
                showNotification('Primero debe generar los resultados (datos de paciente y fecha).', 'warning');
                return;
            }

            try {
                await db.collection('evaluaciones').add({
                    userId: currentUserId,
                    ...lastReportData,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                showNotification('Evaluaci√≥n guardada exitosamente.', 'success');
                loadHistorial(); // Recargar historial despu√©s de guardar
            } catch (error) {
                console.error("Error al guardar la evaluaci√≥n:", error);
                showNotification(`Error al guardar: ${error.message}`, 'error');
            }
        }

        async function loadHistorial(forceRefresh = false) {
            if (!currentUserId) return;
            const historialList = document.getElementById('historial-list');
            historialList.innerHTML = '<li id="loading-history-msg">Cargando historial...</li>';

            try {
                const snapshot = await db.collection('evaluaciones')
                    .where('userId', '==', currentUserId)
                    .orderBy('timestamp', 'desc')
                    .limit(50) // Limitar a las 50 m√°s recientes
                    .get();

                historialList.innerHTML = ''; // Limpiar mensaje de carga
                if (snapshot.empty) {
                    historialList.innerHTML = '<li>No hay evaluaciones guardadas.</li>';
                    return;
                }

                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const li = document.createElement('li');
                    const date = data.fecha ? new Date(data.fecha + 'T00:00:00').toLocaleDateString() : 'Fecha N/A';
                    
                    li.innerHTML = `
                        <span><strong>${data.nombre || 'Sin Nombre'}</strong> - ${date}</span>
                        <div>
                            <button class="btn-secondary" style="margin-right: 5px;" onclick="viewReport('${doc.id}')">
                                <i class="fas fa-eye"></i> Ver
                            </button>
                            <button style="background-color: #F44336;" onclick="deleteReport('${doc.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    historialList.appendChild(li);
                });
            } catch (error) {
                console.error("Error al cargar el historial:", error);
                historialList.innerHTML = `<li>Error al cargar: ${error.message}</li>`;
                showNotification(`Error al cargar el historial: ${error.message}`, 'error', 5000);
            }
        }
        
        // Funci√≥n para cargar los valores de un reporte del historial al formulario
        async function viewReport(docId) {
            try {
                const doc = await db.collection('evaluaciones').doc(docId).get();
                if (!doc.exists) {
                    showNotification('El reporte solicitado no existe.', 'error');
                    return;
                }
                const data = doc.data();

                // 1. Resetear el formulario y Tinetti
                resetForm();

                // 2. Cargar Datos Generales
                document.getElementById('nombre').value = data.nombre || '';
                document.getElementById('fecha').value = data.fecha || '';
                document.getElementById('evaluador').value = data.evaluador || '';

                // 3. Cargar IRAT-5
                (data.iratInputs || []).forEach(input => {
                    const element = document.getElementById(input.id);
                    if (element) element.value = input.value;
                });
                
                // 4. Cargar Norton
                (data.nortonInputs || []).forEach(input => {
                    const element = document.getElementById(input.id);
                    if (element) element.value = input.value;
                });

                // 5. Cargar Tinetti (usando los radios)
                (data.tinettiInputs || []).forEach(input => {
                    const radio = document.querySelector(`input[name="${input.name}"][value="${input.value}"]`);
                    if (radio) radio.checked = true;
                });
                
                // 6. Recalcular y mostrar resultados
                generarResultados();
                showNotification(`Evaluaci√≥n de ${data.nombre} cargada.`, 'info');
                document.querySelector('#results-section').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                console.error("Error al cargar el reporte:", error);
                showNotification(`Error al ver reporte: ${error.message}`, 'error');
            }
        }


        async function deleteReport(docId) {
            if (!confirm('¬øEst√° seguro de que desea eliminar esta evaluaci√≥n?')) {
                return;
            }

            try {
                await db.collection('evaluaciones').doc(docId).delete();
                showNotification('Evaluaci√≥n eliminada.', 'success');
                loadHistorial(); // Recargar historial despu√©s de eliminar
            } catch (error) {
                console.error("Error al eliminar la evaluaci√≥n:", error);
                showNotification(`Error al eliminar: ${error.message}`, 'error');
            }
        }
        
        // ------------------------------------------------------------------
        // FUNCIONES DE ADMINISTRADOR (Limpieza Masiva)
        // ------------------------------------------------------------------

        function confirmAndClearHistorial() {
            if (confirm("üö® ATENCI√ìN: Esta acci√≥n eliminar√° *TODAS* las evaluaciones (evaluaciones de *todos* los usuarios) de Firestore. ¬øEst√° seguro?")) {
                clearAllHistorial();
            }
        }

        /**
         * Elimina todas las evaluaciones de la colecci√≥n 'evaluaciones'. SOLO para administradores.
         */
        async function clearAllHistorial() {
            if (!currentUser) {
                showNotification('Debe iniciar sesi√≥n para realizar esta acci√≥n.', 'error');
                return;
            }

            const isAdmin = await checkAdminStatus(currentUser.uid);
            if (!isAdmin) {
                showNotification('Acceso denegado. Solo administradores pueden limpiar el historial.', 'error');
                return;
            }

            showNotification('Iniciando limpieza de historial...', 'warning', 10000);

            try {
                const batch = db.batch();
                // Firestore solo permite eliminar 500 documentos por lote (batch).
                let deletedCount = 0;
                let batchLimit = 500;
                let snapshot;

                do {
                    snapshot = await db.collection('evaluaciones').limit(batchLimit).get();
                    if (snapshot.size === 0) break;

                    snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });

                    await batch.commit();
                    deletedCount += snapshot.size;
                    
                    // Si hay m√°s documentos (tama√±o del snapshot igual al l√≠mite), hacemos un nuevo query y batch
                    if (snapshot.size === batchLimit) {
                         // Para asegurar que tomamos los siguientes documentos, volvemos a hacer la query
                         continue; 
                    }

                } while (snapshot.size > 0);
                
                showNotification(`Se eliminaron ${deletedCount} evaluaciones. Recargando historial...`, 'success', 5000);
                loadHistorial(true);

            } catch (error) {
                console.error("Error al limpiar el historial:", error);
                showNotification(`Error cr√≠tico al limpiar el historial: ${error.message}`, 'error', 10000);
            }
        }


        // ------------------------------------------------------------------
        // UTILIDADES DE UI
        // ------------------------------------------------------------------
        
        function showNotification(message, type = 'info', duration = 3000) {
            const bar = document.getElementById('notification-bar');
            bar.textContent = message;
            bar.className = `notification-bar notification-${type}`;
            bar.style.display = 'block';

            setTimeout(() => {
                bar.style.display = 'none';
            }, duration);
        }

        function resetForm() {
            document.getElementById('nombre').value = '';
            document.getElementById('fecha').value = '';
            document.getElementById('evaluador').value = '';
            
            // Resetear todos los selects/radios a la primera opci√≥n
            document.querySelectorAll('select').forEach(select => select.selectedIndex = 0);
            
            // Resetear radios de Tinetti al valor 0 (o la opci√≥n 'checked')
            document.querySelectorAll('#tinetti-section input[type="radio"]').forEach(radio => {
                if (radio.value === '0') radio.checked = true;
            });

            calcularIRAT();
            calcularTinetti();
            calcularNorton();

            document.getElementById('results-section').style.display = 'none';
        }

        // ------------------------------------------------------------------
        // GENERACI√ìN DE PDF
        // ------------------------------------------------------------------

        function generatePDF() {
            if (!lastReportData || !lastReportData.nombre) {
                showNotification('Primero genere los resultados para crear el PDF.', 'warning');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let y = 15;
            const margin = 15;
            const lineHeight = 7;
            const sectionMargin = 10;
            const pageWidth = doc.internal.pageSize.width;

            // T√≠tulo
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(18);
            doc.setTextColor(30, 60, 114); // Azul oscuro
            doc.text("INFORME DE EVALUACI√ìN CL√çNICA INTEGRADA", pageWidth / 2, y, { align: 'center' });
            y += lineHeight * 2;

            // Datos Generales
            doc.setFontSize(12);
            doc.setTextColor(51, 51, 51);
            doc.setFont('helvetica', 'normal');
            doc.text(`Paciente: ${lastReportData.nombre}`, margin, y);
            doc.text(`Fecha de Evaluaci√≥n: ${lastReportData.fecha}`, pageWidth / 2, y);
            y += lineHeight;
            doc.text(`Evaluador: ${lastReportData.evaluador || 'N/A'}`, margin, y);
            y += sectionMargin;

            // T√≠tulos de Secciones
            const drawSectionTitle = (text, color) => {
                doc.setFillColor(color[0], color[1], color[2]);
                doc.rect(margin, y - 5, pageWidth - margin * 2, 7, 'F');
                doc.setTextColor(255, 255, 255);
                doc.text(text, margin + 2, y);
                doc.setTextColor(51, 51, 51);
                doc.setFont('helvetica', 'bold');
                y += lineHeight;
            };

            // Secci√≥n de Puntajes
            drawSectionTitle("PUNTAJES OBTENIDOS", [30, 60, 114]);
            doc.setFont('helvetica', 'normal');
            
            doc.text(`IRAT-5 (Ca√≠da/Amputaci√≥n): ${lastReportData.iratScore} | Riesgo: ${lastReportData.iratRiesgo}`, margin, y);
            y += lineHeight;
            doc.text(`Tinetti (Marcha/Equilibrio): ${lastReportData.tinettiScore} / 28`, margin, y);
            y += lineHeight;
            doc.text(`Norton (√ölcera por Presi√≥n): ${lastReportData.nortonScore} / 20 | Riesgo: ${lastReportData.nortonRiesgo}`, margin, y);
            y += sectionMargin;
            
            // Secci√≥n de Clasificaci√≥n Global
            drawSectionTitle("CLASIFICACI√ìN CL√çNICA COMBINADA", [255, 90, 96]); // Rojo/Salm√≥n
            doc.text(`Nivel de Riesgo Global: ${lastReportData.clasificacionGlobal}`, margin, y);
            y += sectionMargin;

            // Secci√≥n de Recomendaciones
            drawSectionTitle("RECOMENDACIONES CLAVE Y PLAN INTERDISCIPLINAR", [114, 153, 192]); // Azul claro
            doc.setFont('helvetica', 'normal');

            lastReportData.recomendaciones.forEach(rec => {
                if (y > doc.internal.pageSize.height - margin * 2) {
                    doc.addPage();
                    y = margin;
                }
                
                // T√≠tulo de la recomendaci√≥n
                doc.setFont('helvetica', 'bold');
                doc.text(`- ${rec.titulo}:`, margin, y);
                y += lineHeight * 0.8;
                
                // Texto de la recomendaci√≥n (Manejo de l√≠neas)
                doc.setFont('helvetica', 'normal');
                const splitText = doc.splitTextToSize(rec.texto, pageWidth - margin * 2);
                doc.text(splitText, margin + 5, y);
                y += splitText.length * lineHeight;
                y += 2; // Espacio entre recomendaciones
            });

            // Guardar el PDF
            doc.save(`Evaluacion_${lastReportData.nombre.replace(/\s/g, '_')}_${lastReportData.fecha}.pdf`);
        }

    </script>
</body>
</html>
